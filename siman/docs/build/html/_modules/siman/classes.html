
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>siman.classes &#8212; Siman 0.9.5 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for siman.classes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- </span>
<span class="c1">#Copyright Aksyonov D.A</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">io</span>


<span class="c1">#additional packages</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tabulate is not avail&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pandas is not avail&#39;</span><span class="p">)</span>

<span class="c1"># import pymatgen</span>
<span class="c1"># sys.exit()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pymatgen</span>
    <span class="kn">from</span> <span class="nn">pymatgen.io.cif</span> <span class="k">import</span> <span class="n">CifWriter</span>
    <span class="kn">from</span> <span class="nn">pymatgen.symmetry.analyzer</span> <span class="k">import</span> <span class="n">SpacegroupAnalyzer</span>
    <span class="kn">from</span> <span class="nn">pymatgen.core.surface</span> <span class="k">import</span> <span class="n">Slab</span>
    <span class="kn">from</span> <span class="nn">pymatgen.core.composition</span> <span class="k">import</span> <span class="n">Composition</span>
    <span class="n">pymatgen_flag</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pymatgen is not avail&#39;</span><span class="p">)</span>
    <span class="n">pymatgen_flag</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># import matplotlib.pyplot as plt</span>


<span class="c1">#siman packages</span>
<span class="kn">from</span> <span class="nn">siman</span> <span class="k">import</span> <span class="n">header</span>

<span class="kn">from</span> <span class="nn">siman.header</span> <span class="k">import</span> <span class="n">printlog</span><span class="p">,</span> <span class="n">print_and_log</span><span class="p">,</span> <span class="n">runBash</span><span class="p">,</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">siman.small_functions</span> <span class="k">import</span> <span class="n">makedir</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">is_string_like</span><span class="p">,</span> <span class="n">cat_files</span><span class="p">,</span> <span class="n">grep_file</span><span class="p">,</span> <span class="n">red_prec</span><span class="p">,</span> <span class="n">list2string</span><span class="p">,</span> <span class="n">is_list_like</span>
<span class="kn">from</span> <span class="nn">siman.functions</span> <span class="k">import</span> <span class="p">(</span><span class="n">read_vectors</span><span class="p">,</span> <span class="n">read_list</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span>
     <span class="n">element_name_inv</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">calculate_voronoi</span><span class="p">,</span>
    <span class="n">get_from_server</span><span class="p">,</span> <span class="n">push_to_server</span><span class="p">,</span> <span class="n">run_on_server</span><span class="p">,</span> <span class="n">smoother</span><span class="p">,</span> <span class="n">file_exists_on_server</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">siman.inout</span> <span class="k">import</span> <span class="n">write_xyz</span><span class="p">,</span> <span class="n">write_lammps</span><span class="p">,</span> <span class="n">read_xyz</span><span class="p">,</span> <span class="n">read_poscar</span>
<span class="kn">from</span> <span class="nn">siman.geo</span> <span class="k">import</span> <span class="n">image_distance</span><span class="p">,</span> <span class="n">replic</span><span class="p">,</span> <span class="n">calc_recip_vectors</span><span class="p">,</span> <span class="n">calc_kspacings</span><span class="p">,</span> <span class="n">xred2xcart</span><span class="p">,</span> <span class="n">xcart2xred</span><span class="p">,</span> <span class="n">local_surrounding</span><span class="p">,</span> <span class="n">determine_symmetry_positions</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes used in siman</span>
<span class="sd">TODO:</span>
<span class="sd">1. Please  combine calculate_nbands(), calc_kspacings(), magmom filling in make incar  with actualize_set() </span>
<span class="sd">2. split make_incar_and_copy_all() into make_incar() and copy_calc_files_to_cluster()</span>
<span class="sd">3. split .read_results() into download_output_files() and .parse_outcar() and .analyze_output()</span>
<span class="sd">4. outcar name should be returned by write_sge_script in all cases and used, now only in u_ramping</span>
<span class="sd">5. write_sge() - в режиме inherit_option = continue - предыдущие outcar резервируются только один</span>
<span class="sd">раз с префиксом prev, повторный запуск перезатрет их, поэтому нужно писать спец код</span>
<span class="sd">типа</span>
<span class="sd">if test -f prev1.outcar</span>
<span class="sd">    cp name prev2+name</span>
<span class="sd">чтобы она находила prev3 с максимальным числом, и к этому числу прибавляла единицу для нового файла</span>

<span class="sd">NEW:</span>
<span class="sd">Calculation Structure():</span>
<span class="sd">    *self.magmom* (list) - magnetic moments for each ion in structure; has higher preference than self.set.magnetic_moments which</span>
<span class="sd">    include only moments for atom types</span>


<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="cd"><a class="viewcode-back" href="../../siman.html#siman.classes.cd">[docs]</a><span class="k">class</span> <span class="nc">cd</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Context manager for changing the current working directory&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">newPath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newPath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savedPath</span><span class="p">)</span></div>






<div class="viewcode-block" id="Description"><a class="viewcode-back" href="../../siman.html#siman.classes.Description">[docs]</a><span class="k">class</span> <span class="nc">Description</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objects of this class include just folder and description of specific calculation.</span>
<span class="sd">    Mostly was needed for manual addition of new calculations</span>

<span class="sd">    self.ngkpt_dict_for_kspacings (dict of lists) - the key is kspacing; the dict</span>
<span class="sd">    contains k-meshes </span>
<span class="sd">    for all calculations</span>
<span class="sd">    based on this geometry structure.</span>
<span class="sd">    can be useful for fine tuning of k-mesh for specific kspacing.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sectionfolder</span> <span class="o">=</span> <span class="s2">&quot;forgot_folder&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;forgot_description&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfolder</span> <span class="o">=</span> <span class="n">sectionfolder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#the key is kspacing</span></div>




<div class="viewcode-block" id="empty_struct"><a class="viewcode-back" href="../../siman.html#siman.classes.empty_struct">[docs]</a><span class="k">class</span> <span class="nc">empty_struct</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This class includes only structure related information such as primitive vectors, coordinates, forces and so on&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># flags for selective dynamics</span>
        <span class="c1"># self.pos = write_poscar()</span>

<div class="viewcode-block" id="Structure.copy"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Structure.new"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.new">[docs]</a>    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Structure</span><span class="p">()</span></div>

<div class="viewcode-block" id="Structure.selective_all"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.selective_all">[docs]</a>    <span class="k">def</span> <span class="nf">selective_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># if hasattr(self, &#39;select&#39;):</span>
        <span class="n">st</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># print(st.natom)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
            <span class="c1"># print(&#39;9&#39;)</span>
        <span class="c1"># print(st.select)</span>
        <span class="k">return</span> <span class="n">st</span> </div>

<div class="viewcode-block" id="Structure.check_selective"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.check_selective">[docs]</a>    <span class="k">def</span> <span class="nf">check_selective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if some atoms should be frozen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selective_dyn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                <span class="c1"># print (not all(sel))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
                    <span class="n">selective_dyn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">selective_dyn</span></div>

<div class="viewcode-block" id="Structure.selective_byCompare"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.selective_byCompare">[docs]</a>    <span class="k">def</span> <span class="nf">selective_byCompare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st2</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">freeze</span> <span class="o">=</span> <span class="s1">&#39;present&#39;</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set selective dynamics falgs in the calling structure (self) by freezing the atoms that are present (or missing) in the supplied structure (st2)</span>
<span class="sd">        tol - tolerance for finding the same atoms in the two structures</span>
<span class="sd">        freeze = &#39;present&#39; or &#39;missing&#39;</span>

<span class="sd">        TODO:</span>
<span class="sd">        read st2 from file</span>
<span class="sd">        optional save flag-changed atoms to cif (to check the result)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freeze</span> <span class="o">==</span> <span class="s1">&#39;missing&#39;</span><span class="p">:</span>
            <span class="n">flag_change</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
            <span class="n">flag_default</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag_change</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
            <span class="n">flag_default</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">freeze</span> <span class="o">!=</span> <span class="s1">&#39;present&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning! incorrect </span><span class="se">\&#39;</span><span class="s1">freeze</span><span class="se">\&#39;</span><span class="s1"> argument, </span><span class="se">\&#39;</span><span class="s1">presnt</span><span class="se">\&#39;</span><span class="s1"> is used&#39;</span><span class="p">)</span>

        <span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># ^2 tol instead sqrt(dist)</span>

        <span class="n">totNatom1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st1</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span>
        <span class="n">totNatom2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st1</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">totNatom2</span> <span class="o">&gt;</span> <span class="n">totNatom1</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! struct to compare with has more atoms than original struct!&#39;</span><span class="p">)</span>

        <span class="n">st1</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag_default</span><span class="p">]</span> <span class="o">*</span> <span class="n">totNatom1</span>

        <span class="n">natom1</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dictionary of atom types (by znucl); each entry contains list of atom nubers of certain type</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st1</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st1</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">atype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">natom1</span><span class="p">:</span>
                <span class="n">natom1</span><span class="p">[</span><span class="n">st1</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">atype</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">natom1</span><span class="p">[</span><span class="n">st1</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">atype</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">natom2</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary of atom types (by znucl); each entry contains list of atom nubers of certain type</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st2</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st2</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">atype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">natom2</span><span class="p">:</span>
                <span class="n">natom2</span><span class="p">[</span><span class="n">st2</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">atype</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">natom2</span><span class="p">[</span><span class="n">st2</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">atype</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ztype</span> <span class="ow">in</span> <span class="n">natom2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="n">natom2</span><span class="p">[</span><span class="n">ztype</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">natom1</span><span class="p">[</span><span class="n">ztype</span><span class="p">]):</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">st1</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">-</span> <span class="n">st2</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">i2</span><span class="p">]))</span> <span class="c1"># square distance between compared atoms</span>
                    <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">st1</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag_change</span> <span class="c1"># change SD flags for if the atoms are identical</span>
                        <span class="k">del</span> <span class="p">(</span><span class="n">natom1</span><span class="p">[</span><span class="n">ztype</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">st1</span></div>


<div class="viewcode-block" id="Structure.fix_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.fix_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">fix_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numbers</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#fix all atom with numbers in numbers list</span>
        
        <span class="c1">#TODO allow choice of axis of fix </span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! number of select atom is not equal to total number of atoms. First I make all moveable&#39;</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selective_all</span><span class="p">()</span>

        <span class="c1"># print(st.select)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="Structure.fix_layers"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.fix_layers">[docs]</a>    <span class="k">def</span> <span class="nf">fix_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xred_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xcart_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fix atoms in layers normal to R3</span>

<span class="sd">        xred_range (list) [from, to]</span>
<span class="sd">        highlight - replace with Pu to check</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">r3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">xcr</span> <span class="o">=</span> <span class="n">xcart_range</span>
        <span class="k">if</span> <span class="n">xcr</span><span class="p">:</span>
            <span class="n">xred_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">xcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r3</span><span class="p">,</span> <span class="n">xcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r3</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;xcart_range converted to xred&#39;</span><span class="p">,</span> <span class="n">xred_range</span><span class="p">)</span>



        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selective_all</span><span class="p">()</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># print(st.select)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xred_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="n">xr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xred_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="c1"># fix</span>
                <span class="n">fixed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;_fix&#39;</span>
        <span class="k">if</span> <span class="n">highlight</span><span class="p">:</span>
            <span class="n">st_h</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">replace_atoms</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="s1">&#39;Pu&#39;</span><span class="p">)</span>
            <span class="n">st_h</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">st</span></div>





<div class="viewcode-block" id="Structure.get_layers_pos"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_layers_pos">[docs]</a>    <span class="k">def</span> <span class="nf">get_layers_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xred_range</span><span class="p">):</span>
        <span class="c1">#return layer positions along vector 3 in xred_range</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">zred_req</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span><span class="n">xr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">xred_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">xred_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zred_req</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">zred_req</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

                <span class="n">m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zred_req</span><span class="p">)</span> <span class="o">-</span> <span class="n">z</span><span class="p">))</span>
                <span class="c1"># print()</span>
                <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="c1">#tolerance 0.1 A</span>
                    <span class="n">zred_req</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">z_unique</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zred_req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z_unique</span></div>


<div class="viewcode-block" id="Structure.get_slice"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thickness</span><span class="p">):</span>
        <span class="c1">#return element numbers from the top part of slab along z</span>
        <span class="c1">#slab should start from bottom</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_surface_pos</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">z2</span><span class="o">-</span><span class="n">thickness</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">z2</span><span class="p">:</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nn</span></div>



<div class="viewcode-block" id="Structure.xcart2xred"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.xcart2xred">[docs]</a>    <span class="k">def</span> <span class="nf">xcart2xred</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span></div>
<div class="viewcode-block" id="Structure.update_xred"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.update_xred">[docs]</a>    <span class="k">def</span> <span class="nf">update_xred</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span></div>


<div class="viewcode-block" id="Structure.xred2xcart"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.xred2xcart">[docs]</a>    <span class="k">def</span> <span class="nf">xred2xcart</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Structure.update_xcart"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.update_xcart">[docs]</a>    <span class="k">def</span> <span class="nf">update_xcart</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Structure.exchange_axes"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.exchange_axes">[docs]</a>    <span class="k">def</span> <span class="nf">exchange_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i1_r</span><span class="p">,</span> <span class="n">i2_r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i1_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i2_r</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i2_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i1_r</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">update_xred</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">st</span></div>




<div class="viewcode-block" id="Structure.get_volume"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">);</span> <span class="c1">#volume</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span></div>

<div class="viewcode-block" id="Structure.get_recip"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_recip">[docs]</a>    <span class="k">def</span> <span class="nf">get_recip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate reciprocal vectors&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="n">calc_recip_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recip</span></div>

<div class="viewcode-block" id="Structure.get_nznucl"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_nznucl">[docs]</a>    <span class="k">def</span> <span class="nf">get_nznucl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list of numbers of atoms of each type, order is not important</span>
<span class="sd">            updated directly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span></div>

<div class="viewcode-block" id="Structure.get_elements"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_elements">[docs]</a>    <span class="k">def</span> <span class="nf">get_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#return list of elements names</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">element_name_inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="p">]</span></div>

<div class="viewcode-block" id="Structure.get_elements_z"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_elements_z">[docs]</a>    <span class="k">def</span> <span class="nf">get_elements_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#return list of elements names</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="p">]</span></div>

<div class="viewcode-block" id="Structure.get_elements_zval"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_elements_zval">[docs]</a>    <span class="k">def</span> <span class="nf">get_elements_zval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#return list with number of valence electrons for each element</span>
        <span class="n">zvals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements_z</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">zv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">zvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zvals</span></div>

<div class="viewcode-block" id="Structure.determine_symmetry_positions"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.determine_symmetry_positions">[docs]</a>    <span class="k">def</span> <span class="nf">determine_symmetry_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">siman.geo</span> <span class="k">import</span> <span class="n">determine_symmetry_positions</span>

        <span class="k">return</span> <span class="n">determine_symmetry_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span></div>


<div class="viewcode-block" id="Structure.get_maglist"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_maglist">[docs]</a>    <span class="k">def</span> <span class="nf">get_maglist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#return bool list of which  elements are magnetic (here all transition metals are searched!)</span>
        <span class="c1">#and dictionary with numbers of each transition metal</span>
        <span class="n">ifmaglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements_z</span><span class="p">()</span>
        <span class="n">mag_numbers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zlist</span><span class="p">):</span> <span class="c1">#</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">TRANSITION_ELEMENTS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">z</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mag_numbers</span><span class="p">:</span>
                    <span class="n">mag_numbers</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ifmaglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">mag_numbers</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ifmaglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ifmaglist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ifmaglist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ifmaglist</span><span class="p">,</span> <span class="n">mag_numbers</span></div>

<div class="viewcode-block" id="Structure.show_mag"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.show_mag">[docs]</a>    <span class="k">def</span> <span class="nf">show_mag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="c1"># show magmom of i atoms, starting from 1</span>
        <span class="n">i</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magmom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mag for </span><span class="si">{:s}</span><span class="s1"> = </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>

        <span class="k">return</span> </div>

<div class="viewcode-block" id="Structure.get_mag_tran"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_mag_tran">[docs]</a>    <span class="k">def</span> <span class="nf">get_mag_tran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#show mag moments of transition metals </span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_maglist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(l)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magmom</span><span class="p">)[</span><span class="n">l</span><span class="p">]</span></div>

<div class="viewcode-block" id="Structure.set_magnetic_config"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.set_magnetic_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_magnetic_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">moments</span><span class="p">):</span>
        <span class="c1">#set magnetic configuration based on symmetry non-equivalent positions</span>
        <span class="c1"># element (str) - elements for which moments should be set </span>
        <span class="c1"># moments (list) - list of moments for non-equivalent positions - the same order as in determine</span>
        <span class="c1">#                  the length should be the same as number of unique postions</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">:</span>
            <span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">]</span><span class="o">*</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">magmom</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">determine_symmetry_positions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">magmom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># print(magmom)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">magmom</span>

        <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="Structure.convert2pymatgen"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.convert2pymatgen">[docs]</a>    <span class="k">def</span> <span class="nf">convert2pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxidation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">slab</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">chg_type</span> <span class="o">=</span> <span class="s1">&#39;ox&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        oxidation (dict) - {&#39;Ti&#39;:&#39;Ti3+&#39;}</span>
<span class="sd">        if self.charges exist then it is used to update oxidation states of atoms</span>
<span class="sd">        chg_type - &#39;ox&#39; - oxidation states calculated from self.charges </span>
<span class="sd">                   &#39;norm&#39; - normalized self.charges</span>
<span class="sd">                    &#39;tot&#39; - just self.charges</span>
<span class="sd">                    &#39;pot&#39; - charges from potentials zval, number of valence electrons</span>


<span class="sd">        slab - if True return slab object is returned - limited functional is implemented</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">siman.analysis</span> <span class="k">import</span> <span class="n">calc_oxidation_states</span>

        <span class="n">site_properties</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
            <span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magmom</span>







        <span class="k">if</span> <span class="n">oxidation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">oxidation</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">slab</span><span class="p">:</span>
            <span class="c1"># print(dir(pymatgen.core))</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">Slab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> 
                <span class="n">miller_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">oriented_unit_cell</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">reorient_lattice</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">site_properties</span> <span class="o">=</span> <span class="n">site_properties</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(elements)</span>
            <span class="c1"># print(len(self.xred))</span>
            <span class="c1"># print(site_properties)</span>

            <span class="n">pm</span> <span class="o">=</span> <span class="n">pymatgen</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">site_properties</span> <span class="o">=</span> <span class="n">site_properties</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">chg_type</span> <span class="o">==</span> <span class="s1">&#39;pot&#39;</span><span class="p">:</span>
            
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Using zval as charges&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">chg</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">*-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements_zval</span><span class="p">()</span>           <span class="p">]</span>
            <span class="c1"># print(chg)</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">add_oxidation_state_by_site</span><span class="p">(</span><span class="n">chg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;charges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charges</span><span class="p">):</span>

                <span class="n">chg_type</span> <span class="o">=</span> <span class="s1">&#39;ox&#39;</span> <span class="c1"># &#39;norm&#39;, &#39;tot&#39;</span>

                <span class="c1"># print(chg_type)</span>
                <span class="k">if</span> <span class="n">chg_type</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="c1">#normalize charges</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charges</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charges</span><span class="p">)</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="n">t</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">charges</span> <span class="p">]</span>
                    <span class="c1"># print(t)</span>
                
                <span class="k">elif</span> <span class="n">chg_type</span> <span class="o">==</span> <span class="s1">&#39;ox&#39;</span><span class="p">:</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="n">calc_oxidation_states</span><span class="p">(</span><span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">chg_type</span> <span class="o">==</span> <span class="s1">&#39;tot&#39;</span><span class="p">:</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charges</span>
                
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#check total charge</span>
                    <span class="c1"># st = st.copy()</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">chg</span><span class="p">)</span>
                    <span class="n">tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">chg</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total charge is &#39;</span><span class="p">,</span> <span class="n">tot</span><span class="p">,</span> <span class="s1">&#39;I subtract it uniformly from each atom&#39;</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">tot</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="n">d</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chg</span><span class="p">]</span>





                <span class="n">pm</span><span class="o">.</span><span class="n">add_oxidation_state_by_site</span><span class="p">(</span><span class="n">chg</span><span class="p">)</span>




        <span class="k">return</span> <span class="n">pm</span></div>







<div class="viewcode-block" id="Structure.get_pm_composition"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_pm_composition">[docs]</a>    <span class="k">def</span> <span class="nf">get_pm_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span></div>


<div class="viewcode-block" id="Structure.get_reduced_formula"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_reduced_formula">[docs]</a>    <span class="k">def</span> <span class="nf">get_reduced_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="c1"># cm = Composition(self.get_elements())</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">reduced_formula</span></div>

<div class="viewcode-block" id="Structure.get_name"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">siman.small_functions</span> <span class="k">import</span> <span class="n">latex_chem</span>
        <span class="k">return</span> <span class="n">latex_chem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">())</span></div>

<div class="viewcode-block" id="Structure.get_formula"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_formula">[docs]</a>    <span class="k">def</span> <span class="nf">get_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1"># pm = self.convert2pymatgen()</span>
        <span class="c1"># cm = Composition(pm.formula)</span>
        <span class="c1"># cm = Composition(self.get_elements())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span><span class="o">.</span><span class="n">formula</span></div>

<div class="viewcode-block" id="Structure.get_reduced_composition"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_reduced_composition">[docs]</a>    <span class="k">def</span> <span class="nf">get_reduced_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="c1"># cm = Composition(self.get_elements())</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">reduced_composition</span></div>

<div class="viewcode-block" id="Structure.get_reduced_formula_and_factor"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_reduced_formula_and_factor">[docs]</a>    <span class="k">def</span> <span class="nf">get_reduced_formula_and_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="c1"># cm = Composition(self.get_elements())</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_reduced_formula_and_factor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Structure.get_fractional_composition"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_fractional_composition">[docs]</a>    <span class="k">def</span> <span class="nf">get_fractional_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="c1"># cm = Composition(self.get_elements())</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">fractional_composition</span></div>





<div class="viewcode-block" id="Structure.update_types"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.update_types">[docs]</a>    <span class="k">def</span> <span class="nf">update_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="c1"># update typat, ntypat, znucl, nznucl from elements - list of elements names</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>

        <span class="n">st</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curtyp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
                <span class="n">curtyp</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">types</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">=</span> <span class="n">curtyp</span>
                <span class="k">if</span> <span class="n">is_string_like</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">invert</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">el</span>

                <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="c1"># nznucl.append(0)</span>
                <span class="n">unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">el</span><span class="p">])</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">get_nznucl</span><span class="p">()</span>

        <span class="c1"># print(st.ntypat, st.typat, st.nznucl, st.znucl)</span>

        <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="Structure.update_from_pymatgen"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.update_from_pymatgen">[docs]</a>    <span class="k">def</span> <span class="nf">update_from_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stpm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        stpm - pymatgen structure</span>
<span class="sd">        update the current structure from pymatgen structure</span>
<span class="sd">        only rprimd, xred and xcart are updated now!!!!!</span>

<span class="sd">        TODO:</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">stpm</span><span class="o">.</span><span class="n">_lattice</span><span class="o">.</span><span class="n">_matrix</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">xred</span>   <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">_fcoords</span><span class="p">)</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">stpm</span><span class="o">.</span><span class="n">_sites</span><span class="p">]</span>
        

        <span class="c1"># print(elements)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">update_xcart</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">stpm</span><span class="o">.</span><span class="n">_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;magmom&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;magmom&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">stpm</span><span class="o">.</span><span class="n">_sites</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="c1"># print( dir(s._lattice) )</span>
        <span class="c1"># print( dir(s) )</span>
        <span class="c1"># print( s.properties )</span>
        <span class="c1"># print( s._properties )</span>
        <span class="c1"># print( dir(s.specie) )</span>
        <span class="c1"># print( s.specie.name )</span>
        <span class="c1"># sys.exit()</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stpm</span><span class="o">.</span><span class="n">_sites</span><span class="p">]</span>
        <span class="c1"># print(s.specie.oxi_state)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="s1">&#39;oxi_state&#39;</span><span class="p">):</span>
            <span class="n">charges</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">oxi_state</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stpm</span><span class="o">.</span><span class="n">_sites</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">charges</span> <span class="o">=</span> <span class="n">charges</span>
        
        <span class="c1"># if hasattr(s.specie, &#39;oxi_state&#39;):</span>
        <span class="c1">#     charges = [s.specie.oxi_state for s in stpm._sites]</span>
        <span class="c1">#     st.charges = charges</span>


        <span class="c1"># print(st.charges)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     charges = [None]</span>
        <span class="c1"># print(elements)</span>
        <span class="c1"># print(charges)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">update_types</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span>
        <span class="c1"># sys.exit()</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">):</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! number of atoms was changed, please improve this method&#39;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;_from_pmg&#39;</span>
        <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.rotate"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
        <span class="c1">#axis - list of 3 elements, [0,0,1]</span>
        <span class="c1">#angle in degrees</span>
        
        <span class="kn">from</span> <span class="nn">pymatgen.transformations.standard_transformations</span> <span class="k">import</span> <span class="n">RotationTransformation</span>
        
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">RotationTransformation</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
        <span class="n">stpm</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
        <span class="n">stpmr1</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">apply_transformation</span><span class="p">(</span><span class="n">stpm</span><span class="p">)</span>
        <span class="n">st_r1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">update_from_pymatgen</span><span class="p">(</span><span class="n">stpmr1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">st_r1</span></div>


<div class="viewcode-block" id="Structure.invert_axis"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.invert_axis">[docs]</a>    <span class="k">def</span> <span class="nf">invert_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">st</span><span class="o">.</span><span class="n">update_xred</span><span class="p">()</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">return_atoms_to_cell</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">st</span></div>











<div class="viewcode-block" id="Structure.get_conventional_cell"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_conventional_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_conventional_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return conventional cell </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st_mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>

        <span class="c1"># st_test = self.update_from_pymatgen(st_mp)</span>
        <span class="c1"># st_test.printme()</span>

        <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">st_mp</span><span class="p">,</span> <span class="p">)</span> <span class="c1">#symprec = 0.1</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_conventional_standard_structure</span><span class="p">()</span> <span class="c1"># magmom are set to None</span>

        <span class="c1"># print(sc)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_from_pymatgen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

        <span class="c1"># print(st.rprimd)</span>
        <span class="c1"># print(len(st.xcart))</span>
        <span class="c1"># print(st.ntypat)</span>

        <span class="k">return</span> <span class="n">st</span></div>




<div class="viewcode-block" id="Structure.get_primitive_cell"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_primitive_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_primitive_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return primitive cell </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st_mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>

        <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">st_mp</span><span class="p">,</span> <span class="p">)</span> <span class="c1">#symprec = 0.1</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_primitive_standard_structure</span><span class="p">()</span> <span class="c1"># magmom are set to None</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_from_pymatgen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="Structure.get_surface_pos"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_surface_pos">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="c1">#allows to return positions of top and bottom surfaces (edge atoms) in cartesian</span>
        <span class="c1">#assumed normal to R3</span>
        <span class="c1">#small number is added or subtracted to/from edge atom to overcome further numericall errors</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">z1</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># print(st.xcart)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">z1</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">z1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">z2</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">z2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">z1</span><span class="o">-=</span><span class="mf">0.01</span>
        <span class="n">z2</span><span class="o">+=</span><span class="mf">0.01</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Surfaces are &#39;</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>

        <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">z</span></div>


<div class="viewcode-block" id="Structure.get_surface_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_surface_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">surface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surface_width</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="p">):</span>
        <span class="c1">#return numbers of surface atoms</span>
        <span class="c1">#elememt - which element is interesting?</span>
        <span class="c1">#surface_width - which atoms to consider as surface </span>
        <span class="c1">#surface (int) - 0 or 1 - one of two surfaces; surface 1 has lowest z coordinate</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">surface_atoms</span> <span class="o">=</span> <span class="p">[[],[]]</span>
        
        <span class="n">z</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_surface_pos</span><span class="p">()</span>


        <span class="n">els</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>


        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">):</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">els</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="n">element</span><span class="p">:</span>
                <span class="c1"># print(x[2])</span>
                <span class="k">if</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">surface_width</span><span class="p">:</span>
                    <span class="n">surface_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">surface_width</span>  <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">surface_atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">surface_atoms</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span></div>


<div class="viewcode-block" id="Structure.get_surface_area"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_surface_area">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#currently should be normal to rprim[0] and rprim[1]</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># print()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span></div>



<div class="viewcode-block" id="Structure.printme"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.printme">[docs]</a>    <span class="k">def</span> <span class="nf">printme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">())</span>
        <span class="k">return</span> </div>

<div class="viewcode-block" id="Structure.get_space_group_info"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_space_group_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_space_group_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="n">default</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">symprec</span><span class="p">:</span>
            <span class="n">symprec</span> <span class="o">=</span> <span class="n">default</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;spg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">symprec</span> <span class="o">==</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">spg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
            <span class="n">spg</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_space_group_info</span><span class="p">(</span><span class="n">symprec</span><span class="p">)</span>
        <span class="c1"># p = self.convert2pymatgen()</span>

        <span class="c1"># print(p.get_symmetry_operations(symprec))</span>


        <span class="k">return</span> <span class="n">spg</span></div>

<div class="viewcode-block" id="Structure.sg"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.sg">[docs]</a>    <span class="k">def</span> <span class="nf">sg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">symprec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_space_group_info</span><span class="p">(</span><span class="n">symprec</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="Structure.get_angles"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_angles">[docs]</a>    <span class="k">def</span> <span class="nf">get_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">beta</span>  <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span></div>

    <span class="c1"># def __str__(self):</span>
    <span class="c1">#     # print(self.convert2pymatgen())</span>
    <span class="c1">#     return </span>


<div class="viewcode-block" id="Structure.get_element_xred"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_element_xred">[docs]</a>    <span class="k">def</span> <span class="nf">get_element_xred</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get xred of *element* first occurance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="Structure.get_element_xcart"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_element_xcart">[docs]</a>    <span class="k">def</span> <span class="nf">get_element_xcart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get xred of *element* first occurance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="Structure.get_transition_elements"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_transition_elements">[docs]</a>    <span class="k">def</span> <span class="nf">get_transition_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;names&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of transition elements (chemical names or z) in the structure</span>
<span class="sd">        fmt - </span>
<span class="sd">            &#39;names&#39;</span>
<span class="sd">            &#39;z&#39;</span>
<span class="sd">            &#39;n&#39; - numbers of atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="n">tra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">TRANSITION_ELEMENTS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="n">invert</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">tra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
            <span class="n">tra</span> <span class="o">=</span> <span class="p">[</span><span class="n">invert</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tra</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="n">tra</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="k">return</span> <span class="n">tra</span></div>

<div class="viewcode-block" id="Structure.get_specific_elements"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_specific_elements">[docs]</a>    <span class="k">def</span> <span class="nf">get_specific_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_elements</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">z_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of specific elements (chemical names. z, or numbers from 0) in the structure</span>
<span class="sd">        required_elements - list of elements z of interest</span>
<span class="sd">        z_range - (2 index tuple) range of z coordinates: only atoms from z1 to z2 are taken</span>
<span class="sd">        fmt - format of output</span>
<span class="sd">            &#39;names&#39;</span>
<span class="sd">            &#39;z&#39;</span>
<span class="sd">            &#39;n&#39; - numbers of atoms</span>
<span class="sd">            &#39;x&#39; - xcart</span>
<span class="sd">        </span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="n">tra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">z_range</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">additional_condition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">additional_condition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">xcart</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">xc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="p">):</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">invert</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Z</span> <span class="ow">in</span> <span class="n">required_elements</span> <span class="ow">and</span> <span class="n">additional_condition</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">tra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">xcart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
            <span class="n">tra</span> <span class="o">=</span> <span class="p">[</span><span class="n">invert</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tra</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="n">tra</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">tra</span> <span class="o">=</span> <span class="n">xcart</span>

        <span class="k">return</span> <span class="n">tra</span></div>



<div class="viewcode-block" id="Structure.get_dipole"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_dipole">[docs]</a>    <span class="k">def</span> <span class="nf">get_dipole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ox_states</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chg_type</span> <span class="o">=</span> <span class="s1">&#39;ox&#39;</span><span class="p">):</span>
        <span class="c1">#return dipole moment, e*A</span>
        <span class="c1">#</span>
        <span class="c1"># if you need to convert it to debye (D), use 1 D = 0.20819434 eÅ = 3.33564×10−30; 1 eA = 4.8 D</span>

        <span class="n">slab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">(</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oxidation</span> <span class="o">=</span> <span class="n">ox_states</span><span class="p">,</span> <span class="n">chg_type</span> <span class="o">=</span> <span class="n">chg_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slab</span><span class="o">.</span><span class="n">dipole</span></div>




<div class="viewcode-block" id="Structure.add_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.add_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">add_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms_xcart</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="s1">&#39;Pu&#39;</span><span class="p">,</span> <span class="n">return_ins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">selective</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        appends at the end if element is new. Other case insertered according to VASP conventions</span>
<span class="sd">        Updates ntypat, typat, znucl, nznucl, xred, magmom and natom</span>
<span class="sd">        atoms_xcart (list of ndarray)</span>
<span class="sd">        selective (list of lists) - selective dynamics</span>

<span class="sd">        magmom is appended with 0.6, please improve me! by using other values for magnetic elements </span>


<span class="sd">        if return_ins:</span>
<span class="sd">            Returns Structure(), int - place of insertion of first atom</span>
<span class="sd">        else:</span>
<span class="sd">            Structure()</span>
<span class="sd">       </span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;self.add_atoms(): adding atom &#39;</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># print(st.select)</span>
        <span class="k">if</span> <span class="n">selective</span><span class="p">:</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selective_all</span><span class="p">()</span>
        <span class="c1"># print(st.select)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">natom_to_add</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms_xcart</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="o">+=</span><span class="n">natom_to_add</span>

        <span class="n">el_z_to_add</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
            <span class="n">magmom_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">magmom_flag</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="k">if</span> <span class="n">el_z_to_add</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">el_z_to_add</span> <span class="p">)</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">natom_to_add</span><span class="p">)</span>            

            <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="o">+=</span><span class="mi">1</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        
            <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">atoms_xcart</span><span class="p">)</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="o">*</span><span class="n">natom_to_add</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">selective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selective</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># printlog(&#39;adding default selective&#39;, imp = &#39;y&#39;)</span>

                <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[[</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom_to_add</span><span class="p">)]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">magmom_flag</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">]</span><span class="o">*</span><span class="n">natom_to_add</span>  <span class="p">)</span>

            <span class="n">j_ins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="c1"># first one</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">el_z_to_add</span><span class="p">)</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">natom_to_add</span>
            
            <span class="n">typ</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>


            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">typ</span><span class="p">:</span>
                    <span class="n">j_ins</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># place to insert</span>




            <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">j_ins</span><span class="p">:</span><span class="n">j_ins</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms_xcart</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">j_ins</span><span class="p">:</span><span class="n">j_ins</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="o">*</span><span class="n">natom_to_add</span>

            <span class="c1"># print(st.select)</span>
            <span class="c1"># sys.exit()</span>
            <span class="k">if</span> <span class="n">selective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;adding selective&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">j_ins</span><span class="p">:</span><span class="n">j_ins</span><span class="p">]</span> <span class="o">=</span> <span class="n">selective</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="ow">and</span>  <span class="n">st</span><span class="o">.</span><span class="n">select</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;adding default selective&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">j_ins</span><span class="p">:</span><span class="n">j_ins</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom_to_add</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">magmom_flag</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">[</span><span class="n">j_ins</span><span class="p">:</span><span class="n">j_ins</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span><span class="mf">0.6</span><span class="p">]</span><span class="o">*</span><span class="n">natom_to_add</span>


        <span class="n">st</span><span class="o">.</span><span class="n">xcart2xred</span><span class="p">()</span>
        


        <span class="c1"># print(st.select)</span>



        <span class="k">if</span> <span class="n">return_ins</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">st</span><span class="p">,</span> <span class="n">j_ins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.add_atom"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.add_atom">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="s1">&#39;Pu&#39;</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">selective</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wrapper </span>
<span class="sd">        allows to add one atom using reduced coordinates or cartesian</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">xr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">([</span><span class="n">xr</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">elif</span> <span class="n">xc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Provide reduced *xr* or cartesian *xc* coordinates!&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">selective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">selective</span> <span class="o">=</span> <span class="p">[</span><span class="n">selective</span><span class="p">]</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">([</span><span class="n">xc</span><span class="p">],</span> <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="p">,</span> <span class="n">selective</span> <span class="o">=</span> <span class="n">selective</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">st</span> </div>

<div class="viewcode-block" id="Structure.reorder_for_vasp"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.reorder_for_vasp">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_for_vasp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Group and order atoms by atom types; consistent with VASP</span>
<span class="sd">        return st</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="p">)</span>
        <span class="n">zxred</span>  <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">]</span>
        <span class="n">zxcart</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">]</span>
        <span class="n">ztypat</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">]</span>
        <span class="n">zmagmom</span><span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">]</span>
        <span class="n">ziat</span> <span class="o">=</span>   <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># print(st.ntypat)</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">):</span>
            <span class="c1"># print (&quot;t &quot;, t, xr)</span>
            <span class="n">zxred</span><span class="p">[</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
            <span class="n">zxcart</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
            <span class="n">ztypat</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">ziat</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typat</span><span class="p">)</span> <span class="k">for</span> <span class="n">typat</span> <span class="ow">in</span> <span class="n">ztypat</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">zxcart</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">xred</span>  <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">zxred</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">ztypat</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">original_numbers</span>  <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">ziat</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">perm</span> <span class="o">=</span> <span class="p">[</span><span class="n">original_numbers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">)]</span> <span class="c1"># show the initial order of atoms; starting from 0</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
                <span class="n">zmagmom</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">zmagmom</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="c1"># print(st.get_elements())</span>

        <span class="c1"># print(st.perm)</span>

        

        <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.reorder_element_groups"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.reorder_element_groups">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_element_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Group and order atoms by atom types; consistent with VASP</span>
<span class="sd">        order (list) -required order e.g. [&#39;O&#39;, &#39;Li&#39;]</span>

<span class="sd">        return st</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># for z in st.znucl:</span>
        <span class="c1">#     print(z)</span>
        
        <span class="n">typat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xcart</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">magmom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">znucl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># st.write_poscar()</span>


        <span class="n">els</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">els</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Check *order* list&#39;</span><span class="p">)</span>
            
            <span class="n">znucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">invert</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                <span class="n">el_i</span> <span class="o">=</span> <span class="n">els</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">el_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Check *order* list&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">el_i</span> <span class="o">==</span> <span class="n">el</span><span class="p">:</span>
                    <span class="c1"># print(el)</span>
                    <span class="n">typat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">xcart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">magmom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xcart</span>
        <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">magmom</span>
        <span class="n">st</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="n">typat</span>
        <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="n">znucl</span>
        <span class="n">st</span><span class="o">.</span><span class="n">update_xred</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;_r&#39;</span>
        <span class="c1"># st.write_poscar()</span>

        <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.del_atom"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.del_atom">[docs]</a>    <span class="k">def</span> <span class="nf">del_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Now can delete only one atom with number iat (int), starting from 0. </span>
<span class="sd">        Takes care of magmom, ntypat, typat, znucl, nznucl, xred and natom</span>
<span class="sd">        Returns Structure()</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># print_and_log(&#39;Warning! Method del_atoms() was not carefully tested &#39;)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># print(st.nznucl)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">iat</span>

        <span class="n">typ</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;del_atom(): I remove atom &#39;</span><span class="p">,</span>  <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># print (&#39;Magmom deleted?&#39;)</span>
        <span class="c1"># print(st.magmom)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># print (&#39;Yes!&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="c1"># print (&#39;No!&#39;)</span>



        <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="o">-=</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">typ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">typ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">typ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="o">-=</span><span class="mi">1</span>

            <span class="c1"># for i, n in enumerate(st.nznucl):</span>
            <span class="c1">#     typ = i+1</span>
            <span class="c1">#     st.typat = [typ, ]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">typ</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>


        <span class="c1"># print(st.nznucl)</span>

        <span class="k">return</span> <span class="n">st</span></div>







<div class="viewcode-block" id="Structure.mov_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.mov_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">mov_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">to_x</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">relative</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move one atom to xcart position *to_x*</span>
<span class="sd">        relative (bool) - if shift is relative</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_x</span>
        

        <span class="n">st</span><span class="o">.</span><span class="n">xcart2xred</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="Structure.swap_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.swap_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">swap_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iat1</span><span class="p">,</span> <span class="n">iat2</span><span class="p">):</span>
        
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">els</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="c1"># printlog(&#39;You choose&#39;, els[iat1], &#39;and&#39;, els[iat2])</span>

        <span class="n">x1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iat1</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iat1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iat2</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iat2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="n">st</span><span class="o">.</span><span class="n">xcart2xred</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.leave_only"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.leave_only">[docs]</a>    <span class="k">def</span> <span class="nf">leave_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#Remove all atoms except *atom_type*(str, mendeleev element name)</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Starting leave_only()&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;    N of atoms before = &#39;</span><span class="p">,</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>


        <span class="n">z</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">atom_type</span><span class="p">)</span>

        <span class="n">new_xred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_magmom</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">new_xred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
                    <span class="n">new_magmom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">new_xred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>


        <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">new_magmom</span>

        <span class="n">st</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">new_xred</span>

        <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_xred</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">st</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span>

        <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="p">,]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">,]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

        <span class="c1"># print st.xred</span>

        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;    N of atoms after  = &#39;</span><span class="p">,</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.get_numbers"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.get_numbers">[docs]</a>    <span class="k">def</span> <span class="nf">get_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="s2">&quot;return numbers of specific element &quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())</span> <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="n">element</span><span class="p">]</span></div>


<div class="viewcode-block" id="Structure.remove_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.remove_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">remove_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms_to_remove</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remove atoms either of types provided in *atoms_to_remove* or having numbers provided in *atoms_to_remove*, starting from 0</span>
<span class="sd">        st (Structure)</span>
<span class="sd">        atoms_to_remove (list) - list of element names or numbers</span>
<span class="sd">        from_one (int)- if 1 the numbers of atoms in provided list are starting from one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># print(st.nznucl)</span>

        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">))</span>


        <span class="n">atom_exsist</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="n">atom_exsist</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>  <span class="nb">zip</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())</span> <span class="p">):</span>
                <span class="c1"># print(i)</span>

                <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">atoms_to_remove</span> <span class="ow">or</span> <span class="n">n</span><span class="o">+</span><span class="n">from_one</span> <span class="ow">in</span> <span class="n">atoms_to_remove</span><span class="p">:</span>
                    <span class="c1"># print(n)</span>
                    <span class="c1"># atoms_to_remove.remove(i)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">del_atom</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_exsist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;remove_atoms(): Atoms&#39;</span><span class="p">,</span> <span class="n">atoms_to_remove</span><span class="p">,</span> <span class="s1">&#39;were removed&#39;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="c1"># print(st.nznucl)</span>

        <span class="c1"># print(st.get_elements())</span>
        <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="Structure.del_layers"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.del_layers">[docs]</a>    <span class="k">def</span> <span class="nf">del_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xred_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xcart_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remove atoms normal to R3 in given range</span>

<span class="sd">        xred_range (list) [from, to]</span>
<span class="sd">        highlight - replace with Pu to check</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># print(st.nznucl)</span>
        <span class="n">r3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">xcr</span> <span class="o">=</span> <span class="n">xcart_range</span>
        <span class="k">if</span> <span class="n">xcr</span><span class="p">:</span>
            <span class="n">xred_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">xcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r3</span><span class="p">,</span> <span class="n">xcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r3</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;xcart_range converted to xred&#39;</span><span class="p">,</span> <span class="n">xred_range</span><span class="p">)</span>

        <span class="n">dels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xred_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="n">xr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xred_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># print(xred_range[0], xr[2], xred_range[1])</span>
                <span class="n">dels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># print(dels)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">dels</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;_del&#39;</span>
        <span class="c1"># print(st.nznucl)</span>
        
        <span class="k">return</span> <span class="n">st</span></div>






<div class="viewcode-block" id="Structure.replace_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.replace_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">replace_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms_to_replace</span><span class="p">,</span> <span class="n">el_new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        atoms_to_replace - list of atom numbers starting from 0</span>
<span class="sd">        el_new - new element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">))</span>


        <span class="n">atom_exsist</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="n">atom_exsist</span><span class="p">:</span>


            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>  <span class="nb">zip</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())</span> <span class="p">):</span>
                <span class="c1"># print(i)</span>

                <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">atoms_to_replace</span><span class="p">:</span>
                    <span class="n">xcart</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;replace_atoms(): atom&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;replaced with&#39;</span><span class="p">,</span> <span class="n">el_new</span><span class="p">)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">del_atom</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">([</span><span class="n">xcart</span><span class="p">],</span> <span class="n">element</span> <span class="o">=</span> <span class="n">el_new</span><span class="p">)</span>
                    <span class="c1"># print(st.natom)</span>
                    <span class="c1"># print(st.get_elements())</span>

                    <span class="c1"># print(st.natom)</span>

                    <span class="c1"># print(st.get_elements())</span>
                    <span class="k">del</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_exsist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># printlog(&#39;remove_atoms(): Atoms&#39;, atoms_to_remove, &#39;were removed&#39;)</span>

        <span class="c1"># print(st.get_elements())</span>
        <span class="k">return</span> <span class="n">st</span></div>





<div class="viewcode-block" id="Structure.remove_part"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.remove_part">[docs]</a>    <span class="k">def</span> <span class="nf">remove_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">new_conc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        element to remove</span>
<span class="sd">        new_conc &lt;1 - new concentration of element atoms (part of unity)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


        <span class="n">numb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_numbers</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="n">nat_el</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span><span class="o">*</span><span class="n">new_conc</span><span class="p">)))</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;New number of &#39;</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;atoms is &#39;</span><span class="p">,</span> <span class="n">nat_el</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

        <span class="n">del_num</span> <span class="o">=</span> <span class="n">numb</span><span class="p">[</span><span class="n">nat_el</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">numb</span><span class="p">)]</span>



        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">del_num</span><span class="p">)</span></div>




<div class="viewcode-block" id="Structure.add_vacuum"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.add_vacuum">[docs]</a>    <span class="k">def</span> <span class="nf">add_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">thick</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be improved</span>
<span class="sd">        vector - along which vector, 0, 1, 2</span>
<span class="sd">        thick - thickness of vector </span>


<span class="sd">        TODO:</span>
<span class="sd">        make thick to be thickness along axis and not vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">vec</span><span class="p">]</span>
        <span class="n">v_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="n">v_l</span><span class="o">+</span><span class="n">thick</span>

        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">vec</span><span class="p">]</span><span class="o">*=</span><span class="n">new_len</span><span class="o">/</span><span class="n">v_l</span>

        <span class="n">st</span><span class="o">.</span><span class="n">update_xred</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;_vac&#39;</span>
        <span class="c1"># st.write_xyz()</span>
        <span class="k">return</span> <span class="n">st</span></div>





    <span class="c1"># def sum_of_coord(self):</span>
    <span class="c1">#     sumx = 0</span>
    <span class="c1">#     for x in self.xcart:</span>
    <span class="c1">#         sumx+=x</span>
    <span class="c1">#     sumx/=len(self.xcart)</span>
    <span class="c1">#     return sumx</span>

<div class="viewcode-block" id="Structure.return_atoms_to_cell"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.return_atoms_to_cell">[docs]</a>    <span class="k">def</span> <span class="nf">return_atoms_to_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1">#shift - shift from the end of vectors between 0 and 1 - allows to collect atoms close to origin</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bob</span> <span class="o">=</span> <span class="mi">0</span><span class="o">-</span><span class="n">shift</span><span class="p">;</span> <span class="n">upb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">shift</span><span class="p">;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="c1"># print st.xred</span>
        <span class="k">for</span> <span class="n">xr</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="n">bob</span><span class="p">:</span>  
                    <span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">#allows to account that xr can be more than 2</span>
                <span class="k">if</span> <span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="o">&gt;=</span> <span class="n">upb</span><span class="p">:</span>  
                    <span class="c1"># print(xr[j], int(xr[j]))</span>
                    <span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> 
        <span class="c1"># n+=1</span>
        <span class="c1"># zmin = 100</span>
        <span class="c1"># for xr in st.xred:</span>
        <span class="c1">#     if xr[2]&lt;zmin: zmin = xr[2]</span>
        <span class="c1"># if zmin &lt; 0:</span>
        <span class="c1">#     for xr in st.xred:</span>
        <span class="c1">#         xr[2] = xr[2]-zmin</span>



        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

        <span class="c1"># print_and_log(str(n)+&quot; atoms were returned to cell.\n&quot;)</span>
        <span class="c1">#print st.xred</span>
        <span class="k">return</span> <span class="n">st</span></div>



<div class="viewcode-block" id="Structure.find_atom_num_by_xcart"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.find_atom_num_by_xcart">[docs]</a>    <span class="k">def</span> <span class="nf">find_atom_num_by_xcart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_tar</span><span class="p">,</span> <span class="n">prec</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;take into account periodic conditions</span>

<span class="sd">        TODO:</span>
<span class="sd">        make normal function that treats periodic boundary conditions normally!!!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">[</span><span class="n">xr_tar</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">([</span><span class="n">x_tar</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;find_atom_num_by_xcart(): xr_tar = &#39;</span><span class="p">,</span> <span class="n">xr_tar</span><span class="p">)</span>
        <span class="c1">#PBC!!!</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">xr_tar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xr_tar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span> <span class="mi">1</span>
                
            <span class="k">if</span> <span class="n">xr_tar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xr_tar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-=</span> <span class="mi">1</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;find_atom_num_by_xcart(): xr_tar after periodic = &#39;</span><span class="p">,</span> <span class="n">xr_tar</span><span class="p">)</span>

        <span class="c1"># print(xr_tar)</span>
        <span class="p">[</span><span class="n">x_tar</span><span class="p">]</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">([</span><span class="n">xr_tar</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
        
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;find_atom_num_by_xcart(): x_tar after periodic = &#39;</span><span class="p">,</span> <span class="n">x_tar</span><span class="p">)</span>

        <span class="c1"># print(x_tar)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_atoms_to_cell</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x_tar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">prec</span><span class="p">:</span>
            <span class="c1"># if all(x == x_tar):</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;corresponds to&#39;</span><span class="p">,</span> <span class="n">x_tar</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention, atom &#39;</span><span class="p">,</span> <span class="n">x_tar</span><span class="p">,</span> <span class="s1">&#39;was not found&#39;</span> <span class="p">)</span></div>
        <span class="c1"># print self.xcart.index(x_tar)</span>
        <span class="c1"># return self.xcart.index(x_tar)</span>


        <span class="c1"># print type(atoms_xcart)</span>



<div class="viewcode-block" id="Structure.shift_atoms"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.shift_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">shift_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_red</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shift all atoms according to *vector_red*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vector_red</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xr</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">:</span>
            <span class="n">xr</span><span class="o">+=</span><span class="n">vec</span>

        <span class="n">st</span><span class="o">.</span><span class="n">xred2xcart</span><span class="p">()</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">return_atoms_to_cell</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">st</span></div>



<div class="viewcode-block" id="Structure.replic"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.replic">[docs]</a>    <span class="k">def</span> <span class="nf">replic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">replic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Structure.image_distance"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.image_distance">[docs]</a>    <span class="k">def</span> <span class="nf">image_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">image_distance</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="Structure.remove_close_lying"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.remove_close_lying">[docs]</a>    <span class="k">def</span> <span class="nf">remove_close_lying</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_both</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rm_first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        rm_both (bool) - if True than remove both atoms, if False than only the second atom is removed</span>
<span class="sd">        rm_first (bool) - if True than the first atom of two overlapping is removed, otherwise the second atom is removed</span>

<span class="sd">        PBC is realized through image_distance</span>

<span class="sd">        SIDE:</span>
<span class="sd">            write _removed field to returned st</span>

<span class="sd">        TODO:</span>
<span class="sd">            Works incorrectly for more than one overlap !!!</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">x1_del</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x2_del</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">))[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># print(i,j)</span>
                <span class="c1"># if all(x1 == x2):</span>
                <span class="c1">#     continue</span>
                <span class="c1"># if all(x1 == x1_del) or (x2 == x2_del):</span>
                <span class="c1">#     continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_distance</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span> <span class="c1"># for detecting multiple overlaps please make this function more universal - removing not by numbers, but by coordinates or more intelligent- see remove_atoms()</span>
                    <span class="n">x1_del</span> <span class="o">=</span> <span class="n">x1</span>
                    <span class="n">x2_del</span> <span class="o">=</span> <span class="n">x2</span>
                    <span class="k">if</span> <span class="n">rm_both</span><span class="p">:</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;remove_close_lying(): Atoms&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;of types &#39;</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;are removed&#39;</span><span class="p">)</span>

                        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;remove_close_lying(): Atom&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s1">&#39;of type &#39;</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;is removed&#39;</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">rm_first</span><span class="p">:</span>
                            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">([</span><span class="n">i</span><span class="p">])</span> <span class="c1"># the existing atom is removed</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">([</span><span class="n">j</span><span class="p">])</span> <span class="c1"># the added atom is removed</span>
                        
                        <span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">st</span><span class="o">.</span><span class="n">_removed</span> <span class="o">=</span> <span class="n">removed</span>

        <span class="k">return</span> <span class="n">st</span><span class="p">,</span> <span class="n">x1_del</span><span class="p">,</span> <span class="n">x2_del</span></div>

<div class="viewcode-block" id="Structure.nn"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.nn">[docs]</a>    <span class="k">def</span> <span class="nf">nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ndict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">only</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">more_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        show neigbours</span>
<span class="sd">        i - number of central atom, from 1 or 0 (from_one = True or False)</span>
<span class="sd">        ndict (dic) - number of specific neigbour atoms</span>
<span class="sd">        only - list of interesting z neighbours</span>

<span class="sd">        more_info - return more output - takes time</span>

<span class="sd">        out</span>
<span class="sd">            &#39;numbers&#39; from 0 in the new version!!!!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">itertools</span>
        <span class="kn">from</span> <span class="nn">siman.functions</span> <span class="k">import</span> <span class="n">invert</span>
        <span class="k">if</span> <span class="n">from_one</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">zn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">znucl</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">out_or</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;atoms&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="n">only</span><span class="p">)</span>
        <span class="c1"># out =  (xcart_local, typat_local, numbers, dlist )</span>

        <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_or</span><span class="p">)</span>
        <span class="c1"># out[0] = list(itertools.chain.from_iterable(out[0]))</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">invert</span><span class="p">(</span><span class="n">zn</span><span class="p">[</span><span class="n">o</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="n">out_tab</span> <span class="o">=</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

        <span class="n">tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out_tab</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

 
        <span class="c1"># df = pd.DataFrame(tab)</span>
        <span class="c1"># print(df)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Neighbors around atom&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nn&#39;</span><span class="p">,</span> <span class="s1">&#39;No.&#39;</span><span class="p">,</span> <span class="s1">&#39;El&#39;</span><span class="p">,</span> <span class="s1">&#39;Dist, A&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;psql&#39;</span><span class="p">,</span> <span class="n">floatfmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">)</span> <span class="p">)</span>


        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_or</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


        <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;el&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">out_or</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;av(A-O,F)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;av&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span> <span class="n">round_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">more_info</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;avsq(A-O,F)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;avsq&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;avdev(A-O,F)&#39;</span><span class="p">],</span> <span class="n">_</span>   <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;av_dev&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;sum(A-O,F)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>

        <span class="n">t</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">out_or</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">))</span> 
        <span class="n">d</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> 
        <span class="c1"># d = d.remove(i)</span>
        <span class="c1"># print(t)</span>
        <span class="c1"># print(i)</span>
        <span class="c1"># print(d)</span>
        <span class="n">st_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">st_left</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;_loc&#39;</span>
        <span class="c1"># sys.exit()</span>
        <span class="n">st_left</span><span class="o">.</span><span class="n">dlist</span> <span class="o">=</span> <span class="n">out_or</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># distances to neighbours</span>
        <span class="n">st_left</span><span class="o">.</span><span class="n">ellist</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;el&#39;</span><span class="p">]</span> <span class="c1"># types of neighbours</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_left</span>

        <span class="k">if</span> <span class="n">ndict</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;av(A-O)&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ndict</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;av&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;avdev(A-O)&#39;</span><span class="p">],</span> <span class="n">_</span>   <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ndict</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;av_dev&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;min(A-O)&#39;</span><span class="p">],</span> <span class="n">_</span> <span class="p">,</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;max(A-O)&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ndict</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;mavm&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ndict</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;atoms&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;Onumbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># exclude first, because itself!</span>
            <span class="c1"># print(info[&#39;Onumbers&#39;])</span>

        <span class="c1"># print(info)</span>

        <span class="k">return</span> <span class="n">info</span></div>


<div class="viewcode-block" id="Structure.center"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#return cartesian center of the cell</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span></div>

<div class="viewcode-block" id="Structure.center_on"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.center_on">[docs]</a>    <span class="k">def</span> <span class="nf">center_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="c1">#calc vector which alows to make particular atom in the center </span>
        <span class="n">x_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span>
        <span class="c1"># print(center)</span>
        <span class="c1"># sys.exit()</span>
        <span class="c1"># print(x_r)</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">x_r</span>
        <span class="c1"># print(dv)</span>
        <span class="c1"># print(dv+x_r)</span>
        <span class="k">return</span> <span class="n">dv</span></div>


<div class="viewcode-block" id="Structure.write_poscar"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.write_poscar">[docs]</a>    <span class="k">def</span> <span class="nf">write_poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coord_type</span> <span class="o">=</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="n">vasp5</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">charges</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">selective_dynamics</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        write </span>

<span class="sd">        charges (bool) - write charges, self.charges should be available</span>
<span class="sd">        energy - write total energy</span>

<span class="sd">        selective dynamics - </span>
<span class="sd">            if at least one F is found than automatically switched on</span>
<span class="sd">            !works only for coord_type = &#39;dir&#39; and charges = False</span>

<span class="sd">        NOTE</span>
<span class="sd">        #void element type is not written to POSCAR</span>

<span class="sd">        TODO</span>
<span class="sd">            selective_dynamics for coord_type = &#39;cart&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">b2s</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="c1">#bool to vasp str</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>

            <span class="k">return</span> <span class="n">s</span>


        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">([</span><span class="s1">&#39;void&#39;</span><span class="p">])</span> <span class="c1"># remove voids</span>
 
        <span class="n">to_ang</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rprimd</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span>
        <span class="n">xred</span>   <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span>
        <span class="n">xcart</span>  <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span>
        <span class="n">typat</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span>  
        <span class="n">znucl</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span>
        <span class="n">els</span>   <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>


        <span class="c1"># print(st.convert2pymatgen())</span>

        <span class="c1"># print()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selective_all</span><span class="p">()</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span>

        <span class="c1"># print(select)</span>

        <span class="k">if</span> <span class="n">selective_dynamics</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">selective_dynamics</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">check_selective</span><span class="p">()</span>

        <span class="c1"># print(selective_dynamics)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xyz/POSCAR_&#39;</span><span class="o">+</span><span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="n">makedir</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Starting writing POSCAR&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;Vasp5:&#39;</span><span class="p">,</span> <span class="n">vasp5</span><span class="p">)</span>

        <span class="c1"># print </span>
        <span class="sd">&quot;&quot;&quot;1. Generate correct nznucl and zxred and zxcart&quot;&quot;&quot;</span>
        <span class="n">zxred</span>  <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">zxcart</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">zchar</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">zelem</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">zselect</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">zmagmom</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span> <span class="c1"># not used for the moment</span>
        <span class="n">ziatom</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">iatom</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span>
        <span class="c1"># nznucl = []</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">typat</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xred</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xred</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xcart</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        

        <span class="c1"># print(xred)</span>
        <span class="c1"># print(typat)</span>

        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">typat</span><span class="p">,</span> <span class="n">xred</span><span class="p">,</span> <span class="n">xcart</span><span class="p">,</span> <span class="n">els</span><span class="p">,</span> <span class="n">iatom</span> <span class="p">):</span>
            <span class="c1"># print (&quot;t &quot;, t-1, xr)</span>
            <span class="n">zxred</span><span class="p">[</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
            <span class="n">zxcart</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
            <span class="n">zelem</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="n">ziatom</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">selective_dynamics</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">typat</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
                <span class="n">zselect</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># print(zselect)</span>
        <span class="c1"># print(zxred)</span>


        <span class="c1"># print(charges)</span>
        <span class="k">if</span> <span class="n">charges</span><span class="p">:</span>
            <span class="n">charg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charges</span>

            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">typat</span><span class="p">,</span> <span class="n">charg</span><span class="p">):</span>
                <span class="n">zchar</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span> <span class="c1"># if needed put it here</span>

        <span class="n">poscar_atom_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="n">ziatom</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iatom</span><span class="p">:</span>
                <span class="n">poscar_atom_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">poscar_atom_order</span> <span class="o">=</span> <span class="n">poscar_atom_order</span>

        <span class="n">nznucl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">xred</span><span class="p">)</span> <span class="k">for</span> <span class="n">xred</span> <span class="ow">in</span> <span class="n">zxred</span><span class="p">]</span>
        <span class="c1"># print(nznucl)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">elnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">element_name_inv</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>



        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Writes structure (POSCAR) in VASP format &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">energy</span><span class="p">:</span>
                <span class="n">energy_string</span> <span class="o">=</span> <span class="s1">&#39;e0=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">energy_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;i2a=[&#39;</span><span class="o">+</span><span class="n">list2string</span><span class="p">(</span><span class="n">elnames</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] ; &#39;</span><span class="o">+</span><span class="n">energy_string</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;tmap&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tmap=[</span><span class="si">{:s}</span><span class="s1">] ; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">list2string</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">tmap</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">))</span>


            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{:18.15f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:10.6f}</span><span class="s1"> </span><span class="si">{:10.6f}</span><span class="s1"> </span><span class="si">{:10.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">vasp5</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elnames</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nznucl</span><span class="p">:</span>    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="c1"># print(str(n)+&#39; &#39;)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">selective_dynamics</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Selective dynamics</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



            <span class="k">if</span> <span class="s2">&quot;car&quot;</span> <span class="ow">in</span> <span class="n">coord_type</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! may be obsolete!!! and incorrect&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cartesian</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xcart</span> <span class="ow">in</span> <span class="n">zxcart</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xcart</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">):</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;I write to POSCAR velocity as well&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cartesian</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">vel</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;  </span><span class="si">{:18.16f}</span><span class="s1">  </span><span class="si">{:18.16f}</span><span class="s1">  </span><span class="si">{:18.16f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">elif</span> <span class="s2">&quot;dir&quot;</span> <span class="ow">in</span> <span class="n">coord_type</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Direct</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">charges</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">xred</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zxred</span><span class="p">,</span> <span class="n">zelem</span><span class="p">,</span> <span class="n">zchar</span><span class="p">,</span> <span class="p">):</span>
                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xred</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{:12.10f}</span><span class="s2">  </span><span class="si">{:12.10f}</span><span class="s2">  </span><span class="si">{:12.10f}</span><span class="s2">  </span><span class="si">{:2s}</span><span class="s2">  </span><span class="si">{:6.3f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">el</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">selective_dynamics</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">xred</span><span class="p">,</span> <span class="n">select</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zxred</span><span class="p">,</span> <span class="n">zselect</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xred</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
                            <span class="c1"># print(x,s)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{:19.16f}</span><span class="s2">  </span><span class="si">{:19.16f}</span><span class="s2">  </span><span class="si">{:19.16f}</span><span class="s2">  </span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b2s</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">b2s</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">b2s</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">xred</span>  <span class="ow">in</span> <span class="n">zxred</span> <span class="p">:</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xred</span> <span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{:19.16f}</span><span class="s2">  </span><span class="si">{:19.16f}</span><span class="s2">  </span><span class="si">{:19.16f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            


            <span class="k">elif</span> <span class="s1">&#39;None&#39;</span> <span class="ow">in</span> <span class="n">coord_type</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! The type of coordinates should be &#39;car&#39; or &#39;dir&#39; &quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NameError</span>
        

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filename</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;POSCAR was written to&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>



<div class="viewcode-block" id="Structure.write_cif"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.write_cif">[docs]</a>    <span class="k">def</span> <span class="nf">write_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mcif</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">write_prim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find primitive cell and write it in cif format</span>
<span class="sd">        </span>

<span class="sd">        mcif (bool) - if True, than write mcif file with magnetic moments included, primitive cell is not supported</span>


<span class="sd">        </span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">mcif</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/cif/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>


        <span class="n">makedir</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">st_mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>

        <span class="c1"># print(st_mp)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sg_before</span> <span class="o">=</span>  <span class="n">st_mp</span><span class="o">.</span><span class="n">get_space_group_info</span><span class="p">()</span> 


            <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">st_mp</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="n">symprec</span><span class="p">)</span>

            <span class="n">st_mp_prim</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">find_primitive</span><span class="p">()</span>

            <span class="n">sg_after</span> <span class="o">=</span> <span class="n">st_mp_prim</span><span class="o">.</span><span class="n">get_space_group_info</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">sg_before</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">sg_after</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">st_mp_prim</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! could not analyze space group&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sg_before</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sg_after</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! the space group was changed after primitive cell searching&#39;</span><span class="p">,</span> <span class="n">sg_before</span><span class="p">,</span> <span class="n">sg_after</span><span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;I will save supercell in cif Pay attention that CifWriter can symmetrize and change vectors. Also use *write_prim*&#39;</span><span class="p">)</span>
            <span class="c1"># st_mp_prim = st_mp</span>
            <span class="c1"># symprec = 0.001</span>
            <span class="c1"># symprec = None</span>

        <span class="k">if</span> <span class="n">mcif</span><span class="p">:</span>
            <span class="n">cif</span> <span class="o">=</span> <span class="n">CifWriter</span><span class="p">(</span><span class="n">st_mp</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="n">symprec</span><span class="p">,</span> <span class="n">write_magmoms</span><span class="o">=</span><span class="n">mcif</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">st_mp_prim</span><span class="p">:</span>
                <span class="n">cif_prim</span> <span class="o">=</span> <span class="n">CifWriter</span><span class="p">(</span><span class="n">st_mp_prim</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="n">symprec</span><span class="p">,</span> <span class="p">)</span>
            
            <span class="n">cif</span> <span class="o">=</span> <span class="n">CifWriter</span><span class="p">(</span><span class="n">st_mp</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="n">symprec</span><span class="p">,</span> <span class="p">)</span>

        
        <span class="n">cif_name</span> <span class="o">=</span>  <span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="s1">&#39;cif&#39;</span>
        <span class="n">cif_prim_name</span> <span class="o">=</span>  <span class="n">filename</span><span class="o">+</span><span class="s1">&#39;_prim.&#39;</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="s1">&#39;cif&#39;</span>
        

        <span class="n">cif</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span> <span class="n">cif_name</span>  <span class="p">)</span>
        <span class="k">if</span> <span class="n">write_prim</span><span class="p">:</span>
            <span class="n">cif_prim</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span> <span class="n">cif_prim_name</span>  <span class="p">)</span>
        
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Writing cif&#39;</span><span class="p">,</span> <span class="n">cif_name</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cif_name</span></div>

<div class="viewcode-block" id="Structure.write_xyz"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.write_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">write_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#see description for write_xyz()</span>
        <span class="k">return</span> <span class="n">write_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="Structure.write_lammps"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.write_lammps">[docs]</a>    <span class="k">def</span> <span class="nf">write_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">write_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Structure.read_xyz"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.read_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">read_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="c1"># print(self.perm)</span>
        <span class="k">return</span> <span class="n">read_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Structure.jmol"><a class="viewcode-back" href="../../siman.html#siman.classes.Structure.jmol">[docs]</a>    <span class="k">def</span> <span class="nf">jmol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># self.write_poscar(&#39;CONTCAR&#39;, vasp5 = 1)</span>
        <span class="c1">#if r == 1 then open outcar</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">shift_atoms</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>


        <span class="c1"># filename, _ = st.write_xyz()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">outfile</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">(</span><span class="n">vasp5</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># print(r, filename)</span>
        <span class="c1"># sys.exit()</span>
        <span class="n">runBash</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">PATH2JMOL</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="n">detached</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span></div></div>

<div class="viewcode-block" id="Calculation"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation">[docs]</a><span class="k">class</span> <span class="nc">Calculation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main class of siman. Objects of this class contain all information about first-principles calculation</span>
<span class="sd">        List of important fields:</span>
<span class="sd">            - init (Structure)</span>
<span class="sd">            - end  (Structure)</span>
<span class="sd">            - occ_matrices (dict) - occupation matrices, number of atom (starting from 0) is used as key</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">iid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#super(CalculationAbinit, self).__init__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;noname&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inset</span><span class="p">)</span>
        
        <span class="c1"># if self.set.set_sequence:</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;0.Initialized&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;input&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;input_geo&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;potential&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span><span class="n">output</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of previous calculations</span>
        <span class="k">if</span> <span class="n">iid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">iid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    
<div class="viewcode-block" id="Calculation.get_path"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.get_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="Calculation.read_geometry"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.read_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">read_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads geometrical data from filename file in abinit format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>



        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1">#For large files can be time consuming</span>
            <span class="n">memfile</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">gen_words</span> <span class="o">=</span> <span class="n">memfile</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>  
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">memfile</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;des&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                    <span class="c1"># print line; </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;des &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;;&#39;</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">build</span> <span class="o">=</span> <span class="n">empty_struct</span><span class="p">()</span>                
                <span class="k">if</span> <span class="s1">&#39;BEGIN BUILD INFORMATION&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;File contain build information! Start to read&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
                    <span class="c1"># self.build = Structure()</span>
                    <span class="c1"># # self.build.rprimd = None</span>
                    <span class="c1"># # self.build.xred = None</span>
                    <span class="c1"># # self.build.xcart = None</span>
                    <span class="c1"># # self.build.des = None</span>
                    <span class="c1"># # self.build.name = None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">calctype</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;calctype&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">a_c_conv</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;a_c_conv&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_natom</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_natom&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_acell</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;build_acell&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_rprim</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;build_rprim&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_xred</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;build_xred&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_ntypat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_ntypat&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_typat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_typat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_natom</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_znucl</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_znucl&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_ntypat</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">hkl1</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;hkl1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">uvw1</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;uvw1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">uvw2</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;uvw2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">uvw3</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;uvw3&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">mul</span>  <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nadded</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;nadded&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#total number of added atoms after building structure</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">listadded</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;listadded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nadded</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span> <span class="c1">#list of added atoms corresponding to xred </span>

                    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Build information has been read&quot;</span><span class="p">)</span>




            <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>

            <span class="c1">#sys.exit()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useable</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#Read total number of atoms</span>
<span class="c1">#             #Programm nznucl, since We will have more impurity atoms of different types</span>
<span class="c1">#             command=&quot;&quot;&quot;grep -w -m 1 &quot;natom &quot; &quot;&quot;&quot;+filename</span>
<span class="c1">#             s1=runBash(command)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;natom&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># print command</span>
            <span class="c1"># print s1</span>
<span class="c1">#             self.natom_str = s1</span>
<span class="c1">#             if s1==&#39;&#39;:</span>
<span class="c1">#                 self.natom = 0</span>
<span class="c1">#                 print_and_log( &quot;&quot;&quot;Warning! In filename &quot;&quot;&quot;+filename+&quot;&quot;&quot; not found natom! set to zero.</span>
<span class="c1">#                 It is very likely that other parameters was not </span>
<span class="c1">#                 found too, Calculation completely unusable!!!&quot;&quot;&quot;)</span>
<span class="c1">#                 raise RuntimeError</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.natom=int(s1.split()[1]) </span>

            <span class="bp">self</span><span class="o">.</span><span class="n">acell</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;acell&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rprim</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;rprim&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprim</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">acell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>         <span class="c1">#Calculate rprimd</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">);</span> <span class="c1">#volume</span>
                      
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="n">calc_recip_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span> <span class="c1">#Determine reciprocal vectors</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;ntypat&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;typat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error; 0 in typat is not allowed&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;znucl&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;xcart&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;xred&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="c1">#print self.xred</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Convert xcart to xred&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Convert xred to xcart&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;hex_a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;hex_c&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;len_units&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;gbpos&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>



            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.init&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">znucl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> 



            <span class="n">vel</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="c1"># print vel</span>
            <span class="k">if</span> <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span>

            <span class="c1">#read magnetic states; name of vasp variable</span>
            <span class="n">curset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">curset</span><span class="p">,</span> <span class="s1">&#39;magnetic_moments&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">curset</span><span class="o">.</span><span class="n">magnetic_moments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;magmom&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="c1"># self.init.mag_moments </span>







            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;1.Geometry has been read&quot;</span>



        <span class="c1">#file.close();</span>

        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;If no warnings, geometry has been succesfully read from file &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>





<div class="viewcode-block" id="Calculation.write_geometry"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.write_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geotype</span> <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes geometrical data in custom siman format bases on abinit format to self.path[&quot;input_geo&quot;]&quot;&quot;&quot;</span>
        <span class="n">geo_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">geofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span>
        <span class="n">geo_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">geofile</span><span class="p">)</span>
        <span class="c1"># print (os.path.exists(geofile))</span>
        <span class="k">if</span> <span class="n">geo_exists</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! File &quot;</span><span class="o">+</span><span class="n">geofile</span><span class="o">+</span><span class="s2">&quot; was replaced&quot;</span><span class="p">);</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! File &quot;</span><span class="o">+</span><span class="n">geofile</span><span class="o">+</span><span class="s2">&quot; exists. To replace it set parameter override&quot;</span><span class="p">);</span> 
                <span class="k">return</span> <span class="kc">False</span>
                <span class="c1">#raise RuntimeError</span>
        <span class="c1"># print &quot;geofile name, classes:&quot;,  geofile</span>
        <span class="c1"># print &quot;folder :&quot;,  os.path.dirname(geofile)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geofile</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geofile</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">geotype</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="c1">#write initial structure</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="k">elif</span> <span class="n">geotype</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
            <span class="c1"># if not hasattr(st, &#39;natom&#39;):  st.natom = self.init.natom</span>
            <span class="c1"># if not hasattr(st, &#39;ntypat&#39;): st.ntypat = self.init.ntypat</span>
            <span class="c1"># if not hasattr(st, &#39;typat&#39;): st.typat = self.init.typat</span>
            <span class="c1"># if not hasattr(st, &#39;znucl&#39;): st.znucl = self.init.znucl </span>
        <span class="k">else</span><span class="p">:</span> <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! Unknown geotype </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> <span class="k">raise</span> <span class="ne">RuntimeError</span>                                  

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">max</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span> 
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! write_geometry: check your arrays.&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># print (st.magmom)</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">],</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;des &quot;</span><span class="o">+</span><span class="n">description</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;len_units &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">len_units</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;hex_a&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hex_a &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">hex_a</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;hex_c&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hex_c &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">hex_c</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># try: self.gbpos</span>
            <span class="c1"># except AttributeError:</span>
            <span class="c1">#     self.gbpos = None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;gbpos&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;gbpos &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">gbpos</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;version &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">st</span><span class="o">.</span><span class="n">magmom</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="c1"># print st.magmom </span>
            <span class="c1"># sys.exit()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;magmom &quot;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;acell 1 1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;natom  &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ntypat &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;znucl  &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">typat  &quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="p">);</span> <span class="n">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">rprim  &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;xred  &quot;</span><span class="p">)</span>
            <span class="c1">#print st.xred</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">:</span> <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! write_geometry(): xred is empty or overfull</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span><span class="k">raise</span> <span class="ne">RuntimeError</span> 
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;xcart  &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">:</span> 
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! write_geometry(): xcart is empty or overfull, I make it from xred</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span><span class="c1">#raise RuntimeError</span>
                <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span>


            <span class="c1">#Write build information</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">#BEGIN BUILD INFORMATION!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1">#print self.build.__dict__</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">val</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="c1">#print temp</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">temp</span> <span class="p">))</span>  <span class="c1"># iterable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>  <span class="p">)</span>                    <span class="c1"># not iterable</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#END BUILD INFORMATION!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Calculation.write_siman_geo"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.write_siman_geo">[docs]</a>    <span class="k">def</span> <span class="nf">write_siman_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Please rename write_geometry() to write_abinit_geo() everywhere and transfer the code here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculation.serialize"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save as pickle object, return path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.pickle&#39;</span>
        <span class="n">makedir</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file</span></div>

<div class="viewcode-block" id="Calculation.deserialize"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.deserialize">[docs]</a>    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        
        <span class="c1"># import chardet  </span>
        <span class="c1"># with open(filename, &#39;rb&#39;) as f:</span>
        <span class="c1">#     result = chardet.detect(f.read(10000))  </span>
        <span class="c1"># print(result)</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">)</span>
        <span class="c1"># printlog(&#39;Calculation object succesfully read from &#39;, filename)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Calculation.get_kpoints_density"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.get_kpoints_density">[docs]</a>    <span class="k">def</span> <span class="nf">get_kpoints_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of k-points per atom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NKPTS</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span> <span class="c1">#KPPRA - k-points per reciprocal atom? </span></div>




<div class="viewcode-block" id="Calculation.copy"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculation.jmol"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.jmol">[docs]</a>    <span class="k">def</span> <span class="nf">jmol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">jmol</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="Calculation.poscar"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.poscar">[docs]</a>    <span class="k">def</span> <span class="nf">poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">()</span></div>
<div class="viewcode-block" id="Calculation.me"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.me">[docs]</a>    <span class="k">def</span> <span class="nf">me</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">printme</span><span class="p">()</span></div>

<div class="viewcode-block" id="Calculation.add_new_name"><a class="viewcode-back" href="../../siman.html#siman.classes.Calculation.add_new_name">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        just adding new key in database for that calculation</span>
<span class="sd">        warning cl.id is updated; old name in db remains</span>
<span class="sd">        the calculation folder remains the same</span>
<span class="sd">        </span>
<span class="sd">        idd - key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idd</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! &#39;</span><span class="p">,</span><span class="n">idd</span><span class="p">,</span><span class="s1">&#39;already used in database! Choose another name&#39;</span><span class="p">)</span>
            
        <span class="n">header</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="n">idd</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sfolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span></div>




<div class="viewcode-block" id="CalculationAbinit"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationAbinit">[docs]</a><span class="k">class</span> <span class="nc">CalculationAbinit</span><span class="p">(</span><span class="n">Calculation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;docstring for CalculationAbinit&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>








<div class="viewcode-block" id="CalculationVasp"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp">[docs]</a><span class="k">class</span> <span class="nc">CalculationVasp</span><span class="p">(</span><span class="n">Calculation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods for calculations made using VASP DFT code&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">iid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CalculationVasp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inset</span><span class="p">,</span> <span class="n">iid</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span> <span class="o">=</span> <span class="s1">&#39;Angstrom&#39;</span>



<div class="viewcode-block" id="CalculationVasp.read_poscar"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.read_poscar">[docs]</a>    <span class="k">def</span> <span class="nf">read_poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read POSCAR file using st.read_poscar </span>
<span class="sd">        </span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;poscar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1">#Determine version</span>
        <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Trying to find version at the end of filename POSCAR-v ...&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Trying to find version at the begenning of filename v.POSCAR...&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
               
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;No version, using 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">ver</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ver</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">read_poscar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">des</span>

        <span class="k">return</span></div>
    

<div class="viewcode-block" id="CalculationVasp.check_kpoints"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.check_kpoints">[docs]</a>    <span class="k">def</span> <span class="nf">check_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The method updates init.ngkpt and ngkpt_dict_for_kspacings !!! as well provides possible options for it</span>
<span class="sd">        TODO probably the method should transfered to Structure?</span>
<span class="sd">        Attention: the order should be the same as in make_kpoints_file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
        <span class="c1"># to_ang_local = header.to_ang</span>
        <span class="n">to_ang_local</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># try:</span>
        <span class="c1">#     if &quot;Ang&quot; in self.len_units:</span>
        <span class="c1">#         to_ang_local = 1</span>
        <span class="c1">#         #print &quot;units angs&quot;</span>
        <span class="c1"># except AttributeError:</span>
        <span class="c1">#     print_and_log(&quot;Warning! no len_units for &quot;+self.name+&quot; calculation, I use Bohr \n&quot;) </span>
        
        <span class="n">N_from_kspacing</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="s1">&#39;ngkpt_dict_for_kspacings&#39;</span><span class="p">):</span> <span class="c1">#compatibiliy issues</span>
            <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">ngkpt_dict</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span>

        <span class="c1"># if self.set.kpoints_file  == False:#self.set.vasp_params[&#39;KSPACING&#39;]:</span>
        <span class="c1">#     N = N_from_kspacing</span>
        <span class="n">kspacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;KSPACING&#39;</span><span class="p">]</span>

        <span class="c1"># print (struct_des)</span>
        <span class="k">if</span> <span class="n">ngkpt</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">ngkpt</span>

        <span class="k">elif</span> <span class="n">kspacing</span> <span class="ow">in</span> <span class="n">ngkpt_dict</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">ngkpt_dict</span><span class="p">[</span><span class="n">kspacing</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;check_kpoints(): k-points will be used from *ngkpt_dict* of&#39;</span><span class="p">,</span><span class="n">it</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;check_kpoints(): k-points will be used from set.ngkpt of&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ise</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">kspacing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">get_recip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">N_from_kspacing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">to_ang_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">kspacing</span><span class="p">)</span> <span class="p">)</span>

            <span class="n">N</span> <span class="o">=</span> <span class="n">N_from_kspacing</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;check_kpoints(): k-points are determined from kspacing&#39;</span><span class="p">,</span><span class="n">kspacing</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;K-points file was provided&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(self.dir)</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! check_kpoints(): no information about k-points</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="n">N</span>

        <span class="k">if</span> <span class="n">kspacing</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kspacing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ngkpt_dict</span><span class="p">:</span>
            <span class="n">ngkpt_dict</span><span class="p">[</span><span class="n">kspacing</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;check_kpoints(): I added &#39;</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;as a k-grid for&#39;</span><span class="p">,</span><span class="n">kspacing</span><span class="p">,</span><span class="s1">&#39;in struct_des of&#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>


        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;check_kpoints(): Kpoint   mesh is: &quot;</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="s1">&#39;ngkpt_dict_for_kspacings&#39;</span><span class="p">)</span> <span class="ow">or</span>  <span class="n">kspacing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Several other options instead of automatically determined ngkpt = &#39;</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;ngkpt              |    actual kspacings       &#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span>
            

            <span class="k">for</span> <span class="n">ngkpt</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span>

            <span class="c1"># user_ngkpt = input(&#39;Provide ngkpt:&#39;)</span>
            <span class="c1"># print(user_ngkpt)</span>
            <span class="c1"># sys.exit()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;check_kpoints(): The actual k-spacings are &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">N_from_kspacing</span></div>


<div class="viewcode-block" id="CalculationVasp.write_structure"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.write_structure">[docs]</a>    <span class="k">def</span> <span class="nf">write_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_output_file</span><span class="p">,</span> <span class="n">type_of_coordinates</span> <span class="o">=</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prevcalcver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates POSCAR file</span>
<span class="sd">           type_of_coordinates - &#39;direct&#39; (xred) or &#39;cartesian&#39; (xcart)</span>
<span class="sd">           option -inheritance option</span>
<span class="sd">           prevcalcver - ver of first calc in calc list; for first None</span>
<span class="sd">           state - &#39;init&#39; or &#39;end&#39; </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#units</span>
        <span class="c1"># try:</span>
        <span class="c1">#     if &quot;ang&quot; in self.len_units or &quot;Ang&quot; in self.len_units: </span>
        <span class="c1">#         global to_ang; to_ang = 1.0; print_and_log(&quot;Conversion multiplier to_ang is &quot;+str(to_ang) )</span>
        <span class="c1"># except AttributeError:</span>
        <span class="c1">#     pass</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;inherit_xred&#39;</span> <span class="ow">and</span> <span class="s1">&#39;car&#39;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span> 

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;inherit_xred&#39;</span> <span class="ow">and</span> <span class="n">prevcalcver</span><span class="p">:</span> <span class="n">type_of_coordinates</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span> <span class="c1"># do not write xred or xcart if they will be transfered on cluster</span>
        
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">st</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
            <span class="n">st</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">RuntimeError</span> 
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name_of_output_file</span><span class="p">)</span>

        <span class="n">makedir</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">coord_type</span> <span class="o">=</span> <span class="n">type_of_coordinates</span><span class="p">)</span>



        <span class="k">return</span></div>



<div class="viewcode-block" id="CalculationVasp.add_potcar"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.add_potcar">[docs]</a>    <span class="k">def</span> <span class="nf">add_potcar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should be run for the first calculation only&quot;&quot;&quot;</span>
        <span class="c1">#Add POTCAR</span>

        <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;POTCAR&#39;</span><span class="p">)</span>
        <span class="n">potcar_files</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;path2pot&#39;</span> <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">path2pot</span><span class="p">:</span>
            <span class="n">path2pot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">path2pot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path2pot</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">PATH2POTENTIALS</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Potentials from &#39;</span><span class="p">,</span> <span class="n">path2pot</span><span class="p">,</span> <span class="s1">&#39;are taken&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">potdir</span><span class="p">:</span>
            <span class="c1"># print (self.set.potdir)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">300</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c1"># skip voids</span>
                <span class="n">potcar_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path2pot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">potdir</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="p">],</span> <span class="s1">&#39;POTCAR&#39;</span><span class="p">)</span> <span class="p">)</span>

            <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;POTCAR files:&quot;</span><span class="p">,</span> <span class="n">potcar_files</span><span class="p">)</span>        
            <span class="c1"># print(path_to_potcar)            </span>
            <span class="n">cat_files</span><span class="p">(</span><span class="n">potcar_files</span><span class="p">,</span> <span class="n">path_to_potcar</span><span class="p">)</span>

        


        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">path_to_potcar</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! set.path_to_potcar is used !&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">path_to_potcar</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">path_to_potcar</span><span class="p">,</span> <span class="n">path_to_potcar</span><span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;POTCAR was copied to&#39;</span><span class="p">,</span> <span class="n">path_to_potcar</span><span class="p">)</span>
            <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">path_to_potcar</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! set.potdir and set.path_to_potcar are empty; no POTCAR was not created!&#39;</span><span class="p">)</span>
            <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;potcar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_to_potcar</span>

        <span class="k">return</span> <span class="n">path_to_potcar</span></div>


<div class="viewcode-block" id="CalculationVasp.calculate_nbands"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.calculate_nbands">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_nbands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curset</span><span class="p">,</span> <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should be run after add_potcar()&quot;&quot;&quot;</span>
        <span class="c1">#1 add additional information to set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">curset</span><span class="p">:</span>
            <span class="n">curset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">curset</span><span class="o">.</span><span class="n">vasp_params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">([</span><span class="s1">&#39;void&#39;</span><span class="p">])</span> <span class="c1"># remove voids</span>

        <span class="k">if</span> <span class="n">path_to_potcar</span><span class="p">:</span>
            <span class="c1"># path_to_potcar = self.dir+&#39;/POTCAR&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># print path_to_potcar</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_potcar</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;ZVAL&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># print line</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]))</span>
            
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">curset</span><span class="o">.</span><span class="n">add_nbands</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
                <span class="n">curset</span><span class="o">.</span><span class="n">add_nbands</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">curset</span><span class="o">.</span><span class="n">add_nbands</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tve</span> <span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="p">):</span>
                    <span class="c1"># print self.init.zval</span>
                    <span class="n">tve</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1">#number of electrons </span>
                    <span class="c1"># print(self.init.zval[i], self.init.nznucl[i])</span>
                <span class="n">nbands_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tve</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span> <span class="nb">round</span> <span class="p">(</span> <span class="n">nbands_min</span> <span class="o">*</span> <span class="n">curset</span><span class="o">.</span><span class="n">add_nbands</span> <span class="p">)</span> <span class="p">)</span>
                <span class="c1"># print(self.nbands)</span>
                

                <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;I found that at least&#39;</span><span class="p">,</span> <span class="n">nbands_min</span><span class="p">,</span> <span class="s1">&#39; bands are required. I will use&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span><span class="p">,</span> <span class="s1">&#39;bands; add_nbands = &#39;</span><span class="p">,</span> <span class="n">curset</span><span class="o">.</span><span class="n">add_nbands</span><span class="p">)</span>





            <span class="k">if</span> <span class="s1">&#39;LSORBIT&#39;</span> <span class="ow">in</span> <span class="n">vp</span> <span class="ow">and</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;LSORBIT&#39;</span><span class="p">]:</span>
                <span class="c1"># print (vp)</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;SOC calculation detected; increasing number of bands by two&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">]</span><span class="o">*=</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! No path_to_potcar! skipping NBANDS calculation&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="CalculationVasp.actualize_set"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.actualize_set">[docs]</a>    <span class="k">def</span> <span class="nf">actualize_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes additional processing of set parameters, which also depends on calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1">#check if some parameters should be filled according to number of species</span>
        <span class="c1">#make element list</span>
        <span class="n">el_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">element_name_inv</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">curset</span><span class="p">:</span>
            <span class="n">curset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">curset</span><span class="o">.</span><span class="n">vasp_params</span>

        <span class="c1"># print([&#39;LDAU&#39;])</span>
        <span class="c1"># print(vp)</span>
        <span class="c1"># print(vp[&#39;LDAU&#39;])</span>

        <span class="k">if</span> <span class="s1">&#39;LDAU&#39;</span> <span class="ow">in</span> <span class="n">vp</span> <span class="ow">and</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;LDAU&#39;</span><span class="p">]:</span> 
            <span class="c1"># print(vp[&#39;LDAU&#39;])</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LDAUL&#39;</span><span class="p">,</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> <span class="s1">&#39;LDAUJ&#39;</span><span class="p">]:</span>
                <span class="c1"># print( vp[key])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">el_list</span><span class="p">)):</span> <span class="c1">#no common elements at all</span>
                        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">Attention! The &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; doesnt not contain values for your elements! Setting to zero</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="c1"># raise RuntimeError</span>

                    <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">el_list</span><span class="p">:</span>
                        
                        <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">el</span><span class="p">]</span>
                            
                            <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">el_list</span><span class="p">:</span>  <span class="c1"># use another value in the format of Fe/S</span>
                                <span class="n">kk</span> <span class="o">=</span> <span class="n">el</span><span class="o">+</span><span class="s1">&#39;/S&#39;</span> 
                                <span class="k">if</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span>
                    





                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;LDAUL&#39;</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span>  <span class="mi">0</span>

                        <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    
                    <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
                
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! LDAU* were not processed&#39;</span><span class="p">)</span>
                    <span class="k">pass</span>

        <span class="sd">&quot;&quot;&quot;Process magnetic moments&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span> <span class="ow">and</span> <span class="s1">&#39;afm_ordering&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>



        <span class="c1"># print(hasattr(self.init, &#39;magmom&#39;) and hasattr(self.init.magmom, &#39;__iter__&#39;) and not None in self.init.magmom)</span>
        <span class="c1"># print(self.init.magmom)</span>
        <span class="c1"># print(None in self.init.magmom)</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span>

            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;actualize_set(): Magnetic moments are determined from self.init.magmom:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">curset</span><span class="p">,</span> <span class="s1">&#39;magnetic_moments&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">curset</span><span class="o">.</span><span class="n">magnetic_moments</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;actualize_set(): Magnetic moments are determined using siman key &quot;magnetic_moments&quot; and corresponding dict in set&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;curset.magnetic_moments = &#39;</span><span class="p">,</span> <span class="n">curset</span><span class="o">.</span><span class="n">magnetic_moments</span><span class="p">)</span>
            
            <span class="n">mag_mom_other</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="c1"># magnetic moment for all other elements</span>
            <span class="n">magmom</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">el</span>  <span class="o">=</span> <span class="n">el_list</span><span class="p">[</span><span class="n">typ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">curset</span><span class="o">.</span><span class="n">magnetic_moments</span><span class="p">:</span>
                    <span class="n">magmom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curset</span><span class="o">.</span><span class="n">magnetic_moments</span><span class="p">[</span><span class="n">el</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">magmom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag_mom_other</span><span class="p">)</span>
            

            <span class="c1">#convert magmom to vasp ordering</span>

            <span class="n">zmagmom</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ntypat</span><span class="p">)]</span>

            <span class="c1"># print zmagmom</span>

            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">typat</span><span class="p">,</span> <span class="n">magmom</span><span class="p">):</span>
                <span class="c1"># print &quot;t, m = &quot;, t, m</span>
                <span class="n">zmagmom</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="c1"># print t-1, zmagmom[3]</span>

            <span class="c1"># print &#39;sdfsdf&#39;, zmagmom[3], </span>
            <span class="n">poscar_ordered_magmom</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">mag</span> <span class="ow">in</span> <span class="n">zmagmom</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mag</span>  <span class="p">]</span>
            <span class="c1"># sys.exit()</span>
               
            <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;MAGMOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poscar_ordered_magmom</span>

            <span class="c1">#check possible antiferromagnetic configurations:</span>
            <span class="n">spec_mom_is</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">magmom</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">mag_mom_other</span><span class="p">:</span> <span class="c1">#detected some specific moment</span>
                    <span class="n">spec_mom_is</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_mom_is</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_mom_is</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Number of elements is even! trying to find all antiferromagnetic orderings:&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_mom_is</span><span class="p">);</span> 
                <span class="n">number_of_ord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">ns</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">number_of_ord</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! Too much orderings (1000), skipping ...&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nords</span> <span class="o">=</span> <span class="mi">71</span>
                    <span class="n">use_each</span> <span class="o">=</span> <span class="n">number_of_ord</span> <span class="o">//</span> <span class="n">nords</span>  <span class="c1"># spin() should be improved to find the AFM state based on the number of configuration </span>
                    <span class="k">if</span> <span class="n">use_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">use_each</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">number_of_ord</span> <span class="o">&gt;</span> <span class="n">nords</span><span class="p">:</span>
                        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Attention! Number of orderings is&#39;</span><span class="p">,</span> <span class="n">number_of_ord</span><span class="p">,</span> <span class="s1">&#39; more than&#39;</span><span class="p">,</span> <span class="n">nords</span><span class="p">,</span> <span class="s1">&#39; - I will check only each first &#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                <span class="c1"># else:</span>

                    <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spec_mom_is</span><span class="p">)</span>
                    <span class="c1"># print ls</span>
                    <span class="n">orderings</span> <span class="o">=</span> <span class="p">[]</span>
                    



                    <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        Find recursivly all possible orderings</span>
<span class="sd">                        ls - initial list of mag moments</span>
<span class="sd">                        i - index in ls  </span>

<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="c1"># nonlocal i_current</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orderings</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nords</span><span class="p">:</span>

                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                
                                <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                                
                                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                
                                    <span class="n">spin</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">i_current</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>  
                                        <span class="c1"># print (i_current)</span>

                                        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#  i_current % use_each == 0:  # every use_each will be calculated; two slow even for sampling!</span>
                                            <span class="n">orderings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="p">)</span>  
                                            <span class="c1"># print (i_current)</span>
                        <span class="k">return</span>

                    <span class="n">i_current</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                    <span class="n">spin</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">mag_orderings</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">mag_orderings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magmom</span><span class="p">)</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Only &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nords</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; orderings equally sampled along the whole space are checked !&#39;</span><span class="p">)</span>




                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderings</span><span class="p">):</span>
                        
                        <span class="c1"># if j &gt;nords: # old behaviour - just first ten orderings were checked</span>
                        <span class="c1">#     break</span>

                        <span class="n">new_magmom</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">magmom</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spec_mom_is</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
                            <span class="c1"># print i</span>
                            <span class="n">new_magmom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">magmom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        

                        <span class="n">printlog</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">new_magmom</span><span class="p">,)</span>
                        
                        <span class="n">mag_orderings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_magmom</span><span class="p">)</span>

                    <span class="c1"># print orderings</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Total number of orderings is &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">orderings</span><span class="p">),</span><span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span> <span class="ow">and</span> <span class="s1">&#39;afm_ordering&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magnetic_orderings</span> <span class="o">=</span> <span class="n">mag_orderings</span>
                  
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">magmom</span> <span class="c1"># the order is the same as for other lists in init</span>

        
        <span class="k">elif</span> <span class="s1">&#39;MAGMOM&#39;</span> <span class="ow">in</span> <span class="n">vp</span> <span class="ow">and</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;MAGMOM&#39;</span><span class="p">]:</span> <span class="c1">#just add * to magmom tag if it is provided without it</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Magnetic moments from vasp_params[&quot;MAGMOM&quot;] are used</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># if &quot;*&quot; not in vp[&#39;MAGMOM&#39;]:</span>
            <span class="c1">#     vp[&#39;MAGMOM&#39;] = str(natom) +&quot;*&quot;+ vp[&#39;MAGMOM&#39;]</span>
        


        <span class="c1"># print (self.init.magmom, &#39;asdfaaaaaaaaaaaa&#39;)</span>
        
        <span class="c1"># sys.exit()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="CalculationVasp.make_incar"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.make_incar">[docs]</a>    <span class="k">def</span> <span class="nf">make_incar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes Incar file for current calculation and copy all</span>
<span class="sd">        TO DO: there is no need to send all POSCAR files; It is enothg to send only one. However for rsync its not that crucial</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print &quot;Begin make---------------------------------------------&quot;</span>
        
        
        <span class="c1">#Generate incar</span>
        <span class="n">varset</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">varset</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span>
        <span class="n">poscar_atom_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">poscar_atom_order</span> <span class="c1"># order of atoms in POSCAR, can be different from init!!!! used for magmom</span>
        <span class="n">incar_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">setseq</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;set_sequence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">:</span>
                <span class="n">setseq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


        <span class="n">nsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">setseq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">curset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">setseq</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">nsets</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_mod</span> <span class="o">=</span> <span class="n">curset</span><span class="o">.</span><span class="n">ise</span><span class="o">+</span><span class="s1">&#39;.&#39;</span>

            <span class="n">incar_filename</span> <span class="o">=</span> <span class="n">d</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;INCAR&#39;</span>
            <span class="n">vp</span> <span class="o">=</span> <span class="n">curset</span><span class="o">.</span><span class="n">vasp_params</span>
            

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">incar_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;SYSTEM = &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s1">&#39;perm&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;perm=[</span><span class="si">{:s}</span><span class="s1">] ; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">list2string</span><span class="p">([</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">perm</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">))</span> <span class="c1">#write permuations</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">des</span><span class="p">)</span> <span class="p">)</span>


                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vp</span><span class="p">):</span>
    
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span>
                        <span class="s1">&#39;&#39;</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;MAGMOM&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span><span class="p">):</span> <span class="c1">#</span>
                        <span class="n">mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span>
                        <span class="n">magmom_aligned_with_poscar</span> <span class="o">=</span> <span class="p">[</span><span class="n">mag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">poscar_atom_order</span> <span class="p">]</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MAGMOM = &#39;</span><span class="o">+</span><span class="n">list2string</span><span class="p">(</span><span class="n">magmom_aligned_with_poscar</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#magmom from geo file has higher preference</span>
                   
                    <span class="k">elif</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="s1">&#39;&#39;</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;KSPACING&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">:</span> <span class="c1">#attention! for k-points only the base set is used!!</span>
                        <span class="s1">&#39;&#39;</span> <span class="c1"># since VASP has higher priority of KSPACING param, it should not be written </span>

                    <span class="k">elif</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                        <span class="n">lis</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lis</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">lis</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                   
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
               

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>




            <span class="n">print_and_log</span><span class="p">(</span><span class="n">incar_filename</span><span class="p">,</span> <span class="s2">&quot;was generated</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
            <span class="n">incar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incar_filename</span><span class="p">)</span>
        

        <span class="k">return</span> <span class="n">incar_list</span></div>




    
<div class="viewcode-block" id="CalculationVasp.make_kpoints_file"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.make_kpoints_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_kpoints_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
        <span class="c1">#Generate KPOINTS</span>
        <span class="n">kspacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;KSPACING&#39;</span><span class="p">]</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;KPOINTS&quot;</span><span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>



        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;k_band_structure&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">k_band_structure</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">k_band_structure</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Writing k-points file for band structure calculation.&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;k-points along high symmetry lines</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> ! intersections</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Line-mode</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rec</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># now only reciprocal are supported</span>
                <span class="n">ps</span><span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="c1"># pn  = next(k)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:6.3f}</span><span class="s1"> </span><span class="si">{:6.3f}</span><span class="s1"> </span><span class="si">{:6.3f}</span><span class="s1"> ! </span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ps</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> 
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:6.3f}</span><span class="s1"> </span><span class="si">{:6.3f}</span><span class="s1"> </span><span class="si">{:6.3f}</span><span class="s1"> ! </span><span class="si">{:s}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">pn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> 
                    <span class="n">ps</span> <span class="o">=</span> <span class="n">pn</span>





        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;You said to generate KPOINTS file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">()</span>
                <span class="c1">#Generate kpoints file</span>

                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="s1">&#39;ngkpt_dict_for_kspacings&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kspacing</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span><span class="p">:</span>
                    <span class="n">N</span> <span class="o">=</span>    <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span><span class="p">[</span><span class="n">kspacing</span><span class="p">]</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s1">&#39;Attention! ngkpt = &#39;</span><span class="p">,</span><span class="n">N</span><span class="p">,</span> 
                        <span class="s1">&#39; is adopted from struct_des which you provided for it &#39;</span><span class="p">,</span><span class="n">it</span><span class="p">,</span> <span class="s1">&#39; and kspacing = &#39;</span><span class="p">,</span><span class="n">kspacing</span><span class="p">)</span>
                    <span class="n">nk1</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">nk2</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">nk3</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="n">N</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">:</span>
                    <span class="n">nk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">nk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">nk3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Attention! ngkpt was used for kpoints file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                
                <span class="k">elif</span> <span class="n">kspacing</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Attention! ngkpt for kpoints file are created from kspacing; ngkpt is empty</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_kpoints</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="n">N</span>
                    <span class="n">nk1</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">nk2</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">nk3</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Error! could not find information about k-points</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Automatic Mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#Comment</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1">#Number of points; 0-Auto</span>
                    <span class="k">if</span> <span class="s1">&#39;KGAMMA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;KGAMMA&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;.TRUE.&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Gamma</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Monkhorst Pack</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nk1</span><span class="p">,</span> <span class="n">nk2</span><span class="p">,</span> <span class="n">nk3</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0 0 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># optional shift</span>

                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;KPOINTS was generated</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print()</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;KPOINTS was copied from&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;This set is without KPOINTS file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>



        <span class="k">return</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span></div>

<div class="viewcode-block" id="CalculationVasp.copy_to_cluster"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.copy_to_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_to_copy</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">list_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;POTCAR&#39;</span><span class="p">)</span>  <span class="p">)</span>
        <span class="n">list_to_copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;*POSCAR*&#39;</span><span class="p">)</span>  <span class="p">)</span> <span class="p">)</span>
        <span class="c1"># list_to_copy.extend( glob.glob(   os.path.join(d, &#39;*.run*&#39;  )  ) )</span>

        <span class="k">if</span> <span class="s1">&#39;OCCEXT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;OCCEXT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">list_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;OCCMATRIX&#39;</span><span class="p">)</span>   <span class="p">)</span>

        
        <span class="k">if</span> <span class="s2">&quot;up&quot;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span> <span class="c1">#Copy to server</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Files to copy:&#39;</span><span class="p">,</span> <span class="n">list_to_copy</span><span class="p">)</span>

            <span class="c1"># command = &#39; mkdir -p {:}&#39;.format( os.path.join(self.project_path_cluster, self.dir)  )</span>

            <span class="c1"># run_on_server(command, self.cluster_address)</span>

            <span class="n">push_to_server</span><span class="p">(</span><span class="n">list_to_copy</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>


        <span class="k">return</span></div>



<div class="viewcode-block" id="CalculationVasp.write_sge_script"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.write_sge_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_sge_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">prevcalcver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">schedule_system</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_files_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_script_filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Without arguments writes header, else adds sequence of calculatios</span>
<span class="sd">            option - the same as inherit_option, &#39;inherit_xred&#39; - control inheritance, or &#39;master&#39; - run serial on master </span>
<span class="sd">            prevcalcver - ver of previous calc; for first none</span>
<span class="sd">            savefile - &#39;cdawx&#39;, where c-charge, d-dos, a- AECCAR, w-wavefile, x-xml</span>
<span class="sd">            schedule_system - type of job scheduling system:&#39;PBS&#39;, &#39;SGE&#39;, &#39;SLURM&#39;</span>
<span class="sd">            mode - </span>
<span class="sd">                body</span>
<span class="sd">                footer</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># print &#39;Starting write_sge()&#39;, input_geofile</span>
        <span class="n">varset</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">varset</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">batch_script_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#</span>

        <span class="c1"># print(savefile)</span>
        <span class="c1"># sys.exit()</span>


        <span class="k">def</span> <span class="nf">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name_mod_prev</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
            <span class="n">curver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;1. Input files preparation</span>

<span class="sd">                curver - current version</span>
<span class="sd">            &quot;&quot;&quot;</span>  


            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="c1"># if not &#39;only_neb&#39; in self.calc_method:</span>
                <span class="n">precont</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prevcalcver</span><span class="p">)</span><span class="o">+</span><span class="n">name_mod_prev</span><span class="o">+</span><span class="s1">&#39;.CONTCAR&#39;</span> <span class="c1">#previous contcar</span>
                <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;inherit_xred&#39;</span> <span class="ow">and</span> <span class="n">prevcalcver</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">copy_poscar_flag</span><span class="p">:</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;grep -A &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; &quot;Direct&quot; &#39;</span><span class="o">+</span><span class="n">precont</span><span class="o">+</span><span class="s1">&#39; &gt;&gt; &#39;</span><span class="o">+</span><span class="n">input_geofile</span><span class="o">+</span> <span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">copy_poscar_flag</span><span class="p">:</span> <span class="c1"># only for first set </span>
                    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;continue&#39;</span><span class="p">:</span> <span class="c1">#test for the case of sequence set - OK</span>
                        <span class="s1">&#39;&#39;</span>
                        <span class="n">precont</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">curver</span><span class="p">)</span><span class="o">+</span><span class="n">name_mod_prev</span><span class="o">+</span><span class="s1">&#39;.CONTCAR &#39;</span> <span class="c1">#previous contcar</span>
                        <span class="n">preout</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">curver</span><span class="p">)</span><span class="o">+</span><span class="n">name_mod_prev</span><span class="o">+</span><span class="s1">&#39;.OUTCAR &#39;</span> <span class="c1">#previous outcar</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp &quot;</span><span class="o">+</span><span class="n">precont</span><span class="o">+</span><span class="s2">&quot; POSCAR  # inherit_option = continue</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp &quot;</span><span class="o">+</span><span class="n">preout</span><span class="o">+</span><span class="s1">&#39;prev.&#39;</span><span class="o">+</span><span class="n">preout</span><span class="o">+</span><span class="s2">&quot; # inherit_option = continue</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mv CHGCAR prev.CHGCAR   # inherit_option = continue</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp &quot;</span><span class="o">+</span><span class="n">input_geofile</span><span class="o">+</span><span class="s2">&quot; POSCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        



            <span class="k">return</span>



        <span class="k">def</span> <span class="nf">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">u_ramp_step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>    
            <span class="sd">&quot;&quot;&quot;Modifications of INCAR. Take attention that *parameter* will be changed to new *value*</span>
<span class="sd">            if it only already exist in INCAR.  *u_ramp_step*-current step to determine u,</span>
<span class="sd">            *write*-sometimes just the return value is needed. </span>
<span class="sd">            Returns U value corresponding to *u_ramp_step*.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">u_step</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">:</span>
                <span class="c1">#Update only non-zero elements of LDAUU with value</span>

                <span class="n">set_LDAUU_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;LDAUU&#39;</span><span class="p">]</span>
                <span class="n">new_LDAUU_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">set_LDAUU_list</span><span class="p">)</span>
                
                <span class="c1"># print set_LDAUU_list</span>
                <span class="n">u_step</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">set_LDAUU_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">u_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="p">)[</span><span class="n">u_ramp_step</span><span class="p">]</span>
                    <span class="n">u_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">u_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># new_LDAUU_list[i] = value</span>
                    <span class="n">new_LDAUU_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_step</span>


                <span class="n">new_LDAUU</span> <span class="o">=</span> <span class="s1">&#39;LDAUU = &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">new_LDAUU_list</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">new_LDAUU_list</span><span class="p">)</span>
                
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;sed -i.bak &#39;/LDAUU/c</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">new_LDAUU</span> <span class="o">+</span> <span class="s2">&quot;&#39; INCAR</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1">#print(&#39;u_step&#39;,u_step)</span>
                <span class="c1">#sys.exit()</span>

            <span class="k">elif</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s1">&#39;MAGMOM&#39;</span><span class="p">:</span>

                <span class="n">new_incar_string</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;sed -i.bak &#39;/&quot;</span><span class="o">+</span><span class="n">parameter</span><span class="o">+</span><span class="s2">&quot;/c</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">new_incar_string</span> <span class="o">+</span> <span class="s2">&quot;&#39; INCAR</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">,</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">]:</span>

                <span class="n">new_incar_string</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;sed -i.bak &#39;/&quot;</span><span class="o">+</span><span class="n">parameter</span><span class="o">+</span><span class="s2">&quot;/c</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">new_incar_string</span> <span class="o">+</span> <span class="s2">&quot;&#39; INCAR</span><span class="se">\n</span><span class="s2">&quot;</span>




            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

            <span class="k">return</span>  <span class="n">u_step</span> <span class="c1">#for last element</span>

        <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parrallel_run_command</span><span class="p">,</span> <span class="n">condition</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;2. write commands for running vasp. condition = true allows override additional conditions&quot;&quot;&quot;</span> 

            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="c1"># if not condition:</span>
                <span class="c1">#     condition = (not &#39;only_neb&#39; in self.calc_method)</span>

                <span class="c1"># if condition:</span>


                <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;vasp &gt;&quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="s1">&#39;monte&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;python &quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_tools</span><span class="o">+</span><span class="s1">&#39;/siman/monte.py &gt; monte.log</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">parrallel_run_command</span> <span class="o">+</span><span class="s2">&quot; &gt;&quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                



                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sleep 20</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>


        <span class="k">def</span> <span class="nf">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;cw&#39;</span><span class="p">,</span>
            <span class="p">):</span>    
            <span class="sd">&quot;&quot;&quot;3. Out files saving block</span>
<span class="sd">                </span>
<span class="sd">                rm_chg_wav - if True than CHGCAR and WAVECAR are removed</span>

<span class="sd">            &quot;&quot;&quot;</span>   
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The value of savefile is&#39;</span><span class="p">,</span> <span class="n">savefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span>

                <span class="n">contcar</span> <span class="o">=</span> <span class="n">pre</span><span class="o">+</span><span class="s1">&#39;.CONTCAR&#39;</span>

                <span class="k">if</span> <span class="s2">&quot;o&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv OUTCAR &quot;</span>          <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.OUTCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv CONTCAR &quot;</span>         <span class="o">+</span> <span class="n">contcar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;i&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp INCAR &quot;</span>           <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.INCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;v&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span> <span class="c1"># v means visualization chgcar</span>
                    <span class="n">chg</span>  <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.CHG&#39;</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv CHG &quot;</span><span class="o">+</span><span class="n">chg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;gzip -f &quot;</span><span class="o">+</span><span class="n">chg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span> <span class="c1"># </span>
                    <span class="n">fln</span> <span class="o">=</span> <span class="s1">&#39;CHGCAR&#39;</span>
                    <span class="n">chgcar</span>  <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">fln</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">fln</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">chgcar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#use cp, cause it may be needed for other calcs in run</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;gzip -f &#39;</span><span class="o">+</span><span class="n">chgcar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>                

                <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span> <span class="c1"># </span>
                    <span class="n">fln</span> <span class="o">=</span> <span class="s1">&#39;PARCHG&#39;</span>
                    <span class="n">parchg</span>  <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">fln</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">fln</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">parchg</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#use cp, cause it may be needed for other calcs in run</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;gzip -f &#39;</span><span class="o">+</span><span class="n">parchg</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> 

                <span class="c1"># else:</span>
                <span class="c1">#     f.write(&quot;rm CHG \n&quot;) #file can be used only for visualization</span>


                <span class="k">if</span> <span class="s2">&quot;d&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">fln</span> <span class="o">=</span> <span class="s1">&#39;DOSCAR&#39;</span>
                    <span class="n">doscar</span>  <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">fln</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span><span class="o">+</span><span class="n">fln</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">doscar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;gzip -f &#39;</span><span class="o">+</span><span class="n">doscar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>                
                


                <span class="k">if</span> <span class="s2">&quot;a&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv AECCAR0 &quot;</span>     <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.AECCAR0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv AECCAR2 &quot;</span>     <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.AECCAR2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv vasprun.xml &quot;</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.vasprun.xml</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
               
                <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">fln</span> <span class="o">=</span> <span class="s1">&#39;WAVECAR&#39;</span>
                    <span class="n">wavecar</span>  <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">fln</span>
                    <span class="c1"># f.write(&quot;mv WAVECAR &quot;     + v + name_mod + &quot;.WAVECAR\n&quot;)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span><span class="o">+</span><span class="n">fln</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">wavecar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;gzip -f &#39;</span><span class="o">+</span><span class="n">wavecar</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  
                    <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="n">rm_chg_wav</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     f.write(&quot;rm WAVECAR\n&quot;)</span>


                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">rm_chg_wav</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm CHGCAR   # rm_chg_wav flag</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#file is important for continuation</span>
                <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">rm_chg_wav</span><span class="p">:</span>
                    <span class="s1">&#39;&#39;</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm WAVECAR  # rm_chg_wav flag</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#</span>
                <span class="k">if</span> <span class="s1">&#39;v&#39;</span> <span class="ow">in</span> <span class="n">rm_chg_wav</span><span class="p">:</span> <span class="c1">#chgcar for visualization</span>
                    <span class="s1">&#39;&#39;</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm CHG   # rm_chg_wav flag</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#</span>

            <span class="k">return</span> <span class="n">contcar</span>


        <span class="k">def</span> <span class="nf">analysis_script</span><span class="p">(</span><span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1">#now only for u-ramping</span>
            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;touch ENERGIES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                

                <span class="k">for</span> <span class="n">outcar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;grep &#39;energy  without entropy&#39; &quot;</span><span class="o">+</span><span class="n">outcar</span><span class="o">+</span><span class="s2">&quot; | awk &#39;{print $7}&#39; &gt;&gt; ENERGIES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">name_mod_U_last</span><span class="p">():</span>
            <span class="n">name_mod_last</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span>
                        <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> 
                            <span class="n">u_ramp_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#used to det last U</span>

            <span class="k">return</span> <span class="n">name_mod_last</span>


        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
            <span class="c1"># parrallel_run_command = &quot;mpirun -x PATH vasp&quot; # MPIE</span>
            <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">vasp_command</span>
        <span class="k">elif</span> <span class="n">schedule_system</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span> <span class="s1">&#39;PBS_bsu&#39;</span><span class="p">]:</span>
            <span class="c1"># parrallel_run_command = &quot;mpiexec --prefix /home/aleksenov_d/mpi/openmpi-1.6.3/installed vasp&quot; bsu cluster</span>
            <span class="c1"># parrallel_run_command = &quot;mpirun  vasp_std&quot; #skoltech cluster</span>
            <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">vasp_command</span> <span class="c1">#skoltech cluster</span>
        
        <span class="k">elif</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
            <span class="c1"># parrallel_run_command = &quot;prun /opt/vasp/bin/vasp5.4.1MPI&quot;</span>
            <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">vasp_command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>


        <span class="n">run_name</span> <span class="o">=</span> <span class="n">batch_script_filename</span>     
        <span class="n">job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">neb_flag</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;neb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span> <span class="ow">or</span> <span class="s1">&#39;only_neb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;set_sequence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">):</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">se</span> <span class="k">for</span> <span class="n">se</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">]</span>




 
        <span class="k">def</span> <span class="nf">write_body</span><span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">final_analysis_flag</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">penult_set_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">curset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            set_mod (str) - additional modification of names needed for *set_sequence* regime, should be &#39;.setname&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;only_neb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                <span class="n">write</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">write_poscar</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">write_poscar</span> <span class="o">=</span> <span class="kc">True</span>                

            <span class="c1">#neb</span>
            <span class="k">if</span> <span class="s1">&#39;neb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">write</span><span class="p">:</span> 
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#NEB run, start and final configurations, then IMAGES:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
                <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;IMAGES&#39;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">)</span> <span class="c1"># start and final runs</span>

            
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#experimental preliminary non-magnetic run</span>
                <span class="s1">&#39;&#39;</span>
                <span class="c1">#     if self.set.vasp_params[&#39;ISPIN&#39;] == 2:</span>
                <span class="c1">#         print_and_log(&#39;Magnetic calculation detected; For better convergence&#39;,</span>
                <span class="c1">#          &#39;I add first non-magnetic run&#39;, imp = &#39;Y&#39;)</span>
                <span class="c1">#         write = True</span>
                <span class="c1">#         name_mod_last = &#39;.&#39;+&#39;NM&#39;</span>
                <span class="c1">#         name_mod = &#39;.NM&#39;</span>

                <span class="c1">#         if write: </span>
                <span class="c1">#             f.write(&quot;#Preliminary non-magnetic run:\n&quot;)  </span>
                <span class="c1">#         prepare_input(prevcalcver = prevcalcver, option = option,</span>
                <span class="c1">#          input_geofile = input_geofile, name_mod_prev = name_mod_last, write = write, curver = version)</span>

                <span class="c1">#         update_incar(parameter = &#39;ISPIN&#39;, value = 1, write = write) #</span>
                        
                <span class="c1">#         run_command(option = option, name = self.name+name_mod, parrallel_run_command = parrallel_run_command, write = write)</span>

                <span class="c1">#         if write:</span>
                <span class="c1">#             f.write(&quot;cp CONTCAR POSCAR  #prepare for basic run\n&quot;)</span>
                <span class="c1">#             write_poscar = False  </span>

                <span class="c1">#         mv_files_according_versions(&#39;co&#39;, v, name_mod = name_mod, write = write, rm_chg_wav = &#39;&#39;)</span>

                <span class="c1">#         update_incar(parameter = &#39;ISPIN&#39;, value = 2, write = write) #</span>




            <span class="k">if</span> <span class="s1">&#39;u_ramping&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">write</span><span class="p">:</span> 
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#U-ramping run:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  

                <span class="c1"># name_mod_last = &#39;.&#39;+name_mod_U_last()</span>
                <span class="n">name_mod_last</span> <span class="o">=</span> <span class="s1">&#39;.U00&#39;</span> <span class="c1">#since u_ramp starts from u = 00, it is more correct to continue from 00</span>
                <span class="k">if</span> <span class="n">penult_set_name</span><span class="p">:</span>
                    <span class="n">name_mod_last</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">penult_set_name</span> <span class="c1">#however, for multiset run, the structure for u=00 exists only</span>
                                                      <span class="c1">#for penult set or maybe even for the first only set</span>
                    <span class="c1"># print (name_mod_last, penult_set_name)</span>
                    <span class="c1"># sys.exit()</span>
                    
                <span class="c1"># print &#39;prevcalver&#39;, prevcalcver</span>

                <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="n">copy_poscar_flag</span><span class="p">:</span> 
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm CHGCAR    #u-ramp init from scratch</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                

                <span class="n">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span>
                 <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">input_geofile</span><span class="p">,</span> <span class="n">name_mod_prev</span> <span class="o">=</span> <span class="n">name_mod_last</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write_poscar</span><span class="p">,</span> <span class="n">curver</span> <span class="o">=</span> <span class="n">version</span><span class="p">,</span>
                 <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="n">copy_poscar_flag</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">copy_poscar_flag</span><span class="p">:</span>
                    <span class="n">usteps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">usteps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># now it the case of sequence_set for contin sets only the last U is used</span>

                <span class="n">u_last</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="k">for</span> <span class="n">i_u</span> <span class="ow">in</span> <span class="n">usteps</span><span class="p">:</span>

                    <span class="n">u</span> <span class="o">=</span> <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> <span class="n">u_ramp_step</span> <span class="o">=</span> <span class="n">i_u</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="n">u_last</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">name_mod</span>   <span class="o">=</span> <span class="s1">&#39;.U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">set_mod</span>
                   
                    <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="n">name_mod</span><span class="p">,</span> <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">write</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="n">copy_poscar_flag</span><span class="p">:</span>

                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp CONTCAR POSCAR   #u-ramp preparation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                

            <span class="c1"># print(savefile)</span>
                    <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">,</span> <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                


                    <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.OUTCAR&quot;</span>  <span class="p">)</span>
                    <span class="n">u_last</span> <span class="o">=</span> <span class="n">u</span>
                
                <span class="k">if</span> <span class="n">final_analysis_flag</span><span class="p">:</span>
                    <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="c1">#The wavcar is removed for the sake of harddrive space</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="k">if</span> <span class="n">curset</span><span class="o">.</span><span class="n">save_last_wave</span><span class="p">:</span>
                    <span class="n">save_last</span> <span class="o">=</span> <span class="s1">&#39;cw&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">save_last</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>


                <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span> <span class="o">=</span> <span class="n">save_last</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">,</span> <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="n">rm_chg_wav</span><span class="p">)</span> <span class="c1">#save more files for last U</span>
                

                <span class="n">analysis_script</span><span class="p">(</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">)</span>
                <span class="c1"># print self.associated</span>





            <span class="k">elif</span> <span class="s1">&#39;afm_ordering&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>

                <span class="c1">#Comment - inherit_xred option is not available here</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm CHGCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">savefile</span><span class="p">:</span> 
                    <span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">magmom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnetic_orderings</span><span class="p">):</span>

                    <span class="n">name_mod</span>   <span class="o">=</span> <span class="s1">&#39;.AFM&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">set_mod</span>

                    <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;MAGMOM&#39;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">magmom</span><span class="p">)</span>

                    <span class="n">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">input_geofile</span><span class="p">,</span>
                        <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="n">copy_poscar_flag</span><span class="p">)</span>
                    
                    <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="n">name_mod</span><span class="p">,</span> <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">)</span>

                    <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">)</span>
                
                    <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.OUTCAR&quot;</span>  <span class="p">)</span>

                <span class="n">analysis_script</span><span class="p">()</span>
            

            <span class="k">else</span><span class="p">:</span> <span class="c1">#simple run</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">savefile</span><span class="p">:</span> 
                    <span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;vco&#39;</span>

                <span class="k">if</span> <span class="n">write</span><span class="p">:</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#Basic run:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  

                <span class="n">name_mod</span>   <span class="o">=</span> <span class="n">set_mod</span>
                <span class="n">name_mod_last</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="n">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name_mod_prev</span> <span class="o">=</span> <span class="n">name_mod_last</span><span class="p">,</span>
                    <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">input_geofile</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write_poscar</span><span class="p">,</span> <span class="n">curver</span> <span class="o">=</span> <span class="n">version</span><span class="p">,</span>
                    <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="n">copy_poscar_flag</span><span class="p">)</span>

                <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="n">name_mod</span><span class="p">,</span> <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">final_analysis_flag</span><span class="p">:</span>
                    <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="c1">#The wavcar is removed for the sake of harddrive space</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>


                <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">,</span> <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="n">rm_chg_wav</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.OUTCAR&quot;</span>  <span class="p">)</span>

            <span class="k">return</span> <span class="n">contcar_file</span>
        


        <span class="k">def</span> <span class="nf">write_footer</span><span class="p">(</span><span class="n">set_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">run_tool_flag</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">final_analysis_flag</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;footer&quot;&quot;&quot;</span>
            
            <span class="k">def</span> <span class="nf">u_ramp_prepare</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;u_ramping&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> <span class="n">u_ramp_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">name_mod</span>   <span class="o">=</span> <span class="s1">&#39;.U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="c1"># name_mod_last = name_mod_U_last()+&#39;.&#39;</span>
                    <span class="n">name_mod_last</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="s1">&#39;U00&#39;</span> <span class="c1">#since u_ramp starts from u = 00, it is more correct to continue from 00</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name_mod_last</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">name_mod</span>   <span class="o">=</span> <span class="s1">&#39;&#39;</span>                

                <span class="k">return</span> <span class="n">name_mod</span><span class="p">,</span> <span class="n">name_mod_last</span>

            <span class="k">def</span> <span class="nf">u_ramp_loop</span><span class="p">(</span><span class="n">ver_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subfolders</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run_name_prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">subfolders</span><span class="p">:</span>
                    <span class="n">subfolders</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>

                

                <span class="k">if</span> <span class="n">run_tool_flag</span><span class="p">:</span>
                    <span class="n">usteps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">usteps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># now it the case of sequence_set for contin sets only the last U is used</span>


                <span class="n">u_last</span> <span class="o">=</span> <span class="mi">100</span>

                <span class="k">for</span> <span class="n">i_u</span> <span class="ow">in</span> <span class="n">usteps</span><span class="p">:</span>


                    <span class="n">u</span> <span class="o">=</span> <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> <span class="n">u_ramp_step</span> <span class="o">=</span> <span class="n">i_u</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="n">u_last</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">name_mod</span>   <span class="o">=</span> <span class="n">ver_prefix</span><span class="o">+</span><span class="s1">&#39;U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">set_mod</span>

                    
                    <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">run_name_prefix</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">name_mod</span><span class="p">,</span> 
                        <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    
                    <span class="n">u_last</span> <span class="o">=</span> <span class="n">u</span>


                    <span class="k">for</span> <span class="n">n_st</span> <span class="ow">in</span> <span class="n">subfolders</span><span class="p">:</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/CONTCAR &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/POSCAR&#39;</span><span class="o">+</span><span class="s1">&#39;               #u_ramp_loop()</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/OUTCAR  &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.OUTCAR&#39;</span><span class="o">+</span><span class="s1">&#39;  #u_ramp_loop()</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="n">contcar</span> <span class="o">=</span> <span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.CONTCAR&#39;</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/CONTCAR  &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">contcar</span><span class="o">+</span><span class="s1">&#39;            #u_ramp_loop()</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>

                        <span class="c1"># self.associated_outcars.append( v + name_mod +  &quot;.OUTCAR&quot;  )</span>


                <span class="k">return</span> <span class="n">contcar</span>

            <span class="n">subfolders</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">contcar_file</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="n">neb_flag</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Writing scripts for NEB method&#39;</span><span class="p">,</span> <span class="n">important</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
                <span class="n">nim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]</span>
                <span class="n">nim_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nim</span><span class="p">)</span>

                <span class="n">subfolders</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nim</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">n_st</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="n">n_st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">subfolders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_st</span><span class="p">)</span>


                <span class="n">name_mod</span><span class="p">,</span> <span class="n">name_mod_last</span> <span class="o">=</span> <span class="n">u_ramp_prepare</span><span class="p">()</span>


                <span class="n">start</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.OUTCAR &#39;</span>
                <span class="n">final</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.OUTCAR &#39;</span>



                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">#Starting NEB script </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">option</span> <span class="ow">and</span> <span class="s1">&#39;continue&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                    <span class="n">prevout</span> <span class="o">=</span> <span class="n">name_mod_last</span><span class="o">+</span><span class="s1">&#39;OUTCAR &#39;</span>

                    <span class="k">for</span> <span class="n">n_st</span> <span class="ow">in</span> <span class="n">subfolders</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">prevout</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;prev.&#39;</span><span class="o">+</span><span class="n">prevout</span><span class="o">+</span><span class="s1">&#39;  # inherit_option = continue</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/CONTCAR &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/POSCAR  # inherit_option = continue</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/CHGCAR &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/prev.CHGCAR   # inherit_option = continue</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">run_tool_flag</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export PATH=$PATH:&#39;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="o">+</span><span class="s1">&#39;/tools/vts/</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#header.project_path_cluster</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;nebmake.pl &#39;</span><span class="o">+</span> <span class="n">start</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span><span class="s1">&#39;CONT&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">final</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span><span class="s1">&#39;CONT&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">nim_str</span> <span class="o">+</span><span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">nim</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> 
                    <span class="n">nim_plus_one_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">run_tool_flag</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">start</span> <span class="o">+</span>  <span class="s1">&#39;00/OUTCAR</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">final</span> <span class="o">+</span>  <span class="n">nim_plus_one_str</span> <span class="o">+</span> <span class="s1">&#39;/OUTCAR</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>


                <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;IMAGES&#39;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">nim</span><span class="p">)</span>


                <span class="k">if</span> <span class="s1">&#39;u_ramping&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>


                    <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">u_ramp_loop</span><span class="p">(</span><span class="n">subfolders</span> <span class="o">=</span> <span class="n">subfolders</span><span class="p">,</span> 
                        <span class="n">run_name_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.n_&#39;</span><span class="o">+</span><span class="n">nim_str</span><span class="p">,</span> 
                        <span class="n">set_mod</span> <span class="o">=</span> <span class="n">set_mod</span><span class="p">)</span>
              

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="n">set_mod</span><span class="o">+</span><span class="s1">&#39;.n_&#39;</span><span class="o">+</span><span class="n">nim_str</span><span class="o">+</span><span class="n">name_mod</span><span class="p">,</span> 
                    <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># print(set_mod)</span>
                    <span class="c1"># sys.exit()</span>
                    <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">set_mod</span> <span class="ow">and</span> <span class="n">set_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                        <span class="n">set_mod_loc</span> <span class="o">=</span> <span class="n">set_mod</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">set_mod_loc</span> <span class="o">=</span> <span class="n">set_mod</span>

                    <span class="n">name_mod</span>   <span class="o">=</span> <span class="n">set_mod_loc</span>
                    <span class="k">if</span> <span class="n">name_mod</span><span class="p">:</span>
                        <span class="n">contcar</span> <span class="o">=</span> <span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.CONTCAR&#39;</span>
                        <span class="n">outcar</span>  <span class="o">=</span> <span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.OUTCAR&#39;</span>
                        <span class="k">for</span> <span class="n">n_st</span> <span class="ow">in</span> <span class="n">subfolders</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/OUTCAR  &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outcar</span>  <span class="o">+</span><span class="s1">&#39;  #sequence set: save file</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/CONTCAR  &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">contcar</span><span class="o">+</span><span class="s1">&#39;  #sequence set: save file</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">contcar</span> <span class="o">=</span> <span class="s1">&#39;CONTCAR&#39;</span>

                    <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">contcar</span>






                <span class="k">if</span> <span class="n">final_analysis_flag</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export PATH=$PATH:&#39;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="o">+</span><span class="s1">&#39;/tools/gnuplot/bin/ </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="o">+</span><span class="s1">&#39;/tools/vts/nebresults.pl  </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;find . -name WAVECAR -delete</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;find . -name PROCAR -delete</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># for n in range</span>



            <span class="c1"># print (calc[id].calc_method )</span>
            <span class="c1"># sys.exit()</span>
            <span class="k">if</span> <span class="s1">&#39;uniform_scale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                <span class="c1"># print (input_geofile)</span>
                <span class="n">name_mod</span> <span class="o">=</span> <span class="n">set_mod</span>
                
                <span class="k">if</span> <span class="n">run_tool_flag</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">#Starting fitting tool </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output_files_names</span> <span class="p">]</span>
                    <span class="c1"># f.write(&#39;export PYTHONPATH=$PYTHONPATH:&#39;+CLUSTER_PYTHONPATH+&#39;\n&#39;)</span>
                    <span class="c1"># f.write(&#39;/home/aksenov/tools/fit_tool.py &#39;+list2string(outputs)+&#39;\n&#39; )</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;python &#39;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="o">+</span><span class="s1">&#39;/tools/fit_tool.py &#39;</span><span class="o">+</span><span class="n">list2string</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                    

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp 100.POSCAR POSCAR </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;u_ramping&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                    

                    <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">u_ramp_loop</span><span class="p">(</span><span class="n">ver_prefix</span> <span class="o">=</span> <span class="s1">&#39;100.&#39;</span><span class="p">,</span> <span class="n">run_name_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fitted&#39;</span><span class="p">,</span> <span class="n">set_mod</span> <span class="o">=</span> <span class="n">set_mod</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">final_analysis_flag</span><span class="p">:</span>
                        <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="c1">#The wavcar is removed for the sake of harddrive space</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>




                    <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.100&#39;</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.fitted&#39;</span><span class="p">,</span> 
                        <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># print(final_analysis_flag)</span>
                    <span class="c1"># sys.exit()</span>

                    <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">rm_chg_wav</span> <span class="o">=</span> <span class="n">rm_chg_wav</span><span class="p">)</span>

                <span class="c1"># sys.exit()</span>


            <span class="c1">#clean at the end</span>
            <span class="k">if</span> <span class="n">final_analysis_flag</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">final_vasp_clean</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rm PROCAR DOSCAR OSZICAR PCDAT REPORT XDATCAR vasprun.xml</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rm RUNNING</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>



            <span class="k">return</span> <span class="n">contcar_file</span><span class="p">,</span> <span class="n">subfolders</span>




        <span class="n">nsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
        <span class="n">footer_flag</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">([</span><span class="s1">&#39;uniform_scale&#39;</span><span class="p">,</span> <span class="s1">&#39;neb&#39;</span><span class="p">,</span> <span class="s1">&#39;only_neb&#39;</span> <span class="p">])</span>




        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="c1">#control part of script</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">penult_set_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">curset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">nsets</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#the incar name is modified during creation only if more than 1 set is detected</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;body&#39;</span> <span class="ow">or</span> <span class="n">footer_flag</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#sequence set: &#39;</span><span class="o">+</span><span class="n">curset</span><span class="o">.</span><span class="n">ise</span><span class="o">+</span><span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">curset</span><span class="o">.</span><span class="n">ise</span><span class="o">+</span><span class="s1">&#39;.INCAR  INCAR</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">curset</span><span class="p">,</span> <span class="s1">&#39;savefile&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">curset</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">savefile</span> <span class="o">=</span> <span class="n">curset</span><span class="o">.</span><span class="n">savefile</span> 


                <span class="n">penult_set_name</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ise</span>
            

            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nsets</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">set_mod</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">curset</span><span class="o">.</span><span class="n">ise</span>
                <span class="n">final_analysis_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#last set</span>
                <span class="n">set_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># the last step do no use modifications of names </span>
                <span class="n">final_analysis_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#for footer</span>



            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># additional control of prepare_input routine and footer</span>
                <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># the flag is also used to detect first set</span>
                <span class="n">run_tool_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">run_tool_flag</span>  <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span>
                
                <span class="n">contcar_file</span> <span class="o">=</span> <span class="n">write_body</span><span class="p">(</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="n">savefile</span> <span class="o">=</span> <span class="n">savefile</span><span class="p">,</span> 
                    <span class="n">set_mod</span> <span class="o">=</span> <span class="n">set_mod</span><span class="p">,</span> <span class="n">copy_poscar_flag</span> <span class="o">=</span> <span class="n">copy_poscar_flag</span><span class="p">,</span> 
                    <span class="n">final_analysis_flag</span> <span class="o">=</span> <span class="n">final_analysis_flag</span><span class="p">,</span> <span class="n">penult_set_name</span> <span class="o">=</span> <span class="n">penult_set_name</span><span class="p">,</span> <span class="n">curset</span> <span class="o">=</span> <span class="n">curset</span><span class="p">)</span>

                

            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;footer&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">copy_poscar_flag</span><span class="p">:</span> 
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#Footer section: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


                <span class="c1"># print(savefile)</span>
                <span class="c1"># sys.exit()</span>
                <span class="n">contcar_file</span><span class="p">,</span> <span class="n">subfolders</span> <span class="o">=</span> <span class="n">write_footer</span><span class="p">(</span><span class="n">set_mod</span> <span class="o">=</span> <span class="n">set_mod</span><span class="p">,</span> <span class="n">run_tool_flag</span> <span class="o">=</span> <span class="n">run_tool_flag</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="n">savefile</span><span class="p">,</span>
                 <span class="n">final_analysis_flag</span> <span class="o">=</span> <span class="n">final_analysis_flag</span><span class="p">)</span>

            
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nsets</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">contcar_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;o&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">neb_flag</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;footer&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">n_st</span> <span class="ow">in</span> <span class="n">subfolders</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">contcar_file</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">n_st</span><span class="o">+</span><span class="s1">&#39;/POSCAR  # sequence_set: preparation of input geo for next neb set</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cp &#39;</span><span class="o">+</span><span class="n">contcar_file</span><span class="o">+</span><span class="s1">&#39; POSCAR  #sequence_set: preparation of input geo for next set</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>










        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;associated_outcars&#39;</span><span class="p">)</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># print &#39;write_sge() out=&#39;, out</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span>  <span class="n">out</span><span class="c1">#return OUTCAR name</span></div>
    



<div class="viewcode-block" id="CalculationVasp.make_run"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.make_run">[docs]</a>    <span class="k">def</span> <span class="nf">make_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_system</span><span class="p">,</span> <span class="n">run_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate run file</span>

<span class="sd">        INPUT:</span>
<span class="sd">            schedule_system - </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
                <span class="c1">#&#39;qsub -pe &#39;mpi*&#39; NCORES -l CLUSTER_TAG script.parallel.sh&#39; for mpi-jobs which should run on CLUSTER_TAG (cmmd or cmdft)</span>
                <span class="c1">#IMPORTANT: NCORES must be a multiple of 8(24) on cmdft(cmmd). </span>
                <span class="c1"># f.write(&quot;qsub -pe &#39;mpi*&#39; &quot;+str(header.corenum)+&quot; &quot;+header.queue+&quot; &quot;+run_name+&quot;\n&quot;) #str(self.set.np) #-l cmmd; on MPIE</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;qsub &quot;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">run_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
            
                <span class="c1"># f.write(&#39;sleep 5\n&#39;)</span>
                <span class="c1"># runBash(&#39;chmod +x run&#39;)</span>
            
            <span class="k">elif</span> <span class="n">schedule_system</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span> <span class="s1">&#39;PBS_bsu&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">PATH2PROJECT</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">PATH2PROJECT</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">PATH2PROJECT</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;qsub &quot;</span><span class="o">+</span><span class="n">run_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd -</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sleep 5</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>                        
            
            <span class="k">elif</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;squeue</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sbatch -p AMG &quot;</span> <span class="o">+</span> <span class="n">run_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Unknown schedule_system&#39;</span><span class="p">,</span> <span class="n">schedule_system</span><span class="p">)</span>
                



        <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run file created</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>     
        <span class="k">return</span></div>



<div class="viewcode-block" id="CalculationVasp.calc_kspacings"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.calc_kspacings">[docs]</a>    <span class="k">def</span> <span class="nf">calc_kspacings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sttype</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates reciprocal vectors and kspacing from ngkpt&quot;&quot;&quot;</span>
        <span class="c1"># to_ang_local = header.to_ang</span>
        <span class="c1"># try:</span>
        <span class="c1">#     if &quot;Ang&quot; in self.len_units:</span>
        <span class="c1">#         to_ang_local = 1</span>
        <span class="c1">#         #print &quot;units angs&quot;</span>
        <span class="c1"># except AttributeError:</span>
        <span class="c1">#     print_and_log(&quot;Warning! no len_units for &quot;+self.name+&quot; calculation, I use Bohr \n&quot;)</span>
        

        <span class="k">if</span> <span class="n">sttype</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="k">if</span> <span class="n">sttype</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> 


        <span class="bp">self</span><span class="o">.</span><span class="n">kspacing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">kspacings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ngkpt</span><span class="p">:</span>
            <span class="n">ngkpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span>

        <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ngkpt</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">calc_kspacings</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kspacing</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">kspacing</span>   <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">return</span>  <span class="n">k</span></div>













<div class="viewcode-block" id="CalculationVasp.read_results"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.read_results">[docs]</a>    <span class="k">def</span> <span class="nf">read_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">out_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">voronoi</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alkali_ion_number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">only_load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download and Read VASP OUTCAR file</span>

<span class="sd">        ###INPUT:</span>
<span class="sd">            - load (str) - &#39;x&#39; - download xml, o - download outcar and contcar, un - read unfinished</span>
<span class="sd">            - show (str) - print additional information</span>
<span class="sd">            - choose_outcar - see description in res_loop(), from 1</span>
<span class="sd">            - out_type - controls the return string</span>
<span class="sd">                see in code, add here</span>
<span class="sd">                also controls reading of OUTCAR</span>
<span class="sd">                &#39;xcarts&#39; read xcart every relaxation step and write into self.end.list_xcart</span>

<span class="sd">            - only_load (bool) - if true - only load the files (used for database)</span>

<span class="sd">        ###RETURN:</span>
<span class="sd">            ?</span>

<span class="sd">        ###DEPENDS:</span>
<span class="sd">        TODO:</span>
<span class="sd">        please split into outcar parser, downloader, and checker-formatter</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print (choose_outcar, hasattr(self, &#39;associated_outcars&#39;), self.associated_outcars)</span>
        <span class="n">join</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">show</span><span class="p">:</span>
            <span class="n">show</span> <span class="o">+=</span><span class="n">header</span><span class="o">.</span><span class="n">show</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">choose_outcar</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;associated_outcars&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">choose_outcar</span><span class="p">:</span>
            <span class="c1"># print (&#39;associated outcars = &#39;,self.associated_outcars)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;read_results(): choose_outcar&#39;</span><span class="p">,</span> <span class="n">choose_outcar</span><span class="p">)</span>

            <span class="n">path_to_outcar</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span> <span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">[</span><span class="n">choose_outcar</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

            <span class="n">printlog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_outcar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        

        <span class="k">if</span> <span class="s1">&#39;OUTCAR&#39;</span> <span class="ow">in</span> <span class="n">path_to_outcar</span><span class="p">:</span>
            <span class="n">path_to_contcar</span> <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span> <span class="s2">&quot;CONTCAR&quot;</span><span class="p">)</span>
            <span class="n">path_to_poscar</span> <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span> <span class="s2">&quot;POSCAR&quot;</span><span class="p">)</span>
            <span class="n">path_to_xml</span>     <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span> <span class="s2">&quot;vasprun.xml&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_contcar</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">path_to_xml</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span>  <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span>  <span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span>  <span class="p">[</span><span class="s1">&#39;u_ramping&#39;</span><span class="p">,</span> <span class="s1">&#39;afm_ordering&#39;</span><span class="p">]):</span>
            <span class="s1">&#39;&#39;</span> 
            <span class="c1"># print self.associated_outcars</span>
            <span class="c1"># lor = self.associated_outcars[-1]</span>
            <span class="c1"># path_to_outcar  = self.dir + lor</span>
            <span class="c1"># path_to_contcar = self.dir + lor.replace(&#39;OUTCAR&#39;, &#39;CONTCAR&#39;)</span>
            <span class="c1"># path_to_xml     = self.dir + lor.replace(&#39;OUTCAR&#39;, &#39;vasprun.xml&#39;)         </span>
            <span class="c1"># print &#39;sdf&#39;, path_to_outcar, path_to_contcar, path_to_xml</span>

            <span class="c1"># energies_str = runBash(&quot;ssh &quot;+self.cluster_address+&quot; cat &quot;+self.dir+&quot;ENERGIES&quot;)</span>
            
            <span class="c1"># print &quot;ssh &quot;+self.cluster_address+&quot; cat &quot;+self.dir+&quot;ENERGIES&quot;</span>
            <span class="c1"># print (  energies_str )</span>
            <span class="c1"># if not &#39;cat&#39; in energies_str:</span>
            <span class="c1">#     self.associated_energies = [float(e) for e in energies_str.split()]</span>
            
            <span class="c1"># self.u_ramping_u_values = np.arange(*self.u_ramping_list)</span>
            <span class="c1"># print &#39;associated_energies:&#39;, self.associated_energies</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;read_results() path to outcar&#39;</span><span class="p">,</span> <span class="n">path_to_outcar</span><span class="p">)</span>
        <span class="c1"># sys.exit()</span>



        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">):</span>
            <span class="n">load</span> <span class="o">=</span> <span class="n">load</span><span class="o">+</span><span class="s1">&#39;o&#39;</span>




        <span class="sd">&quot;&quot;&quot;Copy from server &quot;&quot;&quot;</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The load flag is &#39;</span><span class="p">,</span> <span class="n">load</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;o&#39;</span> <span class="ow">in</span> <span class="n">load</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cluster_address&#39;</span><span class="p">):</span>

            <span class="c1">#reduce size of downloadable file by removing occupations: vasp 4 and 5</span>
            <span class="n">command_reduce</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;ssh </span><span class="si">{0:s}</span><span class="s2"> nbands=\`grep </span><span class="se">\\</span><span class="s2">&quot;NBANDS=</span><span class="se">\\</span><span class="s2">&quot; \</span><span class="si">{1:s}</span><span class="s2"> \| awk </span><span class="se">\\</span><span class="s2">&#39;{{print \$NF - 1}}</span><span class="se">\\</span><span class="s2">&#39;\`\; sed -i -e </span><span class="se">\\</span><span class="s2">&quot;/band No./,+\${{nbands}}d</span><span class="se">\\</span><span class="s2">&quot; \</span><span class="si">{1:s}</span><span class="s2"> &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="p">,</span> <span class="n">path_to_outcar</span><span class="p">)</span> <span class="p">)</span>
            <span class="c1"># runBash(command_reduce)</span>


            <span class="k">if</span> <span class="s1">&#39;un2&#39;</span> <span class="ow">in</span> <span class="n">load</span><span class="p">:</span>
                <span class="n">out_name</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">)</span>
                <span class="n">cont_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_to_contcar</span><span class="p">)</span>
                <span class="n">path_to_outcar</span> <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="s1">&#39;OUTCAR&#39;</span><span class="p">)</span>
                <span class="n">path_to_contcar</span> <span class="o">=</span> <span class="n">path_to_contcar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cont_name</span><span class="p">,</span> <span class="s1">&#39;CONTCAR&#39;</span><span class="p">)</span>


            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">path_to_contcar</span> <span class="p">]</span>
            <span class="c1"># print(load)</span>
            <span class="c1"># print(files)</span>
            <span class="c1"># get_from_server(files = files, to = os.path.dirname(path_to_outcar),  addr = self.cluster_address)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="n">load</span><span class="p">)</span>


        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">load</span><span class="p">:</span>

            <span class="c1"># get_from_server(files = join(self.project_path_cluster, path_to_xml), to = os.path.dirname(path_to_outcar),  </span>
            <span class="c1">#     addr = self.cluster_address)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_to_xml</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="n">load</span><span class="p">)</span>





        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">):</span>
            <span class="n">outcar_exist</span>   <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcar_exist</span>   <span class="o">=</span> <span class="kc">False</span>
            <span class="n">path_to_zip</span> <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">+</span><span class="s1">&#39;.gz&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_zip</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path_to_zip</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>      <span class="c1"># unzip OUTCAR</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">):</span>
                    <span class="n">outcar_exist</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="sd">&quot;&quot;&quot;Start reading &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outcar_exist</span><span class="p">:</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">grep_file</span><span class="p">(</span><span class="s1">&#39;General timing&#39;</span><span class="p">,</span> <span class="n">path_to_outcar</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The grep result of&#39;</span><span class="p">,</span><span class="n">path_to_outcar</span><span class="p">,</span> <span class="s1">&#39;is:&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
            <span class="c1"># sys.exit()</span>
            <span class="k">if</span> <span class="s1">&#39;Gen&#39;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">or</span> <span class="s1">&#39;un&#39;</span> <span class="ow">in</span> <span class="n">load</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;4. Finished&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;5. Broken outcar&#39;</span>



        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;5. no OUTCAR&#39;</span>
        
        <span class="n">outst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>


        <span class="k">if</span> <span class="s2">&quot;4&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
            

            <span class="sd">&quot;&quot;&quot;Try to read xred from CONCAR and calculate xcart&quot;&quot;&quot;</span>

            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Path to CONTCAR&#39;</span><span class="p">,</span> <span class="n">path_to_contcar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_contcar</span><span class="p">):</span>
                <span class="n">contcar_exist</span>   <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">contcar_exist</span>   <span class="o">=</span> <span class="kc">False</span>


            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The status of CONTCAR file is&#39;</span><span class="p">,</span> <span class="n">contcar_exist</span><span class="p">)</span>
            <span class="c1"># self.end.update_xred()</span>
        
            <span class="k">if</span> <span class="n">contcar_exist</span><span class="p">:</span>
                <span class="c1"># try:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">read_poscar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">path_to_contcar</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># read from CONTCAR</span>
                <span class="c1"># except:</span>
                <span class="n">contcar_read</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention!, No CONTCAR:&#39;</span><span class="p">,</span> <span class="n">path_to_contcar</span><span class="p">,</span> <span class="s1">&#39;. I use data from outcar&#39;</span><span class="p">)</span>
                <span class="n">contcar_read</span> <span class="o">=</span> <span class="kc">False</span>






            <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">read</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#please use this only for linux or create cross-platform way</span>
                    <span class="n">nw</span> <span class="o">=</span> <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;sed -n &quot;/NPAR = approx SQRT( number of cores)/=&quot; &#39;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="p">)</span> <span class="c1">#remove warinig</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot;.tmp&quot;</span>
                    <span class="k">if</span> <span class="n">nw</span><span class="p">:</span>
                        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>
                        <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;sed &#39;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nw</span><span class="o">-</span><span class="mi">11</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nw</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d&#39; &quot;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="n">tmp</span><span class="o">+</span><span class="s2">&quot;;mv &quot;</span><span class="o">+</span><span class="n">tmp</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="p">)</span>


                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outcar</span><span class="p">:</span>
                    
                    <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;Start reading from &quot;</span><span class="o">+</span> <span class="n">path_to_outcar</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
                    <span class="n">outcarlines</span> <span class="o">=</span> <span class="n">outcar</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>




                <span class="n">re_lengths</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;length of vectors&quot;</span><span class="p">)</span>
                <span class="n">re_eltime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;Elapsed time&quot;</span><span class="p">)</span>
                <span class="n">re_nkpts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;NKPTS&quot;</span><span class="p">)</span>
                <span class="n">iterat</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">i_line</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mdstep_prev</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dipol</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">warnings</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nscflist</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">mdstep_old</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">niter_old</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">maxforce</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">average</span> <span class="o">=</span> <span class="p">[];</span>  <span class="n">gstress</span> <span class="o">=</span><span class="p">[]</span>
                <span class="c1"># mforce = []</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_e_without_entr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># try:</span>
                <span class="c1">#     self.end = copy.deepcopy(self.init) # below needed end values will be updated</span>
                <span class="c1"># except:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">contcar_read</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>

                <span class="c1"># if not hasattr(self.end, &quot;natom&quot;): </span>
                <span class="c1">#     self.end.natom = self.natom</span>
                <span class="c1">#Structure() #create structure object with end values after calculation</span>
                <span class="c1">#self.end.typat = self.typat</span>
                <span class="c1">#self.end.znucl = self.znucl</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.end&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">list_xcart</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">empty_struct</span><span class="p">()</span>

                <span class="n">de_each_md</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># to control convergence each md step</span>
                <span class="n">de_each_md_list</span> <span class="o">=</span> <span class="p">[]</span>


                <span class="n">nsgroup</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">magnitudes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mag_sum</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#toatal mag summed by atoms, +augmentation</span>

                <span class="n">tot_mag_by_atoms</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#magnetic moments by atoms on each step</span>
                <span class="n">tot_chg_by_atoms</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tot_mag_by_mag_atoms</span> <span class="o">=</span> <span class="p">[]</span>


                <span class="n">ldauu</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">e_sig0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#energy sigma 0 every scf iteration</span>
                <span class="n">occ_matrices</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># the number of atom is the key</span>

                <span class="c1">#which kind of forces to use</span>
                <span class="k">if</span> <span class="s1">&#39; CHAIN + TOTAL  (eV/Angst)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">:</span>
                    <span class="n">force_keyword</span> <span class="o">=</span> <span class="s1">&#39;CHAIN + TOTAL  (eV/Angst)&#39;</span>
                    <span class="n">ff</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">force_prefix</span> <span class="o">=</span> <span class="s1">&#39; chain+tot &#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">force_keyword</span> <span class="o">=</span> <span class="s1">&#39;TOTAL-FORCE&#39;</span>
                    <span class="n">ff</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="n">force_prefix</span> <span class="o">=</span> <span class="s1">&#39; tot &#39;</span>



                <span class="c1"># try:</span>
                <span class="c1">#     spin_polarized = self.set.spin_polarized # again it will be better to determine this from outcar </span>
                <span class="c1"># except:</span>
                <span class="c1">#     spin_polarized = None</span>



                <span class="bp">self</span><span class="o">.</span><span class="n">potcar_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stress</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intstress</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">:</span>

                    <span class="c1">#Check bands</span>

                    <span class="c1"># if &#39;band No.&#39; in line:</span>
                    <span class="c1">#     kpoint = float(outcarlines[i_line-1].split()[1])</span>
                    <span class="c1">#     lastocc = float(outcarlines[i_line+self.nbands].split()[2])</span>
                    <span class="c1">#     lastbandno = outcarlines[i_line+self.nbands].split()[0]</span>
                    <span class="c1">#     if lastocc &gt; 0:</span>
                    <span class="c1">#         print &quot;Warning!!! at kpoint &quot;, kpoint, &quot; last band No. &quot;,lastbandno, &quot; is not empty &quot;, lastocc</span>

                    <span class="k">if</span> <span class="s1">&#39;TITEL&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">potcar_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span> <span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;LEXCH  =&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print(line)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">xc_pot</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1">#xc from potential </span>

                    <span class="k">if</span> <span class="s1">&#39;GGA     =&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print(line)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">xc_inc</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1">#xc from incar</span>

                    <span class="k">if</span> <span class="s1">&#39;ions per type =&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">contcar_read</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">:]]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">)</span>

                            <span class="c1">#correction of bug; Take into account that VASP changes typat by sorting impurities of the same type.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c1">#correction of bug</span>



                            <span class="c1"># print(self.potcar_lines)</span>
                            <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">potcar_lines</span><span class="p">]</span>
                            <span class="c1"># printlog(&#39;I read &#39;,elements, &#39;from outcar&#39;)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="p">[</span><span class="n">element_name_inv</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">]</span>
                            <span class="c1"># print (self.end.znucl)</span>

                        <span class="n">ifmaglist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">get_maglist</span><span class="p">()</span>


                    <span class="k">if</span> <span class="s1">&#39;ISPIN&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
                            <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span> <span class="o">=</span> <span class="n">spin_polarized</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">False</span>


                    <span class="k">if</span> <span class="s2">&quot;TOO FEW BANDS&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! TOO FEW BANDS!!!</span><span class="se">\n\n\n</span><span class="s2">Warning! TOO FEW BANDS!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



                    <span class="c1">#Check W(q)</span>
                    <span class="k">if</span> <span class="s1">&#39;operators is LMAX&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">lmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">7</span><span class="p">])</span>
                        <span class="c1"># print &#39;lmax&#39;, lmax</span>
                    <span class="k">if</span> <span class="s2">&quot;W(low)/X(q)&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
                        <span class="n">low</span> <span class="o">=</span> <span class="p">[];</span> 
                        <span class="n">high</span> <span class="o">=</span> <span class="p">[];</span>
                        
                        <span class="k">while</span> <span class="n">kk</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;Optimization&#39;</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span> 
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="s1">&#39;PSMAXN&#39;</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]:</span>
                                <span class="c1"># print(line)</span>
                                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! PSMAXN for non-local potential too small&#39;</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="c1"># print( &#39;line&#39;, outcarlines[i_line + kk])</span>

                            <span class="n">low</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span>
                            <span class="n">high</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">])</span> <span class="p">)</span>
                            <span class="n">kk</span><span class="o">+=</span><span class="mi">1</span>


                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">low</span><span class="o">+</span><span class="n">high</span><span class="p">):</span>
                            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;W(q)/X(q) are too high, check output!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Low + high = &#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">+</span><span class="n">high</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>
                            <span class="n">print_and_log</span><span class="p">([</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">low</span><span class="o">+</span><span class="n">high</span><span class="p">],</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="s2">&quot;direct lattice vectors&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">contcar_read</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">v</span><span class="p">]</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; -&#39;</span><span class="p">)</span>
                                <span class="c1"># print(line)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>   <span class="p">]</span> <span class="p">)</span>


                        <span class="c1">#print self.end.rprimd</span>
                        <span class="c1">#print self.rprimd</span>
                    <span class="k">if</span> <span class="s2">&quot;POSITION&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># if not contcar_exist or out_type == &#39;xcarts&#39;:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">contcar_read</span> <span class="ow">or</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;xcarts&#39;</span><span class="p">:</span>
                            <span class="n">local_xcart</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                                <span class="c1">#print outcarlines[i_line+1+i].split()[0:3] </span>
                                <span class="n">xcart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span> <span class="p">(</span> 
                                            <span class="p">[</span>   <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>   <span class="p">]</span> 
                                        <span class="p">)</span>
                                
                                <span class="n">local_xcart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xcart</span> <span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">local_xcart</span>

                    
                            <span class="k">if</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;xcarts&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">list_xcart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_xcart</span><span class="p">)</span> <span class="c1">#xcart at each step only for dimer</span>

                                <span class="c1">#the change of typat is accounted below</span>

                    <span class="k">if</span> <span class="s2">&quot;number of electron &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print line</span>
                        <span class="c1"># print line.split()[-1]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">magn1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">magn1</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="s2">&quot;augmentation part &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">magn2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">magn2</span> <span class="o">=</span> <span class="mi">0</span>


                    <span class="k">if</span> <span class="n">force_keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># Calculate forces here...</span>
                        <span class="n">forces</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">magnitudes</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># print(self.end.select)</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="c1"># print &quot;parts&quot;, parts</span>
                            <span class="c1"># sys.exit()</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                                <span class="c1"># print(float(parts[ff[0]]), self.end.select[j][0])</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="c1"># print (self.end.select)</span>
                                <span class="k">for</span> <span class="n">kkk</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                                    <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">kkk</span><span class="p">]</span>
                                    <span class="c1"># print(cur)</span>
                                    
                                    <span class="k">if</span> <span class="n">cur</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span><span class="c1"># or &#39;F&#39; in cur:</span>
                                        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="n">cur</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span><span class="c1"># or &#39;T&#39; in cur:</span>
                                        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
                                <span class="c1"># print(b)</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                                <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                                <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                            
                            
                            <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
                            <span class="n">magnitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">))</span>
                        <span class="c1"># print(&#39;new step:&#39;)</span>
                        <span class="c1"># for f, s in zip(forces, self.end.select):</span>
                        <span class="c1">#     print(&#39;{:5.2f} {:5.2f} {:5.2f} {}&#39;.format(*f, s))</span>
                        <span class="c1"># sys.exit()</span>
                        <span class="n">average</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">red_prec</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                        <span class="n">maxforce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">imax</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)]</span>  <span class="p">)</span>
                        <span class="c1"># mforce.append( round(magnitudes[imax] * 1000))</span>
                        
                   

                    <span class="c1">#Check total drift</span>
                    <span class="k">if</span> <span class="s2">&quot;total drift:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1">#print line</span>
                        <span class="n">tdrift</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]]</span>
                        <span class="c1">#if any(d &gt; 0.001 and d &gt; max(magnitudes) for d in tdrift):</span>
                            <span class="c1">#print_and_log(&quot;Total drift is too high = &quot;+str(tdrift)+&quot;, check output!\n&quot;)</span>
                            <span class="c1">#pass</span>


                    <span class="k">if</span> <span class="s2">&quot;g(Stress)&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1">#print line</span>
                        <span class="n">gstress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="mi">1000</span> <span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>  <span class="p">)</span>
                    <span class="c1">#if &quot;Total&quot; in line:</span>
                        <span class="c1">#gstress.append( red_prec(float(line.split()[4])*1000 *100, 1000 )  )</span>
                    <span class="k">if</span> <span class="s2">&quot;volume of cell&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>                     
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> 
                            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! Cant read volume in calc &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1">#print self.vol      </span>

                    <span class="k">if</span> <span class="s2">&quot;generate k-points for:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>  <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]]</span>  <span class="p">)</span>
                        <span class="c1">#print self.set.ngkpt</span>

                      <span class="c1"># Kohn-Sham hamiltonian: http://en.wikipedia.org/wiki/Kohn%E2%80%93Sham_equations</span>
                      <span class="c1">#kinetic energy</span>
                      <span class="c1">#+ the external potential + the exchange-correlation energy +</span>
                      <span class="c1">#+ Hartree (or Coulomb) energy</span>
                    <span class="c1"># print line</span>
                    
                    <span class="k">if</span>  <span class="s2">&quot;alpha Z        PSCENC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print line</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># the electrostatic interaction of the ions in a compensating electron gas.</span>

                    <span class="k">if</span>  <span class="s2">&quot;Ewald energy   TEWEN&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">ewald</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># the electrostatic interaction of the ions in a compensating electron gas.</span>
                        <span class="c1"># print self.energy.ewald</span>
                    <span class="k">if</span>  <span class="s2">&quot;-1/2 Hartree   DENC&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;-Hartree energ DENC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">hartree</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#Coulomb electron-electron energy</span>
                        <span class="c1"># print self.energy.hartree</span>
                    <span class="k">if</span>  <span class="s2">&quot;-V(xc)+E(xc)   XCENC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Kohn-Sham exchange-correlation energy</span>
                    <span class="k">if</span>  <span class="s2">&quot;PAW double counting&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">pawdc1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">pawdc2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#</span>
                    <span class="k">if</span>  <span class="s2">&quot;eigenvalues    EBANDS&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">bands</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># - Kohn Sham eigenvalues - include kinetic energy , but not exactly</span>
                    <span class="k">if</span>  <span class="s2">&quot;atomic energy  EATOM&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">atomic</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#energy of atoms in the box</span>



                    <span class="k">if</span> <span class="s2">&quot;energy  without entropy=&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1">#self.energy = float(line.split()[4])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">e_without_entr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">])</span> <span class="c1">#energy(sigma-&gt;0)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span>  <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">list_e_without_entr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">e_without_entr</span>  <span class="p">)</span>

                        <span class="n">de_each_md_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">de_each_md</span><span class="p">)</span>


                    <span class="k">if</span> <span class="s2">&quot;energy without entropy =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">e_sig0_prev</span> <span class="o">=</span> <span class="n">e_sig0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">e_sig0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">7</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">e_sig0</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">de_each_md</span> <span class="o">=</span> <span class="n">e_sig0_prev</span> <span class="o">-</span> <span class="n">e_sig0</span>

                    <span class="k">if</span> <span class="s2">&quot;free  energy   TOTEN  =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1">#self.energy = float(line.split()[4])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">energy_free</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">#F free energy</span>
                    




                    <span class="k">if</span> <span class="n">re_lengths</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vlength</span> <span class="o">=</span> <span class="p">[</span><span class="n">red_prec</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="mi">1000</span> <span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
                        <span class="c1">#print self.vlength</span>
                    <span class="k">if</span> <span class="s2">&quot;in kB&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print(line)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; -&#39;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">stress</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]]</span>  <span class="c1"># in MPa </span>
                    <span class="k">if</span> <span class="s2">&quot;Total  &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print(line)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; -&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">intstress</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span> <span class="c1">#stress in internal units; can be regarded as forces</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">intstress</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;external pressure =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                        <span class="c1">#print iterat</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extpress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="c1"># in MPa </span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extpress_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extpress</span>

                    <span class="k">if</span> <span class="s2">&quot;E-fermi :&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                        <span class="c1"># print line</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">efermi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># in eV</span>


                    <span class="k">if</span> <span class="s2">&quot;Elapsed time&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">re_nkpts</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">NKPTS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s2">&quot;WARNING&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">warnings</span> <span class="o">+=</span> <span class="mi">1</span><span class="c1">#line</span>


                    <span class="k">if</span> <span class="s2">&quot;Subroutine DYNSYM returns&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nsgroup</span><span class="p">:</span>
                        <span class="n">nsgroup</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="c1">#number of space group operations</span>
                    <span class="c1"># if nsgroup == None:</span>
                    <span class="k">if</span> <span class="s2">&quot;Subroutine GETGRP returns:&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nsgroup</span><span class="p">:</span>
                        <span class="n">nsgroup</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>    


                    <span class="k">if</span> <span class="s2">&quot;Iteration&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">iterat</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="c1"># print self.mdstep</span>
                        <span class="c1"># print line</span>
                        <span class="k">if</span> <span class="n">mdstep_old</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span><span class="p">:</span>
                            <span class="n">nscflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">niter</span> <span class="p">)</span> <span class="c1"># add to list number of scf iterations during mdstep_old</span>
                        <span class="n">niter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="c1">#number of scf iterations</span>
                        <span class="n">mdstep_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span>


                    <span class="k">if</span> <span class="s1">&#39;number of electron &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print (line)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mag_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="s1">&#39;augmentation part&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print (line)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mag_sum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="s1">&#39;total charge &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">chg</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                            <span class="n">chg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span>
                        
                        <span class="n">tot_chg_by_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chg</span><span class="p">))</span><span class="c1">#[ifmaglist])                    </span>


                    <span class="k">if</span> <span class="s1">&#39;magnetization (x)&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print(line)</span>
                        <span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                            <span class="n">mags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span>
                        
                        <span class="n">tot_mag_by_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mags</span><span class="p">))</span><span class="c1">#[ifmaglist])</span>
                        <span class="c1"># print(ifmaglist)</span>
                        <span class="n">tot_mag_by_mag_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mags</span><span class="p">)[</span><span class="n">ifmaglist</span><span class="p">])</span>
                        <span class="c1"># print tot_mag_by_atoms</span>
                        <span class="c1"># magnetic_elements</span>
                        <span class="c1"># ifmaglist</span>
                        <span class="c1"># self.tot_mag_by_atoms = tot_mag_by_atoms</span>



                    <span class="k">if</span> <span class="s1">&#39;LDAUU&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">ldauu</span> <span class="o">=</span> <span class="n">line</span>


                    <span class="k">if</span> <span class="s1">&#39;onsite density matrix&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">i_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>  <span class="p">)</span> <span class="c1">#starting from one</span>
                        <span class="n">l_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">8</span><span class="p">]</span>  <span class="p">)</span>
                        <span class="c1"># print (spin_polarized)</span>
                        <span class="n">spin1</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">spin2</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">l_at</span><span class="o">+</span><span class="mi">1</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">spin1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Warning! Somthing wrong with occ matrix:&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">spin_polarized</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
                                <span class="c1"># try:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="mi">7</span><span class="o">+</span><span class="n">nm</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
                                <span class="c1"># print(line)</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; -&#39;</span><span class="p">)</span>
                                <span class="n">spin2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="p">)</span>
                                <span class="c1"># except:</span>
                                <span class="c1">#     printlog(&#39;Attention! Could not read spin2, probably no spaces&#39;)</span>
                                <span class="c1">#     spin2.append(0)        </span>

                        <span class="n">occ_matrices</span><span class="p">[</span><span class="n">i_at</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">spin1</span><span class="o">+</span><span class="n">spin2</span>
                        <span class="c1"># print (np.array(spin1) )</span>


                    <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>

                        <span class="k">if</span> <span class="s1">&#39;Eigenvectors and eigenvalues of the dynamical matrix&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">freq</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="s1">&#39;ELASTIC MODULI CONTR FROM IONIC RELAXATION&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s1">&#39;f  =&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                    <span class="n">freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span> <span class="c1">#THz</span>
                                    <span class="c1"># print(line)</span>


                    <span class="k">if</span> <span class="s1">&#39;TOTAL ELASTIC MODULI&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">eltensor</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">eltensor</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]])</span>

                        <span class="n">eltensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eltensor</span><span class="p">)</span>
                        <span class="c1"># print(eltensor)</span>
                        <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">eltensor</span><span class="p">)</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Eigenvalues are:&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                                <span class="c1"># eltensor</span>

                    <span class="k">if</span> <span class="s1">&#39;average eigenvalue GAMMA=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># print(line)</span>
                        <span class="n">gamma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">gamma</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;conv&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;average eigenvalue GAMMA &gt;1&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                        <span class="c1"># sys.exit()</span>



                    <span class="c1"># if &#39;DIPCOR: dipole corrections for dipol&#39; in line:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">&gt;</span> <span class="n">mdstep_prev</span><span class="p">:</span>
                        <span class="c1"># print(self.mdstep, dipol)</span>
                        <span class="n">mdstep_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span>

                    <span class="k">if</span> <span class="s1">&#39;dipolmoment&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">dipol</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dipol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dipol</span><span class="p">]</span>
                        <span class="c1"># print(line)</span>

                        <span class="c1"># for i in range(1,4):</span>
                        <span class="c1">#     line = outcarlines[i_line+i]</span>
                        <span class="c1">#     print(line)</span>



                    <span class="c1"># if &#39;irreducible k-points:&#39;: in line:</span>
                    <span class="c1">#     self.nkpt = int(line.split()[1])</span>




                    <span class="n">i_line</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># sys.exit()</span>
                <span class="c1">#Check total drift</span>
                






            <span class="k">try</span><span class="p">:</span>
                <span class="n">toldfe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">toldfe</span>  <span class="c1"># eV</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">toldfe</span> <span class="o">=</span> <span class="mi">0</span>




            <span class="n">max_magnitude</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span>
            <span class="n">max_tdrift</span>    <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tdrift</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxforce</span> <span class="o">=</span> <span class="n">maxforce</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># if max_magnitude &lt; self.set.toldff/10: max_magnitude = self.set.toldff</span>
            <span class="c1"># print &#39;magn&#39;, magnitudes</span>
            <span class="c1"># print &#39;totdr&#39;, tdrift</span>
            <span class="c1"># print &#39;max_magnitude&#39;, max_magnitude</span>
            <span class="k">try</span><span class="p">:</span> 
                
                <span class="k">if</span> <span class="n">max_magnitude</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">tolmxf</span><span class="p">:</span> 
                    <span class="n">max_magnitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">tolmxf</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>

            <span class="c1">#if any(d &gt; 0.001 and d &gt; max_magnitude for d in tdrift):</span>
            <span class="k">if</span> <span class="n">max_tdrift</span> <span class="o">&gt;</span> <span class="mf">0.001</span> <span class="ow">and</span> <span class="n">max_tdrift</span> <span class="o">&gt;</span> <span class="n">max_magnitude</span><span class="p">:</span>
                
                <span class="n">printlog</span><span class="p">(</span> <span class="s2">&quot;Total drift is too high! At the end one component is </span><span class="si">{:2.1f}</span><span class="s2"> of the maximum force, check output!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_tdrift</span><span class="p">)</span>  <span class="p">)</span>
                <span class="k">pass</span>
            <span class="c1">#else: maxdrift = </span>
            <span class="c1"># print magn</span>
            <span class="k">if</span> <span class="n">tot_mag_by_atoms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">tot_mag_by_atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="sd">&quot;&quot;&quot;update xred&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">update_xred</span><span class="p">()</span>









            <span class="c1">#print &quot;init pressure = &quot;,self.extpress_init,&quot;; final pressure =&quot;,self.extpress</span>
            <span class="c1">#print self.end.xred</span>
            <span class="c1">#self.vol = np.dot( self.rprimd[0], np.cross(self.rprimd[1], self.rprimd[2])  ); #volume</span>
            <span class="n">nscflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">niter</span> <span class="p">)</span> <span class="c1"># add to list number of scf iterations during mdstep_old</span>
            <span class="c1">#print &quot;Stress:&quot;, self.stress</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlength</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vlength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlength</span>

            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stress</span>
            <span class="n">yznormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1">#print yznormal</span>
            <span class="c1">#print np.cross( yznormal, np.array([1,0,0]) )</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s1">&#39;gbpos&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="kc">None</span><span class="c1">#for compatability</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">gbpos</span> <span class="c1">#for compatability</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="n">yznormal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! The normal to yz is not parallel to x. Take care of gb area</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">yzarea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">yznormal</span> <span class="p">)</span>  <span class="c1">#It is assumed, that boundary is perpendicular to x</span>


            <span class="sd">&quot;&quot;&quot;Calculate voronoi volume&quot;&quot;&quot;</span>
            <span class="c1"># print hasattr(self, &#39;vorovol&#39;)</span>
            <span class="n">voro</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">voronoi</span><span class="p">:</span><span class="c1"># and not hasattr(self, &#39;vorovol&#39;):#out_type == &#39;e_seg&#39;:</span>
                <span class="n">voro</span> <span class="o">=</span> <span class="n">calculate_voronoi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">calculate_voronoi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span><span class="p">)</span>


            <span class="c1">#deal with ldauu</span>
            <span class="n">u_hubbard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">ldauu</span><span class="p">:</span> 
                <span class="n">ldauu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ldauu</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">7</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="c1"># print (ldauu)</span>
                <span class="c1">#find first non-zero</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ldauu</span> <span class="o">=</span> <span class="n">ldauu</span>
                <span class="n">u_hubbard</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">next</span><span class="p">((</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">ldauu</span> <span class="k">if</span> <span class="n">u</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
                <span class="c1"># print ( np.unique(ldauu)  )</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ldauu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1">#Check if energy is converged relative to relaxation</span>
            <span class="n">e_diff_md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">e_diff_md</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">1000</span> <span class="c1">#meV</span>

            <span class="n">e_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_sig0_prev</span> <span class="o">-</span> <span class="n">e_sig0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1">#meV</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">toldfe</span><span class="o">*</span><span class="mi">1000</span><span class="p">:</span>
                <span class="n">toldfe_warning</span> <span class="o">=</span> <span class="s1">&#39;!&#39;</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Attention!, SCF was not converged to desirable prec&quot;</span><span class="p">,</span> 
                    <span class="nb">round</span><span class="p">(</span><span class="n">e_diff</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">toldfe</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;meV&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">toldfe_warning</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;conv&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">de</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">de_each_md_list</span> <span class="p">):</span>
                    <span class="k">if</span> <span class="n">de</span><span class="o">/</span><span class="n">toldfe</span> <span class="o">&gt;</span> <span class="mf">1.01</span><span class="p">:</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! bad SCF convergence </span><span class="si">{:6.1g}</span><span class="s1"> eV for MD step </span><span class="si">{:}</span><span class="s1">; toldfe = </span><span class="si">{:6.0g}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">de</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">toldfe</span><span class="p">))</span>


            <span class="c1">#  Construct beatifull table</span>
            <span class="c1">#self.a1 = float(v[0])/2 ; self.a2 = float(v[1])/2/math.sqrt(0.75); self.c = float(v[2])  # o1b</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span>  <span class="c1"># c1b</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#calculations with full relaxation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="mi">35</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">etot</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">etot1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># print self.a</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span>      <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="p">)</span>      <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span>      <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">)</span>      <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">/</span><span class="mf">3600.</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">itertm</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">/</span><span class="mf">1.</span><span class="o">/</span><span class="n">iterat</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">Nmd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%1i</span><span class="s2">,</span><span class="si">%2i</span><span class="s2">,</span><span class="si">%3i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span><span class="p">,</span> <span class="n">iterat</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span><span class="p">,</span> <span class="n">iterat</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterat</span> <span class="o">=</span> <span class="n">iterat</span>
            <span class="n">War</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">warnings</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="c1">#nbands = (&quot;%i&quot; % (self.set.vasp_params[&quot;NBANDS&quot;])    ).center(j[8])</span>
            <span class="c1">#added = (&quot;%.0f&quot; % ( (self.set.add_nbands - 1) * 100 )    ).center(j[15])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kmesh</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">)</span> <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">()</span>
                <span class="n">kspacing</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%.2f</span><span class="s2">,</span><span class="si">%.2f</span><span class="s2">,</span><span class="si">%.2f</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="n">ks1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%.2f</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">kmesh</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">ks</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">kspacing</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">ks1</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">nkpt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">)</span>     <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">:</span>
                <span class="n">istrs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%5i</span><span class="s2">,</span><span class="si">%5i</span><span class="s2">,</span><span class="si">%5i</span><span class="s2">] &quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">intstress</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">intstress</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">intstress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
                <span class="n">strs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">,</span><span class="si">%.0f</span><span class="s2">,</span><span class="si">%.0f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>   
                <span class="n">eprs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extpress</span><span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">istrs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">strs</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">eprs</span> <span class="o">=</span>  <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tsm</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">tsmear</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">tsm</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">entrr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_free</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="o">*</span> <span class="mi">1000</span>    <span class="p">)</span>   <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="c1">#entropy due to the use of smearing</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">npar</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;NPAR&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
                <span class="n">lpl</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;LPLANE&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span>
                <span class="n">ecut</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;ENCUT&quot;</span><span class="p">])</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span> 
            <span class="k">except</span><span class="p">:</span>
                <span class="n">npar</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">lpl</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">ecut</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># lens = (&quot;%.2f;%.2f;%.2f&quot; % (v[0],v[1],v[2] ) ).center(j[19])</span>
            <span class="n">lens</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:4.2f}</span><span class="s2">;</span><span class="si">{:4.2f}</span><span class="s2">;</span><span class="si">{:4.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> 
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">19</span><span class="p">])</span>            
            <span class="n">vol</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">20</span><span class="p">])</span>
            <span class="n">nat</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">21</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">totd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>   <span class="n">max_tdrift</span><span class="o">/</span><span class="n">max_magnitude</span> <span class="o">*</span> <span class="mi">100</span>      <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">totd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">nsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>     <span class="n">nsgroup</span>     <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span>
            <span class="n">Uhu</span>   <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{:3.1f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u_hubbard</span><span class="p">)</span>
            <span class="n">ed</span>    <span class="o">=</span> <span class="s1">&#39; </span><span class="si">{:3.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">e_diff</span><span class="p">)</span>
            <span class="n">edg</span>   <span class="o">=</span> <span class="s1">&#39; </span><span class="si">{:3.1f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">e_diff_md</span><span class="p">)</span>
            <span class="n">spg</span>   <span class="o">=</span> <span class="s1">&#39; </span><span class="si">{:4s}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">sg</span><span class="p">(</span><span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="sd">&quot;&quot;&quot;Warning! concentrations are calculated correctly only for cells with one impurity atom&quot;&quot;&quot;</span>
            <span class="c1">#gbcon = (&quot;%.3f&quot; % (     1./self.end.yzarea      ) ).center(j[23]) # surface concentation at GB A-2</span>
            <span class="c1">#bcon = (&quot;%.1f&quot; % (     1./self.natom * 100      ) ).center(j[24]) # volume atomic concentration, %</span>
            <span class="c1">#outstring_nbands = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+nbands+d+added+&quot;\\\\&quot;</span>
            <span class="c1">#outstring_npar = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+npar+d+lpl+&quot;\\\\&quot;</span>

            <span class="c1">#outstring_stress = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+istrs+d+eprs</span>

            <span class="c1">#outstring_kp_ec = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+strs+d+eprs+d+kmesh+d+ecut+&quot;\\\\&quot;</span>
            <span class="n">outst_ecut</span><span class="o">=</span> <span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span>                                            <span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">itertm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">ecut</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>
            <span class="n">outst_kp</span>  <span class="o">=</span> <span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span>                                            <span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">itertm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kmesh</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nkpt</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>            
            <span class="n">outst_ts</span>  <span class="o">=</span> <span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span>                                            <span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">itertm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kmesh</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">tsm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">entrr</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>

            <span class="n">outst_all</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">lens</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>
            <span class="n">outst_seg</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span>        <span class="n">lens</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">ks1</span>     <span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1">#for segregation</span>
            <span class="n">outst_coseg</span><span class="o">=</span><span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span>                                <span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1">#for co-segregation; </span>
            <span class="n">outst_gbe</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span>               <span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1"># For comparing gb energies and volume</span>
            <span class="n">outst_imp</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">lens</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span>       <span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1"># For comparing impurity energies</span>
            
            <span class="n">outst_cathode</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">spg</span><span class="p">,</span><span class="n">etot</span><span class="p">,</span> <span class="n">etot1</span><span class="p">,</span> <span class="n">lens</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span><span class="n">nkpt</span><span class="p">,</span> <span class="n">strs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">Nmd</span><span class="p">,</span> <span class="n">War</span><span class="p">,</span> <span class="n">nsg</span><span class="p">,</span> <span class="n">Uhu</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">edg</span> <span class="p">])</span>
            <span class="c1"># print self.end.xred[-1]</span>
            <span class="c1">#print outstring_kp_ec</span>
            <span class="c1"># print show</span>
            <span class="c1"># print &#39;force&#39; in show</span>


            <span class="k">if</span> <span class="s1">&#39;conv&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="c1"># print(&#39;asdf&#39;, de_each_md_list)</span>
                <span class="c1"># show achived convergence every step with respect to toldfe, should be less than 1</span>
                <span class="c1"># np.set_printoptions(linewidth=150, formatter={&#39;float&#39;:lambda x: &quot;%3.0f-&gt;&quot; % x}) #precision=1,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="p">)</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Conv each step, de/toldfe (toldfe = </span><span class="si">{:.0g}</span><span class="s1"> eV) =  </span><span class="se">\n</span><span class="si">{:}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toldfe</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">de</span><span class="o">/</span><span class="n">toldfe</span> <span class="k">for</span> <span class="n">de</span> <span class="ow">in</span> <span class="n">de_each_md_list</span> <span class="p">])),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            



            <span class="k">if</span> <span class="s1">&#39;fo&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="c1"># print &quot;Maxforce by md steps (meV/A) = %s;&quot;%(str(maxforce)  )</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Max. F.&quot;</span><span class="o">+</span><span class="n">force_prefix</span><span class="o">+</span><span class="s2">&quot; (meV/A) = </span><span class="se">\n</span><span class="si">{:}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maxforce</span> <span class="p">])[:]</span>  <span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
                <span class="c1"># print &quot;\nAve. F. (meV/A) = \n%s;&quot;%(  np.array(average)  )</span>
                <span class="c1"># import inspect</span>
                <span class="c1"># print inspect.getargspec(plt.plot).args</span>
                <span class="c1"># print plt.plot.__doc__</span>
                <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maxforce</span><span class="p">,</span> <span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;MD step&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Max. force on atom (meV/$\AA$)&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="s1">&#39;sur&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sumAO</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">devAO</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">get_elements</span><span class="p">():</span>
                        <span class="n">pos</span>  <span class="o">=</span> <span class="n">determine_symmetry_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
                        <span class="c1"># print(pos)</span>
                        <span class="c1"># sys.exit()</span>
                        <span class="c1"># xc = self.end.xcart[pos[0][0]]</span>
                        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                            <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
                                <span class="n">neib</span> <span class="o">=</span> <span class="mi">6</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">neib</span> <span class="o">=</span> <span class="mi">6</span>
                            <span class="n">sumAO</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">neib</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span><span class="p">)</span><span class="c1">#[0]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">devAO</span><span class="p">[</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-O&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">neib</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;av_dev&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;d_av &#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-O:&#39;</span><span class="p">,</span><span class="n">sumAO</span> <span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dev_av &#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-O:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">devAO</span><span class="p">[</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-O&#39;</span><span class="p">]</span> <span class="p">)</span>
                            <span class="n">AO</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">neib</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;mavm&#39;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;d_min, d_avex, d_max: </span><span class="si">{:4.2f}</span><span class="s1">, </span><span class="si">{:4.2f}</span><span class="s1">, </span><span class="si">{:4.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">AO</span><span class="p">))</span>




                            <span class="bp">self</span><span class="o">.</span><span class="n">sumAO</span><span class="p">[</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-O&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sumAO</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">show_around_x</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="n">nnumber</span> <span class="o">=</span> <span class="n">neib</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-OF&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">neib</span><span class="p">),</span> <span class="n">analysis</span> <span class="o">=</span> <span class="s1">&#39;imp_surrounding&#39;</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">]:</span>
                                <span class="n">neib</span> <span class="o">=</span> <span class="mi">2</span>
                                <span class="n">sumAO</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">neib</span><span class="p">,</span> <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">26</span><span class="p">,],</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span><span class="p">)</span><span class="c1">#[0]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">show_around_x</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="n">nnumber</span> <span class="o">=</span> <span class="n">neib</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-Fe&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">neib</span><span class="p">),</span> <span class="n">analysis</span> <span class="o">=</span> <span class="s1">&#39;imp_surrounding&#39;</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">26</span><span class="p">])</span>
                                
                                <span class="nb">print</span><span class="p">(</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-Fe&#39;</span><span class="p">,</span><span class="n">sumAO</span> <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sumAO</span><span class="p">[</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39;-Fe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sumAO</span>


            <span class="k">if</span> <span class="s1">&#39;en&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">maxf</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maxforce</span> <span class="p">]</span>
                    <span class="c1"># print(maxf)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maxf</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">)</span>
                    <span class="c1"># plt.xlabel(&#39;MD step&#39;)</span>
                    <span class="c1"># plt.ylabel(&#39;Energy per cell (eV&#39;)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Max. force on atom (meV/$\AA$)&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Energy per cell relative to min (meV)&#39;</span><span class="p">)</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;smag&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="c1"># printlog(&#39;{:s}&#39;.format([round(m) for m in self.mag_sum]), imp = &#39;Y&#39; )</span>
                <span class="n">printlog</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_sum</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;mag&#39;</span> <span class="ow">in</span> <span class="n">show</span> <span class="ow">or</span> <span class="s1">&#39;occ&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">siman.analysis</span> <span class="k">import</span> <span class="n">around_alkali</span>
                <span class="n">numb</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">chosen_ion</span> <span class="o">=</span> <span class="n">around_alkali</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alkali_ion_number</span><span class="p">)</span>
                
                <span class="c1">#probably not used anymore</span>
                <span class="c1"># dist_dic = {}</span>
                <span class="c1"># self.dist_numb = zip(dist, numb)</span>
                <span class="c1"># for d, n in self.dist_numb:</span>
                <span class="c1">#     dist_dic[n] = d </span>
                <span class="c1">#probably not used anymore</span>


            <span class="k">if</span> <span class="s1">&#39;mag&#39;</span> <span class="ow">in</span> <span class="n">show</span> <span class="ow">and</span> <span class="n">tot_mag_by_atoms</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># print_and_log</span>
                <span class="c1"># print &#39;Final mag moments for atoms:&#39;</span>
                <span class="c1"># print np.arange(self.end.natom)[ifmaglist]+1</span>
                <span class="c1"># print np.array(tot_mag_by_atoms)</span>

                <span class="c1"># print (tot_mag_by_atoms)</span>
                <span class="c1"># if tot_mag_by_atoms:</span>
                <span class="c1"># print (&#39;first step &#39;, tot_mag_by_atoms[0][numb].round(3) )</span>
                <span class="c1"># print (&#39;first step all &#39;, tot_mag_by_atoms[0][ifmaglist].round(3) )</span>
                <span class="c1"># for mag in tot_mag_by_atoms:</span>
                <span class="c1">#     print (&#39;  -&#39;, mag[numb].round(3) )</span>

                <span class="c1"># print (&#39;last  step &#39;, tot_mag_by_atoms[-1][numb].round(3), tot_chg_by_atoms[-1][numb].round(3) )</span>
                <span class="n">mmm</span> <span class="o">=</span> <span class="n">tot_mag_by_atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">numb</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;atom:mag  = &#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{:4.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iat</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">iat</span><span class="p">,</span> <span class="n">m</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>  <span class="n">numb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mmm</span>   <span class="p">))</span> <span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="s1">&#39;&#39;</span>
                    <span class="c1"># print (&#39;last  step all&#39;, tot_mag_by_atoms[-1][ifmaglist].round(3) )</span>

                    <span class="c1"># sys.exit()</span>
                <span class="k">if</span> <span class="n">chosen_ion</span><span class="p">:</span>
                    <span class="n">printlog</span> <span class="p">(</span><span class="s1">&#39;Dist from 1st found alkali ion &#39;</span><span class="p">,</span><span class="n">element_name_inv</span><span class="p">(</span> <span class="n">chosen_ion</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="s1">&#39; to sur. transition met atoms: (Use *alkali_ion_number* to choose ion manually)&#39;</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;atom:dist = &#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iat</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">iat</span><span class="p">,</span> <span class="n">d</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>  <span class="n">numb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist</span>   <span class="p">)</span>  <span class="p">)</span> <span class="p">)</span>

                <span class="c1"># plt.plot(np.array(sur[3]).round(2), tot_mag_by_atoms[-1][numb]) mag vs dist for last step</span>
                
                <span class="c1"># print (&#39;Moments on all mag atoms:\n&#39;, tot_mag_by_atoms[-1][ifmaglist].round(3))</span>
                <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tot_mag_by_mag_atoms</span><span class="p">))</span> <span class="c1"># magnetization vs md step</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;chg&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tot_chg_by_atoms</span> <span class="o">=</span> <span class="n">tot_chg_by_atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#save for last step only</span>
                <span class="c1"># print(list(zip(self.end.get_elements(), self.tot_chg_by_atoms)))</span>
                <span class="n">els</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">only_el</span> <span class="o">=</span> <span class="n">show</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">only_el</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mulliken charges are:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">els</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_chg_by_atoms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">only_el</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">only_el</span> <span class="ow">and</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">only_el</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:4.2f}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;occ&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>
                <span class="c1"># print (matrices)</span>
                <span class="c1"># print (df)</span>
                <span class="k">if</span> <span class="n">chosen_ion</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Distances (A) from alkali ion #&#39;</span><span class="p">,</span><span class="n">chosen_ion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39; to transition atoms:&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;,  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="s1">&#39;(</span><span class="si">{:}</span><span class="s1">&lt;-&gt;</span><span class="si">{:}</span><span class="s1">): </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chosen_ion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">iat</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>  <span class="n">dist</span><span class="p">,</span> <span class="n">numb</span><span class="o">+</span><span class="mi">1</span>  <span class="p">)</span>  <span class="p">]),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
                
                <span class="n">show_occ_for_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">show</span><span class="p">)]</span>
                <span class="c1"># print (show_occ_for_atom)</span>
                <span class="c1"># sys.exit()</span>
                <span class="k">if</span> <span class="n">show_occ_for_atoms</span><span class="p">:</span>
                    <span class="n">iat</span> <span class="o">=</span> <span class="n">show_occ_for_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                    <span class="c1"># dist_toi = dist_dic[iat]</span>
                    <span class="n">i_mag_at</span> <span class="o">=</span> <span class="n">iat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># dist_toi = dist[i]</span>
                    <span class="n">i_mag_at</span> <span class="o">=</span> <span class="n">numb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># print (st.znucl[st.typat[i_mag_at]-1] )</span>
                <span class="n">l05</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">occ_matrices</span><span class="p">[</span><span class="n">i_mag_at</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">occ_matrices</span><span class="p">[</span><span class="n">i_mag_at</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

                <span class="n">print_and_log</span><span class="p">(</span> <span class="s1">&#39;Occ. matrix for atom &#39;</span><span class="p">,</span> <span class="n">i_mag_at</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
                    <span class="c1"># &#39;:  ; dist to alk ion is &#39;,  dist_toi, &#39;A&#39;, end = &#39;\n&#39; )</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Spin 1:&#39;</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">l05</span><span class="p">],</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dxy&#39;</span><span class="p">,</span> <span class="s1">&#39;dyz&#39;</span><span class="p">,</span> <span class="s1">&#39;dz2&#39;</span><span class="p">,</span> <span class="s1">&#39;dxz&#39;</span><span class="p">,</span> <span class="s1">&#39;dx2-y2&#39;</span><span class="p">],</span> <span class="n">floatfmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;psql&#39;</span><span class="p">),</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
                <span class="c1"># print(&#39; &amp; &#39;.join([&#39;d_{xy}&#39;, &#39;d_{yz}&#39;, &#39;d_{z^2}&#39;, &#39;d_{xz}&#39;, &#39;d_{x^2-y^2}&#39;]))</span>
                <span class="c1"># print_and_log(tabulate(occ_matrices[i_mag_at][l05:], headers = [&#39;d_{xy}&#39;, &#39;d_{yz}&#39;, &#39;d_{z^2}&#39;, &#39;d_{xz}&#39;, &#39;d_{x^2-y^2}&#39;], floatfmt=&quot;.1f&quot;, tablefmt=&#39;latex&#39;),end = &#39;\n&#39; )</span>
                <span class="c1"># print(tabulate(a, tablefmt=&quot;latex&quot;, floatfmt=&quot;.2f&quot;))</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Spin 2:&#39;</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">l05</span><span class="p">:],</span> <span class="n">floatfmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;psql&#39;</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occ_matrices</span> <span class="o">=</span> <span class="n">occ_matrices</span>
            


            <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">dos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                <span class="c1"># from scipy.ndimage.filters import gaussian_filter</span>
                <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">butter</span><span class="p">,</span> <span class="n">lfilter</span><span class="p">,</span> <span class="n">freqz</span>
                <span class="c1"># blurred = gaussian_filter(freq, sigma=7)</span>
                <span class="n">fmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                <span class="n">fmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                <span class="n">fw</span>   <span class="o">=</span> <span class="n">fmax</span><span class="o">-</span><span class="n">fmin</span>

                <span class="n">finefreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">dos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>

                <span class="c1"># for i in range(1000):</span>
                <span class="c1"># print(fw)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freq</span><span class="p">:</span>
                    <span class="c1"># print(f)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">fmin</span><span class="p">)</span><span class="o">/</span> <span class="n">fw</span> <span class="o">*</span> <span class="mi">999</span> <span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">dos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="c1"># print(i, finefreq[i], f)</span>
                

                <span class="k">def</span> <span class="nf">butter_lowpass</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fs</span>
                    <span class="n">normal_cutoff</span> <span class="o">=</span> <span class="n">cutoff</span> <span class="o">/</span> <span class="n">nyq</span>
                    <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">normal_cutoff</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>

                <span class="k">def</span> <span class="nf">butter_lowpass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter_lowpass</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">y</span>

                <span class="n">order</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="mf">30.0</span>       <span class="c1"># sample rate, Hz</span>
                <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">3.667</span>  <span class="c1"># desired cutoff frequency of the filter, Hz</span>

                <span class="n">y</span> <span class="o">=</span> <span class="n">butter_lowpass_filter</span><span class="p">(</span><span class="n">finefreq</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">finefreq</span><span class="p">,</span> <span class="n">smoother</span><span class="p">(</span><span class="n">smoother</span><span class="p">(</span><span class="n">dos</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> <span class="mi">50</span><span class="p">),</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> 
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.eps&#39;</span><span class="p">)</span>
                <span class="c1"># plt.show()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

            <span class="c1"># sys.exit()</span>


            <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;Reading of results completed</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">path_to_outcar</span>
            

            <span class="k">if</span> <span class="n">pymatgen_flag</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>
                <span class="c1"># self.end.write_cif(os.path.join(self.dir,self.name))</span>
            

            <span class="c1"># print(out_type)</span>
            <span class="c1"># sys.exit()</span>
            <span class="k">if</span>   <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;gbe&#39;</span>  <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_gbe</span>
            <span class="k">elif</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;e_imp&#39;</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_imp</span>
            <span class="k">elif</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;e_seg&#39;</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_seg</span>            
            <span class="k">elif</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;coseg&#39;</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_coseg</span>            
            <span class="k">elif</span> <span class="s1">&#39;ecut&#39;</span> <span class="ow">in</span> <span class="n">out_type</span> <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_ecut</span>
            <span class="k">elif</span> <span class="s1">&#39;kp&#39;</span> <span class="ow">in</span> <span class="n">out_type</span>   <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_kp</span>
            <span class="k">elif</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">in</span> <span class="n">out_type</span>   <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_ts</span>
            
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">header</span><span class="o">.</span><span class="n">siman_run</span><span class="p">:</span>
                <span class="n">outst_simple</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">etot</span><span class="p">,</span> <span class="n">lens</span><span class="p">,</span> <span class="n">strs</span><span class="p">,</span> <span class="n">Nmd</span><span class="p">])</span>
                <span class="c1"># print(&quot;Bi2Se3.static.1               |  -20.1543  |    10.27;10.27;10.27    | -680,-680,-657 |   1,13, 13   |    &quot;)</span>
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">show_head</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;name                          |  energy(eV)|    Vector lenghts (A)   | Stresses (MPa)     | N MD, N SCF   &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">show_head</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_simple</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Output type: outst_cathode&#39;</span><span class="p">)</span>
                <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_cathode</span>
            <span class="c1">#else: print_and_log(&quot;Uknown type of outstring\n&quot;)</span>


            <span class="c1">#save cif file</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if not hasattr(cl,&#39;energy_sigma0&#39;):</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_unfinished&quot;</span><span class="p">)</span> 
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;read_results():&#39;</span><span class="p">,</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;is unfinished, continue:&#39;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;5. Unfinished&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;read_results():&#39;</span><span class="p">,</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;probably was not submitted:&#39;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">outst</span></div>




<div class="viewcode-block" id="CalculationVasp.determine_filenames"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.determine_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">determine_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nametype</span> <span class="o">=</span> <span class="s1">&#39;asoutcar&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        try to determine correct filenames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nametype</span> <span class="o">==</span> <span class="s1">&#39;asoutcar&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="s1">&#39;CHGCAR&#39;</span><span class="p">,</span> <span class="s1">&#39;AECCAR0&#39;</span><span class="p">,</span> <span class="s1">&#39;AECCAR2&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">filetype</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span><span class="n">filetype</span><span class="p">)</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;determine_filenames()&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">filetype</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span></div>



<div class="viewcode-block" id="CalculationVasp.get_file"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">nametype</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">):</span>
        <span class="c1">#allow to get any file of type filetype </span>
        <span class="c1">#cl - object of CalculationVasp class</span>
        <span class="c1">#filetype (str) - &#39;CHG&#39;, &#39;CHGCAR&#39;, etc just the name of file in calculation folder</span>
        <span class="c1">#nametype (str) - &#39;asoutcar&#39; - update filetype to OUTCAR format</span>
        <span class="c1">#up = up1 - donot update</span>
              <span class="c1">#up2 - update</span>

        <span class="c1">#Comment</span>
            <span class="c1">#initially used for chg files - rename!</span>
        <span class="k">if</span> <span class="n">nametype</span> <span class="o">==</span> <span class="s1">&#39;asoutcar&#39;</span><span class="p">:</span>
            <span class="n">path_to_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span><span class="n">filetype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">filetype</span>

        <span class="k">if</span> <span class="s1">&#39;CHGCAR&#39;</span> <span class="ow">in</span> <span class="n">filetype</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;chgcar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_to_file</span>
        <span class="k">elif</span> <span class="s1">&#39;xml&#39;</span> <span class="ow">in</span> <span class="n">filetype</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;xml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_to_file</span>


        <span class="c1"># print(path_to_file)</span>
        <span class="c1"># print(self.cluster_address)</span>
        <span class="c1"># print(self.project_path_cluster+&#39;/&#39;)</span>
        <span class="c1"># sys.exit()</span>
        <span class="n">path2file_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">path_to_file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;up2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span> 
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">get_from_server</span><span class="p">(</span><span class="n">path2file_cluster</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">),</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="n">path2file_cluster</span><span class="p">,</span> <span class="s1">&#39;was not found, trying archive:&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">.</span><span class="n">PATH2ARCHIVE</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            <span class="c1"># printlog(&#39;Charge file&#39;, path_to_file, &#39;was not found&#39;)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_home</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#project path without home</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># print(pp)</span>
            <span class="n">path_to_file_scratch</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">PATH2ARCHIVE</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">pp</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">path_to_file</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">get_from_server</span><span class="p">(</span><span class="n">path_to_file_scratch</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">),</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="n">path_to_file_scratch</span><span class="p">,</span> <span class="s1">&#39;was not found&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="n">path_to_file</span> <span class="o">=</span> <span class="kc">None</span>
           
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">,</span> <span class="s1">&#39; was download&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">path_to_file</span></div>

<div class="viewcode-block" id="CalculationVasp.get_chg_file"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.get_chg_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_chg_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;just wrapper to get chgcar files &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;CHGCAR&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;CHGCAR&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>




<div class="viewcode-block" id="CalculationVasp.bader"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.bader">[docs]</a>    <span class="k">def</span> <span class="nf">bader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">chgcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;chgcar&#39;</span><span class="p">]</span>
        <span class="n">acf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/ACF.dat&#39;</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Bader should be installed&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">acf</span><span class="p">):</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;bader &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">chgcar</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">charges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">acf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">charges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]),</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">charges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())))</span></div>



<div class="viewcode-block" id="CalculationVasp.get_bader_ACF"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.get_bader_ACF">[docs]</a>    <span class="k">def</span> <span class="nf">get_bader_ACF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1">#Make bader on server</span>
        <span class="c1">#assumes that bader is installed</span>
        <span class="kn">from</span> <span class="nn">siman.small_functions</span> <span class="k">import</span> <span class="n">bash_chk_file_cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">ppc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_filenames</span><span class="p">()</span>

        <span class="c1"># print()</span>
        <span class="n">CHG_scratch_gz</span>  <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">PATH2ARCHIVE</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.CHGCAR.gz&quot;</span>

        <span class="n">CHG</span>     <span class="o">=</span> <span class="n">ppc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;chgcar&#39;</span><span class="p">]</span>
        <span class="n">AECCAR0</span> <span class="o">=</span> <span class="n">ppc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;aeccar0&#39;</span><span class="p">]</span>
        <span class="n">AECCAR2</span> <span class="o">=</span> <span class="n">ppc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;aeccar2&#39;</span><span class="p">]</span>
        <span class="n">CHGCAR_sum</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.CHGCAR_sum&quot;</span>
        <span class="n">baderlog</span> <span class="o">=</span>  <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.bader.log&quot;</span>
        <span class="n">ACF</span>      <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;.ACF.dat&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;acf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACF</span>



        <span class="n">run_chgsum</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;; ~/tools/vts/chgsum.pl &quot;</span><span class="o">+</span><span class="n">AECCAR0</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">AECCAR2</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="o">+</span>\
        <span class="s2">&quot;mv CHGCAR_sum &quot;</span><span class="o">+</span><span class="n">CHGCAR_sum</span><span class="o">+</span><span class="s2">&quot;;&quot;</span> <span class="c1"># on cluster</span>

        <span class="n">command_chg_gunzip</span> <span class="o">=</span> <span class="s1">&#39;gunzip &#39;</span><span class="o">+</span><span class="n">CHG</span><span class="o">+</span><span class="s1">&#39;.gz &#39;</span> <span class="c1"># on cluster</span>
        
        <span class="n">restore_CHG</span> <span class="o">=</span> <span class="s2">&quot;rsync &quot;</span><span class="o">+</span><span class="n">CHG_scratch_gz</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39; ; gunzip &#39;</span><span class="o">+</span><span class="n">CHG</span><span class="o">+</span><span class="s1">&#39;.gz &#39;</span> <span class="c1"># on cluster</span>
        <span class="n">restore_AEC</span> <span class="o">=</span> <span class="s2">&quot;rsync &quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">PATH2ARCHIVE</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;aeccar0&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span> <span class="n">header</span><span class="o">.</span><span class="n">PATH2ARCHIVE</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;aeccar2&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">path</span> <span class="c1"># on cluster</span>


        <span class="n">mv</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="s2">&quot;.bader.log; mv ACF.dat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.ACF.dat; mv AVF.dat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.AVF.dat; mv BCF.dat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.BCF.dat; cat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.bader.log&quot;</span>
        
        <span class="n">bader_on_sum</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;; ~/tools/bader &quot;</span><span class="o">+</span><span class="n">CHG</span><span class="o">+</span><span class="s2">&quot; -ref &quot;</span><span class="o">+</span><span class="n">CHGCAR_sum</span><span class="o">+</span><span class="s2">&quot; &gt; &quot;</span><span class="o">+</span><span class="n">mv</span>
        <span class="n">bader_on_chg</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;; ~/tools/bader &quot;</span><span class="o">+</span><span class="n">CHG</span><span class="o">+</span><span class="s2">&quot; &gt; &quot;</span><span class="o">+</span><span class="n">mv</span> <span class="c1">#simple</span>
        <span class="n">command_cat_ACF</span>    <span class="o">=</span> <span class="s2">&quot; cat &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.ACF.dat&quot;</span>
        
        <span class="n">no_CHG_sum</span> <span class="o">=</span> <span class="n">bash_chk_file_cmd</span><span class="p">(</span><span class="n">CHGCAR_sum</span><span class="p">)</span> <span class="c1">#true if file not exists</span>
        <span class="n">no_CHG</span>     <span class="o">=</span> <span class="n">bash_chk_file_cmd</span><span class="p">(</span><span class="n">CHG</span><span class="p">)</span>
        <span class="n">no_ACF</span>     <span class="o">=</span> <span class="n">bash_chk_file_cmd</span><span class="p">(</span><span class="n">ACF</span><span class="p">)</span>
        <span class="n">no_AECCAR0</span> <span class="o">=</span> <span class="n">bash_chk_file_cmd</span><span class="p">(</span><span class="n">AECCAR0</span><span class="p">)</span>
        <span class="n">no_AECCAR2</span> <span class="o">=</span> <span class="n">bash_chk_file_cmd</span><span class="p">(</span><span class="n">AECCAR2</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">remote</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">run_on_server</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>



        <span class="c1">#Calculate CHGCAR_sum</span>
        <span class="k">if</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_CHG_sum</span><span class="p">):</span> 
            <span class="n">printlog</span><span class="p">(</span>  <span class="n">CHGCAR_sum</span><span class="p">,</span> <span class="s2">&quot;does not exist. trying to calculate it ...&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_AECCAR0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_AECCAR2</span><span class="p">):</span>
                <span class="n">printlog</span><span class="p">(</span>  <span class="n">AECCAR0</span><span class="p">,</span> <span class="s2">&quot;does not exist, trying to take it from archive ...&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="n">printlog</span><span class="p">(</span><span class="n">remote</span><span class="p">(</span><span class="n">restore_AEC</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_AECCAR0</span><span class="p">):</span>
                <span class="n">printlog</span><span class="p">(</span> <span class="n">remote</span><span class="p">(</span><span class="n">run_chgsum</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span> 
                <span class="n">printlog</span><span class="p">(</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&quot; rm &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.ACF.dat&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span> 
        <span class="c1"># sys.exit()</span>

        <span class="c1">#Check chgcar</span>
        <span class="k">if</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_CHG</span><span class="p">):</span> <span class="c1">#true if file not exists</span>
            <span class="n">printlog</span><span class="p">(</span> <span class="s1">&#39;Warning! File &#39;</span><span class="p">,</span> <span class="n">CHG</span><span class="p">,</span> <span class="s2">&quot;does not exist. Checking .gz .. &quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

            <span class="n">printlog</span><span class="p">(</span> <span class="n">remote</span><span class="p">(</span><span class="n">command_chg_gunzip</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span> 

        <span class="k">if</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_CHG</span><span class="p">):</span> <span class="c1">#true if file not exists</span>
            <span class="n">printlog</span><span class="p">(</span> <span class="s1">&#39;Warning! File &#39;</span><span class="p">,</span> <span class="n">CHG</span><span class="p">,</span> <span class="s2">&quot;does not exist. Trying to restore it from archive .. &quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

            <span class="n">printlog</span><span class="p">(</span> <span class="n">remote</span><span class="p">(</span><span class="n">restore_CHG</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span> 



        <span class="k">def</span> <span class="nf">run_bader</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">):</span>        
            
            <span class="k">if</span> <span class="n">remote</span><span class="p">(</span><span class="n">no_ACF</span><span class="p">):</span> <span class="c1">#true if file not exists</span>
                <span class="n">printlog</span><span class="p">(</span>  <span class="n">ACF</span><span class="p">,</span> <span class="s2">&quot; does not exist. trying to calculate Bader ... &quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="n">printlog</span><span class="p">(</span> <span class="n">remote</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span> 
                
            <span class="n">ACF_text</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">command_cat_ACF</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ACF_text</span>

        <span class="n">ACF_text</span> <span class="o">=</span> <span class="n">run_bader</span><span class="p">(</span><span class="n">bader_on_sum</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;No such file or directory&#39;</span> <span class="ow">in</span> <span class="n">ACF_text</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! Probably you have problems with&#39;</span><span class="p">,</span><span class="n">CHGCAR_sum</span><span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Trying to calculate charges from CHGCAR ...&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            
            <span class="n">ACF_text</span> <span class="o">=</span> <span class="n">run_bader</span><span class="p">(</span><span class="n">bader_on_chg</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ACF_text = &#39;</span><span class="p">,</span> <span class="n">ACF_text</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">ACF_text</span><span class="p">:</span>
            <span class="n">ACF_l</span> <span class="o">=</span> <span class="n">ACF_text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">charges</span> <span class="o">=</span> <span class="p">[]</span>
        

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ACF_l</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">charges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">charges</span> <span class="o">=</span> <span class="n">charges</span>

        <span class="c1"># print(charges[[1,2]])</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">charges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())))</span>


        <span class="k">return</span> <span class="n">charges</span></div>
        







<div class="viewcode-block" id="CalculationVasp.bader_coseg"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.bader_coseg">[docs]</a>    <span class="k">def</span> <span class="nf">bader_coseg</span><span class="p">():</span>

        <span class="s2">&quot;used in coseg project Ti- C,O&quot;</span> 
        <span class="n">ACF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bader_ACF</span><span class="p">()</span>

        <span class="n">ACF</span> <span class="o">=</span> <span class="n">ACF</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span> <span class="c1">#list of lines with charges for each atom</span>

        <span class="c1"># print ACF[0]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">imp_valence_chg</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#!!should be taken from potential</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">imp_valence_chg</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#!!should be taken from potential</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">mat_valence_chg</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1">#!!should be taken from potential</span>



        <span class="n">local_atoms</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;atoms&#39;</span><span class="p">)</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="n">local_atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># first atom is impurity</span>
        <span class="c1"># print numbers</span>
        <span class="n">imp_partial_chg</span> <span class="o">=</span> <span class="n">imp_valence_chg</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ACF</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>

        <span class="n">mat_partial_chg</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat_valence_chg</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ACF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">]</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Partial charge of impurity &quot;</span><span class="p">,</span> <span class="n">imp_partial_chg</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Partial charges of neibouring Ti atoms&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mat_partial_chg</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Partial charge of matrix&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_partial_chg</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>
        
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Sum of mat and imp charges:&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_partial_chg</span><span class="p">)</span><span class="o">+</span><span class="n">imp_partial_chg</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">path_to_file</span></div>


<div class="viewcode-block" id="CalculationVasp.check_job_state"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.check_job_state">[docs]</a>    <span class="k">def</span> <span class="nf">check_job_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#check if job in queue or Running</span>

        <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">check_job</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">job_in_queue</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s1">&#39;schedule_system&#39;</span><span class="p">):</span>

                <span class="n">check_string</span> <span class="o">=</span>  <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;SLURM&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span><span class="p">:</span>

                    <span class="n">job_in_queue</span> <span class="o">=</span> <span class="n">check_string</span> <span class="ow">in</span> <span class="n">run_on_server</span><span class="p">(</span><span class="s2">&quot;squeue -o &#39;</span><span class="si">%o</span><span class="s2">&#39; &quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;is in queue or running?&#39;</span><span class="p">,</span> <span class="n">job_in_queue</span><span class="p">)</span>

                <span class="k">elif</span> <span class="s1">&#39;PBS&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span><span class="p">:</span>
                    <span class="n">job_in_queue</span> <span class="o">=</span> <span class="n">check_string</span> <span class="ow">in</span> <span class="n">run_on_server</span><span class="p">(</span><span class="s2">&quot;qstat -x &quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Attention! unknown SCHEDULE_SYSTEM=&#39;</span><span class="o">+</span><span class="s1">&#39;; Please teach me here! &#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                    <span class="n">job_in_queue</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>


            <span class="k">if</span> <span class="n">file_exists_on_server</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">),</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span> <span class="ow">and</span> <span class="n">job_in_queue</span><span class="p">:</span> 
                
                <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;3. Running&#39;</span>

            <span class="k">elif</span> <span class="n">job_in_queue</span><span class="p">:</span>
                
                <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;3. In queue&#39;</span>
       
            <span class="k">else</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;2. Unknown&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;2. Unknown&#39;</span>




        <span class="k">return</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span> </div>




<div class="viewcode-block" id="CalculationVasp.res"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.res">[docs]</a>    <span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">siman.calc_manage</span> <span class="k">import</span> <span class="n">res_loop</span>
        <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculationVasp.run"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="n">iopt</span> <span class="o">=</span> <span class="s1">&#39;full_nomag&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">vers</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">i_child</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for add_loop (in development)</span>
<span class="sd">        By default inherit self.end</span>
<span class="sd">        ise - new ise</span>

<span class="sd">        iopt - inherit_option</span>
<span class="sd">            &#39;full_nomag&#39;</span>
<span class="sd">            &#39;full&#39;</span>
<span class="sd">            &#39;full_chg&#39; - including chg file</span>
<span class="sd">        vers - list of version for which the inheritance is done</span>

<span class="sd">        i_child - choose number of child to run res_loop()</span>
<span class="sd">        add - if 1 than add new calculation irrelevant to children</span>
<span class="sd">        TODO:</span>
<span class="sd">        1. if ise is not provided continue in the same folder under the same name,</span>
<span class="sd">        however, it is not always what is needed, therefore use inherit_xred = continue</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">siman.calc_manage</span> <span class="k">import</span> <span class="n">add_loop</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">iopt</span><span class="p">:</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>



        <span class="c1"># if self.id[1] != ise:</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">add</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Children were found:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="s1">&#39;by defauld reading last, choose with *i_child* &#39;</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="c1"># print(i, ise, i[1], i[1] == ise)</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ise</span><span class="p">:</span>
                        <span class="n">idd</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="c1"># add = True</span>
                        <span class="c1"># break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">idd</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">idd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">add</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># idd  = self.children[i_child]</span>
                <span class="c1"># print(idd)</span>

                <span class="k">if</span> <span class="n">idd</span><span class="p">:</span>
                    <span class="n">cl_son</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span>
                    
                    <span class="n">cl_son</span><span class="o">.</span><span class="n">res</span><span class="p">(</span><span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">idd</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="kc">None</span>
            

            <span class="n">vp</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">varset</span><span class="p">[</span><span class="n">ise</span><span class="p">]</span><span class="o">.</span><span class="n">vasp_params</span>
            <span class="n">ICHARG_or</span> <span class="o">=</span> <span class="s1">&#39;impossible_value&#39;</span>
            <span class="k">if</span> <span class="n">add</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                

                <span class="k">if</span> <span class="n">iopt</span>  <span class="o">==</span> <span class="s1">&#39;full_chg&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;ICHARG&#39;</span> <span class="ow">in</span> <span class="n">vp</span> <span class="ow">and</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;ICHARG&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! Inheritance of CHGCAR and ICHARG == 0; I change locally ICHARG to 1&#39;</span><span class="p">)</span>
                        <span class="n">ICHARG_or</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;ICHARG&#39;</span><span class="p">]</span>
                        <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;ICHARG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


                <span class="k">if</span> <span class="ow">not</span> <span class="n">vers</span><span class="p">:</span>
                    <span class="n">vers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                <span class="n">idd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">add_loop</span><span class="p">(</span><span class="n">idd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vers</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="n">iopt</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># it_new = add_loop(*self.id, ise_new = ise, up = up, inherit_option = iopt, override = 1)</span>
                <span class="n">child</span> <span class="o">=</span> <span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">ICHARG_or</span> <span class="o">!=</span> <span class="s1">&#39;impossible_value&#39;</span><span class="p">:</span>
                    <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;ICHARG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ICHARG_or</span>  <span class="c1">#return original value</span>
 

        <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">[</span><span class="n">child</span><span class="p">]</span></div>


<div class="viewcode-block" id="CalculationVasp.read_pdos_using_phonopy"><a class="viewcode-back" href="../../siman.html#siman.classes.CalculationVasp.read_pdos_using_phonopy">[docs]</a>    <span class="k">def</span> <span class="nf">read_pdos_using_phonopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;pdos&#39;</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mode - </span>
<span class="sd">            pdos</span>
<span class="sd">            band</span>
<span class="sd">            free - thermal properties, converted to eV!!!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39; -p &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">siman.calc_manage</span> <span class="k">import</span> <span class="n">create_phonopy_conf_file</span><span class="p">,</span> <span class="n">read_phonopy_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s1">&#39;vasprun.xml&#39;</span><span class="p">,</span> <span class="n">nametype</span> <span class="o">=</span> <span class="s1">&#39;asoutcar&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="p">)</span>
        <span class="n">create_phonopy_conf_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="c1"># create_phonopy_conf_file(self.end, mp = [36, 36, 36], path = self.dir) #almost no difference was found for Na2X</span>
        <span class="n">create_phonopy_conf_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;band&#39;</span><span class="p">)</span> <span class="c1">#create band file</span>



        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>


        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;phonopy --fc &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;xml&#39;</span><span class="p">]))</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;phonopy out: &#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>



        <span class="k">if</span> <span class="s1">&#39;poscar&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span><span class="s1">&#39;POSCAR&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pdos&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phonopy -c &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="s1">&#39;  mesh.conf --readfc &#39;</span><span class="p">)</span>
            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;phonopy -c &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="s1">&#39; mesh.conf --readfc &#39;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">siman.calc_manage</span> <span class="k">import</span> <span class="n">read_phonopy_dat_file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pdos</span> <span class="o">=</span> <span class="n">read_phonopy_dat_file</span><span class="p">(</span><span class="s1">&#39;total_dos.dat&#39;</span><span class="p">)</span>


        <span class="c1">#phonons</span>
        

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;band&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phonopy -c &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; -p band.conf --readfc &#39;</span><span class="p">)</span>
            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;phonopy -c &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; -p band.conf --readfc &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phonopy -c &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; -t -p mesh.conf --readfc &#39;</span><span class="p">)</span>

            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;phonopy -c &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; -t&#39;</span> <span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="s1">&#39; mesh.conf --readfc &#39;</span><span class="p">)</span>


            <span class="n">Trange</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">read_phonopy_data</span><span class="p">(</span><span class="s1">&#39;thermal_properties.yaml&#39;</span><span class="p">,</span> <span class="n">convert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">func</span> <span class="c1"># free energy function in eV, still for the whole supercell!</span>
            <span class="c1"># print(self.id, self.F)</span>


        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">return</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Dmitry Aksenov.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>