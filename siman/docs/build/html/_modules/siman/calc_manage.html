
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>siman.calc_manage &#8212; Siman 0.9.5 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for siman.calc_manage</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- </span>
<span class="c1">#Copyright Aksyonov D.A</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span> 
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">import</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># pmg config --add VASP_PSP_DIR $VASP_PSP_DIR MAPI_KEY $MAPI_KEY</span>
    <span class="kn">from</span> <span class="nn">pymatgen.ext.matproj</span> <span class="k">import</span> <span class="n">MPRester</span>
    <span class="kn">from</span> <span class="nn">pymatgen.io.vasp.inputs</span> <span class="k">import</span> <span class="n">Poscar</span>
    <span class="kn">from</span> <span class="nn">pymatgen.io.cif</span> <span class="k">import</span> <span class="n">CifParser</span>
    <span class="n">pymatgen_flag</span> <span class="o">=</span> <span class="kc">True</span> 
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pymatgen is not available&#39;</span><span class="p">)</span>
    <span class="n">pymatgen_flag</span> <span class="o">=</span> <span class="kc">False</span> 

<span class="kn">import</span> <span class="nn">siman</span>
<span class="kn">from</span> <span class="nn">siman</span> <span class="k">import</span> <span class="n">header</span>
<span class="kn">from</span> <span class="nn">siman.header</span> <span class="k">import</span> <span class="n">print_and_log</span><span class="p">,</span> <span class="n">runBash</span><span class="p">,</span> <span class="n">mpl</span><span class="p">,</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">siman.small_functions</span> <span class="k">import</span> <span class="n">is_list_like</span><span class="p">,</span> <span class="n">makedir</span><span class="p">,</span> <span class="n">list2string</span>
<span class="kn">from</span> <span class="nn">siman.classes</span> <span class="k">import</span> <span class="n">Calculation</span><span class="p">,</span> <span class="n">CalculationVasp</span><span class="p">,</span> <span class="n">Description</span>
<span class="kn">from</span> <span class="nn">siman.functions</span> <span class="k">import</span> <span class="p">(</span><span class="n">gb_energy_volume</span><span class="p">,</span> <span class="n">element_name_inv</span><span class="p">,</span> <span class="n">get_from_server</span><span class="p">,</span>  <span class="n">run_on_server</span><span class="p">,</span> <span class="n">push_to_server</span><span class="p">,</span> <span class="n">wrapper_cp_on_server</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">siman.inout</span> <span class="k">import</span> <span class="n">write_xyz</span><span class="p">,</span> <span class="n">read_xyz</span><span class="p">,</span> <span class="n">write_occmatrix</span>
<span class="kn">from</span> <span class="nn">siman.picture_functions</span> <span class="k">import</span> <span class="n">plot_mep</span><span class="p">,</span> <span class="n">fit_and_plot</span><span class="p">,</span> <span class="n">plot_conv</span>
<span class="kn">from</span> <span class="nn">siman.analysis</span> <span class="k">import</span> <span class="n">find_polaron</span><span class="p">,</span> <span class="n">neb_analysis</span><span class="p">,</span> <span class="n">calc_redox</span><span class="p">,</span> <span class="n">matrix_diff</span><span class="p">,</span> <span class="n">fit_a</span>
<span class="kn">from</span> <span class="nn">siman.geo</span> <span class="k">import</span> <span class="n">replic</span><span class="p">,</span> <span class="n">image_distance</span><span class="p">,</span> <span class="n">scale_cell_uniformly</span><span class="p">,</span> <span class="n">scale_cell_by_matrix</span><span class="p">,</span> <span class="n">remove_atoms</span><span class="p">,</span> <span class="n">create_deintercalated_structure</span><span class="p">,</span> <span class="n">create_antisite_defect</span><span class="p">,</span> <span class="n">create_antisite_defect2</span><span class="p">,</span> <span class="n">local_surrounding</span><span class="p">,</span> <span class="n">find_moving_atom</span>
<span class="kn">from</span> <span class="nn">siman.set_functions</span> <span class="k">import</span> <span class="n">init_default_sets</span>
<span class="kn">from</span> <span class="nn">siman.database</span> <span class="k">import</span> <span class="n">push_figure_to_archive</span>


<span class="n">printlog</span> <span class="o">=</span> <span class="n">print_and_log</span>

<span class="n">init_default_sets</span><span class="p">()</span>




<div class="viewcode-block" id="log_func_exec"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.log_func_exec">[docs]</a><span class="k">def</span> <span class="nf">log_func_exec</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save to history the executed form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="s1">&#39;&#39;</span></div>





<div class="viewcode-block" id="write_batch_header"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.write_batch_header">[docs]</a><span class="k">def</span> <span class="nf">write_batch_header</span><span class="p">(</span><span class="n">batch_script_filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">schedule_system</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">path_to_job</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">job_name</span> <span class="o">=</span> <span class="s1">&#39;SuperJob&#39;</span><span class="p">,</span> <span class="n">number_cores</span> <span class="o">=</span> <span class="mi">1</span>  <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    self-explanatory)</span>
<span class="sd">    path_to_job (str) - absolute path to job folder </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NC</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_cores</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">batch_script_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>


        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;shell&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">def_shell</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;shell&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">def_shell</span> <span class="o">=</span> <span class="s1">&#39;/bin/tcsh&#39;</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!&quot;</span><span class="o">+</span><span class="n">def_shell</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;#$ -M aksenov@mpie.de\n&quot;)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -m be</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -S &quot;</span><span class="o">+</span><span class="n">def_shell</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -cwd </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -R y </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -V  </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># use variables</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -o &quot;</span><span class="o">+</span><span class="n">path_to_job</span><span class="o">+</span><span class="s2">&quot; -j y</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;pe&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -pe &quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">NC</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path_to_job</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;modules&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;module load sge\n&quot;)</span>
            <span class="c1"># f.write(&quot;module load vasp/parallel/5.2.12\n\n&quot;)</span>


        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash   </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -N &quot;</span><span class="o">+</span><span class="n">job_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;walltime&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l walltime=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">WALLTIME_LIMIT</span><span class="p">:</span> <span class="c1">#deprecated remove</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l walltime=72:00:00 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            

            <span class="c1"># f.write(&quot;#PBS -l nodes=1:ppn=&quot;+str(number_cores)+&quot;\n&quot;)</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">PBS_PROCS</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l procs=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_cores</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># 1 node option </span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l nodes=1:ppn=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_cores</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;#PBS -l pmem=16gb\n&quot;) #memory per processor, Skoltech</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -r n</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -j eo</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -m bea</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;#PBS -M dimonaks@gmail.com\n&quot;)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd $PBS_O_WORKDIR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            

            <span class="c1"># f.write(&quot;PATH=/share/apps/vasp/bin:/home/aleksenov_d/mpi/openmpi-1.6.3/installed/bin:/usr/bin:$PATH \n&quot;)</span>
            <span class="c1"># f.write(&quot;LD_LIBRARY_PATH=/home/aleksenov_d/lib64:$LD_LIBRARY_PATH \n&quot;)</span>
            <span class="k">if</span> <span class="s1">&#39;modules&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># f.write(&quot;module load Compilers/Intel/psxe_2015.6\n&quot;)</span>
            <span class="c1"># f.write(&quot;module load MPI/intel/5.1.3.258/intel \n&quot;)</span>
            <span class="c1"># f.write(&quot;module load QCh/VASP/5.4.1p1/psxe2015.6\n&quot;)</span>
            <span class="c1"># f.write(&quot;module load ScriptLang/python/2.7\n\n&quot;)</span>



        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;PBS_bsu&#39;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash   </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -N &quot;</span><span class="o">+</span><span class="n">job_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">WALLTIME_LIMIT</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l walltime=72:00:00 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;#PBS -l nodes=1:ppn=&quot;+str(number_cores)+&quot;\n&quot;)</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">PBS_PROCS</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l nodes=node07:ppn=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_cores</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># 1 node option </span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l nodes=node07:ppn=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_cores</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;#PBS -l pmem=16gb\n&quot;) #memory per processor, Skoltech</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -r n</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -j eo</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -m bea</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -M boev.anton.olegovich@gmail.com</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd $PBS_O_WORKDIR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;echo $LD_LIBRARY_PATH </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>








        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">path_to_job</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! For slurm std err and out you need full paths&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash   </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -J &quot;</span><span class="o">+</span><span class="n">job_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -t 250:00:00 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -N 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -n &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_cores</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -o &quot;</span><span class="o">+</span><span class="n">path_to_job</span><span class="o">+</span><span class="s2">&quot;sbatch.out</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -e &quot;</span><span class="o">+</span><span class="n">path_to_job</span><span class="o">+</span><span class="s2">&quot;sbatch.err</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --mem-per-cpu=7675</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;#SBATCH -I other=avx\n&quot;) # AVX2 instructions for new node to improve speed by 18% </span>

            <span class="c1"># f.write(&quot;#SBATCH --nodelist=node-amg03\n&quot;)</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">siman_run</span><span class="p">:</span> <span class="c1">#only for me</span>
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">EXCLUDE_NODES</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --exclude=node-amg13</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># f.write(&quot;#SBATCH --mail-user=d.aksenov@skoltech.ru\n&quot;)</span>
                <span class="c1"># f.write(&quot;#SBATCH --mail-type=END\n&quot;)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path_to_job</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;export OMP_NUM_THREADS=1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;modules&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># f.write(&quot;module add prun/1.0\n&quot;)</span>
            <span class="c1"># f.write(&quot;module add intel/16.0.2.181\n&quot;)</span>
            <span class="c1"># f.write(&quot;module add impi/5.1.3.181\n&quot;)</span>
            
            <span class="c1"># if header.siman_run: #only for me</span>
            <span class="n">lib64</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;homepath&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/tools/lib64&#39;</span>
            <span class="n">atlas</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;homepath&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/tools/atlas&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&quot;</span><span class="o">+</span><span class="n">lib64</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&quot;</span><span class="o">+</span><span class="n">atlas</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;export PATH=$PATH:&quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;homepath&#39;</span><span class="p">]</span> <span class="o">+</span><span class="s2">&quot;/tools/</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;touch RUNNING</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">return</span></div>

























<div class="viewcode-block" id="clean_history_file"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.clean_history_file">[docs]</a><span class="k">def</span> <span class="nf">clean_history_file</span><span class="p">(</span><span class="n">history_list</span><span class="p">):</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">history_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span></div>





<div class="viewcode-block" id="prepare_run"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.prepare_run">[docs]</a><span class="k">def</span> <span class="nf">prepare_run</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INPUT:</span>
<span class="sd">        schedule_system - type of job scheduling system:&#39;PBS&#39;, &#39;SGE&#39;, &#39;SLURM&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schedule_system</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">schedule_system</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    
        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;shell&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!&quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;shell&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/tcsh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># if &#39;modules&#39; in header.cluster:</span>
                <span class="c1"># f.write(header.cluster[&#39;modules&#39;]+&#39;\n&#39;)</span>
            <span class="c1"># f.write(&quot;module load sge\n&quot;)</span>
            <span class="c1"># f.write(&quot;module load vasp/parallel/5.2.12\n&quot;)</span>
        <span class="k">elif</span> <span class="n">schedule_system</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span> <span class="s1">&#39;PBS_bsu&#39;</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="c1"># print_and_log(&#39;Please provide schedule_system!&#39;)</span>
            <span class="c1"># raise RuntimeError</span>

    <span class="c1"># f.close()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="complete_run"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.complete_run">[docs]</a><span class="k">def</span> <span class="nf">complete_run</span><span class="p">(</span><span class="n">close_run</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">close_run</span><span class="p">:</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">schedule_system</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PBS&quot;</span><span class="p">,</span> <span class="s1">&#39;PBS_bsu&#39;</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;qstat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sleep 2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">header</span><span class="o">.</span><span class="n">schedule_system</span> <span class="o">==</span> <span class="s2">&quot;SLURM&quot;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;squeue</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">header</span><span class="o">.</span><span class="n">schedule_system</span> <span class="o">==</span> <span class="s2">&quot;SGE&quot;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;qstat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv run last_run</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">copy_to_cluster_flag</span><span class="p">:</span>
            <span class="n">push_to_server</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span>  <span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>
            <span class="n">run_on_server</span><span class="p">(</span><span class="s1">&#39;chmod +x run&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;run sent&#39;</span><span class="p">)</span>
    
    <span class="k">return</span></div>












<div class="viewcode-block" id="create_additional"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.create_additional">[docs]</a><span class="k">def</span> <span class="nf">create_additional</span><span class="p">(</span><span class="n">struct_des</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatically make objects in struct_des</span>
<span class="sd">    with .f and .fvac index</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">struct_des</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;auto-created&#39;</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">des</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">des</span><span class="o">+=</span><span class="s1">&#39; fitted; des auto-created;&#39;</span>
        <span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;.f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">des</span><span class="o">+=</span><span class="s1">&#39; fitted and relaxed; des auto-created;&#39;</span>
        <span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;.fr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>


        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">des</span><span class="o">+=</span><span class="s1">&#39; with vacancy; des auto-created;&#39;</span>
        <span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;.fvac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>


        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">des</span><span class="o">+=</span><span class="s1">&#39; with vacancy; des auto-created;&#39;</span>
        <span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;.r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>


    <span class="k">return</span> <span class="n">struct_des</span></div>

<div class="viewcode-block" id="add_des"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.add_des">[docs]</a><span class="k">def</span> <span class="nf">add_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Lazy author has not provided description for me :( &#39;</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function adds description to struct_des dictionary;</span>


<span class="sd">    ###INPUT:</span>
<span class="sd">        </span>
<span class="sd">        - struct_des (dict)         - dict from project database</span>
<span class="sd">        * it (str)        - name of calculation</span>
<span class="sd">        * it_folder (str) - path and name of folder used for calculation in current project both on local and remote machines</span>
<span class="sd">        * des (str)       - description of calculation</span>
<span class="sd">        * override (bool) - allows to override existing field</span>


<span class="sd">    ###RETURN:</span>
<span class="sd">        </span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">it</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span> <span class="ow">or</span> <span class="n">override</span><span class="p">:</span>
        <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">Description</span><span class="p">(</span><span class="n">it_folder</span><span class="p">,</span> <span class="n">des</span><span class="p">)</span>
        <span class="c1"># hstring = (&quot;%s    #on %s&quot;% (traceback.extract_stack(None, 2)[0][3],   datetime.date.today() ) )</span>
        <span class="n">hstring</span> <span class="o">=</span> <span class="s1">&#39;add_des(&quot;</span><span class="si">{:s}</span><span class="s1">&quot;, &quot;</span><span class="si">{:s}</span><span class="s1">&quot;, &quot;</span><span class="si">{:s}</span><span class="s1">&quot;)    #on </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hstring</span> <span class="o">!=</span> <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">hstring</span>  <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">hstring</span>  <span class="p">)</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;New structure name &quot;</span><span class="o">+</span><span class="n">it</span><span class="o">+</span> <span class="s2">&quot; added to struct_des dict&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Attention! &quot;</span><span class="o">+</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39; already exist in struct_des, skipping; use override = True if you really need it; or first remove using manually_remove_from_struct_des()&#39;</span><span class="p">)</span>
        <span class="c1"># raise RuntimeError</span>


    <span class="k">return</span></div>




<div class="viewcode-block" id="update_des"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.update_des">[docs]</a><span class="k">def</span> <span class="nf">update_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">des_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manuall adding of information to struct_des dictionary</span>
<span class="sd">    </span>

<span class="sd">    ###INPUT:</span>
<span class="sd">        - struct_des (dict)         - dict from project database</span>
<span class="sd">        - des_list (list of tuples) - list of new calculations to be added to database</span>


<span class="sd">    ###RETURN:</span>
<span class="sd">        - struct_des (dict) </span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">for</span> <span class="n">des</span> <span class="ow">in</span> <span class="n">des_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">des</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
            <span class="n">add_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="o">*</span><span class="n">des</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">create_additional</span><span class="p">(</span><span class="n">struct_des</span><span class="p">)</span></div>


<div class="viewcode-block" id="cif2poscar"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.cif2poscar">[docs]</a><span class="k">def</span> <span class="nf">cif2poscar</span><span class="p">(</span><span class="n">cif_file</span><span class="p">,</span> <span class="n">poscar_file</span><span class="p">):</span>




    <span class="k">if</span> <span class="n">pymatgen_flag</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">CifParser</span><span class="p">(</span><span class="n">cif_file</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_structures</span><span class="p">(</span><span class="n">primitive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        

        <span class="n">si</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># print(dir(si))</span>
        <span class="c1"># print(si.specie)</span>

        <span class="c1"># from pymatgen.symmetry.analyzer import SpacegroupAnalyzer</span>
        <span class="c1"># sf = SpacegroupAnalyzer(s, ) #</span>
        <span class="c1"># sc = sf.get_conventional_standard_structure() # magmom are set to None</span>
        <span class="c1"># print(sc)</span>



        <span class="n">Poscar</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">poscar_file</span><span class="p">)</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span><span class="n">poscar_file</span><span class="p">,</span> <span class="s1">&#39;created.&#39;</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">header</span><span class="o">.</span><span class="n">CIF2CELL</span><span class="p">:</span> <span class="c1">#using cif2cell for conversion</span>

        <span class="n">print_and_log</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;cif2cell &quot;</span><span class="o">+</span><span class="n">cif_file</span><span class="o">+</span><span class="s2">&quot;  -p vasp -o &quot;</span><span class="o">+</span><span class="n">poscar_file</span><span class="p">)</span>  <span class="p">)</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span><span class="n">poscar_file</span><span class="p">,</span> <span class="s1">&#39;created.&#39;</span><span class="p">)</span>

        <span class="c1">#check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">poscar_file</span><span class="p">):</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! cif2cell failed&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Support of cif files requires pymatgen or cif2cell; install it with &quot;pip install pymatgen&quot; or provide POSCAR or Abinit input file&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="determine_file_format"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.determine_file_format">[docs]</a><span class="k">def</span> <span class="nf">determine_file_format</span><span class="p">(</span><span class="n">input_geo_file</span><span class="p">):</span>

    <span class="n">supported_file_formats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;abinit&#39;</span><span class="p">:</span><span class="s1">&#39;.geo&#39;</span><span class="p">,</span>   <span class="s1">&#39;vasp&#39;</span><span class="p">:</span><span class="s1">&#39;POSCAR&#39;</span><span class="p">,</span>   <span class="s1">&#39;cif&#39;</span><span class="p">:</span><span class="s1">&#39;.cif&#39;</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span><span class="s1">&#39;.xyz&#39;</span><span class="p">}</span> <span class="c1">#format name:format specifier</span>

    <span class="k">if</span> <span class="s1">&#39;POSCAR&#39;</span> <span class="ow">in</span> <span class="n">input_geo_file</span> <span class="ow">or</span> <span class="s1">&#39;CONTCAR&#39;</span> <span class="ow">in</span> <span class="n">input_geo_file</span><span class="p">:</span>
        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;.cif&#39;</span> <span class="ow">in</span> <span class="n">input_geo_file</span><span class="p">:</span>
        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;cif&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;.geo&#39;</span> <span class="ow">in</span> <span class="n">input_geo_file</span><span class="p">:</span>
        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;abinit&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;.xyz&#39;</span> <span class="ow">in</span> <span class="n">input_geo_file</span><span class="p">:</span>
        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;xyz&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;Attention! File format of&quot;</span><span class="p">,</span><span class="n">input_geo_file</span> <span class="p">,</span><span class="s2">&quot;is unknown, should be from &quot;</span><span class="p">,</span> <span class="n">supported_file_formats</span><span class="p">,</span> <span class="s1">&#39;skipping&#39;</span><span class="p">)</span>
        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">input_geo_format</span></div>



<div class="viewcode-block" id="get_file_by_version"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.get_file_by_version">[docs]</a><span class="k">def</span> <span class="nf">get_file_by_version</span><span class="p">(</span><span class="n">geofilelist</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find file with needed version from filelist according to certain rules</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curv</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">matched_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># print(geofilelist)</span>

    <span class="k">for</span> <span class="n">input_geofile</span> <span class="ow">in</span> <span class="n">geofilelist</span><span class="p">:</span> 
        
        <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">input_geofile</span><span class="p">)</span>


        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="n">determine_file_format</span><span class="p">(</span><span class="n">input_geofile</span><span class="p">)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;For file&#39;</span><span class="p">,</span> <span class="n">input_geofile</span><span class="p">,</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="s1">&#39; format was detected&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_geo_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;abinit&#39;</span><span class="p">,]:</span> <span class="c1">#version determined from token </span>
            <span class="c1"># curv = int( runBash(&quot;grep version &quot;+str(input_geofile) ).split()[1] )</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_geofile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;version&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">curv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>


        <span class="k">elif</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;vasp&#39;</span><span class="p">:</span> <span class="c1">#from filename</span>
            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">input_geofile</span><span class="p">:</span>
                <span class="n">curv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_geofile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="c1">#!Applied only for phonopy POSCAR-n naming convention</span>
            <span class="c1"># try: </span>
            <span class="c1">#     curv = int(input_geofile.split(&#39;-&#39;)[-1] ) #!Applied only for phonopy POSCAR-n naming convention</span>
            <span class="c1"># except:</span>
            <span class="c1">#     printlog(&#39;Error! Could not determine version of poscar file&#39;)</span>

        <span class="k">elif</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;cif&#39;</span><span class="p">:</span> <span class="c1">#from filename</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;I found cif file &#39;</span><span class="p">,</span> <span class="n">input_geofile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">curv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_geofile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">curv</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Failed to determine version, skipping&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">curv</span> <span class="o">==</span> <span class="n">version</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="n">curv</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
            <span class="n">matched_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_geofile</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;get_file_by_version(): Error! Several files have same versions:&#39;</span><span class="p">,</span> <span class="n">matched_files</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">input_geofile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">matched_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">input_geofile</span></div>





<div class="viewcode-block" id="smart_structure_read"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.smart_structure_read">[docs]</a><span class="k">def</span> <span class="nf">smart_structure_read</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">curver</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">calcul</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geo_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for reading geometry files</span>
<span class="sd">    calcul (Calculation()) - object to which the path and version read</span>

<span class="sd">    curver (int) - version of file to be read</span>
<span class="sd">    input_geo_file or filename (str) - explicitly provided input file, has higher priority</span>
<span class="sd">    input_folder (str)   - folder with several input files, the names doesnot matter only versions</span>
<span class="sd">    input_geo_format (str) - explicitly provided format of input file </span>



<span class="sd">    returns Structure()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">search_templates</span> <span class="o">=</span>       <span class="p">{</span><span class="s1">&#39;abinit&#39;</span><span class="p">:</span><span class="s1">&#39;*.geo*&#39;</span><span class="p">,</span> <span class="s1">&#39;vasp&#39;</span><span class="p">:</span><span class="s1">&#39;*POSCAR*&#39;</span><span class="p">,</span> <span class="s1">&#39;cif&#39;</span><span class="p">:</span><span class="s1">&#39;*.cif&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">if</span> <span class="n">input_geo_file</span><span class="p">:</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;You provided the following geo file explicitly &quot;</span><span class="p">,</span> <span class="n">input_geo_file</span><span class="p">,</span> 
            <span class="s1">&#39;; Version of file does not matter, I use *curver*=&#39;</span><span class="p">,</span><span class="n">curver</span><span class="p">,</span> <span class="s1">&#39;as a new version&#39;</span> <span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">input_folder</span><span class="p">:</span>

        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;I am searching for geofiles in folder &quot;</span><span class="o">+</span><span class="n">input_folder</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">input_geo_format</span><span class="p">:</span> 
            <span class="n">geofilelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_folder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">search_templates</span><span class="p">[</span><span class="n">input_geo_format</span><span class="p">])</span> <span class="c1">#Find input_geofile of specific format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geofilelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_folder</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">)</span> 

        <span class="n">geofilelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">geofilelist</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span>   <span class="p">]</span>  <span class="c1">#skip hidden files</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;List of files:&#39;</span><span class="p">,</span> <span class="n">geofilelist</span><span class="p">)</span>

        <span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">get_file_by_version</span><span class="p">(</span><span class="n">geofilelist</span><span class="p">,</span> <span class="n">curver</span><span class="p">)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The result of getting by version&#39;</span><span class="p">,</span> <span class="n">input_geo_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_geo_file</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;File &#39;</span><span class="p">,</span> <span class="n">input_geo_file</span><span class="p">,</span> <span class="s1">&#39;was found&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! No input file with version &#39;</span><span class="p">,</span> <span class="n">curver</span><span class="p">,</span> <span class="s1">&#39;was found in&#39;</span><span class="p">,</span> <span class="n">input_folder</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Neither *input_geo_file* nor *input_folder* were provided&#39;</span><span class="p">)</span>


    <span class="n">input_geo_format</span> <span class="o">=</span> <span class="n">determine_file_format</span><span class="p">(</span><span class="n">input_geo_file</span><span class="p">)</span>
    <span class="n">printlog</span><span class="p">(</span><span class="n">input_geo_format</span><span class="p">,</span><span class="s1">&#39; format is detected&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">calcul</span><span class="p">:</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">calcul</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">input_geo_format</span>   <span class="o">==</span> <span class="s1">&#39;abinit&#39;</span><span class="p">:</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">input_geo_file</span><span class="p">)</span>

    
    <span class="k">elif</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;vasp&#39;</span><span class="p">:</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">read_poscar</span><span class="p">(</span><span class="n">input_geo_file</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">curver</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;cif&#39;</span><span class="p">:</span>
        
        <span class="n">cif2poscar</span><span class="p">(</span><span class="n">input_geo_file</span><span class="p">,</span> <span class="n">input_geo_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.cif&#39;</span><span class="p">,</span> <span class="s1">&#39;.POSCAR&#39;</span><span class="p">))</span>
        <span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">input_geo_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.cif&#39;</span><span class="p">,</span> <span class="s1">&#39;.POSCAR&#39;</span><span class="p">)</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">read_poscar</span><span class="p">(</span><span class="n">input_geo_file</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
        <span class="c1">#version = 1</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">init</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">read_xyz</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">input_geo_file</span><span class="p">)</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">st</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_geo_file</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! smart_structure_read(): File format&quot;</span><span class="p">,</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="s2">&quot;is unknown&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">printlog</span><span class="p">(</span><span class="s2">&quot;Error! Input file was not properly read for some reason&quot;</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="n">cl</span><span class="o">.</span><span class="n">init</span></div>








<div class="viewcode-block" id="name_mod_supercell"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.name_mod_supercell">[docs]</a><span class="k">def</span> <span class="nf">name_mod_supercell</span><span class="p">(</span><span class="n">ortho</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mul_matrix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">ortho</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ortho</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="s1">&#39;.s&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ortho</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span>  <span class="s1">&#39;.s&#39;</span><span class="o">+</span><span class="n">list2string</span><span class="p">(</span><span class="n">ortho</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="s1">&#39;.s&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mul_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mul_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mul_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mod</span></div>



<div class="viewcode-block" id="inherit_ngkpt"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.inherit_ngkpt">[docs]</a><span class="k">def</span> <span class="nf">inherit_ngkpt</span><span class="p">(</span><span class="n">it_to</span><span class="p">,</span> <span class="n">it_from</span><span class="p">,</span> <span class="n">inputset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    inherit ngkpt from it_from to it_to</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print(it_to, it_from)</span>
    
    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
    
    <span class="k">if</span> <span class="n">it_to</span> <span class="ow">and</span> <span class="n">it_from</span> <span class="ow">and</span> <span class="n">it_from</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="n">inputset</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;KSPACING&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="p">[</span><span class="n">it_to</span><span class="p">,</span> <span class="n">it_from</span><span class="p">]:</span> <span class="c1">#just create ngkpt_dict_for_kspacings property</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="s1">&#39;ngkpt_dict_for_kspacings&#39;</span> <span class="p">):</span>
                <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">k_dict1</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_from</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span>
        <span class="n">k_dict2</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_to</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span>

        <span class="k">if</span> <span class="n">ks</span> <span class="ow">in</span> <span class="n">k_dict1</span><span class="p">:</span>
            <span class="n">k_dict2</span><span class="p">[</span><span class="n">ks</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_dict1</span><span class="p">[</span><span class="n">ks</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;inherit_ngkpt(): the k-grid from&#39;</span><span class="p">,</span> <span class="n">it_from</span><span class="p">,</span> <span class="s1">&#39;was inherited to&#39;</span><span class="p">,</span> <span class="n">it_to</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;no ngkpt for k-spacing&#39;</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="s1">&#39;in ngkpt_dict_for_kspacings of&#39;</span><span class="p">,</span> <span class="n">it_from</span><span class="p">,</span> <span class="s1">&#39;ngkpt will determined from inputset k-spacing&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    
    <span class="k">return</span></div>


<div class="viewcode-block" id="choose_cluster"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.choose_cluster">[docs]</a><span class="k">def</span> <span class="nf">choose_cluster</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">cluster_home</span><span class="p">,</span> <span class="n">corenum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *cluster_name* should be in header.project_conf.CLUSTERS dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cluster_name</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">CLUSTERS</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;We use&#39;</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">,</span><span class="s1">&#39;cluster&#39;</span><span class="p">)</span>
        <span class="n">clust</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">CLUSTERS</span><span class="p">[</span><span class="n">cluster_name</span><span class="p">]</span>



    <span class="k">else</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention!, cluster&#39;</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">,</span> <span class="s1">&#39;is not found, using default&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">DEFAULT_CLUSTER</span><span class="p">)</span>
        <span class="n">clust</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">CLUSTERS</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">DEFAULT_CLUSTER</span><span class="p">]</span>

    <span class="n">header</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="n">clust</span> <span class="c1"># dict</span>
    <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span> <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>
    <span class="n">header</span><span class="o">.</span><span class="n">CLUSTER_ADDRESS</span> <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>
    



    <span class="k">if</span> <span class="s1">&#39;sshpass&#39;</span> <span class="ow">in</span> <span class="n">clust</span> <span class="ow">and</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;sshpass&#39;</span><span class="p">]:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;setting sshpass to True&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">header</span><span class="o">.</span><span class="n">sshpass</span> <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;sshpass&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">sshpass</span> <span class="o">=</span> <span class="kc">None</span>



    <span class="c1">#Determine cluster home using ssh</span>
    <span class="c1"># run_on_server(&#39;touch ~/.hushlogin&#39;, header.cluster_address)</span>
    <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">copy_to_cluster_flag</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span> <span class="o">=</span> <span class="n">run_on_server</span><span class="p">(</span><span class="s1">&#39;pwd&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The home folder on cluster is &#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span><span class="p">)</span>

    <span class="c1"># if cluster_home is None:</span>
    <span class="c1">#     header.cluster_home    = clust[&#39;homepath&#39;]</span>
    <span class="c1"># else:</span>
    <span class="c1">#     header.cluster_home    = cluster_home</span>
    



    <span class="k">if</span> <span class="s1">&#39;pythonpath&#39;</span> <span class="ow">in</span> <span class="n">clust</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">CLUSTER_PYTHONPATH</span>    <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;pythonpath&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">CLUSTER_PYTHONPATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># header.SCHEDULE_SYSTEM    = clust[&#39;schedule&#39;]</span>
    <span class="n">header</span><span class="o">.</span><span class="n">schedule_system</span>    <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">]</span>
    <span class="c1"># header.CORENUM    = clust[&#39;corenum&#39;]</span>
    
    <span class="k">if</span> <span class="n">corenum</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">corenum</span>    <span class="o">=</span> <span class="n">corenum</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">corenum</span>    <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;corenum&#39;</span><span class="p">]</span>

    <span class="n">header</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">header</span><span class="o">.</span><span class="n">PATH2PROJECT</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">vasp_command</span> <span class="o">=</span> <span class="n">clust</span><span class="p">[</span><span class="s1">&#39;vasp_com&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">vasp_command</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># print(clust)</span>



    <span class="k">return</span></div>





<div class="viewcode-block" id="add_loop"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.add_loop">[docs]</a><span class="k">def</span> <span class="nf">add_loop</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">setlist</span><span class="p">,</span> <span class="n">verlist</span><span class="p">,</span> <span class="n">calc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">varset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up2&#39;</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">id_from</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inherit_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">confdic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">i_atom_to_remove</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;oc&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
    <span class="n">input_geo_format</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ifolder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geo_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">corenum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">calc_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">u_ramping_region</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">mat_proj_cell</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">mat_proj_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">cee_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ise_new</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">it_suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale_region</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_scale_images</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">n_neb_images</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">occ_atom_coressp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">ortho</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mul_matrix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ngkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cluster_home</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">override</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ssh_object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">run</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_job</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main subroutine for creation of calculations, saving them to database and sending to server.</span>

<span class="sd">    Input:</span>

<span class="sd">        - it - arbitary name for your crystal structure </span>
<span class="sd">        - setlist (list of str or str) - names of sets with vasp parameters from *varset* dictionary</span>
<span class="sd">        - verlist - list of versions of new calculations</span>
<span class="sd">        - calc, varset - database dictionaries; could be provided; if not then are taken from header</span>

<span class="sd">        - input_geo_format - format of files in input geo folder </span>

<span class="sd">            &#39;abinit&#39; - the version is determined from the value inside the file</span>
<span class="sd">            &#39;vasp&#39;, &#39;cif&#39; -   the version is determined from the name of file; the names should be like POSCAR-1 for vasp files and 1.name.cif for cif</span>
<span class="sd">            &#39;mat_proj&#39; - take structure from materialsproject.org; use it_folder, len(verlist) = 1</span>


<span class="sd">        - up - string, possible values are: &#39;up1&#39;, &#39;up2&#39;, &#39;no_base&#39;; if empty then test run is performed without saving and sending </span>
<span class="sd">            </span>
<span class="sd">            &#39;up1&#39; - needed for normal creation of calculation and copy to server all files</span>
<span class="sd">            &#39;no_base&#39;: only relevant for typconv</span>
<span class="sd">            is the same as &quot;up1&quot;, but the base set is ommited</span>
<span class="sd">            &#39;up2&#39; - update only unfinished calculations</span>
<span class="sd">            &#39;up3&#39; - run only if id does not exist</span>
<span class="sd">        </span>
<span class="sd">        - coord - type of cooridnates written in POSCAR:</span>
<span class="sd">            </span>
<span class="sd">            &#39;direct&#39;</span>
<span class="sd">            &#39;cart&#39;</span>

<span class="sd">        - savefile - controls which files are saved during VASP run on server; check</span>
<span class="sd">            </span>
<span class="sd">            &#39;ocvdawx&#39; - outcar, chgcar, chg, dos, AECCAR,WAVECAR, xml</span>

<span class="sd">        - ifolder - explicit path to folder where to search for input geo file.</span>

<span class="sd">        - input_geo_file - explicit file name of input file</span>

<span class="sd">        - input_st - see in add_calculation()</span>

<span class="sd">        - it_folder - section folder (sfolder) used in struct_des; here needed with input_geo_format = mat_proj</span>

<span class="sd">        - show - only for read_results() ?.</span>

<span class="sd">        - comment - arbitrary comment for history.</span>



<span class="sd">        #inherit flags:</span>
<span class="sd">        inherit_args (dict) - to pass parameters to inherit_icalc; </span>
<span class="sd">        confdic (dicts) - additional configuration parameters to inherit_icalc in dict, used for antisites</span>
<span class="sd">        - inherit_option (str):</span>
<span class="sd">            </span>
<span class="sd">            - &#39;continue&#39;     - copy last contcar to poscar, outcar to prev.outcar and run again; on the next launch prev.outcar</span>
<span class="sd">                will be rewritten, please improve the code to save all previous outcars </span>
<span class="sd">            - &#39;inherit_xred&#39; - if verlist is provided, xred are copied from previous version to the next</span>
<span class="sd">            - all options available for inherit_icalc() subroutine (now only &#39;full&#39; is tested)</span>
<span class="sd">        </span>
<span class="sd">        - *id_from* - see inherit_icalc()</span>
<span class="sd">        </span>
<span class="sd">        - ise_new (str) - name of new set for inherited calculation  (&#39;uniform_scale&#39;)</span>

<span class="sd">        - occ_atom_coressp (dict) see inherit_icalc()</span>
<span class="sd">        </span>
<span class="sd">        - ortho, mul_matrix - transfered to inherit_icalc</span>
<span class="sd">        </span>
<span class="sd">        - ngkpt (list) - the list of k-points provided explicitly added to struct_des</span>

<span class="sd">        - corenum - number of cores used for calculation; overwrites header.corenum</span>

<span class="sd">        - calc_method - provides additional functionality:</span>
<span class="sd">            </span>
<span class="sd">            - &#39;u_ramping&#39;    - realizes U ramping approach #Phys Rev B 82, 195128</span>
<span class="sd">            - &#39;afm_ordering&#39; - </span>
<span class="sd">            - &#39;uniform_scale&#39; - creates uniformly scaled copies of the provided calculations</span>
<span class="sd">            - &#39;scale&#39; - arbitrary scale according to mul_matrix</span>
<span class="sd">            using *scale_region*  and *n_scale_images* (see *scale_cell_uniformly()*)</span>
<span class="sd">            The copies are available as versions from 1 to *n_scale_images* and</span>
<span class="sd">            suffix .su appended to *it* name</span>
<span class="sd">            Copies to cluster *fit* utility that finds volume corresp. to energy minimum, creates 100.POSCAR and continues run </span>
<span class="sd">            - &#39;monte&#39; - Monte-Carlo functionality</span>



<span class="sd">        - u_ramping_region - used with &#39;u_ramping&#39;=tuple(u_start, u_end, u_step)</span>


<span class="sd">        - cluster_home - override value of header.CLUSTERS</span>

<span class="sd">        cee_args - arguments for taking files from cee database; see get_structure_from_cee_database</span>
<span class="sd">            </span>
<span class="sd">            - cee_file (str) - name of file to be taken from cee database</span>
<span class="sd">            - section (str) - CEStorage, Catalysts, ets</span>

<span class="sd">        - run (bool) - complete the run file copy to server and run</span>

<span class="sd">        - params (dic) - dictionary of additional parameters, please move here numerous arguments</span>
<span class="sd">            </span>
<span class="sd">            - &#39;occmatrix&#39; - explicit path to occmatrix file</span>
<span class="sd">            - &#39;update_set_dic&#39; (dict) - additional parameters to override the existing set</span>
<span class="sd">            - &#39;monte&#39; - dictionary with parameters for Monte-Carlo regime</span>
<span class="sd">                </span>
<span class="sd">                - &#39;xvoid&#39; - xcart coordinates of voids</span>
<span class="sd">                - &#39;thickness&#39; - thickness of slice where Monte-Carlo changes are allowed (from top surface)</span>
<span class="sd">                - &#39;mcsteps&#39; - number of Monte-Carlo steps</span>
<span class="sd">                - &#39;temp&#39;    - temperature (K) for Metropolis Algorithm</span>

<span class="sd">    Comments:</span>
<span class="sd">        </span>
<span class="sd">        !Check To create folders and add calculations add_flag should have value &#39;add&#39; </span>


<span class="sd">    TODO:</span>
<span class="sd">    Now number of images is taken from self.set.vasp_params[&#39;IMAGES&#39;]; </span>
<span class="sd">    In the case of generalization to other codes, set.nimages should be added and used</span>

<span class="sd">    Make class for cluster to save all information about cluster in one object, </span>
<span class="sd">    like schedule_system, cluster address, corenum and so on </span>
<span class="sd">    </span>
<span class="sd">    read structure in add_loop, to add calculation provied only structure, mat_proj_st_id pass in structure</span>

<span class="sd">    - occmatrix in params better to rename to occfile or something like this, </span>


<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">def</span> <span class="nf">add_loop_prepare</span><span class="p">():</span>

        <span class="k">nonlocal</span> <span class="n">calc</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">verlist</span><span class="p">,</span> <span class="n">setlist</span><span class="p">,</span> <span class="n">varset</span><span class="p">,</span> <span class="n">calc_method</span><span class="p">,</span> <span class="n">inherit_args</span><span class="p">,</span> <span class="n">params</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show</span>
        <span class="c1"># if header.copy_to_cluster_flag:</span>
        <span class="n">choose_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">cluster_home</span><span class="p">,</span> <span class="n">corenum</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="n">prepare_run</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">first_run</span> <span class="ow">and</span> <span class="n">header</span><span class="o">.</span><span class="n">copy_to_cluster_flag</span><span class="p">:</span>
            <span class="n">prepare_run</span><span class="p">()</span>
            <span class="n">header</span><span class="o">.</span><span class="n">first_run</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">calc</span><span class="p">:</span>
            <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
            <span class="n">varset</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">varset</span>



        <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">it_folder</span><span class="p">:</span> 
            <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">verlist</span><span class="p">):</span>
            <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">verlist</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">setlist</span><span class="p">):</span>
            <span class="n">setlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">setlist</span><span class="p">]</span>
        <span class="c1"># print(setlist)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">setlist</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! None detected in setlist:&#39;</span><span class="p">,</span> <span class="n">setlist</span><span class="p">)</span>
        <span class="n">setlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setlist</span><span class="p">]</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">calc_method</span><span class="p">):</span>
            <span class="n">calc_method</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_method</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">inherit_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inherit_args</span> <span class="o">=</span> <span class="p">{}</span>






        <span class="k">if</span> <span class="n">ifolder</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">it</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ifolder</span><span class="p">:</span> <span class="c1"># just to be consistent with names</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Check ifolder !!! it is not in ifolder&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>


        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">add_loop_inherit</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        inherit options:</span>
<span class="sd">        full_chg - including chg file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span>  <span class="n">it</span><span class="p">,</span> <span class="n">setlist</span><span class="p">,</span> <span class="n">id_base</span><span class="p">,</span> <span class="n">it_suffix</span>
        <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>

        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_loop: starting add_loop_inherit ...&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
        <span class="c1">#inherit option</span>
        <span class="n">inh_opt_ngkpt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;full_chg&#39;</span><span class="p">,</span> <span class="s1">&#39;full_nomag&#39;</span><span class="p">,</span> <span class="s1">&#39;occ&#39;</span><span class="p">,</span> <span class="s1">&#39;r1r2r3&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_imp&#39;</span><span class="p">,</span> <span class="s1">&#39;replace_atoms&#39;</span><span class="p">,</span> <span class="s1">&#39;make_vacancy&#39;</span><span class="p">,</span> <span class="s1">&#39;antisite&#39;</span><span class="p">]</span> <span class="c1">#inherit also ngkpt</span>
        <span class="n">inh_opt_other</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;supercell&#39;</span><span class="p">,</span> <span class="s1">&#39;r2r3&#39;</span><span class="p">]</span> <span class="c1"># do not inherit ngkpt</span>
        <span class="c1"># if inherit_option in inh_opt_ngkpt+inh_opt_other:</span>
        <span class="n">omit_inh_opt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inherit_xred&#39;</span><span class="p">,</span> <span class="s1">&#39;continue&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inherit_option</span> <span class="ow">and</span> <span class="n">inherit_option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit_inh_opt</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="s1">&#39;id_base_st_type&#39;</span> <span class="ow">in</span> <span class="n">inherit_args</span> <span class="ow">and</span> <span class="n">inherit_args</span><span class="p">[</span><span class="s1">&#39;id_base_st_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
                <span class="n">iti</span> <span class="o">=</span> <span class="n">it</span><span class="o">+</span><span class="s1">&#39;.init&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iti</span> <span class="o">=</span> <span class="n">it</span>

            <span class="k">if</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="s1">&#39;.if&#39;</span>
            
            <span class="k">if</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;full_chg&#39;</span><span class="p">:</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="s1">&#39;.ifc&#39;</span>
            
            <span class="k">elif</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;full_nomag&#39;</span><span class="p">:</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="s1">&#39;.ifn&#39;</span>

            <span class="k">elif</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;occ&#39;</span><span class="p">:</span>
                <span class="c1">#please add additional vars to control for which atoms the inheritance should take place (added)</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="s1">&#39;.ifo&#39;</span> <span class="c1">#full inheritence + triggering OMC from some other source        </span>

            <span class="k">elif</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;supercell&#39;</span><span class="p">:</span>
               <span class="n">mod</span> <span class="o">=</span> <span class="n">name_mod_supercell</span><span class="p">(</span><span class="n">ortho</span><span class="p">,</span> <span class="n">mul_matrix</span><span class="p">)</span>
               <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="n">mod</span>

            <span class="k">elif</span> <span class="s1">&#39;antisite&#39;</span> <span class="ow">in</span> <span class="n">inherit_option</span><span class="p">:</span>
                <span class="n">suf</span> <span class="o">=</span> <span class="n">inherit_option</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">suf</span>
                <span class="c1"># print (it_new)</span>
                <span class="c1"># sys.exit()</span>

            <span class="k">elif</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;make_vacancy&#39;</span><span class="p">:</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">iti</span><span class="o">+</span><span class="s1">&#39;.vac&#39;</span>



            <span class="k">if</span> <span class="n">it_suffix</span><span class="p">:</span> <span class="c1"># override default behaviour</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">it</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">it_suffix</span>
                <span class="n">it_suffix</span> <span class="o">=</span> <span class="kc">None</span>



            <span class="k">if</span> <span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">it_folder</span><span class="p">:</span>
                    <span class="n">section_folder</span> <span class="o">=</span> <span class="n">it_folder</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">section_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span>

                <span class="k">for</span> <span class="n">inputset</span> <span class="ow">in</span> <span class="n">setlist</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verlist</span><span class="p">:</span>
                        <span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

                        <span class="n">inherit_icalc</span><span class="p">(</span><span class="n">inherit_option</span><span class="p">,</span> <span class="n">it_new</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">id_base</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">st_base</span> <span class="o">=</span> <span class="n">input_st</span><span class="p">,</span> <span class="n">id_from</span> <span class="o">=</span> <span class="n">id_from</span><span class="p">,</span> <span class="n">confdic</span> <span class="o">=</span> <span class="n">confdic</span><span class="p">,</span>
                            <span class="n">it_folder</span> <span class="o">=</span> <span class="n">section_folder</span><span class="p">,</span> <span class="n">occ_atom_coressp</span> <span class="o">=</span> <span class="n">occ_atom_coressp</span><span class="p">,</span> <span class="n">i_atom_to_remove</span> <span class="o">=</span> <span class="n">i_atom_to_remove</span><span class="p">,</span>
                            <span class="n">ortho</span> <span class="o">=</span> <span class="n">ortho</span><span class="p">,</span> <span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">mul_matrix</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span><span class="n">override</span><span class="p">,</span> <span class="o">**</span><span class="n">inherit_args</span><span class="p">)</span>
                
                    <span class="k">if</span> <span class="n">inherit_option</span> <span class="ow">in</span> <span class="n">inh_opt_ngkpt</span><span class="p">:</span>
                        <span class="n">inherit_ngkpt</span><span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">varset</span><span class="p">[</span><span class="n">inputset</span><span class="p">])</span> <span class="c1"># </span>



            <span class="k">if</span> <span class="n">ise_new</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Inherited calculation uses set&#39;</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">)</span>

                <span class="n">setlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ise_new</span><span class="p">,]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Inherited calculation uses the same sets&#39;</span><span class="p">,</span> <span class="n">setlist</span><span class="p">)</span>


            <span class="n">it</span> <span class="o">=</span> <span class="n">it_new</span>
        <span class="k">return</span>



    <span class="k">def</span> <span class="nf">add_loop_scale</span><span class="p">():</span>

        <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
        <span class="k">nonlocal</span> <span class="n">it</span><span class="p">,</span> <span class="n">verlist</span><span class="p">,</span> <span class="n">setlist</span><span class="p">,</span> <span class="n">input_st</span><span class="p">,</span><span class="n">it_suffix</span>
        <span class="n">u_scale_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fitted_v100_id</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="k">if</span> <span class="n">calc_method</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;scale&#39;</span> <span class="ow">in</span> <span class="n">calc_method</span> <span class="ow">or</span> <span class="s1">&#39;uniform_scale&#39;</span> <span class="ow">in</span> <span class="n">calc_method</span><span class="p">):</span>
            <span class="c1"># print(&#39;sdfsdf&#39;)</span>
            <span class="k">if</span> <span class="s1">&#39;uniform_scale&#39;</span> <span class="ow">in</span> <span class="n">calc_method</span><span class="p">:</span>
                <span class="n">u_scale_flag</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">it_new</span> <span class="o">=</span> <span class="n">it</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span> <span class="c1">#scale uniformly </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">it</span><span class="o">+</span><span class="s1">&#39;.sm&#39;</span> <span class="c1">#scale according to mul_matrix</span>
            

            <span class="k">if</span> <span class="n">it_suffix</span><span class="p">:</span>
                <span class="n">it_new</span> <span class="o">=</span> <span class="n">it</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">it_suffix</span>
                <span class="n">it_suffix</span> <span class="o">=</span> <span class="kc">None</span>



            <span class="n">v</span> <span class="o">=</span> <span class="n">verlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># printlog(&#39;add_loop_scale(): version is &#39;, v)</span>
            <span class="c1"># sys.exit()</span>


            <span class="c1"># if up != &#39;up3&#39;:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;add_loop_scale(): Preparing   scale  calculation ... &#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">verlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! Currently   scale  is allowed only for one version&#39;</span><span class="p">)</span>
            


            <span class="k">if</span> <span class="n">it_new</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">it_folder</span><span class="p">:</span>
                    <span class="n">section_folder</span> <span class="o">=</span> <span class="n">it_folder</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">section_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span>

                <span class="n">add_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">it_new</span><span class="p">,</span> <span class="n">section_folder</span><span class="p">,</span> <span class="s1">&#39;scale: scaled &quot;images&quot; for &#39;</span><span class="o">+</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">setlist</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>   <span class="p">)</span>




            <span class="n">verlist_new</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">ise_new</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">setlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error, ise_new and setlist &gt; 1 detected!&#39;</span><span class="p">)</span>


            <span class="k">for</span> <span class="n">inputset</span> <span class="ow">in</span> <span class="n">setlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inputset</span> <span class="ow">in</span> <span class="n">varset</span><span class="p">:</span>
                    <span class="n">inherit_ngkpt</span><span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">varset</span><span class="p">[</span><span class="n">inputset</span><span class="p">])</span>

                <span class="n">id_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>




                <span class="k">if</span> <span class="n">input_st</span><span class="p">:</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">input_st</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_loop_scale():using input_st&#39;</span><span class="p">,</span> <span class="n">pname</span><span class="p">)</span>
                    <span class="n">input_st</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">id_s</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_s</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">)</span> <span class="o">==</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_loop_scale(): end state of &#39;</span><span class="p">,</span> <span class="n">id_s</span><span class="p">,</span> <span class="s1">&#39;is used&#39;</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_s</span><span class="p">]</span><span class="o">.</span><span class="n">init</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_loop_scale(): init state of &#39;</span><span class="p">,</span> <span class="n">id_s</span><span class="p">,</span> <span class="s1">&#39;is used&#39;</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                    <span class="n">pname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_loop_scale(): starting to read input file&#39;</span><span class="p">)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">smart_structure_read</span><span class="p">(</span><span class="n">curver</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span> <span class="n">input_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">it</span><span class="p">,</span> 
                        <span class="n">input_geo_format</span> <span class="o">=</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">input_geo_file</span><span class="p">)</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span>

                <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="c1"># added on 24.06.2017</span>

                <span class="n">write_xyz</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_used_for_scaling&#39;</span><span class="p">)</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Scale_region is&#39;</span><span class="p">,</span> <span class="n">scale_region</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;uniform_scale&#39;</span> <span class="ow">in</span> <span class="n">calc_method</span><span class="p">:</span>

                    <span class="n">sts</span> <span class="o">=</span> <span class="n">scale_cell_uniformly</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">scale_region</span> <span class="o">=</span> <span class="n">scale_region</span><span class="p">,</span> <span class="n">n_scale_images</span> <span class="o">=</span> <span class="n">n_scale_images</span><span class="p">,</span> <span class="n">parent_calc_name</span> <span class="o">=</span> <span class="n">pname</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sts</span> <span class="o">=</span> <span class="n">scale_cell_by_matrix</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">scale_region</span> <span class="o">=</span> <span class="n">scale_region</span><span class="p">,</span> <span class="n">n_scale_images</span> <span class="o">=</span> <span class="n">n_scale_images</span><span class="p">,</span> <span class="n">parent_calc_name</span> <span class="o">=</span> <span class="n">pname</span><span class="p">,</span> <span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">mul_matrix</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ise_new</span><span class="p">:</span>
                    <span class="n">inputset</span> <span class="o">=</span> <span class="n">ise_new</span>
                    <span class="n">id_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

                <span class="n">cl_temp</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">(</span><span class="n">varset</span><span class="p">[</span><span class="n">inputset</span><span class="p">],</span> <span class="n">id_s</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sts</span><span class="p">):</span>
                    <span class="n">ver_new</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span> <span class="mi">1</span> <span class="c1"># start from 1; before it was v+i</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">s</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ver_new</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">geo_folder</span> <span class="o">+</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                                                <span class="n">it_new</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.auto_created_scaled_image&#39;</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ver_new</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="s1">&#39;geo&#39;</span>

                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">write_siman_geo</span><span class="p">(</span><span class="n">geotype</span> <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> 
                        <span class="n">description</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">des</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">write_xyz</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">verlist_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ver_new</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;uniform_scale&#39;</span> <span class="ow">in</span> <span class="n">calc_method</span><span class="p">:</span>
                    <span class="c1">#make version 100</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">100</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;fitted with fit_tool.py on cluster, init is incorrect&#39;</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">inputset</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;2. separately prepared&#39;</span>
                    <span class="n">blockdir</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">varset</span><span class="p">[</span><span class="n">inputset</span><span class="p">]</span><span class="o">.</span><span class="n">blockfolder</span> <span class="c1">#calculation folder</span>
                    <span class="c1"># iid = cl_temp.id          </span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">blockdir</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_temp</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.OUTCAR&#39;</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">cluster_address</span>      <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span>
                    <span class="n">cl_temp</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">project_path_cluster</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_temp</span>
                    <span class="c1"># cl_temp.init = None</span>
                    <span class="n">fitted_v100_id</span> <span class="o">=</span> <span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span>


                <span class="n">verlist</span> <span class="o">=</span> <span class="n">verlist_new</span>

                <span class="n">print_and_log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sts</span><span class="p">),</span> <span class="s1">&#39;scale images have been created.&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            




            <span class="n">it</span>      <span class="o">=</span> <span class="n">it_new</span>
            <span class="k">if</span> <span class="n">ise_new</span><span class="p">:</span>
                <span class="n">setlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ise_new</span><span class="p">]</span>
            <span class="c1"># sys.exit()</span>
        <span class="k">return</span> <span class="n">u_scale_flag</span><span class="p">,</span> <span class="n">fitted_v100_id</span>






    <span class="k">def</span> <span class="nf">add_loop_take_from_database</span><span class="p">():</span>

        <span class="k">nonlocal</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="n">it</span>

        <span class="n">mat_proj_st_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mat_proj_id</span><span class="p">:</span>
            <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;mat_proj&#39;</span>

        <span class="k">if</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;mat_proj&#39;</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Taking structure &quot;</span><span class="o">+</span><span class="n">it</span><span class="o">+</span><span class="s2">&quot; from materialsproject.org ...&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">it_folder</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! Please provide local folder for new &#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="s1">&#39;structure using *it_folder* argument! &#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            
            <span class="n">st</span> <span class="o">=</span> <span class="n">get_structure_from_matproj</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">verlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mat_proj_cell</span><span class="p">,</span> <span class="n">mat_proj_id</span><span class="p">)</span>
            <span class="n">mat_proj_st_id</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">mat_proj_st_id</span>
            <span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">input_geo_file</span>
            <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span>

        <span class="k">elif</span> <span class="n">input_geo_format</span> <span class="o">==</span> <span class="s1">&#39;cee_database&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">it_folder</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! Please provide local folder for new &#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="s1">&#39;structure using *it_folder* argument! &#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

            <span class="n">get_structure_from_cee_database</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">verlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">cee_args</span><span class="p">)</span> <span class="c1">#will transform it to vasp</span>
            <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span>
        <span class="k">return</span> <span class="n">mat_proj_st_id</span>


    <span class="k">def</span> <span class="nf">add_loop_neb</span><span class="p">():</span>
        
        <span class="k">nonlocal</span> <span class="n">n_neb_images</span>
        <span class="n">nebsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">neb_flag</span> <span class="o">=</span> <span class="n">calc_method</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;neb&#39;</span><span class="p">,</span> <span class="s1">&#39;only_neb&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">calc_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neb_flag</span><span class="p">:</span> <span class="c1">#put nimage values for set_sequence</span>
            <span class="n">curset</span> <span class="o">=</span> <span class="n">varset</span><span class="p">[</span> <span class="n">setlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">n_neb_images</span><span class="p">:</span>
                <span class="n">n_neb_images</span> <span class="o">=</span> <span class="n">varset</span><span class="p">[</span><span class="n">curset</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">n_neb_images</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! You did not provide number of NEB images nor in *n_neb_images* nor in your set!&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>


            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">corenum</span> <span class="o">%</span> <span class="n">n_neb_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! Number of cores should be dividable by number of IMAGES&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>

            <span class="n">nebsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">curset</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">curset</span><span class="p">,</span> <span class="s1">&#39;set_sequence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">curset</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">curset</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">:</span>
                    <span class="n">nebsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nebsets</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">init_images_value</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">])</span>
                <span class="n">s</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_neb_images</span>
            <span class="c1">#     print s.vasp_params[&#39;IMAGES&#39;]</span>
            <span class="c1"># sys.exit()</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Attention, I update number of images in the set to&#39;</span><span class="p">,</span> <span class="n">n_neb_images</span><span class="p">,</span> <span class="s1">&#39;for this calculation; &#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">neb_flag</span><span class="p">,</span> <span class="n">nebsets</span>


    <span class="k">def</span> <span class="nf">add_loop_neb2</span><span class="p">(</span><span class="n">neb_flag</span><span class="p">,</span> <span class="n">nebsets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">neb_flag</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;In &quot;neb&quot; mode only one set is allowed&#39;</span> <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Preparing   neb  calculation ... &#39;</span><span class="p">)</span>

            <span class="c1">#create necessary calculations without</span>
            <span class="n">nimages</span> <span class="o">=</span> <span class="n">varset</span><span class="p">[</span><span class="n">setlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]</span>
            <span class="c1"># verlist+=[ 3+v for v in range(nimages)  ] #list of images starts from 3 (1 and 2 are final and start)</span>

            <span class="c1"># write_batch_list+=[False for v in range(nimages)] #not used now</span>

            <span class="c1">#probably the add_calculation() should be used instead of the duplicating for code below, but then </span>
            <span class="c1">#the creation of footer should be taken out</span>
            <span class="c1">#from add_calculation and put in add_loop() in the end.</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">setlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimages</span><span class="p">):</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">3</span>
                <span class="n">cl_i</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
                <span class="n">cl_i</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">cl_i</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="n">cl_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                
                <span class="n">n</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">n_st</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">n_st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


                <span class="n">cl_i</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">n_st</span> <span class="o">+</span> <span class="s2">&quot;/OUTCAR&quot;</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="n">i</span> <span class="p">,</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span> <span class="s1">&#39;overwritten in database&#39;</span><span class="p">)</span>

                <span class="n">cl_i</span><span class="o">.</span><span class="n">associated_outcars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;2.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">])</span>




                <span class="n">cl_i</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;2. Ready to read outcar&#39;</span>

                <span class="k">if</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span> <span class="c1"># for &#39;continue&#39; mode the add_calculation() takes care, but here it should be</span>
                                    <span class="c1"># repeated. Again think about using only add_calculation and  write_batch_list</span>
                    <span class="s1">&#39;&#39;</span>
                    <span class="c1"># print_and_log(&#39;Please test code below this message to save prev calcs&#39;)</span>
                    <span class="c1"># if cl_i != calc[cl_i.id]</span>
                    <span class="c1">#     if hasattr(calc[cl_i.id], &#39;prev&#39;) and calc[cl_i.id].prev:</span>
                    <span class="c1">#         prevlist = calc[cl_i.id].prev</span>
                    <span class="c1">#     else:</span>
                    <span class="c1">#         prevlist = [calc[cl_i.id]]</span>
                    <span class="c1">#     cl_i.prev = prevlist</span>
                    <span class="c1">#     calc[cl_i.id] = cl_i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="s1">&#39;&#39;</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_i</span>

            <span class="c1">#return back images values</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nebsets</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">init_images_value</span> <span class="c1">#return back</span>


    <span class="k">def</span> <span class="nf">add_loop_prepare2</span><span class="p">():</span>

        <span class="k">nonlocal</span> <span class="n">it</span>
        <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>

        <span class="c1"># print(it)</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">if</span> <span class="n">it_suffix</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">it_suffix</span>

        <span class="k">if</span> <span class="n">it</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">it_folder</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Structure&#39;</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;is not in struct_des, Please provide *it_folder*&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="s1">&#39;auto add_des &#39;</span>  <span class="p">)</span>


        <span class="k">if</span> <span class="n">ngkpt</span><span class="p">:</span> <span class="c1"># add to struct_des</span>
            <span class="c1"># print (setlist)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! add_loop(): *ngkpt* parameter is allowed only with one inputset&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kspacing</span> <span class="o">=</span> <span class="n">varset</span><span class="p">[</span><span class="n">setlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">kspacing</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">kspacing</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! add_loop(): no kspacing. In order to use inheritence of ngkpt I should know corresponding approximate kspacing, please provide&#39;</span><span class="p">)</span>

                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_loop(), you provided *ngkpt*, I add&#39;</span><span class="p">,</span> <span class="n">ngkpt</span><span class="p">,</span><span class="s1">&#39;to description of&#39;</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;for kspacing&#39;</span><span class="p">,</span><span class="n">kspacing</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span><span class="p">[</span><span class="n">kspacing</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngkpt</span>



    <span class="k">def</span> <span class="nf">add_loop_choose_input_folder</span><span class="p">():</span>
        
        <span class="k">if</span> <span class="n">ifolder</span><span class="p">:</span>
            <span class="n">input_folder</span> <span class="o">=</span> <span class="n">ifolder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_folder</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">geo_folder</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">it</span>

        <span class="k">return</span> <span class="n">input_folder</span>

    <span class="k">def</span> <span class="nf">add_loop_try_to_read</span><span class="p">():</span>
        <span class="c1"># check if it is possible to read as is; please improve that section</span>
        <span class="c1">#not this functional is in add_calculation, probably move here</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">:</span>
            <span class="n">clc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">clc</span><span class="o">.</span><span class="n">res</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="n">clc</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="s1">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">clc</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;is running or already read&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                <span class="c1"># continue</span>


    <span class="k">def</span> <span class="nf">add_loop_finalize</span><span class="p">(</span><span class="n">u_scale_flag</span><span class="p">,</span> <span class="n">fitted_v100_id</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">id_base</span>
        <span class="k">if</span> <span class="n">u_scale_flag</span><span class="p">:</span>
            <span class="c1">#modify output names for fitted version 100, since it is created manually above and </span>
            <span class="c1">#by add_calculation; for u-ramping names are different</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">setlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">calc</span><span class="p">[</span><span class="n">fitted_v100_id</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/1.&#39;</span><span class="p">,</span> <span class="s1">&#39;/100.&#39;</span><span class="p">)</span>
            
            <span class="n">calc</span><span class="p">[</span><span class="n">fitted_v100_id</span><span class="p">]</span><span class="o">.</span><span class="n">associated_outcars</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1.&#39;</span><span class="p">,</span> <span class="s1">&#39;100.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">]</span>


            <span class="c1"># print (fitted_v100_id, calc[fitted_v100_id].associated_outcars)</span>
            <span class="c1"># sys.exit()</span>

        <span class="k">if</span> <span class="n">ise_new</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">varset</span><span class="p">[</span><span class="n">ise_new</span><span class="p">],</span> <span class="s1">&#39;k_band_structure&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varset</span><span class="p">[</span><span class="n">ise_new</span><span class="p">]</span><span class="o">.</span><span class="n">k_band_structure</span><span class="p">:</span> <span class="c1">#copy chgcar</span>
            
            <span class="c1"># calc[id_base].path[&quot;charge&quot;]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Copying CHGCAR for band structure&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">wrapper_cp_on_server</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id_base</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">],</span> <span class="n">header</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">new_filename</span> <span class="o">=</span> <span class="s1">&#39;CHGCAR&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">inherit_option</span>  <span class="o">==</span> <span class="s1">&#39;full_chg&#39;</span><span class="p">:</span>

            <span class="c1"># cl.path[&quot;charge&quot;] = cl.path[&quot;output&quot;].replace(&#39;OUTCAR&#39;, &#39;CHGCAR&#39;)</span>
            <span class="c1"># print(calc[id_base].path)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Copying CHGCAR ...&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

            <span class="n">wrapper_cp_on_server</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id_base</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">],</span> <span class="n">header</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">new_filename</span> <span class="o">=</span> <span class="s1">&#39;CHGCAR&#39;</span><span class="p">)</span>






        <span class="n">hstring</span> <span class="o">=</span> <span class="s2">&quot;res_loop(&#39;</span><span class="si">{:s}</span><span class="s2">&#39;, </span><span class="si">{:s}</span><span class="s2">, </span><span class="si">{:s}</span><span class="s2">, show = &#39;fo&#39;  )     # </span><span class="si">{:s}</span><span class="s2">, on </span><span class="si">{:s}</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">it</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">setlist</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">verlist</span><span class="p">),</span> <span class="n">comment</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="p">)</span>  <span class="p">)</span>

        <span class="k">if</span> <span class="n">hstring</span> <span class="o">!=</span> <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> 
            <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">hstring</span>  <span class="p">)</span>



        <span class="k">if</span> <span class="n">up</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;up1&#39;</span><span class="p">,</span><span class="s1">&#39;up2&#39;</span><span class="p">,</span><span class="s1">&#39;up3&#39;</span><span class="p">):</span> 
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! You are in the test mode, to add please change up to up1; &quot;</span><span class="p">);</span> 
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">run</span><span class="p">:</span> <span class="c1">#</span>
            <span class="n">complete_run</span><span class="p">()</span> <span class="c1"># for IPython notebook</span>
            <span class="n">printlog</span><span class="p">(</span><span class="n">run_on_server</span><span class="p">(</span><span class="s1">&#39;./run&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">CLUSTER_ADDRESS</span><span class="p">),</span> <span class="n">imp</span><span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;To read results use &#39;</span><span class="p">,</span> <span class="n">hstring</span><span class="p">,</span> <span class="s1">&#39;; possible options for show: fit, fo, fop, en, mag, magp, smag, maga, occ, occ1, mep, mepp&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">u_scale_flag</span>




    <span class="c1"># def add_loop_write </span>






    <span class="n">id_base</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># id1 = (it, setlist[0], verlist[0])</span>

    <span class="n">add_loop_prepare</span><span class="p">()</span>

    <span class="c1"># print(verlist)</span>

    <span class="n">mat_proj_st_id</span> <span class="o">=</span> <span class="n">add_loop_take_from_database</span><span class="p">()</span>
    
    <span class="n">neb_flag</span><span class="p">,</span> <span class="n">nebsets</span>     <span class="o">=</span> <span class="n">add_loop_neb</span><span class="p">()</span>


    <span class="c1"># if </span>
    <span class="n">u_scale_flag</span><span class="p">,</span> <span class="n">fitted_v100_id</span> <span class="o">=</span> <span class="n">add_loop_scale</span><span class="p">()</span>
    
    <span class="n">add_loop_inherit</span><span class="p">()</span>
    
    <span class="n">add_loop_prepare2</span><span class="p">()</span>

    <span class="sd">&quot;&quot;&quot;Main Loop by setlist and verlist&quot;&quot;&quot;</span>
    <span class="n">output_files_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">input_folder</span> <span class="o">=</span> <span class="n">add_loop_choose_input_folder</span><span class="p">()</span>


    <span class="k">for</span> <span class="n">inputset</span> <span class="ow">in</span> <span class="n">setlist</span><span class="p">:</span>

        <span class="n">prevcalcver</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># version of previous calculation in verlist</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verlist</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            
           
            <span class="n">blockdir</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">varset</span><span class="p">[</span><span class="n">inputset</span><span class="p">]</span><span class="o">.</span><span class="n">blockfolder</span> <span class="c1">#calculation folder</span>

            <span class="n">add_calculation</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">v</span><span class="p">,</span> <span class="n">verlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">input_folder</span><span class="p">,</span> <span class="n">blockdir</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">varset</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> 
                <span class="n">inherit_option</span><span class="p">,</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">savefile</span><span class="p">,</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="n">input_geo_file</span><span class="p">,</span> 
                <span class="n">calc_method</span> <span class="o">=</span> <span class="n">calc_method</span><span class="p">,</span> 
                <span class="n">u_ramping_region</span> <span class="o">=</span> <span class="n">u_ramping_region</span><span class="p">,</span>
                <span class="n">mat_proj_st_id</span> <span class="o">=</span> <span class="n">mat_proj_st_id</span><span class="p">,</span>
                <span class="n">output_files_names</span> <span class="o">=</span> <span class="n">output_files_names</span><span class="p">,</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">run</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">input_st</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="n">check_job</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">)</span>
            
            <span class="n">prevcalcver</span> <span class="o">=</span> <span class="n">v</span>


 
    <span class="n">add_loop_neb2</span><span class="p">(</span><span class="n">neb_flag</span><span class="p">,</span> <span class="n">nebsets</span><span class="p">)</span>

    <span class="n">add_loop_finalize</span><span class="p">(</span><span class="n">u_scale_flag</span><span class="p">,</span> <span class="n">fitted_v100_id</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="n">it</span></div>












<div class="viewcode-block" id="add_calculation"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.add_calculation">[docs]</a><span class="k">def</span> <span class="nf">add_calculation</span><span class="p">(</span><span class="n">structure_name</span><span class="p">,</span> <span class="n">inputset</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">first_version</span><span class="p">,</span> <span class="n">last_version</span><span class="p">,</span> <span class="n">input_folder</span><span class="p">,</span> <span class="n">blockdir</span><span class="p">,</span> 
    <span class="n">calc</span><span class="p">,</span> <span class="n">varset</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="n">inherit_option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prevcalcver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coord</span> <span class="o">=</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;abinit&#39;</span><span class="p">,</span> 
    <span class="n">input_geo_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">calc_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">u_ramping_region</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mat_proj_st_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_files_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    schedule_system - type of job scheduling system:&#39;PBS&#39;, &#39;SGE&#39;, &#39;SLURM&#39;</span>

<span class="sd">    prevcalcver - version of previous calculation in verlist</span>

<span class="sd">    output_files_names - the list is updated on every call</span>

<span class="sd">    if inherit_option == &#39;continue&#39; the previous completed calculation is saved in cl.prev list</span>

<span class="sd">    input_st (Structure) - Structure object can be provided instead of input_folder and input_geo_file, has highest priority</span>


<span class="sd">    TODO:</span>
<span class="sd">    make init of seqset inside calculate_nbands(), actualize_set, check_kpoints </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write_parameters_for_monte</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">vasp_run_com</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span>  <span class="s1">&#39;monte.json&#39;</span>  
        <span class="k">if</span> <span class="s1">&#39;monte&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! no paramters for Monte-Carlo simulation were provided! please provide params[&quot;monte&quot;] dictionary to add_loop&#39;</span><span class="p">)</span>      
        <span class="n">pm</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;monte&#39;</span><span class="p">]</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">init</span>
        <span class="n">els</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;void&#39;</span> <span class="ow">in</span> <span class="n">els</span><span class="p">:</span>
            <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;xvoid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">get_specific_elements</span><span class="p">([</span><span class="mi">300</span><span class="p">],</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">)]</span>

        <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;vasp_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vasp_run_com</span> <span class="o">+</span> <span class="s1">&#39; &gt; &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>  <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pm</span><span class="p">,</span> <span class="n">fp</span><span class="p">,)</span>

        <span class="k">return</span> <span class="n">file</span>




    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>


    <span class="nb">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure_name</span><span class="p">,</span> <span class="n">inputset</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">id_first</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure_name</span><span class="p">,</span> <span class="n">inputset</span><span class="p">,</span> <span class="n">first_version</span><span class="p">)</span>


    <span class="n">cl_prev</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s1">&#39;show&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;update_set_dic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;update_set_dic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>



    <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span> 
        <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;exist&quot;</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;add_calculation():&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot; has been already created and has state: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">),)</span><span class="c1"># imp = &#39;y&#39;)</span>

        <span class="c1"># print(cl.state)</span>

        <span class="k">if</span> <span class="n">check_job</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="s1">&#39;5&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ready&quot;</span>
                <span class="k">if</span> <span class="n">up</span> <span class="o">!=</span> <span class="s1">&#39;up2&#39;</span><span class="p">:</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">res</span><span class="p">(</span><span class="n">check_job</span> <span class="o">=</span> <span class="n">check_job</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">])</span> 
                    <span class="k">return</span>

            <span class="k">if</span> <span class="s2">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span><span class="p">:</span> <span class="c1">#attention, should be protected from running the same calculation once again</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">res</span><span class="p">(</span><span class="n">check_job</span> <span class="o">=</span> <span class="n">check_job</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">])</span>
                <span class="c1"># print(check_job)</span>
                <span class="c1"># sys.exit()</span>
                <span class="k">if</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">check_job</span><span class="p">:</span> 
                    <span class="k">return</span>

            <span class="k">elif</span> <span class="s2">&quot;4&quot;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span><span class="p">:</span> 
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;compl&quot;</span>
                <span class="k">if</span> <span class="n">up</span> <span class="o">==</span> <span class="s1">&#39;up2&#39;</span><span class="p">:</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">res</span><span class="p">(</span><span class="n">check_job</span> <span class="o">=</span> <span class="n">check_job</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">])</span> 
                <span class="c1"># sys.exit()</span>

                <span class="k">if</span> <span class="n">up</span> <span class="o">!=</span> <span class="s1">&#39;up2&#39;</span><span class="p">:</span>
                    <span class="k">return</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;new&quot;</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;There is no calculation with id &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;. I create new with set &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inputset</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">)</span>        




    <span class="k">if</span> <span class="s2">&quot;up&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>

        <span class="n">header</span><span class="o">.</span><span class="n">close_run</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;exist&quot;</span><span class="p">,</span><span class="s2">&quot;compl&quot;</span><span class="p">]:</span> 
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;You asked to update existing calculation with id &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;; results are overwritten&quot;</span> <span class="p">)</span>         

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;compl&#39;</span> <span class="ow">and</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;continue&#39;</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;is completed, I will make its copy in self.prev[]&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>         

            <span class="n">cl_prev</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>

        <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">(</span> <span class="n">varset</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
        
        <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>

        <span class="n">cl</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span> 
        <span class="n">cl</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">blockdir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
        

        <span class="n">batch_script_filename</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span>  <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.run&#39;</span>        


        <span class="c1"># all additional properties:</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;savefile&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">savefile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">savefile</span><span class="o">+=</span><span class="n">s</span>



        <span class="n">cl</span><span class="o">.</span><span class="n">calc_method</span> <span class="o">=</span> <span class="n">calc_method</span>


        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;u_ramping_nstep&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">u_ramping_nstep</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Attention! U ramping method is detected from set</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">calc_method</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;u_ramping&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;afm_ordering&#39;</span><span class="p">):</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Attention! afm_ordering method is detected from set</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">calc_method</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;afm_ordering&#39;</span><span class="p">)</span>



        <span class="c1">#pass using object</span>
        <span class="c1"># if header.copy_to_cluster_flag:</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span>      <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">project_path_cluster</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">cluster_home</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_home</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">corenum</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">corenum</span> 
        <span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">schedule_system</span>


        <span class="k">if</span> <span class="n">mat_proj_st_id</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">mat_proj_st_id</span> <span class="o">=</span> <span class="n">mat_proj_st_id</span>




        <span class="k">if</span> <span class="n">inherit_option</span> <span class="o">==</span> <span class="s1">&#39;continue&#39;</span> <span class="ow">and</span> <span class="n">cl_prev</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl_prev</span><span class="p">,</span> <span class="s1">&#39;prev&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cl_prev</span><span class="o">.</span><span class="n">prev</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">prev</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cl_prev</span><span class="o">.</span><span class="n">prev</span><span class="p">)</span> <span class="c1">#if &#39;continue&#39; flag is used several times, we do not need cl.prev.prev.prev.... but cl.prev = [cl1, cl2 ..]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">prev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl_prev</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">up</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="s1">&#39;up2&#39;</span><span class="p">,</span> <span class="s1">&#39;up3&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">copy_to_cluster_flag</span><span class="p">:</span>
                    <span class="n">run_on_server</span><span class="p">(</span><span class="s2">&quot;mkdir -p &quot;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">first_version</span><span class="p">:</span>
                <span class="n">write_batch_header</span><span class="p">(</span><span class="n">batch_script_filename</span> <span class="o">=</span> <span class="n">batch_script_filename</span><span class="p">,</span>
                    <span class="n">schedule_system</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span><span class="p">,</span> 
                    <span class="n">path_to_job</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> 
                    <span class="n">job_name</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">number_cores</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">corenum</span>  <span class="p">)</span>



        <span class="k">if</span> <span class="n">input_st</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">init</span>  <span class="o">=</span> <span class="n">input_st</span>
            <span class="c1"># sys.exit()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">smart_structure_read</span><span class="p">(</span><span class="n">curver</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">calcul</span> <span class="o">=</span> <span class="n">cl</span><span class="p">,</span> <span class="n">input_folder</span> <span class="o">=</span> <span class="n">input_folder</span><span class="p">,</span> 
                <span class="n">input_geo_format</span> <span class="o">=</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">input_geo_file</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]:</span>

            <span class="n">calc_geofile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">])</span> <span class="p">)</span>
            
            <span class="c1"># sys.exit()</span>
            <span class="k">if</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">calc_geofile_path</span><span class="p">:</span> <span class="c1"># copy initial geo file and other files to calc folder</span>

                <span class="n">makedir</span><span class="p">(</span><span class="n">calc_geofile_path</span><span class="p">)</span>

                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="n">calc_geofile_path</span><span class="p">)</span>

                <span class="c1">#copy OCCMATRIX file as well             </span>
                <span class="n">dir_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">dir_2</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span>
                <span class="c1"># sys.exit()</span>
        <span class="k">if</span> <span class="s1">&#39;OCCEXT&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;OCCEXT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#copy occfile</span>
            <span class="k">if</span> <span class="s1">&#39;occmatrix&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;occmatrix&#39;</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/OCCMATRIX&#39;</span> <span class="p">)</span> <span class="c1"># file is provided explicitly</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">dir_1</span><span class="o">+</span><span class="s1">&#39;/OCCMATRIX&#39;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/OCCMATRIX&#39;</span> <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! no OCCMATRIX file was found!!!&#39;</span><span class="p">)</span>


        <span class="c1"># if cl.des:</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">struct_des</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">des</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span> <span class="o">+</span> <span class="n">varset</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">des</span>


        <span class="n">setseq</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="p">]</span>                                                                                                    
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="s1">&#39;set_sequence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">:</span>
                <span class="n">setseq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    

        <span class="n">cl</span><span class="o">.</span><span class="n">check_kpoints</span><span class="p">()</span>    
        

        <span class="k">for</span> <span class="n">curset</span> <span class="ow">in</span> <span class="n">setseq</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setseq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;sequence set mode: set&#39;</span><span class="p">,</span> <span class="n">curset</span><span class="o">.</span><span class="n">ise</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">curset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;update_set_dic&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">actualize_set</span><span class="p">(</span><span class="n">curset</span><span class="p">)</span>




        <span class="k">if</span> <span class="n">up</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="s1">&#39;up2&#39;</span><span class="p">,</span> <span class="s1">&#39;up3&#39;</span><span class="p">]:</span>
            
            <span class="n">cl</span><span class="o">.</span><span class="n">write_structure</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;.POSCAR&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">inherit_option</span><span class="p">,</span> <span class="n">prevcalcver</span><span class="p">)</span>
            
        
            <span class="n">out_name</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">write_sge_script</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.POSCAR&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> 
                <span class="n">inherit_option</span><span class="p">,</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">savefile</span><span class="p">,</span> 
                <span class="n">schedule_system</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>
                <span class="n">batch_script_filename</span> <span class="o">=</span> <span class="n">batch_script_filename</span><span class="p">)</span>
            
                        
            <span class="k">if</span> <span class="n">out_name</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="n">out_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s2">&quot;.OUTCAR&quot;</span> <span class="c1">#set path to output</span>
            
            <span class="c1">#paths to other files</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span> <span class="s1">&#39;CHGCAR&#39;</span><span class="p">)</span>



            <span class="n">output_files_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="p">)</span>




            <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="n">id_first</span><span class="p">:</span>
                <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">add_potcar</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">curset</span> <span class="ow">in</span> <span class="n">setseq</span><span class="p">:</span> <span class="c1">#for each set</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">calculate_nbands</span><span class="p">(</span><span class="n">curset</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_first</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;potcar&#39;</span><span class="p">])</span>



            <span class="k">if</span> <span class="nb">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_version</span><span class="p">:</span>

                <span class="n">list_to_copy</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="s1">&#39;monte&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">calc_method</span><span class="p">:</span>
                    <span class="n">monte_params_file</span> <span class="o">=</span> <span class="n">write_parameters_for_monte</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">vasp_command</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="n">list_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monte_params_file</span><span class="p">)</span>
                
                <span class="n">cl</span><span class="o">.</span><span class="n">write_sge_script</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;footer&#39;</span><span class="p">,</span> <span class="n">schedule_system</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">inherit_option</span><span class="p">,</span> 
                    <span class="n">output_files_names</span> <span class="o">=</span> <span class="n">output_files_names</span><span class="p">,</span> <span class="n">batch_script_filename</span> <span class="o">=</span> <span class="n">batch_script_filename</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="n">savefile</span> <span class="p">)</span>
                
                <span class="n">list_to_copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">cl</span><span class="o">.</span><span class="n">make_incar</span><span class="p">()</span> <span class="p">)</span>
                
                <span class="n">list_to_copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">cl</span><span class="o">.</span><span class="n">make_kpoints_file</span><span class="p">()</span> <span class="p">)</span>

                <span class="n">list_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_script_filename</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">copy_to_cluster_flag</span><span class="p">:</span> 
                    <span class="n">cl</span><span class="o">.</span><span class="n">copy_to_cluster</span><span class="p">(</span><span class="n">list_to_copy</span><span class="p">,</span> <span class="n">up</span><span class="p">)</span>

                    <span class="n">batch_on_server</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">batch_script_filename</span> 

                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Setting executable rights for batch script on server&#39;</span><span class="p">,</span> <span class="n">batch_on_server</span><span class="p">)</span>
                    <span class="n">run_on_server</span><span class="p">(</span><span class="s1">&#39;chmod +x &#39;</span><span class="o">+</span><span class="n">batch_on_server</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">siman_run</span> <span class="ow">or</span> <span class="n">run</span><span class="p">:</span> <span class="c1">#for IPython should be only for run = 1 </span>
                        <span class="n">cl</span><span class="o">.</span><span class="n">make_run</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">schedule_system</span><span class="p">,</span> <span class="n">batch_on_server</span><span class="p">)</span>

            <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;2. Ready for start&quot;</span>



        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;compl&quot;</span><span class="p">:</span> 
            <span class="n">cl</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;2. Can be completed but was reinitialized&#39;</span> <span class="c1">#new behavior 30.08.2016</span>


        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculation &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; successfully created</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>




    <span class="k">return</span></div>












<div class="viewcode-block" id="inherit_icalc"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.inherit_icalc">[docs]</a><span class="k">def</span> <span class="nf">inherit_icalc</span><span class="p">(</span><span class="n">inherit_type</span><span class="p">,</span> <span class="n">it_new</span><span class="p">,</span> <span class="n">ver_new</span><span class="p">,</span> <span class="n">id_base</span><span class="p">,</span> <span class="n">calc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">st_base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">id_from</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">confdic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">atom_new</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">atom_to_replace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  
    <span class="n">id_base_st_type</span> <span class="o">=</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> 
    <span class="n">atoms_to_remove</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">del_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">i_atom_to_remove</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">id_from_st_type</span> <span class="o">=</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span>
    <span class="n">atom_to_shift</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shift_vector</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">it_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">occ_atom_coressp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ortho</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mul_matrix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_init</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for creating new geo files in geo folder based on different types of inheritance</span>
<span class="sd">    Input args: </span>
<span class="sd">        </span>
<span class="sd">        it_new, ver_new - name of new structure,</span>
<span class="sd">        id_base - new structure will be based on the final structure of this calculation;     (can be either Calculation() object or path to geo file)</span>
<span class="sd">        id_from - can be additionally used to adopt for example rprimd from id_from to it_new; (can be either Calculation() object or path to geo file)</span>

<span class="sd">        st_base - if not None then used instead of id_base; not implemented yet</span>
<span class="sd">        confdic (dict) - to pass more parameters</span>


<span class="sd">        </span>
<span class="sd">        inherit_type = &#39;&#39;:</span>
<span class="sd">            </span>
<span class="sd">            full          - full inheritance of final state</span>
<span class="sd">            full_chg      - full + chg file, works only if chg file is on the same cluster</span>
<span class="sd">            &#39;full_nomag&#39;  - full except magmom which are set to None</span>
<span class="sd">            r2r3          - use r2 and r3 from id_from</span>
<span class="sd">            r1r2r3        - use r1, r2 and r3 from id_from</span>
<span class="sd">            remove_atoms  - removes atoms specified with *atoms_to_remove* (list of element names or list of atom numbers)</span>
<span class="sd">                del_pos (int) - choose specific position if several positions exist for the same ion</span>

<span class="sd">            replace_atoms - atoms of type &#39;atom_to_replace&#39; in &#39;id_base&#39; will be replaced by &#39;atom_new&#39; type.</span>
<span class="sd">            make_vacancy  - produce vacancy by removing &#39;i_atom_to_remove&#39; starting from 0</span>
<span class="sd">            occ           - take occ from *id_from* and create file OCCMATRIX for </span>
<span class="sd">                            OMC [https://github.com/WatsonGroupTCD/Occupation-matrix-control-in-VASP]</span>
<span class="sd">                            - occ_atom_coressp (dict) {iatom_calc_from:iatom_calc_base, ... } (atomno starting from 0!!!)</span>
<span class="sd">            supercell - create orthogonal supercel using *ortho* list [a,b,c] or *mul_matrix* (3x3) ( higher priority)</span>
<span class="sd">            antisite  - create anitsite defect:</span>
<span class="sd">                        curent implimintation takes the first alkali cation and the closest to it transition metal and swap them</span>
<span class="sd">                confdic</span>
<span class="sd">                   </span>
<span class="sd">                    - st_from</span>
<span class="sd">                    - cation</span>
<span class="sd">                    - trans</span>
<span class="sd">                    - mode </span>



<span class="sd">        id_base_st_type - use init or end structure of id_base calculation.</span>
<span class="sd">        id_from_st_type  - init or end for id_from</span>

<span class="sd">        atom_to_shift - number of atom to be shifted; starting from 1.</span>
<span class="sd">        shift_vector - vector in decart cooridinates (Angstrom!!) by which the atom will be shifted</span>

<span class="sd">        - it_folder - section folder</span>
<span class="sd">        </span>
<span class="sd">        - use_init (bool) use init structure if end is empty</span>

<span class="sd">    Result: </span>
<span class="sd">        </span>
<span class="sd">        new geo file in the input geo folder</span>

<span class="sd">    Output:</span>
<span class="sd">        </span>
<span class="sd">        no</span>

<span class="sd">    Depends from:</span>
<span class="sd">        </span>
<span class="sd">        header.struct_des</span>
<span class="sd">        header.calc</span>


<span class="sd">    Comments: </span>
<span class="sd">        </span>
<span class="sd">        changes len_units of new to Angstrom!!!</span>
<span class="sd">        !nznucl is not calculated, since only geo is created here!</span>
<span class="sd">        make use of new methods for atom manipulation</span>
<span class="sd">        add to des which type of st is used: &#39;end&#39;, &#39;init&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># hstring = (&quot;%s    #on %s&quot;% (traceback.extract_stack(None, 2)[0][3],   datetime.date.today() ) )</span>
    <span class="n">hstring</span> <span class="o">=</span> <span class="s2">&quot;inherit_icalc(it_new = &#39;</span><span class="si">{:s}</span><span class="s2">&#39;, ver_new = </span><span class="si">{:s}</span><span class="s2">, id_base = </span><span class="si">{:s}</span><span class="s2">, id_from = </span><span class="si">{:s}</span><span class="s2">)   # on </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">it_new</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ver_new</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_base</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_from</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>   <span class="p">)</span>
    <span class="k">if</span> <span class="n">hstring</span> <span class="o">!=</span> <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> 
        <span class="n">header</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">hstring</span>  <span class="p">)</span>

    <span class="c1">#if inherit_type not in header.history[-1] or \</span>
    <span class="c1">#it_new not in header.history[-1]:   header.history.append( hstring  )</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
    <span class="c1"># override  = False</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">id_base</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span> <span class="c1">#use function below for other formats</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Reading id_base from file&#39;</span><span class="p">,</span> <span class="n">id_base</span><span class="p">)</span>
        <span class="n">cl_base</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">()</span>
        <span class="n">cl_base</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">id_base</span><span class="p">)</span>
        <span class="n">cl_base</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;from_file&#39;</span><span class="p">,</span> <span class="s1">&#39;from_file&#39;</span><span class="p">,</span> <span class="n">cl_base</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">cl_base</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">id_base</span>
        <span class="n">cl_base</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">cl_base</span><span class="o">.</span><span class="n">init</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># print(id_base)</span>
            <span class="c1"># id_base = (bytes(id_base[0]),bytes(id_base[1]),id_base[2])</span>

        <span class="k">if</span> <span class="n">id_base</span> <span class="ow">in</span> <span class="n">calc</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id_base</span><span class="p">],</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="s1">&#39;&#39;</span>
            <span class="n">valid_calc</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cl_base</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_base</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Taking id_base from calc:&#39;</span><span class="p">,</span> <span class="n">id_base</span><span class="p">)</span>
        

        <span class="k">else</span><span class="p">:</span>

            <span class="n">cl_temp</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">()</span>
            <span class="n">input_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Searching for id_base&#39;</span><span class="p">,</span> <span class="n">id_base</span><span class="p">,</span> <span class="s1">&#39;in &#39;</span><span class="p">,</span><span class="n">input_folder</span><span class="p">)</span>

            <span class="n">cl_temp</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">smart_structure_read</span><span class="p">(</span> <span class="n">curver</span> <span class="o">=</span> <span class="n">id_base</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_folder</span> <span class="o">=</span> <span class="n">input_folder</span><span class="p">)</span>
            <span class="n">cl_temp</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cl_temp</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
            <span class="n">cl_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;from_file&#39;</span>
            <span class="n">cl_temp</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="n">id_base</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cl_base</span> <span class="o">=</span> <span class="n">cl_temp</span>





    <span class="k">if</span> <span class="n">id_from</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">id_from</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># if string - treated like file name</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;I detect *id_from* path provided; taking some information from:&quot;</span><span class="p">,</span> <span class="n">id_from</span><span class="p">)</span>

            <span class="n">calc_from</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">();</span>
            <span class="n">calc_from</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">id_from</span><span class="p">)</span>
            <span class="n">calc_from</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">init</span>
            <span class="n">calc_from_name</span> <span class="o">=</span> <span class="n">id_from</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;I detect *id_from* Calculation(); taking some information from:&quot;</span><span class="p">,</span> <span class="n">id_from</span><span class="p">,</span> <span class="n">id_from_st_type</span><span class="p">)</span>
            

            <span class="n">calc_from</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_from</span><span class="p">]</span>
            <span class="n">calc_from_name</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">id_from_st_type</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
            <span class="n">st_from</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">end</span>
        <span class="k">elif</span> <span class="n">id_from_st_type</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">st_from</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">init</span>



        <span class="k">if</span> <span class="n">cl_base</span><span class="o">.</span><span class="n">len_units</span> <span class="o">!=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">len_units</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Calculations have different len_units&quot;</span><span class="p">);</span> <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="k">if</span> <span class="n">it_new</span> <span class="o">==</span> <span class="n">id_from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ver_new</span> <span class="o">==</span> <span class="n">id_from</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! check your versions, you are trying to overwrite existing from structures, nothing done&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span> 


    <span class="k">if</span> <span class="n">it_new</span> <span class="o">==</span> <span class="n">cl_base</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ver_new</span> <span class="o">==</span> <span class="n">cl_base</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! check your versions, you are trying to overwrite existing base structures, nothing done&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>
  



    <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>  <span class="n">cl_base</span>  <span class="p">)</span>

    <span class="n">new</span><span class="o">.</span><span class="n">len_units</span> <span class="o">=</span> <span class="s1">&#39;Angstrom&#39;</span> <span class="c1">#! Because from VASP</span>

    <span class="c1"># print(id_base_st_type)</span>
    <span class="c1"># sys.exit()</span>

    <span class="n">new</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ver_new</span>

    <span class="k">if</span> <span class="n">id_base_st_type</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">init</span>
    <span class="k">elif</span> <span class="n">id_base_st_type</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">end</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;znucl&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">use_init</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">init</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! *use_init* flag detected, init is used instead of end&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! end structure of&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;is empty! Use either init or finish calculation, check *use_init* flag!&#39;</span><span class="p">)</span>

    <span class="c1"># print(st.typat)</span>


    <span class="c1">#path to new calc</span>
    <span class="k">if</span> <span class="n">it_folder</span><span class="p">:</span>
        <span class="c1"># add_des(struct_des, it_new, it_folder, des = &#39;auto by inherit_icalc &#39;+inherit_type) see below</span>
        <span class="n">section_folder</span> <span class="o">=</span> <span class="n">it_folder</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">it_new</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! please provide *it_folder*&#39;</span><span class="p">)</span>
        <span class="n">section_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span>


    <span class="n">it_new_folder</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">geo_folder</span> <span class="o">+</span> <span class="n">section_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">it_new</span>
    <span class="n">new</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">it_new_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.inherit.&#39;</span><span class="o">+</span><span class="n">inherit_type</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ver_new</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="s1">&#39;geo&#39;</span>

    <span class="n">makedir</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">])</span>
    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Path for inherited calc =&#39;</span><span class="p">,</span> <span class="n">it_new_folder</span><span class="p">)</span>




    <span class="k">if</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;r2r3&quot;</span><span class="p">:</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39; Partly inherited from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;; r2 and r3 from &#39;</span><span class="o">+</span><span class="n">calc_from_name</span>
        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_from</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_from</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>       
        <span class="n">st</span><span class="o">.</span><span class="n">update_xcart</span><span class="p">()</span> <span class="c1">#calculate new xcart from xred, because rprimd was changed</span>


    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;r1r2r3&quot;</span><span class="p">:</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39; Partly inherited from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;; r1, r2, r3 from &#39;</span><span class="o">+</span><span class="n">calc_from_name</span>
        <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span> <span class="n">st_from</span><span class="o">.</span><span class="n">rprimd</span> <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">hex_a</span>
            <span class="n">new</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">hex_c</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! hex_a and hex_c were not found&#39;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">update_xcart</span><span class="p">()</span> <span class="c1">#calculate new xcart from xred, because rprimd was changed</span>


    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="c1"># print_and_log(&quot;Warning! final xred and xcart was used from OUTCAR and have low precision. Please use CONTCAR file \n&quot;);</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Fully inherited from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span>


    <span class="k">elif</span> <span class="n">inherit_type</span>  <span class="o">==</span> <span class="s1">&#39;full_chg&#39;</span><span class="p">:</span>

        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Fully inherited (including chg file ) from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># The file is copied in add_loop_finalize !!!</span>

    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;full_nomag&quot;</span><span class="p">:</span>
        <span class="c1"># print_and_log(&quot;Warning! final xred and xcart was used from OUTCAR and have low precision. Please use CONTCAR file \n&quot;);</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Fully inherited from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;; &quot;magmom&quot; set to [None]&#39;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;occ&quot;</span><span class="p">:</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Fully inherited from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;; occupation matrix is taken from &#39;</span><span class="o">+</span><span class="n">calc_from_name</span>

        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Inherit option: &quot;occ&quot;, reading occupation matrices from&#39;</span><span class="p">,</span><span class="n">calc_from_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">occ_matrices</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error! calc_from.occ_matrices is empty&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>


        <span class="c1">#additional control to which atoms should be applied</span>
        <span class="c1">#if cells are different</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;You can use *occ_atom_coressp* to control for which atoms you inherit occupations&#39;</span><span class="p">)</span>



        <span class="k">if</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="n">new</span><span class="o">.</span><span class="n">natom</span> <span class="ow">or</span> <span class="n">occ_atom_coressp</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="n">new</span><span class="o">.</span><span class="n">natom</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Attention! Numbers of atoms are different. Please use *occ_atom_coressp* or I will try to use most closest to alkali ion d-atoms &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">occ_atom_coressp</span><span class="p">:</span>
                <span class="c1"># raise RuntimeError</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Please run res_loop(show = &quot;occ&quot;) for *id_base*=&#39;</span><span class="p">,</span><span class="n">id_base</span><span class="p">,</span> <span class="s1">&#39; and *id_from*=&#39;</span><span class="p">,</span><span class="n">id_from</span><span class="p">,</span> <span class="s1">&#39;to save self.dist_numb&#39;</span><span class="p">)</span>


                <span class="n">occ_atom_coressp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">occ_atom_coressp</span><span class="p">[</span><span class="n">calc_from</span><span class="o">.</span><span class="n">dist_numb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">dist_numb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 
            
            
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;The occ matrices will be inherited from atom # in id_from to atom # in id_base:&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">occs</span> <span class="o">=</span> <span class="p">{}</span>
                
            <span class="k">for</span> <span class="n">iat_from</span> <span class="ow">in</span> <span class="n">occ_atom_coressp</span><span class="p">:</span> <span class="c1"># key is atom number in id_from </span>
                <span class="n">iat_new</span> <span class="o">=</span> <span class="n">occ_atom_coressp</span><span class="p">[</span><span class="n">iat_from</span><span class="p">]</span> <span class="c1">#new is based on id_base</span>
                <span class="n">occs</span><span class="p">[</span> <span class="n">iat_new</span> <span class="p">]</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">occ_matrices</span><span class="p">[</span><span class="n">iat_from</span><span class="p">]</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;        occ:&#39;</span><span class="p">,</span><span class="n">iat_from</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;--&gt;&#39;</span><span class="p">,</span> <span class="n">iat_new</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;The cells seems to be consistent; full inheritence of occ_matrices&#39;</span><span class="p">)</span>
            <span class="n">occs</span> <span class="o">=</span> <span class="n">calc_from</span><span class="o">.</span><span class="n">occ_matrices</span>
        
        <span class="c1"># sys.exit()</span>

        <span class="n">write_occmatrix</span><span class="p">(</span><span class="n">occs</span><span class="p">,</span> <span class="n">it_new_folder</span><span class="p">)</span>


        <span class="c1"># st.magmom = [None]</span>
        



        <span class="c1"># sys.exit()</span>

    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s1">&#39;supercell&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">siman.geo</span> <span class="k">import</span> <span class="n">ortho_vec</span><span class="p">,</span> <span class="n">create_supercell</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;       inherit_icalc(): starting supercell mode ...&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="c1"># print_and_log(&#39;rprimd is \n&#39;, st.rprimd)</span>
        
        <span class="k">if</span> <span class="n">mul_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#if *mul_matrix* is not provided, try to use *ortho*</span>
            <span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">ortho_vec</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">,</span> <span class="n">ortho_sizes</span> <span class="o">=</span> <span class="n">ortho</span><span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;*mul_matrix* was calculated from *ortho*&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;*mul_matrix* was explicitly provided&#39;</span><span class="p">)</span>

        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Mul matrix is</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">mul_matrix</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">create_supercell</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">mul_matrix</span><span class="p">)</span>
        <span class="c1"># sc.mul_matrix = mul_matrix.copy()</span>
        <span class="c1"># new.init = sc</span>
        <span class="c1"># new.end  = sc</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;obtained from &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; by creating supercell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ortho</span><span class="p">)</span>
        <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>
    

    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;atom_shift&quot;</span><span class="p">:</span>
        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;obtainded from final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; by shifting atom &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom_to_shift</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; by &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shift_vector</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">atom_to_shift</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shift_vector</span><span class="p">)</span> 
        <span class="n">st</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="n">new</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>



    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;remove_atoms&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remove atoms either of types provided in *atoms_to_remove* or having numbers provided in *atoms_to_remove*</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;All atoms of type &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atoms_to_remove</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; removed from the final state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span>


        <span class="k">if</span> <span class="n">del_pos</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms_to_remove</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_string_like</span><span class="p">(</span><span class="n">atoms_to_remove</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! When *del_pos* is given,  *atoms_to_remove* should be list with one element, but it is&#39;</span><span class="p">,</span> <span class="n">atoms_to_remove</span><span class="p">)</span>

            <span class="n">st</span> <span class="o">=</span> <span class="n">create_deintercalated_structure</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">atoms_to_remove</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">del_pos</span> <span class="o">=</span> <span class="n">del_pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="n">st</span> <span class="o">=</span> <span class="n">remove_atoms</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">atoms_to_remove</span><span class="p">)</span>




        <span class="n">new</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">st</span>
        <span class="n">new</span><span class="o">.</span><span class="n">end</span>  <span class="o">=</span> <span class="n">st</span>
        <span class="n">st</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;_from_&#39;</span><span class="o">+</span><span class="n">new</span><span class="o">.</span><span class="n">name</span>
        <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>









    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;make_vacancy&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Remove  atom &#39;i_atom_to_remove&#39; from final state of id_base&quot;&quot;&quot;</span>


        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Warning! Please check inherit_type == &quot;make_vacancy&quot;, typat can be wrong  if more than one element present in the system</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">,</span>
            <span class="s1">&#39;Use del_atom() method &#39;</span><span class="p">)</span>
        <span class="c1"># raise RuntimeError</span>

        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Atom &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i_atom_to_remove</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; removed from  &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span>

        <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">i_atom_to_remove</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i_atom_to_remove</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">i_atom_to_remove</span><span class="p">]</span>
        <span class="n">ntypat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">))</span>
        <span class="n">znucl_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">)):</span>
            <span class="n">znucl_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="n">znucl_new</span>
        <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">-=</span><span class="mi">1</span>
        <span class="c1"># new.write_geometry(&quot;end&quot;, des)      </span>

        <span class="c1">#make visualization by adding to vacancy hydrogen atom</span>
        <span class="n">st_b_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cl_base</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="n">st_b_copy</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">i_atom_to_remove</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">st_b_copy</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">st_b_copy</span><span class="o">.</span><span class="n">ntypat</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">st_b_copy</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">write_xyz</span><span class="p">(</span><span class="n">st_b_copy</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;test_of_vacancy_creation.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">st_b_copy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>






    <span class="k">elif</span> <span class="n">inherit_type</span> <span class="o">==</span> <span class="s2">&quot;replace_atoms&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simply replace in calculation one atoms by another &quot;&quot;&quot;</span>
        <span class="n">z_new</span>     <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">atom_new</span><span class="p">)</span>
        <span class="n">z_replace</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">atom_to_replace</span><span class="p">)</span>




        <span class="n">znucl</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span>
        
        <span class="k">if</span> <span class="n">z_replace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">:</span> 
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! Calc &quot;</span><span class="o">+</span><span class="n">new</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot; does not have atoms of this type&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="k">if</span> <span class="n">atom_to_replace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atom_new</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">it_new</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! inherit_icalc(): Something wrong with names of atom types&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>            
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;replace &quot;</span><span class="p">,</span> <span class="n">z_replace</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="n">z_new</span><span class="p">)</span>

        <span class="n">znucl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span> <span class="c1"># convert to int</span>
        <span class="n">i_r</span> <span class="o">=</span> <span class="n">znucl</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">z_replace</span><span class="p">)</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;index &quot;</span><span class="p">,</span> <span class="n">i_r</span><span class="p">)</span>
        <span class="n">znucl</span><span class="p">[</span><span class="n">i_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_new</span>

        <span class="k">if</span> <span class="n">znucl</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">znucl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1">#just for special case</span>
            <span class="k">del</span> <span class="n">znucl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;found ntypat&quot;</span> <span class="p">,</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                    <span class="c1">#print t</span>
            <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="o">-=</span><span class="mi">1</span>
            <span class="c1">#print st.typat</span>
            <span class="c1">#print new.end.typat</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="n">znucl</span>



        <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Fully inherited from the &#39;</span><span class="o">+</span> <span class="n">id_base_st_type</span> <span class="o">+</span><span class="s1">&#39; state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span>\
        <span class="s1">&#39; by simple replacing of &#39;</span><span class="o">+</span><span class="n">atom_to_replace</span><span class="o">+</span><span class="s1">&#39; by &#39;</span><span class="o">+</span><span class="n">atom_new</span>

        <span class="n">override</span> <span class="o">=</span> <span class="mi">1</span>



    <span class="k">elif</span> <span class="s1">&#39;antisite&#39;</span> <span class="ow">in</span> <span class="n">inherit_type</span><span class="p">:</span>

        <span class="k">if</span> <span class="s1">&#39;as&#39;</span> <span class="ow">in</span> <span class="n">inherit_type</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">create_antisite_defect</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;Fully inherited from the &#39;</span><span class="o">+</span> <span class="n">id_base_st_type</span> <span class="o">+</span><span class="s1">&#39; state of &#39;</span><span class="o">+</span><span class="n">cl_base</span><span class="o">.</span><span class="n">name</span><span class="o">+</span>\
            <span class="s1">&#39; by simple swapping of alkali and transition atoms&#39;</span>

        <span class="k">elif</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">inherit_type</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">create_antisite_defect2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">st_from</span> <span class="o">=</span> <span class="n">confdic</span><span class="p">[</span><span class="s1">&#39;st_from&#39;</span><span class="p">],</span> <span class="n">cation</span> <span class="o">=</span> <span class="n">confdic</span><span class="p">[</span><span class="s1">&#39;cation&#39;</span><span class="p">],</span> <span class="n">trans</span> <span class="o">=</span> <span class="n">confdic</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">],</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">confdic</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">])</span>
            <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;create_antisite_defect2 &#39;</span>

        <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>






    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! Unknown type of Calculation inheritance&quot;</span><span class="p">)</span>



    




    <span class="c1">#auto addition of description</span>
    <span class="k">if</span> <span class="n">it_new</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span> 
        <span class="n">add_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">it</span> <span class="o">=</span> <span class="n">it_new</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;auto &#39;</span><span class="o">+</span><span class="n">des</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span>  <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">des</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="n">des</span> <span class="o">+</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">des</span>
        <span class="k">if</span> <span class="n">it_folder</span><span class="p">:</span>
            <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span> <span class="o">=</span> <span class="n">it_folder</span> <span class="c1">#update itfolder,</span>




    <span class="k">if</span> <span class="n">mul_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">struct_des</span><span class="p">[</span><span class="n">it_new</span><span class="p">]</span><span class="o">.</span><span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">mul_matrix</span>
    <span class="c1">#write files</span>

    <span class="c1"># print new.end.xcart</span>

    <span class="c1">#print(len(new.end.xred))</span>
    <span class="c1"># print (id_base_st_type)</span>
    <span class="n">new</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">st</span>
    <span class="n">new</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="n">override</span><span class="p">)</span>
    

    <span class="n">write_xyz</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>





    <span class="k">return</span></div>




























<div class="viewcode-block" id="res_loop"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.res_loop">[docs]</a><span class="k">def</span> <span class="nf">res_loop</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">setlist</span><span class="p">,</span> <span class="n">verlist</span><span class="p">,</span>  <span class="n">calc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">varset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">b_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">typconv</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">imp1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">imp2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">matr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">voronoi</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">r_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> 
    <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ifolder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bulk_mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">calc_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">u_ramping_region</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_geo_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">corenum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_st</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ortho</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mat_proj_cell</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ngkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">it_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">choose_image</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">cee_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mat_proj_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">old_behaviour</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">alkali_ion_number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cluster</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read results</span>
<span class="sd">    INPUT:</span>
<span class="sd">        </span>
<span class="sd">        &#39;analys_type&#39; - (&#39;gbe&#39; - calculate gb energy and volume and plot it. b_id should be appropriete cell with </span>
<span class="sd">           </span>
<span class="sd">            bulk material,</span>
<span class="sd">            &#39;e_imp&#39; (&#39;e_imp_kp&#39;, &#39;e_imp_ecut&#39;) - calculate impurity energy - just difference between cells with impurity and without.</span>
<span class="sd">            &#39;fit_ac&#39; - fit a and c lattice constants using 2-dimensianal spline</span>
<span class="sd">            &#39;clusters&#39; - allows to calculate formation energies of clusters</span>
<span class="sd">            &#39;diff&#39; - difference of energies in meV, and volumes A^3; E(id) - E(b_id)</span>
<span class="sd">            &#39;matrix_diff&#39; - difference normalized by matrix atoms</span>

<span class="sd">            &#39;redox_pot&#39; - calculate redox potential relative to b_id() (deintercalated cathode) and energy_ref ( energy per one ion atom Li, Na in metallic state or in graphite)</span>
<span class="sd">            &#39;neb&#39; - make neb path. The start and final configurations </span>
<span class="sd">            should be versions 1 and 2, the intermidiate images are starting from 3 to 3+nimages</span>
<span class="sd">            )</span>
<span class="sd">        </span>
<span class="sd">        voronoi - True of False - allows to calculate voronoi volume of impurities and provide them in output. only if lammps is installed</span>
<span class="sd">        b_id - key of base calculation (for example bulk cell), used in several regimes; </span>
<span class="sd">        r_id - key of reference calculation; defines additional calculation (for example atom in vacuum or graphite to calculate formation energies); can contain directly the energy per one atom</span>

<span class="sd">        up - </span>
<span class="sd">            </span>
<span class="sd">            if equal to &#39;up2&#39; the files are redownloaded; also can be used to download additional files can be &#39;xo&#39; (deprecated?)</span>
<span class="sd">            - if &#39;un&#39; is found in up then siman will try to read unfinished outcars</span>


<span class="sd">        readfiles (bool) - True - read from outcar, False - read from database; </span>



<span class="sd">        The next three used for &#39;clusters&#39; regime:    </span>
<span class="sd">        imp1 - key of bulk cell with one imp1</span>
<span class="sd">        imp2 - key of bulk cell with one imp2</span>
<span class="sd">        matr - key of bulk cell with pure matrix.</span>


<span class="sd">        - show - (str), allows to show additional information:</span>
<span class="sd">            </span>
<span class="sd">            - mag - magnetic moments on magnetic atoms</span>
<span class="sd">              maga</span>
<span class="sd">                *alkali_ion_number* (int) - number of atom around which to sort mag moments from 1</span>
<span class="sd">            - en  - convergence of total energy vs max force</span>
<span class="sd">            - mep - neb path</span>
<span class="sd">            - fo  - max force on each md step</span>
<span class="sd">            - polaron - determine polaron positon, write local surroundin</span>
<span class="sd">            - mig_path - write migration path xyz</span>
<span class="sd">            - pickle - download all pickle and convert to CONTCAR (for Monte-Carlo regime)</span>


<span class="sd">        energy_ref - energy in eV; substracted from energy diffs</span>
<span class="sd">        </span>
<span class="sd">        bulk_mul - allows to scale energy and volume of bulk cell during calculation of segregation energies</span>

<span class="sd">        choose_outcar (int, starting from 1)- if calculation have associated outcars, you can check them as well, by default</span>
<span class="sd">        the last one is used during creation of calculation in write_sge_script()</span>

<span class="sd">        choose_image (int) - relative to NEB, allows to choose specific image for analysis, by default the middle image is used</span>

<span class="sd">        - push2archive (bool) - if True produced images are copied to header.project_conf.path_to_images</span>
<span class="sd">        - description_for_archive - caption for images</span>

<span class="sd">        ret (str) - return some more information in results_dic</span>
<span class="sd">            </span>
<span class="sd">            &#39;energies&#39; - just list of full energies</span>
<span class="sd">        </span>
<span class="sd">        check_job - (bool) check status on server, use 0 if no internet connection</span>

<span class="sd">        fitplot_args - additional arguments for fit_and_plot function</span>

<span class="sd">        style_dic - passed to plot_mep()</span>

<span class="sd">        - ise_new - dummy</span>
<span class="sd">        - inherit_option - dummy</span>
<span class="sd">        - savefile - dummy</span>
<span class="sd">        - cluster - dummy</span>
<span class="sd">        - override - dummy</span>
<span class="sd">        </span>
<span class="sd">        - params - dictionary of additional parameters to control internal, many arguments could me moved here </span>
<span class="sd">            </span>
<span class="sd">            mep_shift_vector - visualization of mep in xyz format</span>

<span class="sd">    RETURN:</span>
<span class="sd">        </span>
<span class="sd">        (results_dic,    result_list)</span>
<span class="sd">        or </span>
<span class="sd">        (result_string, result_list)</span>

<span class="sd">        result_list - list of results; was used in previous versions, now left for compatibility</span>
<span class="sd">        results_dic - should be used in current version! actually once was used as list, now should be used as dict</span>

<span class="sd">    TODO:</span>
<span class="sd">        </span>
<span class="sd">        Make possible update of b_id and r_id with up = &#39;up2&#39; flag; now only id works correctly</span>


<span class="sd">    &quot;&quot;&quot;</span>


    <span class="sd">&quot;&quot;&quot;Setup&quot;&quot;&quot;</span>




    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">verlist</span><span class="p">):</span>
        <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">verlist</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">setlist</span><span class="p">):</span>
        <span class="n">setlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">setlist</span><span class="p">]</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">calc</span><span class="p">:</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>

    <span class="k">def</span> <span class="nf">setting_sshpass</span><span class="p">(</span><span class="n">cl</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span> <span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">):</span>
            <span class="c1"># print(cl.cluster)</span>
            <span class="c1"># clust = header.CLUSTERS[cl.cluster]</span>
            <span class="k">if</span> <span class="s1">&#39;sshpass&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;sshpass&#39;</span><span class="p">]:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;setting sshpass to True&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># sys.exit()</span>
                <span class="n">header</span><span class="o">.</span><span class="n">sshpass</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;sshpass&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header</span><span class="o">.</span><span class="n">sshpass</span> <span class="o">=</span> <span class="kc">None</span>




    <span class="k">try</span><span class="p">:</span>
        <span class="n">b_ver_shift</span> <span class="o">=</span> <span class="n">b_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#add to version of base with respect to version of main</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">b_ver_shift</span> <span class="o">=</span> <span class="mi">0</span>



    <span class="k">if</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="n">loadflag</span> <span class="o">=</span> <span class="n">up</span><span class="o">+</span><span class="s1">&#39;o&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loadflag</span> <span class="o">=</span> <span class="n">up</span>

    <span class="c1"># if choose_outcar:</span>


    <span class="n">name_field_length</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">header</span><span class="o">.</span><span class="n">show_head</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># head before the string of read_results()</span>

    <span class="n">conv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span><span class="p">;</span> 
    <span class="n">n</span>    <span class="o">=</span> <span class="s1">&#39;temp&#39;</span>
    <span class="n">conv</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conv</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conv</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>



    <span class="n">emin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">b_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b_id</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># for all cases besides e_seg and coseg for wich b_id is determined every iteration</span>
                <span class="c1"># print &quot;Start to read &quot;, b_id</span>
                <span class="c1"># if &#39;4&#39; not in calc[b_id].state:</span>
                <span class="k">if</span> <span class="n">readfiles</span><span class="p">:</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">read_results</span><span class="p">(</span><span class="n">loadflag</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">)</span>
                
                <span class="n">e_b</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">;</span> <span class="n">v_b</span> <span class="o">=</span> <span class="mf">1e10</span>
                <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="n">e_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span>
                    <span class="n">v_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Warning! Calculation &#39;</span><span class="p">,</span><span class="n">b_id</span><span class="p">,</span> <span class="s1">&#39;was not finished; please check, now skipping ...&#39;</span><span class="p">,</span> <span class="n">important</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! res_loop(): b_id&#39;</span><span class="p">,</span> <span class="n">b_id</span><span class="p">,</span> <span class="s1">&#39;does not exist. return </span><span class="si">{}</span><span class="s1"> []&#39;</span><span class="p">)</span>
            <span class="c1"># return {}, []</span>

    <span class="c1">#define reference values</span>
    <span class="n">e1_r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">r_id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">e1_r</span> <span class="o">=</span> <span class="n">r_id</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">r_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="c1"># if &#39;4&#39; not in calc[r_id].state:</span>
        <span class="c1">#     print &quot;Start to read reference:&quot;</span>
        <span class="k">if</span> <span class="n">readfiles</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span> <span class="n">calc</span><span class="p">[</span><span class="n">r_id</span><span class="p">]</span><span class="o">.</span><span class="n">read_results</span><span class="p">(</span><span class="n">loadflag</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">)</span>  <span class="p">)</span>
        <span class="n">e_r</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">r_id</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="c1">#reference calc</span>
        <span class="n">nat_r</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">r_id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="c1"># reference calc</span>
        <span class="n">e1_r</span> <span class="o">=</span> <span class="n">e_r</span><span class="o">/</span><span class="n">nat_r</span> <span class="c1"># energy per one atom</span>
        <span class="c1"># print e1_r</span>




    <span class="sd">&quot;&quot;&quot;Main loop&quot;&quot;&quot;</span>
    <span class="n">final_outstring</span> <span class="o">=</span> <span class="s1">&#39;no calculation found&#39;</span>
    <span class="k">for</span> <span class="n">inputset</span> <span class="ow">in</span> <span class="n">setlist</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verlist</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># print(id)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Key&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span>  <span class="s1">&#39;not found in calc!&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="k">continue</span> <span class="c1">#pass non existing calculations</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            
            <span class="n">setting_sshpass</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="c1"># checking if special download commands are needed</span>
            
            <span class="k">if</span> <span class="n">readfiles</span> <span class="ow">and</span> <span class="n">check_job</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">check_job_state</span><span class="p">():</span>
                    <span class="n">printlog</span><span class="p">(</span> <span class="n">cl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has state:&#39;</span><span class="p">,</span><span class="n">cl</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="s1">&#39;; I will continue&#39;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                    <span class="c1"># cl.res()</span>
                    <span class="k">continue</span>


            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="c1"># sys.exit()</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="s1">&#39;jmol&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="c1"># printlog(os.getcwd()+&#39;/&#39;+cl.path[&#39;output&#39;], imp = &#39;Y&#39;)</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">jmol</span><span class="p">()</span>
                <span class="c1"># sys.exit()</span>
                <span class="k">return</span>


            <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="s1">&#39;pickle&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">siman</span><span class="o">.</span><span class="n">classes</span> <span class="c1"># temporary migration solution</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">project_path_cluster</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span>
                <span class="c1"># print(path)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">run_on_server</span><span class="p">(</span><span class="s1">&#39;ls &#39;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/*.pickle&#39;</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">):</span>
                        <span class="n">cl</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">)</span>
                    <span class="n">cl_step</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">()</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin1&#39;</span><span class="p">)</span> <span class="c1"># python2</span>
                    <span class="n">cl_step</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;CONTCAR-&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># sys.exit()</span>



            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">):</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span>

            
            <span class="k">if</span> <span class="n">readfiles</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Starting self.read_results() ...&#39;</span><span class="p">)</span>
                <span class="n">outst</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">read_results</span><span class="p">(</span><span class="n">loadflag</span><span class="p">,</span> <span class="n">analys_type</span><span class="p">,</span> <span class="n">voronoi</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> 
                    <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span> <span class="n">alkali_ion_number</span> <span class="o">=</span> <span class="n">alkali_ion_number</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;5&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outst</span> <span class="o">=</span> <span class="s1">&#39; output was not read &#39;</span>

            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;read_results() output&#39;</span><span class="p">,</span> <span class="n">outst</span><span class="p">)</span>



            <span class="k">if</span> <span class="n">analys_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;e_seg&#39;</span><span class="p">,</span> <span class="s1">&#39;coseg&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="n">b_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_ver_shift</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">b_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_ver_shift</span><span class="p">)</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;b_id&#39;</span><span class="p">,</span> <span class="n">b_id</span><span class="p">)</span>


            <span class="c1"># print(id)</span>
            <span class="c1"># sys.exit()</span>
            <span class="n">e</span>   <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">energy_sigma0</span>
            <span class="n">n_m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of matrix atoms</span>


            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#print e</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">emin</span><span class="p">:</span> 
                <span class="n">emin</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> 
                <span class="n">id_min</span> <span class="o">=</span> <span class="nb">id</span>
            
            <span class="n">conv</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="c1"># print base</span>
            <span class="n">conv</span><span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_id</span><span class="p">)</span>


            <span class="n">outst2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;db[&#39;</span><span class="si">{:s}</span><span class="s2">&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">name_field_length</span><span class="p">)</span>
            


            <span class="n">outst2</span><span class="o">+=</span><span class="s1">&#39;|&#39;</span>
            <span class="n">outst_end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> 

            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span>


            
            <span class="k">if</span>   <span class="n">b_id</span> <span class="p">:</span>

                <span class="c1"># if &quot;4&quot; not in calc[b_id].state:</span>
                <span class="k">if</span> <span class="n">readfiles</span><span class="p">:</span>    
                    <span class="c1"># print(b_id)</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">read_results</span><span class="p">(</span><span class="n">loadflag</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">)</span>

                <span class="c1"># print(b_id)</span>
                <span class="k">if</span> <span class="s2">&quot;4&quot;</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>    

                    <span class="k">if</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">!=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">:</span>
                        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! you are trying to compare calcs with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">pass</span>

                    <span class="k">if</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">NKPTS</span> <span class="o">!=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">:</span>
                        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! you are trying to compare calcs with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; kpoints </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;gbe&#39;</span> <span class="ow">in</span> <span class="n">analys_type</span><span class="p">:</span>      
                        <span class="n">outst2</span> <span class="o">=</span> <span class="n">gb_energy_volume</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">])</span>
                
                    <span class="k">elif</span> <span class="s1">&#39;e_imp&#39;</span> <span class="ow">in</span> <span class="n">analys_type</span><span class="p">:</span>
                        <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">e_imp</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span>
                        <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">v_imp</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span>

                        <span class="c1">#calc[id].v_imp = e - e_b</span>
                        <span class="n">outst2</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2"> &amp; </span><span class="si">%.2f</span><span class="s2">  &amp; </span><span class="si">%.2f</span><span class="s2"> &amp;&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span><span class="p">)</span><span class="o">/</span><span class="n">v_b</span><span class="o">*</span><span class="mi">100</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;e_imp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                        <span class="n">a</span>    <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">hex_a</span><span class="p">;</span>                     <span class="n">a_b</span>  <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">hex_a</span>
                        <span class="n">c</span>    <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">hex_c</span><span class="p">;</span>                     <span class="n">c_b</span>  <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">hex_c</span>
                        <span class="n">ca</span> <span class="o">=</span> <span class="n">c</span><span class="o">/</span><span class="n">a</span><span class="p">;</span>                                   <span class="n">ca_b</span> <span class="o">=</span> <span class="n">c_b</span><span class="o">/</span><span class="n">a_b</span>
                        <span class="n">outst_end</span> <span class="o">=</span> <span class="s2">&quot; &amp; </span><span class="si">{0:.1f}</span><span class="s2"> &amp; </span><span class="si">{1:.1f}</span><span class="s2"> &amp; </span><span class="si">{2:.1f}</span><span class="s2"> &amp; </span><span class="si">{3:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_b</span><span class="p">)</span><span class="o">/</span><span class="n">a_b</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>  <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">c_b</span><span class="p">)</span><span class="o">/</span><span class="n">c_b</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span> <span class="o">-</span> <span class="n">ca_b</span><span class="p">)</span><span class="o">/</span><span class="n">ca_b</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span> <span class="o">-</span> <span class="n">e1_r</span><span class="p">)</span> <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;e_2imp&#39;</span><span class="p">:</span> <span class="c1">#&quot;&quot;&quot;For calculation of energies of two impurities in big cell&quot;&quot;&quot;</span>
                        <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">e_imp</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span>            
                        <span class="n">outst2</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2"> &quot;</span><span class="o">%</span> <span class="p">(</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span>  
                        <span class="n">conv</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>


                    <span class="k">elif</span> <span class="n">analys_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;e_seg&#39;</span><span class="p">,</span> <span class="s1">&#39;coseg&#39;</span><span class="p">):</span> <span class="c1">#&quot;&quot;&quot;For calculation of segregation and cosegregation energies&quot;&quot;&quot;</span>
                        <span class="n">e_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="o">*</span> <span class="n">bulk_mul</span>
                        <span class="n">n_m_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">v_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="o">*</span> <span class="n">bulk_mul</span>
                        <span class="c1"># diffE = e - e_b/n_m_b*n_m</span>
                        <span class="n">diffE</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span>

                        <span class="c1"># outst2 += (&quot;%.0f &amp; %.2f &quot;% ( (e - e_b)*1000, v - v_b ) )</span>
                        
                        <span class="n">outst2</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2"> &amp; </span><span class="si">{:.2f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="p">(</span><span class="n">diffE</span> <span class="o">-</span> <span class="n">energy_ref</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                        <span class="n">outst2</span> <span class="o">+=</span><span class="s1">&#39;&amp;&#39;</span>
                        <span class="c1"># write_xyz(calc[id].end)</span>
                        <span class="c1"># write_xyz(calc[b_id].end)</span>
                        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">diffE</span> <span class="o">-</span> <span class="n">energy_ref</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span><span class="p">]</span>


                    <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;matrix_diff&#39;</span><span class="p">:</span> <span class="c1">#</span>
                        <span class="n">print_and_log</span><span class="p">(</span> <span class="s1">&#39;Calculating matrix_diff...&#39;</span><span class="p">)</span>
                        

                        <span class="n">diffE</span><span class="p">,</span> <span class="n">diffV</span> <span class="o">=</span> <span class="n">matrix_diff</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">],</span> <span class="n">energy_ref</span><span class="p">)</span>
                        <span class="n">outst2</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2"> &amp; </span><span class="si">{:.2f}</span><span class="s2"> &amp;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">diffE</span><span class="p">,</span> <span class="n">diffV</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">diffE</span><span class="p">,</span> <span class="n">diffV</span><span class="p">]</span>


                    <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span> <span class="c1">#</span>
                        <span class="n">print_and_log</span><span class="p">(</span> <span class="s1">&#39;Calculating diff...&#39;</span><span class="p">)</span>
                        <span class="n">e_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span>
                        <span class="n">v_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span>
                        <span class="n">diffE</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span>
                        
                        <span class="n">outst2</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2"> &amp; </span><span class="si">{:.2f}</span><span class="s2"> &amp;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="p">(</span><span class="n">diffE</span> <span class="o">-</span> <span class="n">energy_ref</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">diffE</span> <span class="o">-</span> <span class="n">energy_ref</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span><span class="p">]</span>


            <span class="k">if</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;clusters&#39;</span><span class="p">:</span>
                <span class="n">e1</span>  <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">imp1</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span>
                <span class="n">e2</span>  <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">imp2</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span>
                <span class="n">e_m</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">matr</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">n2</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># print n1,n2</span>
                <span class="n">outst2</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2"> &quot;</span><span class="o">%</span> <span class="p">(</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">n1</span><span class="o">*</span><span class="n">e1</span> <span class="o">-</span> <span class="n">n2</span><span class="o">*</span><span class="n">e2</span> <span class="o">+</span> <span class="p">(</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">e_m</span> <span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            


            <span class="n">final_outstring</span> <span class="o">=</span> <span class="n">outst2</span><span class="o">+</span><span class="n">outst</span> <span class="o">+</span> <span class="n">outst_end</span>     
            <span class="c1"># print ([final_outstring])         </span>
            <span class="n">print_and_log</span><span class="p">(</span> <span class="n">final_outstring</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

        <span class="n">emin</span> <span class="o">=</span> <span class="mi">0</span>
        





        <span class="sd">&quot;&quot;&quot;Aditional analysis, plotting&quot;&quot;&quot;</span>
        <span class="n">results_dic</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#if some part fill this list it will be returned instead of final_outstring</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="s1">&#39;energies&#39;</span><span class="p">:</span>
            <span class="n">results_dic</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="n">energies</span>

        <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>


        <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span> <span class="ow">or</span> <span class="s1">&#39;4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
            <span class="c1"># printlog(calc[id].state, imp = &#39;Y&#39;)</span>
            <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;res_loop(): Calculation &quot;</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;is unfinished; return \{\} []&#39;</span><span class="p">,</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>
        

        <span class="k">if</span> <span class="n">b_id</span><span class="p">:</span> 
            <span class="n">bcl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;gbe&#39;</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Grain boundary energy and excess volume fit:&quot;</span><span class="p">)</span>
            <span class="n">plot_conv</span><span class="p">(</span> <span class="n">conv</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">calc</span><span class="p">,</span> <span class="s2">&quot;fit_gb_volume&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;gbep&#39;</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Grain boundary energy and excess volume fit:&quot;</span><span class="p">)</span>
            <span class="c1"># plot_conv( conv[n], calc, &quot;fit_gb_volume&quot;)</span>
            <span class="n">final_outstring</span> <span class="o">=</span> <span class="n">plot_conv</span><span class="p">(</span> <span class="n">conv</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">calc</span><span class="p">,</span> <span class="s2">&quot;fit_gb_volume_pressure&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">analys_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;e_seg&#39;</span><span class="p">,</span> <span class="s1">&#39;coseg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">verlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>

            <span class="c1">#Test lateral sizes</span>
            <span class="n">A</span>   <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">yzarea</span>
            <span class="n">A_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">yzarea</span>
            
            <span class="k">if</span> <span class="n">A</span> <span class="o">!=</span> <span class="n">A_b</span><span class="p">:</span> 
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! you are trying to compare calcs with different lateral sizes: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">A_b</span><span class="p">))</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Areas are &quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A_b</span><span class="p">,</span><span class="s2">&quot; A^3&quot;</span><span class="p">)</span>
            
            <span class="c1">#Show results </span>
            <span class="n">id1</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span><span class="n">verlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#choosen to save calculated values at first version of version set</span>
            
            <span class="k">if</span> <span class="n">readfiles</span> <span class="ow">and</span> <span class="n">plot</span><span class="p">:</span>           
                <span class="c1">#print &quot; \n\nImpurity at the interface :&quot;</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">emin</span><span class="p">,</span> <span class="n">vmin</span>       <span class="o">=</span> <span class="n">plot_conv</span><span class="p">(</span> <span class="n">conv</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">calc</span><span class="p">,</span>  <span class="s2">&quot;fit_gb_volume2&quot;</span><span class="p">)</span>
                <span class="c1">#print &quot; \n\nImpurity in the volume    :&quot;</span>
                <span class="n">e_b</span><span class="p">,</span> <span class="n">v_b</span><span class="p">,</span> <span class="n">e_bmin</span><span class="p">,</span> <span class="n">v_bmin</span> <span class="o">=</span> <span class="n">plot_conv</span><span class="p">(</span> <span class="n">conv</span><span class="p">[</span><span class="n">base</span><span class="p">],</span> <span class="n">calc</span><span class="p">,</span> <span class="s2">&quot;fit_gb_volume2&quot;</span><span class="p">)</span>
                <span class="n">e_segmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">emin</span> <span class="o">-</span> <span class="n">e_bmin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">v_segmin</span> <span class="o">=</span>  <span class="n">vmin</span> <span class="o">-</span> <span class="n">v_bmin</span>

                
                <span class="n">e_seg</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span> <span class="o">*</span> <span class="n">bulk_mul</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">v_seg</span> <span class="o">=</span>  <span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span> <span class="o">*</span> <span class="n">bulk_mul</span>


                <span class="c1"># print(e_seg, e_segmin)</span>

                <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span> <span class="o">=</span> <span class="n">e_seg</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span> <span class="o">=</span> <span class="n">v_seg</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">],</span> <span class="s1">&#39;e_seg&#39;</span><span class="p">):</span> 
                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Warning! Calculation &quot;</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="s1">&#39;does not have e_seg and v_seg. Try to run with readfiles = True to calculate it.&#39;</span><span class="p">)</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span> <span class="o">=</span> <span class="mi">0</span>
            


            <span class="n">natom</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">natom</span>
            <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">natom</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">natom</span>
            <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">Xgb</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">A</span> <span class="c1"># for grain boundary with 1 A width. For other boundaries should be divided by width. </span>
            <span class="c1">#print (&quot;__________________________________________________________________________&quot;)</span>
            
            <span class="c1"># print (&quot; At zero pressure: segregation energy is %.0f  meV; Seg. volume is %.1f A^3; excess seg. vol. is %.2f A&quot; %(e_seg, v_seg, v_seg/A ) )</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;At min: segregation energy is </span><span class="si">%.0f</span><span class="s2">  meV; Seg. volume is </span><span class="si">%.1f</span><span class="s2"> A^3; excess seg. vol. is </span><span class="si">%.2f</span><span class="s2"> A&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">e_segmin</span><span class="p">,</span> <span class="n">v_segmin</span><span class="p">,</span> <span class="n">v_segmin</span><span class="o">/</span><span class="n">A</span> <span class="p">)</span> <span class="p">)</span>
            <span class="c1"># print (&quot;%s.fit.pe &amp; %.0f &amp; %.1f &amp; %.2f &amp; %.3f &amp; %.1f&quot; %(id[0]+&#39;.&#39;+id[1], e_seg, v_seg, v_seg/A, 1./A, 1./calc[id].natom * 100  ) )</span>
            
            <span class="c1">#Calculate distance from impurity to boundary and number of neighbours for version 2!</span>
            <span class="n">id2</span> <span class="o">=</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="n">inputset</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
            <span class="n">gbpos2</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">gbpos</span> 
            <span class="n">print_and_log</span><span class="p">(</span> <span class="n">id2</span><span class="p">,</span> <span class="s1">&#39;is id2&#39;</span><span class="p">)</span>
            <span class="c1"># print gbpos2</span>
            <span class="c1"># print st.rprimd[0][0]/2.</span>
            <span class="k">if</span> <span class="n">gbpos2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gbpos2</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">gbpos1</span> <span class="o">=</span> <span class="n">gbpos2</span> <span class="o">-</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">gbpos2</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">gbpos2</span><span class="p">)</span>
            <span class="n">dgb</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span> 
            <span class="n">iimp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="n">d1</span><span class="p">:</span> 
                <span class="n">dgb</span> <span class="o">=</span> <span class="n">d2</span>
                <span class="n">iimp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="n">t</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">iimp</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">segimp</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="c1">#Type of impurity closest to gb</span>
            <span class="c1"># print segimp, d</span>

            <span class="n">id_m2</span>   <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;.m&#39;</span><span class="p">,</span>      <span class="s1">&#39;8&#39;</span><span class="o">+</span><span class="n">inputset</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;e_seg&#39;</span><span class="p">:</span>

                <span class="c1">#calc e_seg2 and decomposition to mechanical and chemical contributions</span>

                <span class="k">if</span> <span class="n">id_m2</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span> <span class="c1">#additional analysis</span>
                    <span class="n">b_id2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">inputset</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">b_id_m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.m&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="o">+</span><span class="n">inputset</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="n">e_seg2</span> <span class="o">=</span> <span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="o">-</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id2</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="n">e_m2</span>   <span class="o">=</span> <span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id_m2</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="o">-</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id_m2</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="n">e_ch2</span>  <span class="o">=</span> <span class="n">e_seg2</span> <span class="o">-</span> <span class="n">e_m2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e_seg2</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">e_m2</span>   <span class="o">=</span><span class="mi">0</span>
                    <span class="n">e_ch2</span>  <span class="o">=</span><span class="mi">0</span>


                <span class="c1">#calculate number of close neibours around closest to gb imp</span>
                <span class="n">x_central</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">iimp</span><span class="p">]</span>
                <span class="n">st_r</span>  <span class="o">=</span> <span class="n">replic</span><span class="p">(</span><span class="n">st</span><span class="p">,</span>   <span class="n">mul</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">inv</span> <span class="o">=</span>  <span class="mi">1</span> <span class="p">)</span>
                <span class="n">st_rr</span> <span class="o">=</span> <span class="n">replic</span><span class="p">(</span><span class="n">st_r</span><span class="p">,</span> <span class="n">mul</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">inv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="c1"># to be sure that impurity is surrounded by atoms</span>

                <span class="n">dmax</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">nlist</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span>  <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st_rr</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="n">st_rr</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x_central</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dmax</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">nneigbours</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">nlist</span><span class="p">)</span>


                <span class="n">final_outstring</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.fit.pe &amp; </span><span class="si">%.0f</span><span class="s2"> &amp; </span><span class="si">%.1f</span><span class="s2"> &amp; </span><span class="si">%.2f</span><span class="s2"> &amp; %.d &amp; </span><span class="si">%4.0f</span><span class="s2"> &amp; </span><span class="si">%4.0f</span><span class="s2"> &amp; </span><span class="si">%4.0f</span><span class="s2"> &amp; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="p">(</span>
                    <span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">id2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span><span class="p">,</span> <span class="n">dgb</span><span class="p">,</span> <span class="n">nneigbours</span><span class="p">,</span> <span class="n">e_seg2</span><span class="p">,</span> <span class="n">e_ch2</span><span class="p">,</span> <span class="n">e_m2</span><span class="p">,</span> <span class="n">segimp</span>  <span class="p">))</span>

                <span class="c1"># final_outstring = (&quot;%s.fit.pe &amp; %.0f &amp; %.0f &amp; %.1f &amp; %.1f &amp; %.2f &amp; %.d &amp; %4.0f &amp; %4.0f &amp; %4.0f &amp; %s &quot; %(</span>
                <span class="c1">#     id2[0]+&#39;.&#39;+id2[1], calc[id1].e_seg, e_segmin, calc[id1].v_seg, v_segmin , dgb, nneigbours, e_seg2, e_ch2, e_m2, segimp  )) #e_segmin and v_segmin are minimum energy (but at some pressure) and corresponing volume</span>



                <span class="n">results_dic</span> <span class="o">=</span> <span class="p">[</span><span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">id2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span><span class="p">,</span> <span class="n">dgb</span><span class="p">,</span> <span class="n">nneigbours</span><span class="p">,</span> <span class="n">e_seg2</span><span class="p">,</span> <span class="n">e_ch2</span><span class="p">,</span> <span class="n">e_m2</span><span class="p">,</span> <span class="n">segimp</span><span class="p">]</span>
            
            <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;coseg&#39;</span> <span class="p">:</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span> <span class="c1">#save in version 2</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span>
                <span class="n">final_outstring</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.fit.pe &amp; </span><span class="si">%.0f</span><span class="s2"> &amp; </span><span class="si">%.1f</span><span class="s2"> &amp; </span><span class="si">%.1f</span><span class="s2"> &amp; </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">e_seg</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">v_seg</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="p">))</span>




            <span class="n">print_and_log</span><span class="p">(</span>  <span class="n">final_outstring</span><span class="p">)</span>
            <span class="n">print_and_log</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hline&#39;</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;e_2imp&#39;</span><span class="p">:</span>
            <span class="c1"># plot_conv( conv[it], calc,  analys_type, conv_ext) #instead use plot_conv( conv[&#39;hs443OO&#39;], calc,  &#39;e_2imp&#39;, [conv[&#39;hs443CO&#39;],conv[&#39;hs443CC&#39;]]) </span>
            <span class="k">pass</span>



        <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;fit_ac&#39;</span><span class="p">:</span>

            <span class="n">print_and_log</span> <span class="p">(</span><span class="s2">&quot;name </span><span class="si">%s</span><span class="s2">_template          acell  </span><span class="si">%.5f</span><span class="s2">  </span><span class="si">%.5f</span><span class="s2">  </span><span class="si">%.5f</span><span class="s2"> # fit parameters are &amp;</span><span class="si">%.5f</span><span class="s2"> &amp;</span><span class="si">%.5f</span><span class="s2"> &amp;</span><span class="si">%i</span><span class="s2"> &amp;</span><span class="si">%i</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">fit_hex</span><span class="p">(</span><span class="mf">0.00002</span><span class="p">,</span><span class="mf">0.00003</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="mi">6000</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">inputset</span><span class="p">,</span> <span class="n">verlist</span><span class="p">,</span> <span class="n">calc</span><span class="p">)</span> <span class="p">)</span>  <span class="p">)</span>    

        <span class="k">elif</span> <span class="s1">&#39;fit_a&#39;</span> <span class="ow">in</span> <span class="n">analys_type</span><span class="p">:</span>
            
            <span class="n">fit_a</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">description_for_archive</span><span class="p">,</span> <span class="n">analys_type</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">push2archive</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;dimer&#39;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Fit of md steps obtained from constant speed; see vasp description for dimer&quot;&quot;&quot;</span>
            <span class="c1"># print calc[id].list_e_sigma0</span>
            <span class="c1"># calc[id].list_dE = []</span>
            <span class="c1"># for E in calc[id].list_e_without_entr:</span>

            <span class="c1">#     calc[id].list_dE.append(E - 2*calc[b_id].e_without_entr)</span>

            <span class="c1"># print calc[id].list_e_without_entr</span>
            <span class="c1"># print calc[id].list_dE</span>
            <span class="n">calc</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">e_ref</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span><span class="o">.</span><span class="n">e_without_entr</span>

            <span class="n">plot_conv</span><span class="p">(</span> <span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">calc</span><span class="p">,</span>  <span class="s2">&quot;dimer&quot;</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bcl</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;res_loop: Calculation &quot;</span><span class="p">,</span><span class="n">bcl</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;is unfinished; return&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>

            <span class="n">results_dic</span> <span class="o">=</span> <span class="n">calc_redox</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">bcl</span><span class="p">,</span> <span class="n">energy_ref</span><span class="p">)</span>
            



        <span class="k">if</span> <span class="n">analys_type</span> <span class="o">==</span> <span class="s1">&#39;neb&#39;</span><span class="p">:</span>
            <span class="n">results_dic</span> <span class="o">=</span> <span class="n">neb_analysis</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">push2archive</span><span class="p">,</span> <span class="n">old_behaviour</span><span class="p">,</span> <span class="n">results_dic</span><span class="p">,</span> <span class="n">fitplot_args</span><span class="p">,</span> <span class="n">style_dic</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>








    <span class="k">if</span> <span class="n">results_dic</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results_dic</span><span class="p">,</span> <span class="n">result_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_outstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">),</span> <span class="n">result_list</span> <span class="c1"># only for last version or fit depending on type of analysis</span></div>








<div class="viewcode-block" id="create_phonopy_conf_file"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.create_phonopy_conf_file">[docs]</a><span class="k">def</span> <span class="nf">create_phonopy_conf_file</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;mesh&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;filetype</span>
<span class="sd">            mesh - mesh.conf</span>
<span class="sd">            band - band.conf</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">mpstr</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">mp</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;band&#39;</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/band.conf&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/mesh.conf&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DIM = 1 1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATOM_NAME = &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># f.write(&quot;\nDIAG = .TRUE.\n&quot;)</span>
        <span class="c1"># f.write(&quot;DISPLACEMENT_DISTANCE = 0.03\n&quot;)    </span>

        <span class="c1"># f.write(&quot;TETRAHEDRON\n&quot;)</span>
        <span class="c1"># f.write(&quot;SIGMA = 0.1\n&quot;)</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MP = </span><span class="si">{:}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">mpstr</span> <span class="p">))</span>
        
        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;band&#39;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;BAND = </span><span class="si">{:}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s1">&#39;0.5 0.5 0.5  0.0 0.0 0.0  0.5 0.5 0.0  0.0 0.5 0.0&#39;</span> <span class="p">))</span></div>




<div class="viewcode-block" id="read_phonopy_dat_file"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.read_phonopy_dat_file">[docs]</a><span class="k">def</span> <span class="nf">read_phonopy_dat_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read .dat file from phonopy</span>
<span class="sd">    for reading yaml see self.read_phonopy_data()</span>
<span class="sd">    should be probably combined</span>

<span class="sd">    freq - frequency in THz</span>
<span class="sd">    tot - total energy for freq</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tot&#39;</span><span class="p">:[],</span> <span class="s1">&#39;freq&#39;</span><span class="p">:[]}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">dos</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">dos</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">dos</span></div>


<div class="viewcode-block" id="read_phonopy_data"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.read_phonopy_data">[docs]</a><span class="k">def</span> <span class="nf">read_phonopy_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;free_energy&quot;</span><span class="p">,</span> <span class="n">convert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert (bool) - convert kJ/mol to eV</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># with open(filename, &#39;r&#39;) as f:</span>
    <span class="c1">#     f.readline()</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#     for line in f:</span>
    <span class="c1">#         T.append(float(line.split()[0]))</span>
    <span class="c1">#         F.append(float(line.split()[1]))</span>
    <span class="c1">#     # print T, F</span>
    <span class="kn">import</span> <span class="nn">yaml</span>

    <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
        <span class="n">mul</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">kJ_mol2eV</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># print(mul)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># use safe_load instead load</span>
    <span class="n">dataMap</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">dataMap</span><span class="p">[</span><span class="s1">&#39;thermal_properties&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prop</span><span class="p">)):</span>
        <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">prop</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">prop</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="n">mul</span>     <span class="p">)</span>

    <span class="n">coeffs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">fit_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">coeffs1</span><span class="p">)</span>
    <span class="n">T_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    

    <span class="n">fit_and_plot</span><span class="p">(</span><span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">),</span> <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_range</span><span class="p">,</span> <span class="n">fit_func</span><span class="p">(</span><span class="n">T_range</span><span class="p">),</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">),</span> <span class="n">show</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">print_and_log</span><span class="p">(</span> <span class="s1">&#39;I return&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">T_range</span><span class="p">,</span> <span class="n">fit_func</span></div>




<div class="viewcode-block" id="for_phonopy"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.for_phonopy">[docs]</a><span class="k">def</span> <span class="nf">for_phonopy</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">from_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">calctype</span> <span class="o">=</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">additional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1">#creates file for phonopy, run phonopy</span>
    <span class="c1">#new_id - will add this calculation or read; if string then interpreted as filename of thermal_properties.yaml</span>
    <span class="c1">#from_id - tuple - than will take coordinates from the end; or path to input poscar file</span>
    <span class="c1">#type - &#39;create&#39;, &#39;read&#39;</span>
    <span class="c1">#additional - list of calculation names, if calculation was splited into several parts</span>

    <span class="n">mpstr</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">mp</span><span class="p">))</span>





    <span class="k">if</span> <span class="n">calctype</span> <span class="o">==</span> <span class="s1">&#39;create&#39;</span><span class="p">:</span>
        <span class="n">work_path</span> <span class="o">=</span> <span class="s1">&#39;geo/&#39;</span><span class="o">+</span><span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
        <span class="n">log_history</span><span class="p">(</span>  <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">    #on </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>   <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="p">)</span>  <span class="p">)</span>

        <span class="c1"># print type(from_id)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">from_cl</span> <span class="o">=</span> <span class="n">CalculationVasp</span><span class="p">()</span>
            <span class="n">from_cl</span><span class="o">.</span><span class="n">read_poscar</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>
            <span class="n">from_st</span> <span class="o">=</span> <span class="n">from_cl</span><span class="o">.</span><span class="n">init</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">from_cl</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">[</span><span class="n">from_id</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;end&#39;</span>
            <span class="n">from_st</span> <span class="o">=</span> <span class="n">from_cl</span><span class="o">.</span><span class="n">end</span>

            <span class="c1"># print  header.varset</span>
            <span class="c1">#create POSCAR</span>
        <span class="n">posname</span> <span class="o">=</span> <span class="s1">&#39;phonopy_input_poscar&#39;</span>
        <span class="n">from_cl</span><span class="o">.</span><span class="n">write_structure</span><span class="p">(</span><span class="n">name_of_output_file</span> <span class="o">=</span> <span class="n">posname</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">work_path</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">savedPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">work_path</span><span class="p">)</span>
        <span class="c1">#create conf </span>
        <span class="n">confname</span> <span class="o">=</span> <span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.conf&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">confname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DIM = 1 1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATOM_NAME = &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">from_st</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DIAG = .TRUE.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DISPLACEMENT_DISTANCE = 0.03</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

         
        <span class="c1">#run phonopy</span>
        <span class="n">print_and_log</span><span class="p">(</span>
            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;export PYTHONPATH=~/installed/phonopy-1.9.5/lib/python:$PYTHONPATH; rm POSCAR-*; /home/dim/installed/phonopy-1.9.5/bin/phonopy &#39;</span>
            <span class="o">+</span><span class="n">confname</span><span class="o">+</span><span class="s1">&#39; -c &#39;</span><span class="o">+</span><span class="n">posname</span><span class="o">+</span><span class="s1">&#39; -d --tolerance=0.01&#39;</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span>

        <span class="n">ndis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;POSCAR-*&#39;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="n">ndis</span><span class="p">,</span> <span class="s1">&#39; displacement files was created&#39;</span><span class="p">,</span> <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">savedPath</span><span class="p">)</span>


        <span class="c1">#add</span>
        <span class="n">add_loop</span><span class="p">(</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>   <span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ndis</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;ocdx&#39;</span><span class="p">)</span>

        <span class="c1">#copy SPOSCAR - an ideal cell</span>
        <span class="n">src</span> <span class="o">=</span>  <span class="s1">&#39;geo/&#39;</span><span class="o">+</span><span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="s1">&#39;/SPOSCAR&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="s1">&#39;/disp.yaml&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">calctype</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">new_cl</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">[</span><span class="n">new_id</span><span class="p">]</span>

            <span class="n">work_path</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">work_path_geo</span> <span class="o">=</span> <span class="s1">&#39;geo/&#39;</span><span class="o">+</span><span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>



            <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">work_path</span><span class="o">+</span><span class="s1">&#39;/*.POSCAR&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="c1"># print range(1,npos+1), &#39;range&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_path</span><span class="o">+</span><span class="s2">&quot;/1.POSCAR&quot;</span><span class="p">):</span>
                <span class="n">res_loop</span><span class="p">(</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>   <span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">npos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span><span class="p">,</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">additional</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">additional</span><span class="p">:</span>
                    <span class="n">npos_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/*.POSCAR&#39;</span><span class="p">)</span> <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">npos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.POSCAR&quot;</span><span class="p">):</span>
                        <span class="n">res_loop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>   <span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="n">npos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">npos</span><span class="o">+</span><span class="n">npos_new</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span><span class="p">,</span> <span class="p">)</span>
                    
                    <span class="n">npos</span> <span class="o">=</span> <span class="n">npos</span><span class="o">+</span><span class="n">npos_new</span>

                    <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync &quot;</span><span class="o">+</span><span class="n">struct_des</span><span class="p">[</span><span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/*.vasprun.xml &#39;</span><span class="o">+</span><span class="n">work_path</span><span class="p">)</span>
                    <span class="c1"># print &#39;Additional vasprun.xml files were copied to &#39;, work_path</span>

            <span class="n">savedPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">work_path</span><span class="p">)</span>


            <span class="c1">#create conf </span>
            <span class="n">confname</span> <span class="o">=</span> <span class="n">new_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_mesh.conf&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">confname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DIM = 1 1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATOM_NAME = &quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">new_cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
                    <span class="n">el</span> <span class="o">=</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MP = </span><span class="si">{:}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">mpstr</span> <span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSTEP = </span><span class="si">{:}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="mi">1</span> <span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TMAX = </span><span class="si">{:}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="mi">1155</span> <span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;FORCE_SETS&quot;</span><span class="p">):</span>
                <span class="c1">#run phonopy; read forces</span>
                <span class="n">ndis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.vasprun.xml&#39;</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="n">ndis</span><span class="p">,</span> <span class="s1">&#39; displacement files was Found&#39;</span><span class="p">)</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;export PYTHONPATH=~/installed/phonopy-1.9.5/lib/python:$PYTHONPATH; /home/dim/installed/phonopy-1.9.5/bin/phonopy &#39;</span>
                    <span class="o">+</span><span class="s1">&#39;  -f {1..&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndis</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}.vasprun.xml --tolerance=0.01&#39;</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="p">)</span>

            <span class="c1">#calculate thermal prop</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;thermal_properties_&#39;</span><span class="o">+</span><span class="n">mpstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.yaml&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>

                <span class="n">posname</span> <span class="o">=</span> <span class="s1">&#39;SPOSCAR&#39;</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;export PYTHONPATH=~/installed/phonopy-1.9.5/lib/python:$PYTHONPATH; /home/dim/installed/phonopy-1.9.5/bin/phonopy &#39;</span>
                    <span class="o">+</span><span class="n">confname</span><span class="o">+</span><span class="s1">&#39; -c &#39;</span><span class="o">+</span><span class="n">posname</span><span class="o">+</span><span class="s1">&#39; -t -p -s --tolerance=0.01&#39;</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span>

                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s1">&#39;thermal_properties.yaml&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    

            <span class="n">T_range</span><span class="p">,</span> <span class="n">fit_func</span> <span class="o">=</span> <span class="n">read_phonopy_data</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">savedPath</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">new_id</span>
            <span class="n">T_range</span><span class="p">,</span> <span class="n">fit_func</span> <span class="o">=</span> <span class="n">read_phonopy_data</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>



    <span class="k">return</span> <span class="n">T_range</span><span class="p">,</span> <span class="n">fit_func</span></div>






<div class="viewcode-block" id="get_structure_from_cee_database"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.get_structure_from_cee_database">[docs]</a><span class="k">def</span> <span class="nf">get_structure_from_cee_database</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;CEStorage&#39;</span><span class="p">,</span> <span class="n">cee_struct_type</span> <span class="o">=</span> <span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="n">cee_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    cee_struct_type (str) - </span>
<span class="sd">        &#39;exp&#39; - experimental structures</span>
<span class="sd">        &#39;&#39; - all</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">it_base</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Taking structure &quot;</span><span class="o">+</span><span class="n">it_base</span><span class="o">+</span><span class="s2">&quot; from CEE CREI database of Skoltech ...&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>

    <span class="c1"># database_server = &#39;aksenov@10.30.100.28&#39;</span>
    <span class="n">database_server</span> <span class="o">=</span> <span class="s1">&#39;sd&#39;</span>
    <span class="c1"># database_path   = &#39;/home/Data/CEStorage/&#39;</span>
    <span class="n">database_path</span>   <span class="o">=</span> <span class="s1">&#39;/home/Data/&#39;</span><span class="o">+</span><span class="n">section</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">cee_struct_type</span><span class="p">:</span>
        <span class="n">templ</span> <span class="o">=</span> <span class="s1">&#39;*exp*.cif&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">templ</span> <span class="o">=</span> <span class="s1">&#39;*.cif&#39;</span>

    <span class="n">local_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>

    <span class="n">makedir</span><span class="p">(</span><span class="n">local_folder</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">get_from_server</span><span class="p">(</span><span class="n">database_path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">it_base</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">templ</span><span class="p">,</span> <span class="n">local_folder</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">database_server</span><span class="p">)</span>

    <span class="n">geofiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">local_folder</span><span class="o">+</span><span class="n">templ</span><span class="p">)</span>
    <span class="n">printlog</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;The following files have been downloaded&#39;</span><span class="p">,</span> <span class="n">geofiles</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span><span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>
    



    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geofiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cee_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">geofiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cee_file</span> <span class="ow">in</span> <span class="n">file</span> <span class="p">:</span>
                    <span class="n">geofile_from_server</span> <span class="o">=</span> <span class="n">file</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! More than one file, check what you need using *cee_file* parameter&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
    
        <span class="n">geofile_from_server</span> <span class="o">=</span> <span class="n">geofiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;You have chosen&#39;</span><span class="p">,</span> <span class="n">geofile_from_server</span><span class="p">)</span>



    <span class="n">local_poscar_file</span> <span class="o">=</span> <span class="n">local_folder</span><span class="o">+</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;.POSCAR-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>

    <span class="n">cif2poscar</span><span class="p">(</span><span class="n">geofile_from_server</span><span class="p">,</span> <span class="n">poscar_file</span> <span class="o">=</span> <span class="n">local_poscar_file</span><span class="p">)</span>

    <span class="n">add_des</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;taken automatically from cee_database: &#39;</span><span class="o">+</span><span class="n">geofile_from_server</span><span class="p">)</span>

    
    <span class="k">return</span></div>






<div class="viewcode-block" id="get_structure_from_matproj"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.get_structure_from_matproj">[docs]</a><span class="k">def</span> <span class="nf">get_structure_from_matproj</span><span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mat_proj_cell</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mat_proj_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take structures from Mat. projects</span>

<span class="sd">    Find material with &#39;it&#39; stoichiometry (lowest energy) from materialsproject.org, </span>
<span class="sd">    download and create field in struct_des and input POSCAR file</span>
<span class="sd">    ###INPUT:</span>
<span class="sd">        </span>
<span class="sd">        - struct_des-  </span>
<span class="sd">        - it        - materials name, such as &#39;LiCoO2&#39;, .... By default the structure with minimum *e_above_hull* is taken</span>
<span class="sd">        - it_folder - section folder in which the Poscar will be placed</span>
<span class="sd">        - ver       - version of structure defined by user</span>
<span class="sd">        - mat_proj_id (str) - the id can be provided explicitly</span>
<span class="sd">        - mat_proj_cell (str)- </span>
<span class="sd">                - &#39;conv&#39; - conventional</span>

<span class="sd">    ###RETURN:</span>
<span class="sd">        </span>
<span class="sd">        - ?</span>
<span class="sd">        - ?</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">MPRester</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">pmgkey</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="c1"># print m.get_materials_id_references(&#39;mp-24850&#39;)</span>
        <span class="c1"># print m.get_structures(&#39;mp-24850&#39;)</span>
        <span class="c1"># mp_entries = m.get_entries_in_chemsys([&quot;Co&quot;, &quot;O&quot;])</span>
        <span class="c1"># for e in mp_entries:</span>
        <span class="c1">#     if not &#39;is_hubbard = True&#39; in e: continue</span>
        <span class="c1"># energy_per_atom</span>
        <span class="c1"># print mp_entries</span>
        <span class="c1"># print m.supported_task_properties</span>
        <span class="c1"># print it, &#39;it&#39;</span>
        <span class="c1"># print type(it)</span>
        <span class="c1"># it = &quot;LiFePO4&quot;</span>
        <span class="c1"># print m.get_data(it, data_type=&#39;vasp&#39;, prop=&#39;e_above_hull&#39;)</span>

        <span class="k">if</span> <span class="n">mat_proj_id</span><span class="p">:</span>
            <span class="n">groundstate_st_id</span> <span class="o">=</span> <span class="n">mat_proj_id</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">prop_dic_list</span> <span class="o">=</span>  <span class="n">m</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;vasp&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;e_above_hull&#39;</span><span class="p">)</span>




            <span class="n">newlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prop_dic_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s1">&#39;e_above_hull&#39;</span><span class="p">))</span> 

            <span class="n">groundstate_st_id</span> <span class="o">=</span> <span class="n">newlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;material_id&#39;</span><span class="p">]</span>
            <span class="c1"># print groundstate_st_id</span>
            <span class="c1"># print m.get_data(groundstate_st_id, data_type=&#39;vasp&#39;, prop=&#39;hubbards&#39;)</span>
        
        <span class="n">st_pmg</span> <span class="o">=</span>  <span class="n">m</span><span class="o">.</span><span class="n">get_structure_by_material_id</span><span class="p">(</span><span class="n">groundstate_st_id</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;conv&#39;</span> <span class="ow">in</span> <span class="n">mat_proj_cell</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pymatgen.symmetry.analyzer</span> <span class="k">import</span> <span class="n">SpacegroupAnalyzer</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">st_pmg</span><span class="p">,</span> <span class="n">symprec</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="n">st_pmg</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_conventional_standard_structure</span><span class="p">()</span>

        <span class="c1"># print(st_pmg.lattice)</span>
        <span class="c1"># sys.exit()</span>

    <span class="k">if</span> <span class="n">it</span><span class="p">:</span>
        <span class="n">add_des</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;taken automatically from materialsproject.org: &#39;</span><span class="o">+</span><span class="n">groundstate_st_id</span><span class="p">,)</span>
        <span class="n">path2poscar</span> <span class="o">=</span> <span class="n">it_folder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">groundstate_st_id</span><span class="o">+</span><span class="s2">&quot;.POSCAR-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>
        <span class="n">makedir</span><span class="p">(</span><span class="n">path2poscar</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path2poscar</span> <span class="o">=</span> <span class="n">groundstate_st_id</span><span class="o">+</span><span class="s2">&quot;.POSCAR&quot;</span>

    
    <span class="n">Poscar</span><span class="p">(</span><span class="n">st_pmg</span><span class="p">)</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">path2poscar</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vasp4_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Structure&#39;</span><span class="p">,</span> <span class="n">groundstate_st_id</span><span class="p">,</span> <span class="s1">&#39;downloaded from materialsproject.org</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;File &#39;</span><span class="o">+</span><span class="n">path2poscar</span><span class="o">+</span><span class="s2">&quot; was written&quot;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">smart_structure_read</span><span class="p">(</span><span class="n">input_geo_file</span> <span class="o">=</span> <span class="n">path2poscar</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">groundstate_st_id</span> <span class="o">=</span> <span class="n">groundstate_st_id</span>
    <span class="n">st</span><span class="o">.</span><span class="n">mat_proj_st_id</span>    <span class="o">=</span> <span class="n">groundstate_st_id</span>
    <span class="n">st</span><span class="o">.</span><span class="n">input_geo_file</span>    <span class="o">=</span> <span class="n">path2poscar</span>


    <span class="k">return</span> <span class="n">st</span></div>

    <span class="c1">#pymatgen drafts, can be useful</span>

    <span class="c1"># with MPRester(pmgkey) as m:</span>
    <span class="c1">#     print dir(m)</span>
    <span class="c1">#     print m.supported_properties</span>
    <span class="c1">#     print m.get_data(&#39;mp-540111&#39;, data_type=&#39;vasp&#39;, prop=&#39;total_magnetization&#39;)</span>
    <span class="c1">#     # &#39;total_magnetization&#39;</span>

    <span class="c1">#Pymatgen symmetry analyzer</span>
    <span class="c1"># from pymatgen.io.vasp.inputs import Poscar</span>
    <span class="c1"># from pymatgen.symmetry.analyzer import SpacegroupAnalyzer as SA</span>
    <span class="c1"># from pymatgen import Lattice, Structure, Molecule</span>
    <span class="c1"># a = Structure.from_file(&#39;/home/aksenov/scientific_projects/cathode/Li2FePO4F/scaled/Li2FePO4F.ir.su.4uis/100.CONTCAR&#39; )</span>
    <span class="c1"># b = SA(a)</span>
    <span class="c1"># print(b.get_space_group_symbol())</span>
    <span class="c1"># print(a.get_space_group_info())</span>
    <span class="c1"># # lattice = Lattice(st.rprimd)</span>
    <span class="c1"># # print (lattice)</span>

    <span class="c1"># struct = Structure(st.rprimd, st.get_elements(), st.xred)</span>
    <span class="c1"># print(struct)</span>








<div class="viewcode-block" id="manually_remove_from_struct_des"><a class="viewcode-back" href="../../siman.html#siman.calc_manage.manually_remove_from_struct_des">[docs]</a><span class="k">def</span> <span class="nf">manually_remove_from_struct_des</span><span class="p">(</span><span class="n">struct_des</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">del</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Attention! Entry &#39;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39; was removed from struct_des dict/</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>









<span class="n">add</span> <span class="o">=</span> <span class="n">add_loop</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">res_loop</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Dmitry Aksenov.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>