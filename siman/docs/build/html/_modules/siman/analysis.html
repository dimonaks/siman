
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>siman.analysis &#8212; Siman 0.9.5 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for siman.analysis</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span> 
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># sys.path.append(&#39;/home/aksenov/Simulation_wrapper/ase&#39;) #path to ase library</span>
    <span class="kn">from</span> <span class="nn">ase.eos</span> <span class="k">import</span> <span class="n">EquationOfState</span>
    <span class="n">ase_flag</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ase is not avail; run   pip install ase&#39;</span><span class="p">)</span>
    <span class="n">ase_flag</span> <span class="o">=</span> <span class="kc">False</span>


<span class="kn">from</span> <span class="nn">siman</span> <span class="k">import</span> <span class="n">header</span>
<span class="kn">from</span> <span class="nn">siman.header</span> <span class="k">import</span> <span class="n">printlog</span><span class="p">,</span> <span class="n">mpl</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">siman.functions</span> <span class="k">import</span> <span class="n">element_name_inv</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">get_from_server</span>
<span class="kn">from</span> <span class="nn">siman.picture_functions</span> <span class="k">import</span> <span class="n">plot_mep</span>
<span class="kn">from</span> <span class="nn">siman.geo</span> <span class="k">import</span> <span class="n">determine_symmetry_positions</span><span class="p">,</span> <span class="n">local_surrounding</span><span class="p">,</span> <span class="n">find_moving_atom</span><span class="p">,</span> <span class="n">image_distance</span>
<span class="kn">from</span> <span class="nn">siman.database</span> <span class="k">import</span> <span class="n">push_figure_to_archive</span>
<span class="kn">from</span> <span class="nn">siman.small_functions</span> <span class="k">import</span> <span class="n">is_list_like</span><span class="p">,</span> <span class="n">makedir</span>
<span class="kn">from</span> <span class="nn">siman.inout</span> <span class="k">import</span> <span class="n">write_xyz</span><span class="p">,</span> <span class="n">read_xyz</span><span class="p">,</span> <span class="n">write_occmatrix</span>






<div class="viewcode-block" id="determine_barrier"><a class="viewcode-back" href="../../siman.html#siman.analysis.determine_barrier">[docs]</a><span class="k">def</span> <span class="nf">determine_barrier</span><span class="p">(</span><span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The sign of barrier determined by the curvuture at saddle point. Minimum at saddle point corresponds to negative barrier</span>
<span class="sd">    The saddle point is determined as maximum deviation from energy in initial position</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">scipy</span>

    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">energies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Please provide at least energies&#39;</span><span class="p">)</span>


    <span class="n">spl</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">energies</span><span class="p">)</span>

    <span class="n">spl_der</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span>
    <span class="n">spl_der2</span> <span class="o">=</span> <span class="n">spl_der</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">ma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">spl_der</span><span class="o">.</span><span class="n">roots</span><span class="p">()</span>


    <span class="c1"># print(r)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mi</span><span class="o">&lt;</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">ma</span><span class="p">)</span> <span class="p">]</span> <span class="c1"># only roots inside the interval are interesting</span>


    <span class="n">e_at_roots</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e_at_roots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># diff_barrier = max( e_at_roots ) # the maximum value </span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;roots are at &#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">e_at_roots</span><span class="p">)</span>

        <span class="c1">#find r for saddle point. the energy at saddle point is most far away from the energy at initial position by definition</span>
        <span class="n">de_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e_at_roots</span><span class="o">-</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i_r_de_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">de_s</span><span class="p">)</span>
        <span class="c1"># print(de_s)</span>
        <span class="c1"># print(i_r_de_max)</span>


        <span class="n">r_de_max</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i_r_de_max</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span><span class="n">r_de_max</span><span class="p">)</span>
        <span class="n">curvuture_at_saddle</span> <span class="o">=</span> <span class="n">spl_der2</span><span class="p">(</span><span class="n">r_de_max</span><span class="p">)</span>
        
        <span class="n">sign</span> <span class="o">=</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">curvuture_at_saddle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvuture_at_saddle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">critical_point_type</span> <span class="o">=</span> <span class="s1">&#39;maximum&#39;</span>
        <span class="k">elif</span> <span class="n">curvuture_at_saddle</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">critical_point_type</span> <span class="o">=</span> <span class="s1">&#39;minimum&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">critical_point_type</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span>

        <span class="c1"># print(type(r_de_max), type(e), critical_point_type)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saddle point at </span><span class="si">{:.2f}</span><span class="s1"> </span><span class="si">{:.2f}</span><span class="s1"> is a local </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_de_max</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">critical_point_type</span><span class="p">)</span>  <span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Warning! no roots&#39;</span><span class="p">)</span>
        <span class="c1"># diff_barrier = 0</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="n">mine</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">maxe</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">de</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mine</span> <span class="o">-</span> <span class="n">maxe</span><span class="p">)</span>
    <span class="c1"># if de &gt; diff_barrier:</span>
    <span class="n">diff_barrier</span> <span class="o">=</span> <span class="n">de</span> <span class="o">*</span> <span class="n">sign</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Migration barrier is </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">diff_barrier</span><span class="p">))</span>
    <span class="c1"># plt.plot(spl(np.linspace(0, ma, 1000)))</span>
    <span class="c1"># plt.show()</span>

    <span class="k">return</span> <span class="n">diff_barrier</span></div>







<div class="viewcode-block" id="calc_redox"><a class="viewcode-back" href="../../siman.html#siman.analysis.calc_redox">[docs]</a><span class="k">def</span> <span class="nf">calc_redox</span><span class="p">(</span><span class="n">cl1</span><span class="p">,</span> <span class="n">cl2</span><span class="p">,</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculated average redox potential and change of volume</span>
<span class="sd">    cl1 (Calculation) - structure with higher concentration</span>
<span class="sd">    cl2 (Calculation) - structure with lower concentration</span>
<span class="sd">    energy_ref (float) - energy in eV per one alkali ion in anode; default value is for Li; -1.31 eV for Na, -1.02 eV for K</span>
<span class="sd">    </span>
<span class="sd">    temp(float) - potential at temperature, self.F is expected from phonopy calculations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cl1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cl2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! cl1 or cl2 is none; return&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;znucl&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;znucl&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! cl1 or cl2 is bad&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">energy_ref_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span>  <span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mf">1.31</span><span class="p">,</span>  <span class="mi">19</span><span class="p">:</span><span class="o">-</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">37</span><span class="p">:</span><span class="o">-</span><span class="mf">0.93</span><span class="p">}</span>
    <span class="n">z_alk_ions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">37</span><span class="p">]</span>


    <span class="c1">#normalize numbers of atoms by some element except Li, Na, K</span>
    <span class="n">alk1l</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">alk2l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># print cl1.end.znucl</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">):</span>
        <span class="c1"># print i, z</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_alk_ions</span><span class="p">:</span> 
            <span class="n">alk1l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># print &#39;i_alk is found&#39;</span>
            <span class="k">continue</span>
        <span class="c1"># print i, z</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">zb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">zb</span> <span class="ow">in</span> <span class="n">z_alk_ions</span><span class="p">:</span> 
                <span class="c1"># j_alk = j</span>
                <span class="n">alk2l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">zb</span><span class="p">:</span>
                <span class="c1"># print &quot;I use &quot;, z, &quot; to normalize&quot;</span>
                <span class="n">i_n1</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">i_n2</span> <span class="o">=</span> <span class="n">j</span>

    <span class="n">n1</span>  <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i_n1</span><span class="p">]</span>
    <span class="n">n2</span>  <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i_n2</span><span class="p">]</span>

    <span class="c1"># print(n1,n2)</span>

    <span class="n">nz1_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nz2_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">n_alk1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_alk2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_alk_ions</span><span class="p">:</span>
        <span class="n">nz1_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">nz2_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alk1l</span><span class="p">:</span>
        <span class="n">nz1_dict</span><span class="p">[</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alk2l</span><span class="p">:</span>
        <span class="n">nz2_dict</span><span class="p">[</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_alk_ions</span><span class="p">:</span>
        <span class="n">mul</span> <span class="o">=</span> <span class="p">(</span><span class="n">nz1_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">/</span> <span class="n">n1</span> <span class="o">-</span> <span class="n">nz2_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">/</span> <span class="n">n2</span><span class="p">)</span>
        <span class="c1"># print(mul)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mul</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#only change of concentration of one ion type is allowed; the first found is used</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Change of concentration detected for &#39;</span><span class="p">,</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">energy_ref</span><span class="p">:</span> <span class="c1">#take energy ref from dict</span>
                <span class="n">energy_ref</span> <span class="o">=</span> <span class="n">energy_ref_dict</span><span class="p">[</span> <span class="n">z</span> <span class="p">]</span>
            <span class="k">break</span>

    <span class="c1"># print(energy_ref)</span>
    <span class="c1"># print(cl1.energy_sigma0, cl2.energy_sigma0, mul)</span>
    
    <span class="n">e1</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">energy_sigma0</span> 
    <span class="n">e2</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">energy_sigma0</span>
    <span class="k">if</span> <span class="n">temp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#temperature corrections</span>
        <span class="n">e1</span> <span class="o">+=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">+=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="c1"># print(cl1.F(temp), cl2.F(temp))</span>
        <span class="c1"># print(e1, cl1.energy_sigma0)</span>
        <span class="c1"># print(e2, cl2.energy_sigma0)</span>


    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mul</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">redox</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span>  <span class="p">(</span> <span class="n">e1</span> <span class="o">/</span> <span class="n">n1</span> <span class="o">-</span>  <span class="n">e2</span> <span class="o">/</span> <span class="n">n2</span> <span class="p">)</span> <span class="o">/</span> <span class="n">mul</span>  <span class="o">-</span>  <span class="n">energy_ref</span>  <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redox</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># print(n1, n2)</span>

    <span class="n">dV</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="o">/</span> <span class="n">n1</span> <span class="o">-</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="o">/</span> <span class="n">n2</span> 

    <span class="n">vol_red</span> <span class="o">=</span> <span class="n">dV</span> <span class="o">/</span> <span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span><span class="o">/</span><span class="n">n1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="c1"># %</span>

    <span class="c1"># final_outstring = (&quot;{:} | {:.2f} eV \n1&quot;.format(cl1.id[0]+&#39;.&#39;+cl1.id[1], redox  ))</span>
    <span class="n">final_outstring</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:45}</span><span class="s2"> | </span><span class="si">{:30}</span><span class="s2"> | </span><span class="si">{:10.2f}</span><span class="s2"> V | </span><span class="si">{:10.1f}</span><span class="s2"> % | </span><span class="si">{:6.2f}</span><span class="s2">| </span><span class="si">{:6.2f}</span><span class="s2">| </span><span class="si">{:6.0f}</span><span class="s2">| </span><span class="si">{:6.0f}</span><span class="s2"> | </span><span class="si">{:3.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">cl2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">redox</span><span class="p">,</span> <span class="n">vol_red</span><span class="p">,</span> <span class="n">cl1</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">,</span> <span class="n">cl1</span><span class="o">.</span><span class="n">maxforce</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">maxforce</span><span class="p">,</span> <span class="n">value</span> <span class="p">))</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span> <span class="n">final_outstring</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cl1</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">results_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">:</span><span class="n">redox</span><span class="p">,</span> <span class="s1">&#39;id_is&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;id_ds&#39;</span><span class="p">:</span><span class="n">cl2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
        <span class="s1">&#39;kspacing&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kspacing</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">time</span><span class="o">/</span><span class="mf">3600.</span><span class="p">,</span>
        <span class="s1">&#39;mdstep&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">mdstep</span><span class="p">,</span> <span class="s1">&#39;ecut&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ecut</span><span class="p">,</span> <span class="s1">&#39;niter&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">iterat</span><span class="o">/</span><span class="n">cl1</span><span class="o">.</span><span class="n">mdstep</span><span class="p">,</span>
        <span class="s1">&#39;set_is&#39;</span><span class="p">:</span><span class="n">cl1</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;vol_red&#39;</span><span class="p">:</span><span class="n">vol_red</span> <span class="p">}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">results_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">:</span><span class="n">redox</span><span class="p">,</span> <span class="s1">&#39;vol_red&#39;</span><span class="p">:</span><span class="n">vol_red</span><span class="p">}</span>


    <span class="k">return</span> <span class="n">results_dic</span></div>



<div class="viewcode-block" id="matrix_diff"><a class="viewcode-back" href="../../siman.html#siman.analysis.matrix_diff">[docs]</a><span class="k">def</span> <span class="nf">matrix_diff</span><span class="p">(</span><span class="n">cl1</span><span class="p">,</span> <span class="n">cl2</span><span class="p">,</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="c1">#energy of substitutional impurity</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">energy_sigma0</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span>
    <span class="n">n_m</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_b</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">energy_sigma0</span>
    <span class="n">n_m_b</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v_b</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n_m_b</span><span class="p">,</span> <span class="n">n_m</span><span class="p">)</span>
    <span class="n">diffE</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">e_b</span><span class="o">/</span><span class="n">n_m_b</span><span class="o">*</span><span class="n">n_m</span> <span class="o">-</span> <span class="n">energy_ref</span>
    
    <span class="k">return</span> <span class="n">diffE</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v_b</span></div>



<div class="viewcode-block" id="form_en"><a class="viewcode-back" href="../../siman.html#siman.analysis.form_en">[docs]</a><span class="k">def</span> <span class="nf">form_en</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span> <span class="n">norm_el</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate formation energy of reaction.</span>

<span class="sd">    sources, products - list of tuples (x, cl), where x is multiplier and cl is calculation</span>
<span class="sd">    norm_el  - which element to use for normalization</span>

<span class="sd">        &#39;all&#39; - normalize by total number of atoms</span>
<span class="sd">        &#39;el&#39;</span>
<span class="sd">        int - divide by this number</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">El</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Nzl</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sources</span><span class="p">,</span> <span class="n">products</span><span class="p">]:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Nz</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">+=</span> <span class="n">x</span><span class="o">*</span><span class="n">cl</span><span class="o">.</span><span class="n">e0</span> 
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">z</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Nz</span><span class="p">:</span>
                    <span class="n">Nz</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">Nz</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="o">*</span><span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">El</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="n">Nzl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">Nzl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Nzl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">z</span><span class="p">]</span> <span class="o">-</span> <span class="n">Nzl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">z</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! Number of&#39;</span><span class="p">,</span> <span class="n">invert</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="s1">&#39;atoms in source and product are different!&#39;</span><span class="p">)</span>

    <span class="c1"># norm = 1</span>
    <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="o">==</span> <span class="n">norm_el</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Nzl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">norm_el</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">Nzl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">invert</span><span class="p">(</span><span class="n">norm_el</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">norm_el</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">norm_el</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># print(&#39;Normalizing by &#39;, norm_el, norm, &#39;atoms&#39;)</span>

    <span class="n">dE</span> <span class="o">=</span> <span class="p">(</span><span class="n">El</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">El</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">norm</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dE = </span><span class="si">{:4.2f}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dE</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">dE</span></div>

<div class="viewcode-block" id="chgsum"><a class="viewcode-back" href="../../siman.html#siman.analysis.chgsum">[docs]</a><span class="k">def</span> <span class="nf">chgsum</span><span class="p">(</span><span class="n">cll</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate sum of Bader charges for particular atoms</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">cll</span><span class="p">:</span>
        <span class="c1"># print(cl.id, end = &#39;  &#39;)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">chgsum</span><span class="p">[(</span><span class="n">el</span><span class="p">,</span> <span class="n">site</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;charges&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">charges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">get_bader_ACF</span><span class="p">()</span>
        <span class="c1"># determine_symmetry_positions(cl.end, el, silent = 0)</span>

    <span class="c1"># print(&#39;&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">determine_symmetry_positions</span><span class="p">(</span><span class="n">cll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;chgsum() Warning!&#39;</span><span class="p">,</span> <span class="n">cll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;is broken!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">[</span><span class="n">site</span><span class="p">]:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">cll</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;chgsum&#39;</span><span class="p">):</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">chgsum</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">chgsum</span><span class="p">[(</span><span class="n">el</span><span class="p">,</span> <span class="n">site</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">cl</span><span class="o">.</span><span class="n">chgsum</span><span class="p">[(</span><span class="n">el</span><span class="p">,</span> <span class="n">site</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">cl</span><span class="o">.</span><span class="n">charges</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        
            <span class="c1"># print(&#39;{:5.3f}&#39;.format(cl.charges[p]), end = &#39;  &#39;)</span>
        <span class="c1"># print(&#39;&#39;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sum of charges for &#39;</span><span class="p">,</span> <span class="n">el</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
    

    <span class="n">el_ind</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">invert</span><span class="p">(</span><span class="n">el</span><span class="p">))</span> <span class="c1"># index of element in znucl and zval and nznucl</span>
    <span class="n">zval</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span><span class="p">[</span><span class="n">el_ind</span><span class="p">]</span> <span class="c1"># number of electrons in chosen potential</span>

    <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">cll</span><span class="p">:</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">chgsum</span><span class="p">[(</span><span class="n">el</span><span class="p">,</span> <span class="n">site</span><span class="p">)]</span><span class="o">/=</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">site</span><span class="p">])</span>
        
        <span class="n">chgsum</span> <span class="o">=</span> <span class="n">zval</span> <span class="o">-</span> <span class="n">cl</span><span class="o">.</span><span class="n">chgsum</span><span class="p">[(</span><span class="n">el</span><span class="p">,</span> <span class="n">site</span><span class="p">)]</span>



        <span class="k">if</span> <span class="n">cl</span> <span class="o">==</span> <span class="n">cll</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">chgsum_ref</span> <span class="o">=</span> <span class="n">chgsum</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:5.2f}</span><span class="s1">(</span><span class="si">{:4.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chgsum</span><span class="p">,</span> <span class="n">chgsum_ref</span><span class="o">-</span><span class="n">chgsum</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># print(cl.charges)</span>
    <span class="k">return</span> <span class="n">chgsum</span></div>






<div class="viewcode-block" id="fit_a"><a class="viewcode-back" href="../../siman.html#siman.analysis.fit_a">[docs]</a><span class="k">def</span> <span class="nf">fit_a</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">description_for_archive</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">push2archive</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Fit equation of state for bulk systems.</span>

<span class="sd">    The following equation is used::</span>

<span class="sd">       sjeos (default)</span>
<span class="sd">           A third order inverse polynomial fit 10.1103/PhysRevB.67.026103</span>

<span class="sd">                           2      3        -1/3</span>
<span class="sd">       E(V) = c + c t + c t  + c t ,  t = V</span>
<span class="sd">               0   1     2      3</span>

<span class="sd">       taylor</span>
<span class="sd">           A third order Taylor series expansion about the minimum volume</span>

<span class="sd">       murnaghan</span>
<span class="sd">           PRB 28, 5480 (1983)</span>

<span class="sd">       birch</span>
<span class="sd">           Intermetallic compounds: Principles and Practice,</span>
<span class="sd">           Vol I: Principles. pages 195-210</span>

<span class="sd">       birchmurnaghan</span>
<span class="sd">           PRB 70, 224107</span>

<span class="sd">       pouriertarantola</span>
<span class="sd">           PRB 70, 224107</span>

<span class="sd">       vinet</span>
<span class="sd">           PRB 70, 224107</span>

<span class="sd">       antonschmidt</span>
<span class="sd">           Intermetallics 11, 23-32 (2003)</span>

<span class="sd">       p3</span>
<span class="sd">           A third order polynomial fit</span>

<span class="sd">        Use::</span>

<span class="sd">           eos = EquationOfState(volumes, energies, eos=&#39;sjeos&#39;)</span>
<span class="sd">           v0, e0, B = eos.fit()</span>
<span class="sd">           eos.plot()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># e, v, emin, vmin       = plot_conv( conv[n], calc,  &quot;fit_gb_volume2&quot;)</span>


    <span class="kn">from</span> <span class="nn">picture_functions</span> <span class="k">import</span> <span class="n">fit_and_plot</span>

    <span class="n">alist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">etotlist</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">magn1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">magn2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">alphas</span><span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span>
        <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">etotlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span>
        <span class="n">vlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span><span class="p">)</span>
        <span class="n">magn1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">magn1</span><span class="p">)</span>
        <span class="n">magn2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">magn2</span><span class="p">)</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_angles</span><span class="p">()</span>
        <span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;alpha, energy: </span><span class="si">{:4.2f}</span><span class="s1">, </span><span class="si">{:6.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">))</span>

    <span class="n">fit_and_plot</span><span class="p">(</span><span class="n">U1</span> <span class="o">=</span> <span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">etotlist</span><span class="p">,</span> <span class="s1">&#39;o-r&#39;</span><span class="p">),</span> 
        <span class="n">image_name</span> <span class="o">=</span> <span class="s1">&#39;figs/angle&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Total energy, eV&#39;</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Angle, deg&#39;</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">89</span><span class="p">,</span> <span class="mf">92.6</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ase_flag</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;angle&#39;</span> <span class="ow">in</span> <span class="n">analysis_type</span><span class="p">:</span>
            <span class="n">eos</span> <span class="o">=</span> <span class="n">EquationOfState</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">etotlist</span><span class="p">,</span> <span class="n">eos</span> <span class="o">=</span> <span class="s1">&#39;sjeos&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eos</span> <span class="o">=</span> <span class="n">EquationOfState</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">etotlist</span><span class="p">,</span> <span class="n">eos</span> <span class="o">=</span> <span class="s1">&#39;sjeos&#39;</span><span class="p">)</span>
        <span class="c1"># import inspect</span>

        <span class="c1"># print (inspect.getfile(EquationOfState))</span>

        <span class="n">v0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="c1">#print &quot;c = &quot;, clist[2]</span>
        <span class="n">printlog</span><span class="p">(</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        v0 = </span><span class="si">{0}</span><span class="s1"> A^3</span>
<span class="s1">        a0 = </span><span class="si">{1}</span><span class="s1"> A</span>
<span class="s1">        E0 = </span><span class="si">{2}</span><span class="s1"> eV</span>
<span class="s1">        B  = </span><span class="si">{3}</span><span class="s1"> eV/A^3&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">e0</span><span class="p">,</span> <span class="n">B</span><span class="p">),</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>  <span class="p">)</span>

        <span class="n">savedpath</span> <span class="o">=</span> <span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>
        <span class="n">makedir</span><span class="p">(</span><span class="n">savedpath</span><span class="p">)</span>


        <span class="n">cl</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">*</span><span class="mf">160.218</span>
        <span class="c1"># plt.close()</span>
        <span class="c1"># plt.clf()</span>
        <span class="c1"># plt.close(&#39;all&#39;)</span>
        <span class="k">if</span> <span class="s1">&#39;fit&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>

            <span class="n">eos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">savedpath</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;fit results are saved in &#39;</span><span class="p">,</span><span class="n">savedpath</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;To use fitting install ase: pip install ase&#39;</span><span class="p">)</span>
    <span class="c1"># plt.clf()</span>

    <span class="k">if</span> <span class="n">push2archive</span><span class="p">:</span>
        <span class="n">push_figure_to_archive</span><span class="p">(</span><span class="n">local_figure_path</span> <span class="o">=</span> <span class="n">savedpath</span><span class="p">,</span> <span class="n">caption</span> <span class="o">=</span> <span class="n">description_for_archive</span><span class="p">)</span>

    <span class="k">return</span></div>






<div class="viewcode-block" id="around_alkali"><a class="viewcode-back" href="../../siman.html#siman.analysis.around_alkali">[docs]</a><span class="k">def</span> <span class="nf">around_alkali</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">alkali_ion_number</span><span class="p">):</span>
    <span class="c1">#return numbers and distances to </span>

    <span class="n">n_neighbours</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="n">alkali_ions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ifmaglist</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_maglist</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">typ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">ALKALI_ION_ELEMENTS</span><span class="p">:</span>
            <span class="n">alkali_ions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alkali_ions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alkali_ion_number</span><span class="p">:</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">alkali_ion_number</span><span class="o">-</span><span class="mi">1</span>

            <span class="n">chosen_ion</span> <span class="o">=</span> <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chosen_ion</span> <span class="o">=</span> <span class="n">alkali_ions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#just the first one is used</span>
                <span class="c1"># alkali_ions[min(alkali_ions)]</span>

        <span class="n">sur</span>   <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="n">chosen_ion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="n">n_neighbours</span> <span class="o">=</span> <span class="n">n_neighbours</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;atoms&#39;</span><span class="p">,</span> 
        <span class="n">periodic</span>  <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">only_elements</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">TRANSITION_ELEMENTS</span><span class="p">)</span>

        <span class="c1"># print (sur)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sur</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">numb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sur</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">numb</span> <span class="o">=</span> <span class="n">ifmaglist</span> <span class="c1"># if no alk ions show for all mag atoms</span>
        <span class="n">chosen_ion</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">numb</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">chosen_ion</span></div>



<div class="viewcode-block" id="find_polaron"><a class="viewcode-back" href="../../siman.html#siman.analysis.find_polaron">[docs]</a><span class="k">def</span> <span class="nf">find_polaron</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">i_alk_ion</span><span class="p">,</span> <span class="n">out_prec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    #using magmom, find the transition atoms that have different magnetic moments</span>
<span class="sd">    #i_alk_ion - number of ion from 0 to calculate distances to transition metals</span>
<span class="sd">    out_prec (int) - precision of magmom output</span>


<span class="sd">    # maglist = cli.end.get_maglist()</span>
<span class="sd">    # magm = np.array(cli.end.magmom)</span>

<span class="sd">    # n_tm = len(magm[maglist])</span>
<span class="sd">    # # print(len(maglist))</span>
<span class="sd">    # numb, dist, chosen_ion = around_alkali(cli.end, n_tm, atom_num)</span>
<span class="sd">    # # print(magm[numb][1:]) </span>
<span class="sd">    # mtm = magm[numb][1:] # the first is alkali</span>

<span class="sd">    # m_av = sum(mtm)/len(mtm)</span>
<span class="sd">    # print(mtm-m_av)</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">zscore</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># print(np.std(s))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>



    <span class="n">magmom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">magmom</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">magmom</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! magmom is empty&#39;</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">mag_numbers</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_maglist</span><span class="p">()</span>

    <span class="n">pol</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># for z in mag_numbers:</span>
    <span class="c1">#     pos = determine_symmetry_positions(st, invert(z))</span>


    <span class="c1"># sys.exit()</span>
    <span class="n">magmom_tm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mag_numbers</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Looking at polarons on transition atoms: &#39;</span><span class="p">,</span><span class="n">invert</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">numbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mag_numbers</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="c1"># print(numbs)</span>
        <span class="c1"># print(magmom)</span>
        <span class="n">magmom_tm</span> <span class="o">=</span> <span class="n">magmom</span><span class="p">[</span><span class="n">numbs</span><span class="p">]</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span>  <span class="n">zscore</span><span class="p">(</span><span class="n">magmom_tm</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># print(magmom_tm)</span>
        <span class="c1"># print(list(zip(magmom_tm, dev.round(1))))</span>
        <span class="c1"># p = np.where(dev&gt;2)[0] # 2 standard deviations</span>
        <span class="c1"># print(dev&gt;2)</span>
        <span class="c1"># print (type(numbs))</span>
        <span class="n">nstd</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="c1"># nstd = 4</span>
        <span class="n">i_pols</span> <span class="o">=</span> <span class="n">numbs</span><span class="p">[</span><span class="n">dev</span><span class="o">&gt;</span><span class="n">nstd</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_pols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">i_alk_ion</span><span class="p">]</span>
            <span class="n">d_to_pols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i_pols</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">image_distance</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
                <span class="n">d_to_pols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;polarons are detected on atoms&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">i_pols</span><span class="p">],</span> <span class="s1">&#39;with magnetic moments:&#39;</span><span class="p">,</span> <span class="n">magmom</span><span class="p">[</span><span class="n">i_pols</span><span class="p">],</span> <span class="s1">&#39;and distances: &#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:2.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">d_to_pols</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span>  <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mag moments on trans. atoms:&#39;</span><span class="p">,</span> <span class="n">magmom_tm</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">out_prec</span><span class="p">))</span>
            
            <span class="n">pol</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_pols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no polarons is detected with nstd&#39;</span><span class="p">,</span> <span class="n">nstd</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mag moments on trans. atoms:&#39;</span><span class="p">,</span> <span class="n">magmom_tm</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">out_prec</span><span class="p">))</span>
            <span class="c1"># print(&#39; deviations                :&#39;, dev.round(1))</span>
            <span class="n">pol</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">pol</span><span class="p">,</span> <span class="n">magmom_tm</span></div>



<div class="viewcode-block" id="calc_oxidation_states"><a class="viewcode-back" href="../../siman.html#siman.analysis.calc_oxidation_states">[docs]</a><span class="k">def</span> <span class="nf">calc_oxidation_states</span><span class="p">(</span><span class="n">cl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">cl</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">charges</span>
    <span class="k">if</span> <span class="n">st</span><span class="p">:</span>
        <span class="n">ch</span>  <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">charges</span>
    

    <span class="n">z_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">z_val</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements_zval</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()):</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="n">z_val</span> <span class="o">-</span> <span class="n">ch</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">z_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ox</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:3.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ox</span><span class="p">))</span>
    <span class="c1"># print(list(zip(z_vals, self.end.get_elements())))</span>
    <span class="c1"># print(z_vals)</span>
    <span class="k">return</span> <span class="n">z_vals</span></div>





<div class="viewcode-block" id="neb_analysis"><a class="viewcode-back" href="../../siman.html#siman.analysis.neb_analysis">[docs]</a><span class="k">def</span> <span class="nf">neb_analysis</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">old_behaviour</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">results_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse traectories and polarons</span>

<span class="sd">    params</span>
<span class="sd">        mep_shift_vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">results_dic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">results_dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    <span class="n">path2mep_s</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/mep.eps&#39;</span>
    <span class="n">itise</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># print(cl.ldauu)</span>
    <span class="c1"># sys.exit()</span>
    <span class="n">name_without_ext</span> <span class="o">=</span> <span class="s1">&#39;mep.&#39;</span><span class="o">+</span><span class="n">itise</span><span class="o">+</span><span class="s1">&#39;.U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">ldauu</span><span class="p">))</span>
    <span class="n">path2mep_l</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="n">name_without_ext</span><span class="o">+</span><span class="s1">&#39;.eps&#39;</span>
    <span class="c1"># print(path2mep_l)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path2mep_l</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="n">get_from_server</span><span class="p">(</span><span class="n">files</span> <span class="o">=</span> <span class="n">path2mep_s</span><span class="p">,</span> <span class="n">to_file</span> <span class="o">=</span> <span class="n">path2mep_l</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">movie_to</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/movie.xyz&#39;</span>
        <span class="n">get_from_server</span><span class="p">(</span><span class="n">files</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/movie.xyz&#39;</span><span class="p">,</span> <span class="n">to_file</span> <span class="o">=</span> <span class="n">movie_to</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">,</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">movie_to</span><span class="p">):</span>
            <span class="n">makedir</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">name_without_ext</span><span class="o">+</span><span class="s1">&#39;.xyz&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">movie_to</span><span class="p">,</span> <span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">name_without_ext</span><span class="o">+</span><span class="s1">&#39;.xyz&#39;</span><span class="p">)</span>



    <span class="c1"># trying to get one image closest to the saddle point</span>
    <span class="k">if</span> <span class="n">old_behaviour</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#old behaviour, now created automatically in add callc</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]</span>
        <span class="c1"># if im % 2 &gt; 0: #odd</span>
        <span class="c1">#     i = im//2 + 1</span>
        <span class="c1"># else:</span>
        <span class="c1">#     i = im/2</span>
        <span class="c1"># if choose_image:</span>
        <span class="c1">#     i = choose_image</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">cl_i</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
            <span class="n">cl_i</span><span class="o">.</span><span class="n">version</span><span class="o">+=</span><span class="n">i</span>
            <span class="n">cl_i</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">cl_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1"># print cl_i.name</span>
            <span class="n">cl_i</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;/OUTCAR&quot;</span>
            <span class="c1"># for i in range():</span>

            <span class="n">cl_i</span><span class="o">.</span><span class="n">associated_outcars</span> <span class="o">=</span> <span class="p">[</span> <span class="n">aso</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">aso</span> <span class="ow">in</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">associated_outcars</span>  <span class="p">]</span>

            <span class="c1"># print cl_i.path[&quot;output&quot;] </span>
            <span class="n">cl_i</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;2. Ready to read outcar&#39;</span>
            <span class="c1"># if not os.path.exists(cl_i.path[&quot;output&quot;]):</span>
            <span class="c1">#     load = &#39;o&#39;</span>
            <span class="n">outst2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">cl_i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">name_field_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">readfiles</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">outst2</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">cl_i</span><span class="o">.</span><span class="n">read_results</span><span class="p">(</span><span class="n">loadflag</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="n">show</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="n">outst2</span><span class="o">+</span><span class="s1">&#39; | File was not read&#39;</span><span class="p">)</span>
            

            <span class="k">if</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span> <span class="c1">#move creation of calcs with images to add_neb</span>
                <span class="s1">&#39;&#39;</span>
                <span class="c1"># print_and_log(&#39;Please test code below this message to save prev calcs&#39;)</span>
                <span class="c1"># if cl_i != calc[cl_i.id]</span>
                <span class="c1">#     if hasattr(calc[cl_i.id], &#39;prev&#39;) and calc[cl_i.id].prev:</span>
                <span class="c1">#         prevlist = calc[cl_i.id].prev</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         prevlist = [calc[cl_i.id]]</span>
                <span class="c1">#     cl_i.prev = prevlist</span>
                <span class="c1">#     calc[cl_i.id] = cl_i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">cl_i</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_i</span>






    <span class="c1"># print path2mep_l</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path2mep_l</span><span class="p">):</span>
            <span class="c1"># get_from_server(file = path2mep_s, to = path2mep_l, addr = cluster_address)</span>

            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;evince &#39;</span><span class="o">+</span><span class="n">path2mep_l</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span>  <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;*mep*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
                <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;evince &#39;</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    


    <span class="n">cl1</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cl2</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>
    

    <span class="n">atom_num</span> <span class="o">=</span> <span class="n">find_moving_atom</span><span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
    <span class="c1"># cl1.poscar()</span>
    <span class="c1"># cl2.poscar()</span>

    <span class="c1"># print(&#39;atom_num&#39;,atom_num)</span>
    <span class="c1"># sys.exit()</span>

    <span class="c1">#prepare lists</span>
    <span class="n">ni</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;IMAGES&#39;</span><span class="p">]</span>
    <span class="n">vlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">ni</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># print( vlist)</span>
    <span class="n">mep_energies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">atom_pos</span>     <span class="o">=</span> <span class="p">[]</span>



    <span class="n">pols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sts_loc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dAO</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># A-(O,F) distance for each image</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">]</span>
        <span class="c1"># print(cl.id[0], cl.id[1], v, cli.state)</span>
        <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="s1">&#39;un&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! res_loop(): analys_type == neb, Calc&#39;</span><span class="p">,</span><span class="n">cli</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="s1">&#39;is not finished; return&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>
        <span class="c1"># print cli.id</span>
        <span class="c1"># cli.end = return_to_cell(cli.end)</span>
        <span class="c1"># mep_energies.append(  min(cli.list_e_sigma0)   ) #use minimum energy - not very good, sometimes unconverged energy could be lower! </span>
        <span class="n">mep_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">cli</span><span class="o">.</span><span class="n">energy_sigma0</span>   <span class="p">)</span> <span class="c1">#use last energy </span>
        <span class="n">atom_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cli</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">atom_num</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># Find polaron positions</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s1">&#39;polaron&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">pol</span><span class="p">,</span> <span class="n">mag</span> <span class="o">=</span> <span class="n">find_polaron</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">atom_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pol</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pol</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pol</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
                                <span class="n">pols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="s1">&#39;&#39;</span>
                <span class="c1"># print(&#39;Mag_moments on trans,&#39;, mag.round(1))</span>
        
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s1">&#39;neb_geo&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="c1">#visualization of path</span>
            <span class="c1"># print(atom_num)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="c1"># print(&#39;moving_atom&#39;, st.xcart[atom_num])</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">nn</span><span class="p">(</span><span class="n">atom_num</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            

            <span class="n">st</span><span class="o">.</span><span class="n">moving_atom_i</span> <span class="o">=</span> <span class="n">atom_num</span>
            <span class="n">st_loc</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>


            <span class="c1"># print(st_loc.xcart)</span>
            <span class="c1"># st_loc = st_loc.shift</span>
            
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">vlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="n">st1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>


                <span class="n">vec</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">center_on</span><span class="p">(</span><span class="n">atom_num</span><span class="p">)</span>
                <span class="c1"># vec = np.asarray([0.,0.,0.])</span>

            
                <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;mep_shift_vector&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="c1"># vec += np.array([0.11,0.11,0]) # path4</span>
                    <span class="c1"># print(params[&#39;mep_shift_vector&#39;])</span>
                    <span class="n">vec</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;mep_shift_vector&#39;</span><span class="p">])</span> <span class="c1"># path4</span>

            <span class="c1"># print(vec)</span>
            <span class="n">st_loc</span> <span class="o">=</span> <span class="n">st_loc</span><span class="o">.</span><span class="n">shift_atoms</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st_loc</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">()</span>
            <span class="c1"># st.write_cif(&#39;xyz/&#39;+st.name)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">shift_atoms</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">()</span>
            <span class="n">sts_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_loc</span><span class="p">)</span>

            <span class="n">st1</span> <span class="o">=</span> <span class="n">st1</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">[</span><span class="n">atom_num</span><span class="p">],</span> <span class="s1">&#39;Rb&#39;</span><span class="p">)</span>

            <span class="n">sts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">shift_atoms</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>


            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">info1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">nn</span><span class="p">(</span><span class="n">atom_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average_distance A-2(O,F)&#39;</span><span class="p">,</span> <span class="n">info1</span><span class="p">[</span><span class="s1">&#39;av(A-O,F)&#39;</span><span class="p">],</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
                <span class="n">dAO</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">info1</span><span class="p">[</span><span class="s1">&#39;av(A-O,F)&#39;</span><span class="p">])</span>


            <span class="k">if</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s1">&#39;neb_geo&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">av</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">nn</span><span class="p">(</span><span class="n">atom_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">more_info</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;avsq(A-O,F)&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average squared distance A-2(O,F)&#39;</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>

                <span class="n">info2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">nn</span><span class="p">(</span><span class="n">atom_num</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average_distance A-4(O,F)&#39;</span><span class="p">,</span> <span class="n">info2</span><span class="p">[</span><span class="s1">&#39;av(A-O,F)&#39;</span><span class="p">],</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elements are &#39;</span><span class="p">,</span> <span class="n">info2</span><span class="p">[</span><span class="s1">&#39;el&#39;</span><span class="p">])</span>

                <span class="n">info3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">nn</span><span class="p">(</span><span class="n">atom_num</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">more_info</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average_distance A-6(O,F)&#39;</span><span class="p">,</span> <span class="n">info3</span><span class="p">[</span><span class="s1">&#39;av(A-O,F)&#39;</span><span class="p">],</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average_deviation A-6(O,F)&#39;</span><span class="p">,</span> <span class="n">info3</span><span class="p">[</span><span class="s1">&#39;avdev(A-O,F)&#39;</span><span class="p">],</span> <span class="s1">&#39;mA&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elements are &#39;</span><span class="p">,</span> <span class="n">info3</span><span class="p">[</span><span class="s1">&#39;el&#39;</span><span class="p">])</span>



    <span class="n">write_xyz</span><span class="p">(</span><span class="n">sts</span> <span class="o">=</span> <span class="n">sts</span><span class="p">)</span> <span class="c1"># write traectory</span>
    <span class="n">write_xyz</span><span class="p">(</span><span class="n">sts</span> <span class="o">=</span> <span class="n">sts_loc</span><span class="p">)</span> <span class="c1"># write traectory</span>

    <span class="n">st1</span> <span class="o">=</span> <span class="n">st1</span><span class="o">.</span><span class="n">shift_atoms</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">st1</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span><span class="s1">&#39;_all&#39;</span>
    <span class="c1"># st1.write_cif(&#39;xyz/&#39;+st1.name)</span>
    <span class="n">st1</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">dAO</span><span class="p">:</span> <span class="c1"># find maximum change of distance during migration</span>
        <span class="n">dAO_change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dAO</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">dAO</span><span class="p">))</span>
        <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;dAO_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dAO_change</span>

    <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;sts_loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sts_loc</span> <span class="c1"># list of local structures, each structure contains dlist - distances from central cation to anions, and ellist - types of elements</span>
    <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;sts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sts</span> <span class="c1"># list of mep structures, each structure contains moving_atom_i - number of moving atom</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;During migration of alkali ions polarons are detected on atoms:&#39;</span><span class="p">,</span> <span class="n">pols</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! polaron is moving during migration! Obtained barrier is ambiguous&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Compare magnetic moments above! In principle should be the same!&#39;</span><span class="p">)</span>


    <span class="c1"># print np.array(atom_pos)</span>

    <span class="c1">#test if the distances between points are not spoiled by PBC </span>
    <span class="n">nbc</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">jj</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom_pos</span><span class="p">:</span>

        <span class="n">x2</span> <span class="o">=</span> <span class="n">atom_pos</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span>
        <span class="n">d1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#minimal distance</span>
        <span class="n">x2_gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span>  <span class="o">+</span>  <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">j</span>  <span class="o">+</span>  <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nbc</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nbc</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nbc</span><span class="p">)</span> <span class="c1">#generator over PBC images</span>
        <span class="n">x2c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span>  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x2c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">d1</span><span class="p">:</span> <span class="c1">#find the closest PBC image position</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">ii</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">x2c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x2_gen</span><span class="p">)</span>
        <span class="n">atom_pos</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2c</span>
        <span class="n">jj</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">jj</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_pos</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># the last point is not needed, we could not use slice since we need to use changed atom_pos in place</span>
            <span class="k">break</span>
        <span class="c1"># print np.linalg.norm(x - x2c), d1</span>



    <span class="n">_</span><span class="p">,</span> <span class="n">diff_barrier</span> <span class="o">=</span> <span class="n">plot_mep</span><span class="p">(</span><span class="n">atom_pos</span><span class="p">,</span> <span class="n">mep_energies</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">)</span>

    <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;barrier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_barrier</span>
    
    <span class="n">middle_image</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vlist</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;dEm1&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">mep_energies</span><span class="p">[</span><span class="n">middle_image</span><span class="p">]</span> <span class="o">-</span> <span class="n">mep_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    


    <span class="n">cl1</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">diff_barrier</span>
    <span class="n">cl2</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">diff_barrier</span>


    <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;atom_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_pos</span>
    <span class="n">results_dic</span><span class="p">[</span><span class="s1">&#39;mep_energies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mep_energies</span>


    <span class="k">if</span> <span class="s1">&#39;mep&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;mepp&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">show_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">show_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">plot_mep</span><span class="p">(</span><span class="n">atom_pos</span><span class="p">,</span> <span class="n">mep_energies</span><span class="p">,</span> <span class="n">image_name</span> <span class="o">=</span> <span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">name_without_ext</span><span class="o">+</span><span class="s1">&#39;_my.eps&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="n">show_flag</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span>  <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">)</span>






    <span class="k">if</span> <span class="n">push2archive</span><span class="p">:</span>
        <span class="n">path2saved</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plot_mep</span><span class="p">(</span><span class="n">atom_pos</span><span class="p">,</span> <span class="n">mep_energies</span><span class="p">,</span> <span class="n">image_name</span> <span class="o">=</span> <span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">name_without_ext</span><span class="o">+</span><span class="s1">&#39;_my&#39;</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">)</span>
        <span class="n">push_figure_to_archive</span><span class="p">(</span><span class="n">local_figure_path</span> <span class="o">=</span> <span class="n">path2saved</span><span class="p">,</span> <span class="n">caption</span> <span class="o">=</span> <span class="n">description_for_archive</span><span class="p">)</span>








        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#copy files according to chosen outcar to run nebresults locally </span>
            <span class="n">wd</span> <span class="o">=</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">dir</span>
            <span class="n">out_i</span> <span class="o">=</span> <span class="n">cl_i</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">[</span><span class="n">choose_outcar</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_1</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">[</span><span class="n">choose_outcar</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_2</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">associated_outcars</span><span class="p">[</span><span class="n">choose_outcar</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># print out_1</span>
            <span class="c1"># print out_2 </span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">wd</span><span class="o">+</span><span class="n">out_1</span><span class="p">,</span> <span class="n">wd</span><span class="o">+</span><span class="s1">&#39;00/OUTCAR&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">wd</span><span class="o">+</span><span class="n">out_2</span><span class="p">,</span> <span class="n">wd</span><span class="o">+</span><span class="s1">&#39;04/OUTCAR&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;01/&#39;</span><span class="p">,</span><span class="s1">&#39;02/&#39;</span><span class="p">,</span><span class="s1">&#39;03/&#39;</span> <span class="p">]:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">wd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">out_i</span><span class="p">,</span> <span class="n">wd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">)</span>

                <span class="c1"># print wd+d+out_i</span>

    <span class="k">return</span> <span class="n">results_dic</span></div>



<div class="viewcode-block" id="set_oxidation_states"><a class="viewcode-back" href="../../siman.html#siman.analysis.set_oxidation_states">[docs]</a><span class="k">def</span> <span class="nf">set_oxidation_states</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">convert2pymatgen</span><span class="p">()</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">add_oxidation_state_by_guess</span><span class="p">()</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">update_from_pymatgen</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>
    <span class="c1"># print(pm)</span>
    <span class="k">return</span> <span class="n">st</span></div>



<div class="viewcode-block" id="suf_en"><a class="viewcode-back" href="../../siman.html#siman.analysis.suf_en">[docs]</a><span class="k">def</span> <span class="nf">suf_en</span><span class="p">(</span><span class="n">cl1</span><span class="p">,</span> <span class="n">cl2</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate surface energy</span>
<span class="sd">    cl1 - supercell with surface</span>
<span class="sd">    cl2 - comensurate bulk supercell</span>
<span class="sd">    the area is determined from r[0] and r[1];- i.e they lie in surface</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st1</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">end</span>
    <span class="n">st2</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">end</span>
    <span class="c1"># pm = st1.convert2pymatgen(oxidation = {&#39;Y&#39;:&#39;Y3+&#39;, &#39;Ba&#39;:&#39;Ba2+&#39;, &#39;Co&#39;:&#39;Co2.25+&#39;, &#39;O&#39;:&#39;O2-&#39;})</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">st1</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">st1</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
    <span class="c1"># print(A)</span>

    <span class="k">if</span> <span class="n">st1</span><span class="o">.</span><span class="n">natom</span><span class="o">%</span><span class="n">st2</span><span class="o">.</span><span class="n">natom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! non-stoichiometric slab, check system sizes: natom1 = &#39;</span><span class="p">,</span> <span class="n">st1</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="s1">&#39;natom2 = &#39;</span><span class="p">,</span> <span class="n">st2</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">st1</span><span class="o">.</span><span class="n">natom</span><span class="o">/</span><span class="n">st2</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span>

    <span class="n">mul</span> <span class="o">=</span> <span class="n">st1</span><span class="o">.</span><span class="n">natom</span><span class="o">/</span><span class="n">st2</span><span class="o">.</span><span class="n">natom</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">e0</span> <span class="o">-</span> <span class="n">cl2</span><span class="o">.</span><span class="n">e0</span><span class="o">*</span><span class="n">mul</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">A</span><span class="o">*</span> <span class="n">header</span><span class="o">.</span><span class="n">eV_A_to_J_m</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Surface energy = </span><span class="si">{:3.2f}</span><span class="s1"> J/m2   | </span><span class="si">{:}</span><span class="s1"> | </span><span class="si">{:}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">cl1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">gamma</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Dmitry Aksenov.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>