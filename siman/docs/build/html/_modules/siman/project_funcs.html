
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>siman.project_funcs &#8212; Siman 0.9.5 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for siman.project_funcs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- </span>
<span class="c1">#Copyright Aksyonov D.A</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span> 
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="c1">#external</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">siman</span> <span class="k">import</span> <span class="n">header</span>
<span class="kn">from</span> <span class="nn">siman.header</span> <span class="k">import</span> <span class="n">printlog</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">siman.picture_functions</span> <span class="k">import</span> <span class="n">fit_and_plot</span>
<span class="kn">from</span> <span class="nn">siman.small_functions</span> <span class="k">import</span> <span class="n">merge_dics</span> <span class="k">as</span> <span class="n">md</span><span class="p">,</span> <span class="n">makedir</span>
<span class="kn">from</span> <span class="nn">siman.calc_manage</span> <span class="k">import</span> <span class="n">add_loop</span><span class="p">,</span> <span class="n">name_mod_supercell</span><span class="p">,</span> <span class="n">res_loop</span><span class="p">,</span> <span class="n">inherit_icalc</span><span class="p">,</span> <span class="n">push_figure_to_archive</span><span class="p">,</span> <span class="n">smart_structure_read</span>
<span class="kn">from</span> <span class="nn">siman.neb</span> <span class="k">import</span> <span class="n">add_neb</span>
<span class="kn">from</span> <span class="nn">siman.classes</span> <span class="k">import</span> <span class="n">Calculation</span>
<span class="kn">from</span> <span class="nn">siman.analysis</span> <span class="k">import</span> <span class="n">calc_redox</span><span class="p">,</span>  <span class="n">matrix_diff</span>
<span class="kn">from</span> <span class="nn">siman.geo</span> <span class="k">import</span> <span class="n">create_deintercalated_structure</span><span class="p">,</span> <span class="n">remove_one_atom</span><span class="p">,</span> <span class="n">remove_half_based_on_symmetry</span><span class="p">,</span> <span class="n">remove_half</span><span class="p">,</span> <span class="n">create_replaced_structure</span><span class="p">,</span> <span class="n">create_antisite_defect3</span><span class="p">,</span> <span class="n">determine_symmetry_positions</span>
<span class="kn">from</span> <span class="nn">siman.inout</span> <span class="k">import</span> <span class="n">write_occmatrix</span>
<span class="kn">from</span> <span class="nn">siman.database</span> <span class="k">import</span> <span class="n">add_to_archive_database</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">})</span>



<div class="viewcode-block" id="workflow"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.workflow">[docs]</a><span class="k">def</span> <span class="nf">workflow</span><span class="p">():</span>

    <span class="c1"># manually_remove_from_struct_des(struct_des, &#39;Na111.su&#39;)</span>


    <span class="c1">#Na</span>
    <span class="c1"># add_loop(&#39;Na111&#39;, &#39;8u&#39;, 1, up = &#39;up1&#39;, input_geo_format = &#39;vasp&#39;, it_folder = &#39;Na/bcc&#39;)</span>

    <span class="c1"># Li</span>
    <span class="c1"># res_loop(&#39;Li111&#39;, &#39;8Utmb4&#39;, 1, up = &#39;up1&#39;,)</span>
    <span class="c1"># res_loop(&#39;Li111&#39;, &#39;2b4&#39;, 1, up = &#39;up1&#39;, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;Li/bcc&#39;)</span>
    <span class="c1"># res_loop(&#39;Li111&#39;, &#39;2b4&#39;, 1, up = &#39;up1&#39;)</span>
    <span class="c1"># add_loop(&#39;K111&#39;, &#39;8Utmb4&#39;, 1, up = &#39;up1&#39;, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;K/bcc&#39;)</span>

    <span class="c1"># add_loop(&#39;Li111&#39;, &#39;&#39;, 1, ise_new = &#39;1ub4&#39;, savefile = &#39;o&#39;, </span>
    <span class="c1">#     calc_method = &#39;uniform_scale&#39;, scale_region = [-4,4], it_folder = &#39;Li/bcc/scaled/&#39;, cluster = &#39;skol&#39;)</span>

    <span class="c1"># add_loop(&#39;Na111&#39;, &#39;&#39;, 1, ise_new = &#39;1ub4&#39;, savefile = &#39;o&#39;, </span>
    <span class="c1">#     calc_method = &#39;uniform_scale&#39;, scale_region = [-4,4], it_folder = &#39;Na/bcc/scaled/&#39;, cluster = &#39;skol&#39;)</span>

    <span class="c1"># add_loop(&#39;K111&#39;,  &#39;&#39;, 1, ise_new = &#39;1ub4&#39;, savefile = &#39;o&#39;, </span>
    <span class="c1">#     calc_method = &#39;uniform_scale&#39;, scale_region = [-4,4], it_folder = &#39;K/bcc/scaled/&#39;, cluster = &#39;skol&#39;)</span>

    <span class="c1"># res_loop(&#39;Li111.su&#39;, [&#39;1ub4&#39;], [1, 2, 3, 4, 5, 6, 7, 100], up = &#39;up2&#39;, show = &#39;fofit&#39;, analys_type = &#39;fit_a&#39;  )     # , on 2016-10-19  </span>
    <span class="c1"># res_loop(&#39;Na111.su&#39;, [&#39;1ub4&#39;], [1, 2, 3, 4, 5, 6, 7, 100], up = &#39;up2&#39;, show = &#39;fofit&#39;, analys_type = &#39;fit_a&#39;  )     # , on 2016-10-19  </span>
    <span class="c1"># res_loop(&#39;K111.su&#39;,  [&#39;1ub4&#39;], [1, 2, 3, 4, 5, 6, 7, 100], up = &#39;up2&#39;, show = &#39;fofit&#39; , analys_type = &#39;fit_a&#39; ) </span>


    <span class="c1"># print (calc)</span>




    <span class="sd">&quot;&quot;&quot;OCC&quot;&quot;&quot;</span>
    <span class="c1"># add_loop(&#39;LiFePO4&#39;, &#39;1uOCC&#39;, 1, input_geo_format = &#39;vasp&#39;, show = &#39;fo&#39;)</span>



    <span class="sd">&quot;&quot;&quot;Convergence&quot;&quot;&quot;</span>
    <span class="c1"># add_loop(&#39;LiFePO4&#39;, &#39;1u&#39;, 1, show = &#39;force&#39;)</span>
    <span class="c1"># res_loop(&#39;LiCoO2&#39;, &#39;9uk1&#39;, 1, show = &#39;force&#39;)</span>
    <span class="c1"># res_loop(&#39;LiCoO2&#39;, &#39;8ue4&#39;, 1, show = &#39;force&#39;)</span>
    <span class="c1"># res_loop(&#39;LiCoO2&#39;, &#39;8ue5&#39;, 1, show = &#39;force&#39;)</span>



    <span class="sd">&quot;&quot;&quot;Uniform scale&quot;&quot;&quot;</span>
    <span class="c1">#pmna from LiFePO4</span>
    <span class="c1"># inherit_icalc(&#39;replace_atoms&#39;, &#39;NaFePO4.pnma&#39;, 1, (&#39;LiFePO4&#39;,&#39;9u&#39;,1), calc, atom_new = &#39;Na&#39;, atom_to_replace = &#39;Li&#39;, it_folder = &#39;NaFePO4&#39;)    #on 2014-02-26</span>
    <span class="c1"># inherit_icalc(&#39;replace_atoms&#39;, &#39;KFePO4.pnma&#39;, 1, (&#39;LiFePO4&#39;,&#39;9u&#39;,1), calc, atom_new = &#39;K&#39;, atom_to_replace = &#39;Li&#39;, it_folder = &#39;KFePO4&#39;)    #on 2014-02-26</span>

    <span class="c1"># res_loop(&#39;NaFePO4.pnma&#39;,&#39;1u&#39;, 1)</span>
    <span class="c1"># res_loop(&#39;KFePO4.pnma&#39;,&#39;1u&#39;, 1, show = &#39;fo&#39;)</span>



    <span class="c1"># for ise in [&#39;1u&#39;, 1ui&#39;, &#39;4ui&#39;]:</span>
    <span class="c1"># for ise in [&#39;4uiWF&#39;, &#39;4uiCF&#39;, &#39;4uiCWF&#39;,]:</span>
    <span class="k">for</span> <span class="n">ise</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;4ui&#39;</span><span class="p">,</span> <span class="s1">&#39;4uiWF&#39;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1"># add_loop(&#39;KFePO4.pnma&#39;,&#39;1u&#39;, 1, ise_new = &#39;4uiCWF&#39;, savefile = &#39;o&#39;, calc_method = &#39;uniform_scale&#39;, scale_region = (4,12), inherit_option = &#39;inherit_xred&#39; )  </span>
        <span class="c1"># add_loop(&#39;FePO4.pnma2&#39;,&#39;1u&#39;, 1, ise_new = &#39;4ui&#39;, savefile = &#39;o&#39;, calc_method = &#39;uniform_scale&#39;, scale_region = (-4,4), inherit_option = &#39;inherit_xred&#39;  )  </span>

        <span class="c1"># res_loop(&#39;KFePO4.pnma.su&#39;,ise, [1,2,3,4,5,6,100], up = &#39;1&#39;, show = &#39;fo&#39;, analys_type = &#39;fit_a&#39;)  </span>

    <span class="c1">#NaFePo</span>
    <span class="c1"># add_loop(&#39;NaFePO4.pnma&#39;,&#39;1u&#39;, 1, ise_new = &#39;4ui&#39;, savefile = &#39;o&#39;, calc_method = &#39;uniform_scale&#39;, scale_region = (-2,6), inherit_option = &#39;inherit_xred&#39; )  </span>
    <span class="c1"># res_loop(&#39;NaFePO4.pnma.su&#39;,&#39;4ui&#39;, list(range(1,8) )+[100], analys_type = &#39;fit_a&#39; )  </span>


    <span class="c1"># sys.exit()</span>



    <span class="n">inherit_option</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">calc_method</span> <span class="o">=</span> <span class="s1">&#39;neb&#39;</span>


    <span class="sd">&quot;&quot;&quot;LiFePO4  &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;IS  &quot;&quot;&quot;</span>
    <span class="c1">#111</span>
    <span class="c1"># add_neb(calc[&#39;LiFePO4&#39;, &#39;9u&#39;, 1], ise_new = &#39;1uD&#39;, images = 3, corenum = 15, inherit_option = None, mag_config = None, replicate = None)</span>
    <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1&#39;, &#39;1&#39;,     [1],  show = &#39;mep&#39;, old_behaviour = 0 )    </span>


    <span class="c1"># for ise in [&#39;1ue6&#39;, &#39;1uk1&#39;, &#39;1ut&#39; ]:</span>
    <span class="k">for</span> <span class="n">ise</span> <span class="ow">in</span>     <span class="p">[</span><span class="s1">&#39;1ue5k15&#39;</span><span class="p">]:</span>
    <span class="c1"># for ise in [&#39;1uMM40&#39;,&#39;1up&#39;, &#39;1upA&#39; , &#39;1upAMMD&#39;, ]:</span>
    <span class="c1"># for ise in [&#39;1up&#39;, &#39;1upA&#39;]:</span>
    <span class="c1"># for ise in [&#39;1uMM40&#39;, &#39;1up&#39;]:</span>
    <span class="c1"># for ise in [&#39;1uMM40&#39;, &#39;1uA&#39;]:</span>
    <span class="c1"># for ise in [&#39;1uMM40&#39;,&#39;1uB03&#39; , &#39;1uB01&#39; , &#39;1uB005&#39; ,]:</span>
    <span class="c1"># for ise in [&#39;1m&#39;, &#39;1uA&#39;, &#39;1uLF&#39;, &#39;1ulm&#39;, &#39;1uB05&#39;, &#39;1uWC1000&#39;, &#39;1ulmA04&#39;, &#39;1uMM40&#39;]:</span>
    <span class="c1"># for ise in [ &#39;1m&#39; ]: #inherit_magmom = False</span>
    <span class="c1"># for ise in [ &#39;1uD&#39;, &#39;1uMM40&#39; ]: </span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1"># add_neb(calc[&#39;LiFePO4&#39;, &#39;9u&#39;, 1], ise_new = ise, images = 3, corenum = 15, inherit_option = None, mag_config = None, inherit_magmom = True)</span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1mp&#39;, ise,     [5],  show = &#39;fo&#39;, old_behaviour = 0 )    </span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1ms&#39;, ise,     [1,2,3,4,5],  show = &#39;me&#39;, old_behaviour = 0 )    </span>


    <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;,           [5,],  show = &#39;en&#39;, old_behaviour = 0 )    </span>
    <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1mp&#39;,&#39;1uMMD&#39;,     [5,],  show = &#39;en&#39;, old_behaviour = 0 )    </span>
    <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1ulong&#39;, [1],  show = &#39;occ&#39;, old_behaviour = 0 )   </span>


    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#checking initial magmom - in this case ms and mp are equivalent, </span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1">#but still some differences in final for 1uA. the situat. is much better for 1upAMMD, where smaller EDIFF is used</span>
        <span class="c1">#for 1m no such problem</span>
        <span class="c1">#intersting moment - the elapsed time could different for the same run</span>
        <span class="c1">#since the base calc[&#39;LiFePO4&#39;, &#39;9u&#39;, 1] did not have magmom</span>
        <span class="c1"># print calc[&#39;LiFePO4v1.n3Li1v1mp&#39;, &#39;1uA&#39;, 1].init.magmom</span>
        <span class="c1"># print calc[&#39;LiFePO4v1.n3Li1v1ms&#39;, &#39;1uA&#39;, 1].init.magmom</span>
        <span class="c1"># print calc[&#39;LiFePO4&#39;, &#39;9u&#39;, 1].end.magmom</span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1mp&#39;, &#39;1uA&#39;,     [1],  show = &#39;&#39;, old_behaviour = 0 )    </span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1ms&#39;, &#39;1uA&#39;,     [1],  show = &#39;&#39;, old_behaviour = 0 )    </span>

        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1mp&#39;, &#39;1upAMMD&#39;,     [4],  show = &#39;&#39;, old_behaviour = 0 )    </span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1ms&#39;, &#39;1upAMMD&#39;,     [4],  show = &#39;&#39;, old_behaviour = 0 )    </span>

        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1mp&#39;, &#39;1m&#39;,     [4],  show = &#39;&#39;, old_behaviour = 0 )    </span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1ms&#39;, &#39;1m&#39;,     [4],  show = &#39;&#39;, old_behaviour = 0 )  </span>


    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#checking influence of MAXMIX</span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;,           [5,],  show = &#39;en&#39;, old_behaviour = 0 )    </span>
        <span class="c1"># res_loop(&#39;LiFePO4v1.n3Li1v1mp&#39;,&#39;1uMMD&#39;,     [5,],  show = &#39;en&#39;, old_behaviour = 0 )    </span>


    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># cheking influence of restart</span>
        <span class="s1">&#39;&#39;</span>
        
        <span class="c1">#result - doesnot help a lot</span>
        <span class="c1">#TODO - make possible restart with  magnetic moments initial for parent calc</span>

        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,   &#39;1ulong&#39;, [1], up = &#39;1&#39;, show = &#39;fo&#39;,  )   </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,   &#39;1ulong&#39;, [1], up = &#39;1&#39;, show = &#39;fo&#39;,  )   </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,   &#39;1ulong&#39;, [4], up = &#39;1&#39;, show = &#39;fo&#39;,  )   </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,   &#39;1u&#39;, [1,2], up = &#39;1&#39;, show = &#39;mep&#39;,  )   </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m0&#39;, &#39;1u&#39;, [1,2], up = &#39;1&#39;, show = &#39;mep&#39;,  )  </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m1&#39;, &#39;1u&#39;, [1,2], up = &#39;1&#39;, show = &#39;mag&#39;,  )   </span>


        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1.ifn&#39;,   &#39;1u&#39;, [1,2], up = &#39;up1&#39;, show = &#39;mep&#39;, inherit_option = &#39;full_nomag&#39; )   </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m0.ifn&#39;, &#39;1u&#39;, [1,2], up = &#39;up1&#39;, show = &#39;mep&#39;, inherit_option = &#39;full_nomag&#39; )  </span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m1.ifn&#39;, &#39;1u&#39;, [1,2], up = &#39;up1&#39;, show = &#39;mag&#39;, inherit_option = &#39;full_nomag&#39; ) </span>


    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#compare 1urNM and 1urm</span>
        <span class="s1">&#39;&#39;</span>    
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m0&#39;,&#39;1urNM&#39;, verlist = [2], up = &#39;up1&#39;, show = &#39;fo&#39;, old_behaviour = 0)</span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m0&#39;,&#39;1urm&#39;,  verlist = [2], up = &#39;up1&#39;, show = &#39;en&#39;, old_behaviour = 1)</span>
        <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1m1&#39;,&#39;1urm&#39;, verlist = [2], up = &#39;up1&#39;, show = &#39;fo&#39;, old_behaviour = 0)</span>



    <span class="c1"># res_loop(&#39;LiFePO4&#39;,&#39;9uk1&#39;, 1, up = &#39;up1&#39;,)    #on 2016-09-03</span>





    <span class="c1">#122</span>
    <span class="c1"># for ise in [ &#39;1u&#39;, &#39;1uA&#39; ]:</span>
    <span class="k">for</span> <span class="n">ise</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;1m&#39;</span> <span class="p">]:</span>
        <span class="s1">&#39; &#39;</span>
        <span class="c1"># add_neb(calc[&#39;LiFePO4&#39;, &#39;9u&#39;, 1], ise_new = ise, images = 3, corenum = 15, replicate = (1,2,2), it_new_folder = &#39;LiFePO4/122/neb/&#39;)</span>
    <span class="c1"># res_loop(&#39;LiFePO4.neb122Li1v1&#39;,   &#39;1urWF&#39;, [1,], up = &#39;1&#39;, show = &#39;me&#39;,  )   </span>
    <span class="c1"># res_loop(&#39;LiFePO4.neb122Li1v1m1&#39;,  &#39;1urm&#39;, [1,2], up = &#39;1&#39;, show = &#39;mep&#39;,  )   </span>
    <span class="c1"># res_loop(&#39;LiFePO4.neb122Li1v1m0&#39;, &#39;1urm&#39;, verlist = [1, 2,], up = &#39;up1&#39;, show = &#39;fo&#39;, choose_image = 2, choose_outcar = 3 )    #on 2016-09-09</span>

    <span class="c1"># res_loop(&#39;LiFePO4v1.n3122Li1v1ms&#39;,[u&#39;1u&#39;],  verlist = [1], show =&#39;mep&#39; )</span>
    <span class="c1"># res_loop(&#39;LiFePO4v1.n3122Li1v1ms&#39;,[u&#39;1uA&#39;], verlist = [1], show =&#39;occ&#39; )</span>


    <span class="c1"># res_loop(&#39;LiFePO4v1.n3122Li1v1ms&#39;,[u&#39;1m&#39;], verlist = [1,], up = &#39;up1&#39;, show = &#39;mep&#39;)    #on 2016-09-26</span>




    <span class="c1">#NaFePO4, </span>

    <span class="c1"># add_neb(calc[&#39;NaFePO4.pnma.su&#39;, &#39;4ui&#39;, 100], ise_new = &#39;1m&#39;, images = 3, corenum = 15, </span>
    <span class="c1">#     inherit_option = None, mag_config = None, replicate = None, inherit_magmom = False)</span>


    <span class="c1"># res_loop(&#39;NaFePO4.pnma.n3Na1v1mp&#39;,[u&#39;1ulong&#39;], verlist = [1,2,4], up = &#39;up1&#39;, show = &#39;mepfo&#39; )    #on 2016-09-15</span>

    <span class="c1"># res_loop(&#39;NaFePO4.pnma.suv100.n3Na1v1mp&#39;,[u&#39;1u&#39;], verlist = [4,], show = &#39;me&#39; )    #</span>
    <span class="c1"># res_loop(&#39;NaFePO4.pnma.suv100.n3Na1v1ms&#39;,[u&#39;1ulong&#39;], verlist = [1,2,3,4,5], show = &#39;mep&#39; )    #on 2016-09-28</span>
    <span class="c1"># res_loop(&#39;NaFePO4.pnma.suv100.n3Na1v1ms&#39;,[u&#39;1uA&#39;], verlist = [1,2,3,4,5], show = &#39;mep&#39; )    #on 2016-09-28</span>
    <span class="c1"># res_loop(&#39;NaFePO4.pnma.suv100.n3Na1v1ms&#39;,[u&#39;1ur30&#39;], verlist = [1,2,3,4,5], show = &#39;mep&#39; )    #on 2016-09-28</span>
    <span class="c1"># res_loop(&#39;NaFePO4.pnma.suv100.n3Na1v1ms&#39;, [u&#39;1m&#39;], [1, 2,3,4,5], show = &#39;fomep&#39;  )     # comment = None, on 2016-09-30  </span>


    <span class="c1"># sys.exit()</span>





    <span class="c1">#KFePO4</span>
    <span class="c1"># add_neb(calc[&#39;KFePO4.pnma.su&#39;, &#39;4uiWF&#39;, 100], ise_new = &#39;1u&#39;, </span>
    <span class="c1">#     images = 3, corenum = 15, i_void_start = 1, i_void_final = 2,</span>
    <span class="c1">#     inherit_magmom = False)</span>

    <span class="c1"># res_loop(&#39;KFePO4.pnma.suv100.n3K1v1ms&#39;,[u&#39;1u&#39;], verlist = [1],show = &#39;mep&#39; )    #on 2016-09-23</span>


    <span class="c1"># sys.exit()</span>



    <span class="sd">&quot;&quot;&quot;DS  &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma&#39;,&#39;1u&#39;, 1, up = &#39;up1&#39;, input_geo_format = &#39;vasp&#39;, it_folder = &#39;LiFePO4&#39;, mat_proj_id = &#39;mp-777026&#39;)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2&#39;,&#39;1u&#39;, 1, up = &#39;up1&#39;, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiFePO4&#39;, mat_proj_id = &#39;mp-25001&#39;)    #on 2016-09-03</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_s</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i_f</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i_s</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_f</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#stupid path</span>
                    <span class="k">continue</span>
                <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="s1">&#39;Li&#39;</span>
                <span class="c1"># add_neb(calc[&#39;FePO4.pnma2&#39;, &#39;1u&#39;, 1], ise_new = &#39;1m&#39;, </span>
                <span class="c1">#     images = 3, corenum = 15, atom_to_insert = atom_to_insert, i_void_start = i_s, i_void_final = i_f,</span>
                <span class="c1">#     r_impurity = 1.6 , it_new_folder = atom_to_insert+&#39;FePO4/neb/&#39;,</span>
                <span class="c1">#     inherit_magmom = False)</span>

                <span class="c1"># res_loop(&#39;FePO4.pnma2.n3i&#39;+str(i_s)+&#39;e&#39;+str(i_f)+atom_to_insert, [u&#39;1&#39;], verlist = [1,2], up = &#39;up1&#39;, show = &#39;m&#39;, old_behaviour = 0 )    #on 2016-09-15</span>
                <span class="c1"># res_loop(&#39;FePO4.pnma21.n3i&#39;+str(i_s)+&#39;e&#39;+str(i_f)+atom_to_insert, [u&#39;1&#39;], verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>
                <span class="c1"># res_loop(&#39;FePO4.pnma21.n3i&#39;+str(i_s)+&#39;e&#39;+str(i_f)+atom_to_insert+&#39;ms&#39;, [u&#39;1m&#39;], verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>
                <span class="c1"># res_loop(&#39;FePO4.pnma2.n7i&#39;+str(i_s)+&#39;e&#39;+str(i_f)+atom_to_insert+&#39;ms&#39;, [u&#39;1usv&#39;], verlist = [1,2], up = &#39;up1&#39;, show = &#39;mep&#39; )    #on 2016-09-15</span>
                <span class="c1"># res_loop(&#39;FePO4.pnma2.n7i&#39;+str(i_s)+&#39;e&#39;+str(i_f)+atom_to_insert+&#39;ms&#39;, [u&#39;1ulong&#39;], verlist = [2], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>

    <span class="c1"># for ise in [&#39;1ur&#39;, &#39;1urWF&#39;, &#39;1uA&#39;, &#39;1uLF&#39; ]:</span>
    <span class="c1">#     res_loop(&#39;FePO4.pnma2v1.n3i1e2Lims&#39;, ise, verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>
    <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="s1">&#39;Li&#39;</span>

    <span class="c1"># add_neb(calc[&#39;FePO4.pnma2&#39;, &#39;1u&#39;, 1], ise_new = &#39;1ur30&#39;, </span>
    <span class="c1">#     images = 3, corenum = 15, atom_to_insert = atom_to_insert, i_void_start = 1, i_void_final = 2,</span>
    <span class="c1">#     r_impurity = 1.6 , it_new_folder = atom_to_insert+&#39;FePO4/neb/&#39;,</span>
    <span class="c1">#     inherit_magmom = False)</span>

    <span class="c1"># sys.exit()</span>
    <span class="c1">#Li</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2.n3i1e2Lims&#39;, &#39;1u&#39;, verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3i1e2Lims&#39;, &#39;1ur&#39;, verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n7i1e2Lims&#39;,[u&#39;1ur30&#39;], verlist = [1], show = &#39;mep&#39; )    #on 2016-09-22</span>
    <span class="c1"># add_neb(calc[&#39;FePO4.pnma2&#39;, &#39;1u&#39;, 1], ise_new = &#39;1u&#39;, images = 3, corenum = 15, </span>
    <span class="c1">#     i_void_start = 1, i_void_final = 2, atom_to_insert = &#39;Li&#39;,</span>
    <span class="c1">#     r_impurity = 1.6 ,</span>
    <span class="c1">#     inherit_magmom = False, it_new_folder = &#39;LiFePO4/neb/&#39;)</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3i1e2Lims&#39;,[u&#39;1u&#39;], verlist = [1], show =&#39;mep&#39; )    #on 2016-09-26</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2.n3i1e2Li&#39;,[u&#39;1u&#39;], verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;)</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2.n7i1e2Lims&#39;,[u&#39;1ulong&#39;], verlist = [1,2,3,4,5,6,7,8,9], analys_type = &#39;neb&#39;, show = &#39;mep&#39;)</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n7i1e2Lims&#39;,[u&#39;1ur30&#39;], verlist = [1,2,3,4,5,6,7,8,9], analys_type = &#39;neb&#39;, show = &#39;mep&#39;)</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n7i1e2Lims.if&#39;,[u&#39;0m&#39;], 6, show = &#39;fo&#39; )    #???</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3i1e2Lims&#39;, [u&#39;1ur30&#39;], [1, 2,3,4,5], choose_outcar = None, show = &#39;mag&#39;, analys_type = &#39;neb&#39;  )     # for OMC tutorial!!!</span>









    <span class="c1">#122</span>
    <span class="c1"># add_neb(calc[&#39;FePO4.pnma2&#39;, &#39;1u&#39;, 1], ise_new = &#39;1ur30s&#39;, images = 3, corenum = 15, </span>
    <span class="c1">#     replicate = (1,2,2), i_void_start = 2, i_void_final = 2, atom_to_insert = &#39;Li&#39;,</span>
    <span class="c1">#     r_impurity = 1.6 ,</span>
    <span class="c1">#     inherit_magmom = False, it_new_folder = &#39;LiFePO4/122/neb/&#39;)</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3122i2e2Lims&#39;,[u&#39;1u&#39;], verlist = [4,], show = &#39;mep&#39; )    #on 2016-09-26</span>
    <span class="c1"># res_loop(u&#39;FePO4.pnma2v1.n7i1e2Lims&#39;, u&#39;1ur30&#39;, 6, show = &#39;occ&#39; )    #on 2016-09-26</span>
    <span class="c1"># add_loop(&#39;FePO4.pnma2v1.n3122i2e2Lims&#39;,[u&#39;1u&#39;], verlist = [4,], inherit_option = &#39;occ&#39;, ise_new = &#39;1uos&#39;, </span>
    <span class="c1">#     id_from = (&#39;FePO4.pnma2v1.n7i1e2Lims&#39;, &#39;1ur30&#39;, 6), it_folder = &#39;LiFePO4/inherited&#39;,)</span>

    <span class="c1"># add_loop(&#39;FePO4.pnma2v1.n3122i2e2Lims.ifo&#39;, [u&#39;1uos&#39;], [4],up = &#39;up1&#39;, show = &#39;fo&#39;  )     # comment = None, on 2016-09-28  </span>
    <span class="c1"># sys.exit()</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3122i2e2Lims.ifo&#39;, [u&#39;1uos&#39;], [4], up = &#39;up2&#39;, show = &#39;occ&#39;  )     # comment = None, on 2016-09-29  </span>



    <span class="sd">&quot;&quot;&quot;hybrid functional!&quot;&quot;&quot;</span>

    <span class="c1"># add_loop(&#39;LiFePO4&#39;,&#39;1hss&#39;, 1,)  </span>

    <span class="c1"># res_loop(&#39;LiFePO4&#39;,&#39;1hss&#39;, 1,)  </span>
    <span class="c1"># res_loop(&#39;LiFePO4&#39;,&#39;1u&#39;, 1,)  </span>


    <span class="c1"># add_loop(&#39;FePO4.pnma2&#39;,&#39;1hss&#39;, 1)</span>

    <span class="c1"># add_neb(calc[&#39;FePO4.pnma2&#39;, &#39;1u&#39;, 1], ise_new = &#39;1hse&#39;, images = 3, corenum = 15, </span>
    <span class="c1">#     i_void_start = 1, i_void_final = 2, atom_to_insert = &#39;Li&#39;,</span>
    <span class="c1">#     r_impurity = 1.6 ,</span>
    <span class="c1">#     inherit_magmom = False, it_new_folder = &#39;LiFePO4/neb/&#39;)</span>





    <span class="c1">#Na</span>
    <span class="c1">#     res_loop(&#39;FePO4.pnma2v1.n3i1e2Nams&#39;, &#39;1u&#39;, verlist = [1], up = &#39;up1&#39;, show = &#39;mep&#39;, old_behaviour = 0 )    #on 2016-09-15</span>

    <span class="c1">#K </span>
    <span class="c1"># atom_to_insert = &#39;K&#39;</span>
    <span class="c1"># add_neb(calc[&#39;FePO4.pnma2&#39;, &#39;1u&#39;, 1], ise_new = &#39;1u&#39;, </span>
    <span class="c1">#     images = 3, corenum = 15, atom_to_insert = atom_to_insert, i_void_start = 1, i_void_final = 2,</span>
    <span class="c1">#     r_impurity = 1.6 , it_new_folder = atom_to_insert+&#39;FePO4/neb/&#39;,</span>
    <span class="c1">#     inherit_magmom = False)</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3i1e2Kms&#39;,[u&#39;1u&#39;], verlist = [1,2,3,4,5], up = &#39;up1&#39;, show =&#39;fo&#39;)</span>



    <span class="c1"># sys.exit()</span>



    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#checking influence of compression on neb</span>
        <span class="s1">&#39;&#39;</span>
        <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="s1">&#39;Li&#39;</span>

        <span class="c1"># add_neb(calc[&#39;FePO4.pnma2.su&#39;, &#39;1u&#39;, 1], ise_new = &#39;1u&#39;, </span>
        <span class="c1">#                 images = 3, corenum = 15, atom_to_insert = atom_to_insert, i_void_start = 1, i_void_final = 2,</span>
        <span class="c1">#                 r_impurity = 1.3 , it_new_folder = atom_to_insert+&#39;FePO4/neb/&#39;,</span>
        <span class="c1">#                 inherit_magmom = False)</span>

        <span class="c1"># add_neb(calc[&#39;FePO4.pnma2.su&#39;, &#39;1u&#39;, 2], ise_new = &#39;1u&#39;, </span>
        <span class="c1">#                 images = 3, corenum = 15, atom_to_insert = atom_to_insert, i_void_start = 2, i_void_final = 3,</span>
        <span class="c1">#                 r_impurity = 1.4 , it_new_folder = atom_to_insert+&#39;FePO4/neb/&#39;,</span>
        <span class="c1">#                 inherit_magmom = False)</span>

        <span class="c1"># res_loop(&#39;FePO4.pnma2.suv1.n3i1e2Lims&#39;, [u&#39;1u&#39;], verlist =  [4], up = &#39;up1&#39;, show = &#39;me&#39;)  </span>
        <span class="c1"># res_loop(&#39;FePO4.pnma2.n3i1e2Li&#39;,        [u&#39;1u&#39;], verlist =  [4], up = &#39;up1&#39;, show = &#39;me&#39;)  </span>
        <span class="c1"># res_loop(&#39;FePO4.pnma2.suv2.n3i2e3Lims&#39;,[u&#39;1u&#39;], verlist = [1,2,3,4,5], up = &#39;up1&#39;, show = &#39;mep&#39; )    #on 2016-09-23</span>
        
        <span class="c1"># sys.exit()</span>



    <span class="c1">#LiVPO4F</span>
    <span class="c1"># res_loop(&#39;LiVPO4F.nebLi1v1&#39;,&#39;1ur&#39;, verlist = [1,2,3,4,5], up = &#39;up1&#39;, show = &#39;fo&#39;, old_behaviour =0)    #on 2016-09-08</span>




    <span class="c1">#LiMnPO4</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LiMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiNiO2&#39;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1"># add_neb(calc[it, &#39;9u&#39;, 1], ise_new = &#39;1u&#39;, images = 3, corenum = 15, inherit_option = None, mag_config = None, inherit_magmom = False)</span>
        <span class="c1"># res_loop(it+&#39;v1.n3Li1v1ms&#39;,[u&#39;1u&#39;], verlist = [1,2,3,4,5], up = &#39;up1&#39;, show = &#39;m&#39;)    #on 2016-09-23</span>


    <span class="c1"># add_neb(calc[&#39;LiCoPO4&#39;, &#39;8Utmr2-8&#39;, 1], ise_new = &#39;1u&#39;, images = 3, corenum = 15, inherit_option = None, mag_config = None, inherit_magmom = False)</span>

    <span class="c1">#LiMnPO4</span>
    <span class="c1"># res_loop(&#39;LiCoPO4v1.n3Li1v1ms&#39;,[u&#39;1u&#39;], verlist = [1,2,3,4,5], up = &#39;up1&#39;,  )    #on 2016-09-23</span>
    <span class="c1"># res_loop(&#39;CoPO4v1.n3i3e2Nams&#39;, [u&#39;1u&#39;], [1, 2,3,4,5], show = &#39;mep&#39;  )     # comment = None, on 2016-09-29  </span>



    <span class="c1">#DS</span>
    <span class="c1"># add_neb(calc[&#39;CoPO4&#39;, &#39;8Utmr4-2&#39;, 1], ise_new = &#39;1u&#39;, </span>
    <span class="c1">#     images = 3, corenum = 15,</span>
    <span class="c1">#     atom_to_insert = &#39;Na&#39;, i_void_start = 3, i_void_final = 2,</span>
    <span class="c1">#     r_impurity = 1.8 , it_new_folder = &#39;LiCoPO4/neb/&#39;</span>
    <span class="c1">#     )</span>

    <span class="c1"># sys.exit()</span>
    <span class="c1">#NaMnAsO4</span>
    <span class="c1">#IS</span>
    <span class="c1"># add_neb(calc[&#39;NaMnAsO4&#39;, &#39;8u&#39;, 1], ise_new = &#39;1u&#39;, images = 3, corenum = 15, inherit_option = None, mag_config = None, inherit_magmom = False)</span>
    <span class="c1"># res_loop(&#39;NaMnAsO4v1.n3Na17v1ms&#39;, [u&#39;1u&#39;], [1, 2,3,4,5], show = &#39;mep&#39;  )     # comment = None, on 2016-09-29  </span>


    <span class="c1">#DS</span>
    <span class="c1"># add_neb(calc[&#39;MnAsO4&#39;, &#39;8u&#39;, 1], ise_new = &#39;1u&#39;, </span>
    <span class="c1">#     images = 3, corenum = 15, inherit_option = None, mag_config = None, inherit_magmom = False,</span>
    <span class="c1">#     atom_to_insert = &#39;Na&#39;, i_void_start = 0, i_void_final = 0,</span>
    <span class="c1">#     r_impurity = 1.6 , it_new_folder = &#39;NaMnAsO4/neb/&#39;</span>
    <span class="c1">#     )</span>

    <span class="c1"># res_loop(&#39;MnAsO4v1.n3i0e1Nams&#39;, [u&#39;1u&#39;], [1, 2,3,4,5], show = &#39;mep&#39;  )     # comment = None, on 2016-09-29  </span>
    <span class="c1"># res_loop(&#39;MnAsO4v1.n3i0e0Nams&#39;, [u&#39;1u&#39;], [1, 2,3,4,5], show = &#39;fomep&#39;  )     # comment = None, on 2016-09-29  </span>


    <span class="c1"># sys.exit()</span>


    <span class="c1">#some additional</span>
    <span class="c1"># add_loop(&#39;Na2FePO4F&#39;, &#39;1u&#39;, 1, input_geo_format = &#39;cee_database&#39;, it_folder = &#39;Na2FePO4F&#39;)</span>
    <span class="c1"># add_loop(&#39;KFeSO4F&#39;, &#39;1u&#39;, 1, input_geo_format = &#39;cee_database&#39;, it_folder = &#39;KFeSO4F&#39;)</span>
    <span class="c1"># add_loop(&#39;Na2FeVF7&#39;, &#39;1u&#39;, 1, input_geo_format = &#39;cee_database&#39;, it_folder = &#39;Na2FeVF7&#39;)</span>











    <span class="sd">&quot;&quot;&quot;Charge den analysis&quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    <span class="c1"># print calc[&#39;LiFePO4.nebLi1v1&#39;,   &#39;1u&#39;, 1].get_chg_file(&#39;CHG&#39;)</span>
    <span class="c1"># print calc[&#39;LiFePO4v1.n3Li1v1ms&#39;,   &#39;1m&#39;, 1].get_chg_file(&#39;CHG&#39;)</span>
    <span class="c1"># print calc[&#39;LiFePO4.nebLi1v1.if&#39;, &#39;0m&#39;, 1].get_chg_file(&#39;CHG&#39;)</span>
    <span class="c1"># print calc[&#39;FePO4.pnma2v1.n7i1e2Lims&#39;, &#39;1ur30&#39;, 1].get_chg_file(&#39;CHG&#39;)</span>

    <span class="c1"># print (calc[&#39;LiFePO4.nebLi1v1&#39;,   &#39;1u&#39;, 4].get_chg_file(&#39;CHG&#39;))</span>
    <span class="c1"># print (calc[&#39;LiFePO4.nebLi1v1.if&#39;,&#39;0m&#39;, 4].get_chg_file(&#39;CHG&#39;, &#39;asoutcar&#39;))</span>

    <span class="c1"># print (calc[&#39;LiFePO4.nebLi1v1.ifi&#39;,   &#39;0u&#39;, 1].get_chg_file(&#39;CHG&#39;, &#39;asoutcar&#39;))</span>
    <span class="c1"># print (calc[&#39;LiFePO4&#39;,   &#39;1u&#39;, 1].get_chg_file(&#39;CHG&#39;, &#39;asoutcar&#39;))</span>


    <span class="c1"># add_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;, 1, up = &#39;up1&#39;, ise_new = &#39;0m&#39;, inherit_option = &#39;full&#39; )</span>
    <span class="c1"># add_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;, 4, up = &#39;up1&#39;, ise_new = &#39;0m&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocv&#39;, override = 1 )</span>
    <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,   &#39;1u&#39;, 1, show = &#39;mag&#39;, )</span>
    <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,   &#39;1u&#39;, 1, show = &#39;mag&#39;, )</span>
    <span class="c1"># res_loop(&#39;LiFePO4&#39;,&#39;1u&#39;, 1, show = &#39;occ&#39;, )</span>


    <span class="c1"># add_loop(&#39;FePO4.pnma2v1.n7i1e2Lims&#39;,&#39;1ur30&#39;, 6, up = &#39;up1&#39;, ise_new = &#39;0m&#39;, inherit_option = &#39;full&#39; )</span>


    <span class="c1"># inherit_icalc(&#39;full&#39;, &#39;LiFePO4.nebLi1v1.ifi&#39;, 1, (&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;,1), header.calc, id_base_st_type = &#39;init&#39;, it_folder = &#39;LiFePO4&#39; )    #on 2014-02-26</span>
    <span class="c1"># add_loop(&#39;LiFePO4.nebLi1v1.ifi&#39;, &#39;0u&#39;, 1, savefile = &#39;cov&#39;)</span>
    <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1.ifi&#39;, &#39;0u&#39;, 1, show = &#39;mag&#39;)</span>





    <span class="c1"># </span>

    <span class="c1"># add_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;, 1, up = &#39;up1&#39;, ise_new = &#39;1urseq&#39;, calc_method = &#39;uniform_scale&#39;, it_folder = &#39;LiFePO4/uscale/&#39;, scale_region = [-2,6],  inherit_option = &#39;inherit_xred&#39; )</span>
    <span class="c1"># sys.exit()</span>

    <span class="c1"># add_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1useq&#39;, [1,2], up = &#39;up1&#39;, ise_new = &#39;1urseq&#39;, calc_method = &#39;neb&#39;, n_neb_images = 3 )</span>
    <span class="c1"># sys.exit()</span>

    <span class="sd">&quot;&quot;&quot;OMC analysis&quot;&quot;&quot;</span>
    <span class="c1"># res_loop(&#39;LiFePO4.nebLi1v1&#39;,&#39;1u&#39;, 4, show = &#39;occ&#39;)</span>

    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n3i1e2Lims&#39;,[u&#39;1u&#39;],    verlist = [4], show =&#39;occ21&#39; ) </span>


    <span class="c1"># res_loop(&#39;FePO4.pnma2.n7i1e2Lims&#39;, [u&#39;1ulong&#39;], verlist = [1], show = &#39;oc&#39;)</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2v1.n7i1e2Lims&#39;,[u&#39;1ur30&#39;], verlist = [6], show = &#39;occ&#39; ) </span>



    <span class="c1"># add_loop(&#39;FePO4.pnma2.n7i1e2Lims&#39;,&#39;1ulong&#39;, 1, up = &#39;up1&#39;,  inherit_option = &#39;occ&#39;, ise_new = &#39;1uos&#39;, </span>
    <span class="c1">#     id_from = (&#39;FePO4.pnma2v1.n7i1e2Lims&#39;, &#39;1ur30&#39;, 1), it_folder = &#39;LiFePO4/inherited&#39; )</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2.n7i1e2Lims.ifo&#39;,&#39;1uomc&#39;, 1, up = &#39;up2&#39;, show = &#39;occ&#39; )</span>
    <span class="c1"># res_loop(&#39;FePO4.pnma2.n7i1e2Lims.ifo&#39;,&#39;1uos&#39;, 1, show = &#39;occ&#39; )</span>



    <span class="c1"># res_loop(&#39;LiCoO2.s10&#39;,&#39;1urs&#39;,1,   choose_outcar = 0,    show = &#39;maga&#39;)</span>
    <span class="c1"># res_loop(&#39;LiCoO2.s10.su&#39;,&#39;4uis&#39;,100, choose_outcar = 0, show = &#39;maga&#39;)</span>




    <span class="c1"># res_loop(&#39;NiO2.id.su.s10.su&#39;,&#39;4uris&#39;,100, choose_outcar = 3, show = &#39;oc&#39;)</span>
    <span class="c1"># res_loop(&#39;NiO2.id.su.s10.su&#39;,&#39;4uris&#39;,100, choose_outcar = 4, show = &#39;oc&#39;)</span>

    <span class="c1"># res_loop(&#39;NiO2.id.su&#39;,&#39;4uis&#39;,  4, choose_outcar = 2, show = &#39;smag&#39;)</span>
    <span class="c1"># res_loop(&#39;NiO2.id.su&#39;,&#39;4uisWF&#39;,4, choose_outcar = 2, show = &#39;smag&#39;)</span>
    <span class="c1"># res_loop(&#39;NiO2.id.su&#39;,&#39;4uis&#39;,4, choose_outcar = 2, show = &#39;smag&#39;)</span>

    <span class="c1"># res_loop(&#39;NiO2.id.su&#39;,&#39;4uisC0W1&#39;,4, choose_outcar = 1, show = &#39;smag&#39;)</span>
    <span class="c1"># res_loop(&#39;NiO2.id.su&#39;,&#39;4uisWF&#39;, list(range(1,7))+[100],  choose_outcar = 2, show = &#39;fi&#39;, analys_type = &#39;fit_a&#39;)</span>
    <span class="c1"># res_loop(&#39;NiO2.id.su&#39;,&#39;4uisC0W1&#39;, list(range(1,7))+[100], choose_outcar = 1, show = &#39;fo&#39;, analys_type = &#39;fit_a&#39;)</span>
    <span class="c1"># (&#39;NiO2.id.su&#39;, &#39;4uisC0W1&#39;, 7)</span>
    <span class="c1"># (&#39;NiO2.id.su&#39;, &#39;4uisC0W2&#39;, 7)</span>

    <span class="c1"># print(calc[&#39;NiO2.id.su&#39;,&#39;4uis&#39;,4].dir)</span>



    <span class="c1"># res_loop(&#39;LiFePO4.s10.suv100.n3Li1v1ms&#39;,&#39;1urs&#39;,4, choose_outcar = 3, show = &#39;occ102&#39;)</span>
    <span class="c1"># res_loop(&#39;LiFePO4.s10.suv100.n3Li1v1ms&#39;,&#39;1urs&#39;,4, choose_outcar = 4, show = &#39;occ102&#39;)</span>


    <span class="c1"># add_loop(&#39;Na111&#39;, &#39;8u&#39;, 1, up = &#39;up1&#39;, input_geo_format = &#39;vasp&#39;, it_folder = &#39;Na/bcc&#39;)</span>




    <span class="sd">&quot;&quot;&quot;Space groups&quot;&quot;&quot;</span>

    <span class="c1"># res_loop(&#39;LiNiO2.r3m&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiNiO2/r3m&#39;, mat_proj_id = &#39;mp-25592&#39;)    #on 2016-09-03</span>
    <span class="c1"># add_loop(&#39;NiO2.r3m&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiNiO2/r3m&#39;, mat_proj_id = &#39;mp-35925&#39;)  </span>
    <span class="c1"># res_loop(&#39;NiO2.r3m&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiNiO2/r3m&#39;, mat_proj_id = &#39;mp-35925&#39;, show = &#39;occ1&#39;)  </span>
    <span class="c1"># res_loop(&#39;NiO2.r3m.id.su&#39;,&#39;4urisC0W1&#39;,100, show = &#39;occ1&#39;)</span>
    <span class="c1"># res_loop(&#39;NiO2.r3m.id.su&#39;,&#39;4uiAl&#39;,100, show = &#39;occ1&#39;)</span>
    <span class="c1"># rprimd = calc[&#39;KVPO4F.Pna21&#39;,&#39;1u&#39;, 1].init.rprimd</span>
    <span class="c1"># print(rprimd)</span>
    <span class="c1"># print(calc[&#39;NiO2.r3m.id.su&#39;,&#39;4urisC0W1&#39;, 1].end.rprimd)</span>
    <span class="c1"># res_loop(&#39;LiTiS2.s10.su&#39;,&#39;4uis&#39;,100, show = &#39;occ1&#39; )</span>
    <span class="c1"># from geo import ortho_vec2, ortho_vec</span>
    <span class="c1"># print(ortho_vec(rprimd, [10,10,10])  )</span>
    <span class="c1"># print(ortho_vec2(rprimd, [10,10,10])  )</span>

    <span class="c1"># add_loop(&#39;LiMn2O4.Fd3m.111&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiMn2O4/Fd3m&#39;, mat_proj_id = &#39;mp-25015&#39;, mat_proj_cell = &#39;conv&#39;)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;LiMn2O4.Fd3m.111&#39;,&#39;1u&#39;, 1, show = &#39;fomag&#39;)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;LiMn2O4.Fd3m&#39;,&#39;1urs&#39;, 1, choose_outcar  = 3, show = &#39;mag&#39;)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;LiMn2O4.Fd3m&#39;,&#39;1u&#39;, 1, show = &#39;fomag&#39;)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;LiMn2O4.Fd3m.s10&#39;,&#39;1urs&#39;, 1, show = &#39;fomag&#39;, choose_outcar = 3)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;LiMn2O4.Fd3m.s10&#39;,&#39;1ur10&#39;, 1, show = &#39;fomag&#39;, choose_outcar = 10)    #on 2016-09-03</span>
    <span class="c1"># print (calc[&#39;LiMn2O4.Fd3m&#39;,&#39;1u&#39;,1].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;LiMn2O4.Fd3m.s10&#39;,&#39;1ur10&#39;,1].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;LiMn2O4.Fd3m.111&#39;,&#39;1u&#39;, 1,].end.get_space_group_info() )</span>
    <span class="c1"># res_loop(&#39;LiMn2O4.Fd3m.111&#39;,&#39;1u&#39;, 1,)</span>


    <span class="c1"># print (calc[&#39;Na2FePO4F.s10&#39;,&#39;1urs&#39;, 1,].end.get_space_group_info() )</span>

    <span class="c1"># add_loop(&#39;KVPO4F.Pna21&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;cee_database&#39;, it_folder = &#39;KVPO4F/Pna21&#39;, cee_file = &#39;x1aa_exp.cif&#39;)    #on 2016-09-03</span>
    <span class="c1"># res_loop(&#39;KVPO4F.Pna21&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;cee_database&#39;, it_folder = &#39;KVPO4F/Pna21&#39;)    #on 2016-09-03</span>
        <span class="c1"># add_loop(&#39;Na2FePO4F&#39;, &#39;1u&#39;, 1, input_geo_format = &#39;cee_database&#39;, it_folder = &#39;Na2FePO4F&#39;)</span>
    <span class="c1"># print (calc[&#39;KVPO4F.Pna21&#39;,&#39;1u&#39;, 1].init.get_space_group_info() )</span>


    <span class="c1"># print (calc[&#39;LiVPO4F.s10.su&#39;,&#39;4uis&#39;,100].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;LiVP2O7.s10.su&#39;,&#39;4uis&#39;,100].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;LiNiO2.s10.su&#39;,&#39;4uisns&#39;,100].end.get_space_group_info() )</span>

    <span class="c1"># print (calc[&#39;NiO2.id.su&#39;,&#39;4uisC0W1&#39;,1].init.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;NiO2.id.su&#39;,&#39;4uisC0W1&#39;,1].init.get_space_group_info() )</span>

    <span class="c1"># print (calc[&#39;LiTiO2.s10.su&#39;,&#39;4uisns&#39;,100].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;TiS2.id.su&#39;,&#39;4uis&#39;,100].end.rprimd )</span>
    <span class="c1"># print (calc[&#39;TiS2&#39;,&#39;8Utm3-5&#39;,1].end.rprimd )</span>
    <span class="c1"># sys.exit()</span>
    <span class="c1"># print (calc[&#39;LiTiS2.s10.su&#39;,&#39;4uis&#39;,100].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;LiMn2O4.s10.su&#39;,&#39;4uis&#39;,100].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;LiTiS2.s10.su&#39;,&#39;4uis&#39;,100].end.get_space_group_info() )</span>
    <span class="c1"># print (calc[&#39;KVPO4F.ir.su&#39;,&#39;4uisC0W1&#39;,100].end.get_space_group_info() )</span>

    <span class="c1"># print (calc[&#39;Li2FePO4F.ir.su.s10.su&#39;,&#39;4uis&#39;,100].end.get_space_group_info() )</span>


    <span class="c1"># res_loop(&#39;LiFePO4.s10.suv100.n3Li1v1ms&#39;,&#39;1urs&#39;,4, choose_outcar = 3   , show = &#39;occ97&#39;)</span>
    <span class="c1"># res_loop(&#39;LiFePO4.s10.suv100.n3Li1v1ms&#39;,&#39;1urs&#39;,4, choose_outcar = None, show = &#39;occ97&#39;)</span>
     










    <span class="sd">&quot;&quot;&quot;For notebooks&quot;&quot;&quot;</span>

    <span class="c1"># sys.path.extend([&#39;/home/aksenov/Simulation_wrapper/siman&#39;, &#39;/home/aksenov/Simulation_wrapper/SSHTools&#39;])</span>
    <span class="c1"># from SSHTools import SSHTools</span>
    <span class="c1"># header.ssh_object = SSHTools()</span>
    <span class="c1"># header.ssh_object.setup(user=&quot;aksenov&quot;,host=&quot;10.30.16.62&quot;,pkey=&quot;/home/aksenov/.ssh/id_rsa&quot;)</span>
    <span class="c1"># header.PATH2PROJECT    = &#39;topologic&#39;</span>
    <span class="c1"># header.varset[&#39;static&#39;].potdir = {83:&#39;Bi_pv&#39;, 34:&#39;Se&#39;}</span>
    <span class="c1"># header.siman_run = 0</span>
    <span class="c1"># add_loop(&#39;Bi2Se3&#39;, &#39;static&#39;, 1, input_geo_file = &#39;Bi2Se3_mp-541837_computed.cif&#39;, it_folder = &#39;Bi2Se3&#39;, run = 0)</span>

    <span class="c1"># res_loop(&#39;Bi2Se3&#39;, &#39;static&#39;, 1, up = &#39;up&#39;)</span>
    <span class="c1"># header.warnings = &#39;yY&#39;</span>
    <span class="c1"># add_loop(&#39;Bi2Se3&#39;, &#39;static&#39;, 1, calc_method = &#39;uniform_scale&#39;, scale_region = (-5, 5), run = 0)</span>



    <span class="kn">from</span> <span class="nn">siman.dos_functions</span> <span class="k">import</span> <span class="n">plot_dos</span>
    <span class="c1"># add_loop(&#39;Li2&#39;, &#39;dosb4&#39;, 1, run = 1)</span>
    <span class="c1"># res_loop(&#39;Li2&#39;, &#39;dosb4&#39;, 1, )</span>
    <span class="c1"># add_loop(&#39;Li2&#39;, &#39;fullb4sdos&#39;, 1, run = 1)</span>
    <span class="c1"># plot_dos(calc[&#39;Li2&#39;, &#39;dosb4&#39;, 1], dostype = &#39;partial&#39;, orbitals = &#39;d&#39;)</span>
    <span class="c1"># plot_dos(calc[&#39;Li2&#39;, &#39;fullb4sdos&#39;, 1], dostype = &#39;partial&#39;, orbitals = &#39;s&#39;, up = 1, show =0 )</span>

    <span class="c1"># header.PATH2PROJECT    = &#39;topologic&#39;</span>

    <span class="c1"># add_loop(&#39;Bi2Se3&#39;, &#39;dos&#39;, 1, input_geo_file = &#39;Bi2Se3_mp-541837_computed.POSCAR&#39;, run = 0)</span>


    <span class="c1"># res_loop(&#39;Bi2Se3&#39;, &#39;dos&#39;, 1)</span>
    <span class="c1"># plot_dos(header.calc[&#39;Bi2Se3&#39;, &#39;dos&#39;, 1], dostype = &#39;total&#39;)</span>




    <span class="c1"># add_loop(&#39;Li2&#39;, &#39;fullb4&#39;, 1, run =0)</span>
    <span class="c1"># res_loop(&#39;Li2&#39;, &#39;fullb4&#39;, 1, show = &#39;fo&#39;, up = &#39;up&#39;)</span>
    <span class="c1"># add_loop(&#39;Li2&#39;, &#39;fullb4&#39;, 1, ise_new = &#39;ion&#39;, inherit_option = &#39;supercell&#39;, mul_matrix = [[3,0,0],[0,3,0],[0,0,3]], run = 1)</span>
    <span class="c1"># res_loop(&#39;Li2.s333&#39;, [&#39;ion&#39;], [1], up = &#39;up2&#39;, show = &#39;fo&#39; )</span>
    <span class="c1"># add_loop(&#39;Li2.s333&#39;, [&#39;ion&#39;], [1], inherit_option = &#39;make_vacancy&#39;, i_atom_to_remove = 0, run = 1, override = 1)</span>

    <span class="c1"># res_loop(&#39;Li2.s333.vac&#39;, [&#39;ion&#39;], [1], up = &#39;up2&#39;, show = &#39;fo&#39;, analys_type = &#39;matrix_diff&#39;, b_id = (&#39;Li2.s333&#39;, &#39;ion&#39;, 1))</span>
    <span class="kn">from</span> <span class="nn">impurity</span> <span class="k">import</span> <span class="n">add_impurity</span>
    <span class="c1"># add_impurity(&#39;Li2.s333.oct&#39;, &#39;Li&#39;, calc = calc, it_to = &#39;Li2.s333&#39;, put_exactly_to = (0, 1/6, 1/6))</span>

    <span class="c1"># add_loop(&#39;Li2.s333.tet&#39;, [&#39;ion&#39;], [1], run = 1, override = 1)</span>
    <span class="c1"># res_loop(&#39;Li2.s333.tet&#39;, [&#39;ion&#39;], [1], show = &#39;fo&#39;, analys_type = &#39;matrix_diff&#39;, b_id = (&#39;Li2.s333&#39;, &#39;ion&#39;, 1))</span>
    <span class="c1"># add_loop(&#39;Li2.s333.oct&#39;, [&#39;ion&#39;], [1], run = 1, override = 1)</span>
    <span class="c1"># res_loop(&#39;Li2.s333.oct&#39;, [&#39;ion&#39;], [1], show = &#39;fo&#39;, analys_type = &#39;matrix_diff&#39;, b_id = (&#39;Li2.s333&#39;, &#39;ion&#39;, 1))</span>

    <span class="kn">from</span> <span class="nn">impurity</span> <span class="k">import</span> <span class="n">find_pores</span>
    <span class="c1"># st = calc[&#39;Li2.s333&#39;, &#39;ion&#39;, 1].end</span>
    <span class="c1"># st_pores = find_pores(calc[&#39;Li2.s333&#39;, &#39;ion&#39;, 1].end, r_matrix = 1.0, r_impurity = 0.5, fine = 1, calctype = &#39;all_pores&#39;)</span>
    <span class="c1"># write_xyz(st.add_atoms(st_pores.xcart, &#39;H&#39;), file_name = st.name+&#39;_possible_positions&#39;)</span>




    <span class="k">def</span> <span class="nf">test_energy_convergence</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Comparison of two Li2FePO4 structures obtained with U-ramping and without it&quot;&quot;&quot;</span>


        <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su.s10.su.ifn&#39;,&#39;1ur30&#39;, 100, show = &#39;occ35&#39;)</span>
        <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su.s10.su&#39;,    &#39;4uis&#39;,  100, show = &#39;occ35&#39;)</span>

        <span class="c1"># add_loop(&#39;Li2FePO4F.ir.su.s10.su.ifn&#39;,&#39;1ur30&#39;, 100, ise_new = &#39;0ur&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocv&#39;, override = True)</span>
        <span class="c1"># add_loop(&#39;Li2FePO4F.ir.su.s10.su&#39;,    &#39;4uis&#39;,  100, ise_new = &#39;0ur&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocv&#39;, override = True)</span>
        <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;Li2FePO4F.ir.su.s10.su.if&#39;</span><span class="p">,</span>     <span class="p">[</span><span class="s1">&#39;0ur&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;occ&#39;</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="mi">3</span>  <span class="p">)</span>
        <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;Li2FePO4F.ir.su.s10.su.ifn.if&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;0ur&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;occ&#39;</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="mi">3</span>  <span class="p">)</span> <span class="c1"># relaxed in some high energy state</span>
        <span class="c1"># print(calc[&#39;Li2FePO4F.ir.su.s10.su.if&#39;,     &#39;0ur&#39;, 100].get_chg_file(&#39;100.U00.CHGCAR&#39;))</span>
        <span class="c1"># print(calc[&#39;Li2FePO4F.ir.su.s10.su.ifn.if&#39;,     &#39;0ur&#39;, 100].get_chg_file(&#39;100.U00.CHGCAR&#39;))</span>

        <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su&#39;,    &#39;4uis&#39;,  100)</span>
        <span class="c1"># add_loop(&#39;Li2FePO4F.ir.su&#39;,    &#39;4uis&#39;,  100, ise_new = &#39;1urs&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocv&#39;, override = True)</span>

        <span class="c1"># add_loop(&#39;Li2FePO4F.ir.su.if&#39;,    &#39;1urst5&#39;,  100)</span>
        <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su.if&#39;,    &#39;1urs&#39;,    100, show = &#39;fo&#39;)</span>
        <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su.if&#39;,    &#39;1urst5&#39;,  100, show = &#39;fo&#39;, choose_outcar = 3)</span>
        <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su.if&#39;,    &#39;1urst5&#39;,  100, show = &#39;fo&#39;, choose_outcar = 4)</span>

        <span class="c1"># add_loop(&#39;Li2FePO4F.ir.su.if&#39;,    &#39;1ursns&#39;,  100)</span>


    <span class="c1"># test_energy_convergence()</span>











    <span class="sd">&quot;&quot;&quot;Adding to database&quot;&quot;&quot;</span>
    <span class="c1"># from calc_manage import add_to_database</span>
    <span class="c1"># cl = calc[&#39;Li2FePO4F.ir.su.s10.su&#39;,&#39;4uis&#39;,100]</span>
    <span class="c1"># print(cl.end.natom)</span>
    <span class="c1"># print (st.get_space_group_info())</span>
    <span class="c1"># add_to_database(cl)</span>

    <span class="c1"># calc2[&#39;asdf&#39;] = &#39;test&#39;</span>
    <span class="c1"># print(calc2[&#39;asdf&#39;])</span>








    <span class="sd">&quot;&quot;&quot;Additional task&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">siman.set_functions</span> <span class="k">import</span> <span class="n">InputSet</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;/home/aksenov/scientific_projects/cathode/azh_task/&#39;</span>
        <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;azh30&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">InputSet</span><span class="p">(</span><span class="s1">&#39;azh30&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">+</span><span class="s1">&#39;POTCAR&#39;</span><span class="p">)</span>
        <span class="c1"># varset[ise] =</span>
        <span class="n">s</span><span class="o">.</span><span class="n">read_incar</span><span class="p">(</span><span class="n">folder</span><span class="o">+</span><span class="s1">&#39;/INCAR&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">kpoints_file</span> <span class="o">=</span> <span class="n">folder</span><span class="o">+</span><span class="s1">&#39;/KPOINTS&#39;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;LDAUL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Co&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;LDAUU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Co&#39;</span><span class="p">:</span><span class="mf">5.7</span><span class="p">}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;LDAUJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Co&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">u_ramping_nstep</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">s</span><span class="o">.</span><span class="n">save_last_wave</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># manually_remove_from_struct_des(struct_des, &#39;CoPO4F&#39;)</span>

        <span class="c1"># add_loop(&#39;CoPO4F&#39;, &#39;azh&#39;, 1, input_geo_file = &#39;azh_task/POSCAR&#39;,  it_folder = &#39;azh_task&#39;)</span>
        <span class="c1"># res_loop(&#39;CoPO4F&#39;, &#39;0ur&#39;, 1, input_geo_file = &#39;azh_task/POSCAR&#39;,  it_folder = &#39;azh_task&#39;)</span>

        <span class="c1"># res_loop(&#39;CoPO4F&#39;, &#39;azh30&#39;, 1, input_geo_file = &#39;azh_task/POSCAR&#39;,  it_folder = &#39;azh_task&#39;, show = &#39;mag&#39;)</span>
        <span class="c1"># res_loop(&#39;CoPO4F&#39;, &#39;0u57r&#39;, 1, input_geo_file = &#39;azh_task/POSCAR&#39;,  it_folder = &#39;azh_task&#39;, show = &#39;mag&#39;)</span>









        <span class="n">Li2Co_pbcn</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;Li2CoPO4F.pbcn.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uis&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span> <span class="c1">#&#39;Li2CoPO4F.pbcn.su.s10&#39;</span>
        <span class="c1"># v_LiCo = calc[&#39;LiCoPO4F.pbcn.id1.su.s10&#39;,&#39;1u&#39;,100] </span>

        <span class="n">cl</span> <span class="o">=</span> <span class="n">Li2Co_pbcn</span>
        <span class="n">it_folder</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/chg&#39;</span>
        <span class="k">for</span> <span class="n">del_pos</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">it_new</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">del_pos</span><span class="p">)</span>
            <span class="c1"># st = create_deintercalated_structure(cl.end, &#39;Li&#39;, del_pos = del_pos)</span>
            <span class="c1"># add_loop(it_new,&#39;0u&#39;,1, input_st = st, it_folder = it_folder, override = True) #charge density without relaxation</span>
            <span class="n">res_loop</span><span class="p">(</span><span class="n">it_new</span><span class="p">,</span><span class="s1">&#39;0u&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>        


        <span class="n">v_LiCo_pbcn</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;Li2CoPO4F.pbcn.su.id1&#39;</span><span class="p">,</span><span class="s1">&#39;0u&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">cal_chg_diff</span><span class="p">(</span><span class="n">Li2Co_pbcn</span><span class="p">,</span> <span class="n">v_LiCo_pbcn</span><span class="p">,</span> <span class="n">wcell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>










    <span class="kn">from</span> <span class="nn">analysis</span> <span class="k">import</span> <span class="n">calc_redox</span>


    <span class="c1"># calc_redox(calc[&#39;KVPO4F.Pna21.s10.su&#39;,&#39;4uis&#39;,100], calc[&#39;VPO4F.Pna21.id.su.s10.su&#39;,&#39;4uis&#39;,100])</span>




    <span class="kn">from</span> <span class="nn">geo</span> <span class="k">import</span> <span class="n">determine_symmetry_positions</span>

    <span class="c1"># st = calc[&#39;NaFePO4F.id1.su.s10.su&#39;,&#39;4uis&#39;,100].end</span>
    <span class="c1"># st = calc[(&#39;KVPO4F.Pna21&#39;, &#39;1u&#39;, 1)].end</span>
    <span class="c1"># st = calc[&#39;LiFePO4F.pnma.id2.su.s10&#39;,&#39;1u&#39;,100].end</span>
    <span class="c1"># determine_symmetry_positions(st, &#39;Fe&#39;)</span>



    <span class="kn">from</span> <span class="nn">geo</span> <span class="k">import</span> <span class="n">create_antisite_defect2</span>

    <span class="n">st1</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;NaFePO4F.id1.su.s10.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uis&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">init</span>
    <span class="n">st2</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;NaFePO4F.id2.su.s10.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uis&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
    <span class="c1"># print(st1.convert2pymatgen())</span>
    <span class="c1"># print()</span>


    <span class="c1"># st = create_antisite_defect2(st_base = st2, st_from = st1, cation = &#39;Na&#39;, trans = &#39;Fe&#39;, mode = &#39;add_swp&#39;)</span>







    <span class="kn">from</span> <span class="nn">calc_manage</span> <span class="k">import</span> <span class="n">smart_structure_read</span>



    <span class="c1"># st  = calc[&#39;Li2CoPO4F.pnma&#39;,&#39;1u&#39;, 1].end</span>
    <span class="c1"># print(calc[&#39;Li2CoPO4F.pnma&#39;,&#39;1u&#39;, 1].end.get_elements())</span>
    <span class="c1"># from geo import create_deintercalated_structure</span>
    <span class="c1"># create_deintercalated_structure(st, &#39;Li&#39;, del_pos = 1)</span>



    <span class="c1"># add_loop(&#39;Li2CoPO4F.pnma&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;Li2CoPO4F/pnma&#39;, mat_proj_id = &#39;mp-770853&#39;)  </span>

    <span class="c1"># add_loop(&#39;Li2CoPO4F.pbcn&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;Li2CoPO4F/pbcn&#39;, mat_proj_id = &#39;mp-770624&#39;)  </span>

    <span class="c1"># add_loop(&#39;Li2CoPO4F.pnma&#39;,&#39;1ur&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;Li2CoPO4F/pnma&#39;, mat_proj_id = &#39;mp-770853&#39;, run = 1)  </span>


    <span class="c1"># res_loop(&#39;Li2CoPO4F.pbcn&#39;,&#39;1u&#39;, 1)</span>
    <span class="c1"># res_loop(&#39;Li2CoPO4F.pnma&#39;,&#39;1u&#39;, 1)</span>
    <span class="c1"># res_loop(&#39;Li2CoPO4F.pnma&#39;,&#39;1ur&#39;, 1, show = &#39;occ&#39;)</span>

    <span class="c1"># st = smart_structure_read(input_geo_file = &#39;Li2FePO4F/Li2FePO4F_abakumov.cif&#39;)</span>

    <span class="c1"># add_loop(&#39;Li2FePO4F.abak&#39;,&#39;1u&#39;, 1, input_geo_file = &#39;Li2FePO4F/Li2FePO4F_abakumov.cif&#39;, it_folder = &#39;Li2FePO4F/pnma&#39; )  </span>
    <span class="c1"># res_loop(&#39;Li2FePO4F.abak&#39;,&#39;1u&#39;,1, show = &#39;fo&#39;)</span>
    <span class="c1"># st = calc[&#39;Li2FePO4F.abak&#39;,&#39;1u&#39;,1].end</span>
    <span class="c1"># st = calc[&#39;Li2FePO4F.pnma&#39;,&#39;1u&#39;, 1].end</span>
    <span class="c1"># print(st.convert2pymatgen())</span>
    <span class="c1"># print(st.get_space_group_info(0.3))</span>


    <span class="c1"># add_loop(&#39;Li2FePO4F.pnma&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;Li2FePO4F/pnma&#39;, mat_proj_id = &#39;mp-776062&#39;)  </span>

    <span class="c1"># res_loop(&#39;Li2FePO4F.pnma&#39;,&#39;1u&#39;, 1)</span>
    <span class="c1"># res_loop(&#39;Li2FePO4F.ir.su&#39;,&#39;4uis&#39;,100)</span>


    <span class="c1"># calc[&#39;Li2FePO4F.abak&#39;,&#39;1u&#39;,1].end.jmol()</span>
    <span class="c1"># calc[&#39;Li2FePO4F.pnma&#39;,&#39;1u&#39;, 1].end.jmol()</span>






    <span class="c1"># add_loop(&#39;LiCrPO4.pnma&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiCrPO4/pnma&#39;, mat_proj_id = &#39;mp-25507&#39;)  </span>
    <span class="c1"># add_loop(&#39;LiCrPO4.pnma&#39;,&#39;1u&#39;, 1, input_geo_format = &#39;mat_proj&#39;, it_folder = &#39;LiCrPO4/pnma&#39;, mat_proj_id = &#39;mp-25507&#39;)  </span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">param_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:(</span><span class="s1">&#39;LiCrPO4.pnma&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;ds&#39;</span><span class="p">:</span><span class="s1">&#39;CrPO4.pnma&#39;</span><span class="p">,</span> <span class="s1">&#39;itfolder&#39;</span><span class="p">:</span><span class="s1">&#39;LiCrPO4/pnma&#39;</span><span class="p">,</span> <span class="s1">&#39;main_set&#39;</span><span class="p">:</span><span class="s1">&#39;1u&#39;</span>  <span class="p">}</span>
        <span class="c1"># calc_barriers(&#39;normal&#39;, up = 0, param_dic = param_dic)</span>
        <span class="c1"># calc_barriers(&#39;replace&#39;,  &#39;Li&#39;, &#39;Na&#39;, show_fit = 0, up = 0, upA = 0, param_dic = param_dic)</span>
        <span class="n">calc_barriers</span><span class="p">(</span><span class="s1">&#39;make_ds&#39;</span><span class="p">,</span>  <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="n">param_dic</span><span class="p">)</span>



    <span class="c1"># from SSHTools import SSHTools</span>
    <span class="c1"># header.ssh_object = SSHTools()</span>
    <span class="c1"># header.ssh_object.setup(user=&quot;aksenov&quot;,host=&quot;10.30.16.62&quot;,pkey=&quot;/home/aksenov/.ssh/id_rsa&quot;)</span>










    <span class="c1"># add_loop(&#39;Bi2Se3.hex&#39;, &#39;1&#39;, 1, input_geo_file = &#39;Bi2Se3/Bi2Se3_hex.POSCAR&#39;, it_folder = &#39;Bi2Se3&#39;, run = 1)</span>
    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, input_geo_file = &#39;Bi2Se3_mp-541837_computed.POSCAR&#39;, it_folder = &#39;Bi2Se3&#39;, run = 0)</span>


    <span class="c1"># res_loop(&#39;Bi2Se3.hex.su&#39;, &#39;1&#39;, 100)</span>
    <span class="c1"># res_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1)</span>

    <span class="c1"># add_loop(&#39;Bi2Se3.hex&#39;, &#39;1&#39;, 1, calc_method = &#39;uniform_scale&#39;, inherit_option = &#39;inherit_xred&#39;, scale_region = (-4, 4), run = 1)</span>


    <span class="c1"># print(calc[&#39;Bi2Se3.hex.su&#39;, &#39;1&#39;, 100].energy_sigma0/15 - calc[&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1].energy_sigma0/5)</span>

    <span class="c1"># res_loop(&#39;Bi2Se3.hex.su&#39;, [&#39;1&#39;], [1, 2, 3, 4, 5, 6, 7, 100], show = &#39;fitfo&#39;, analys_type = &#39;fit_a&#39;  ) </span>

    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, ise_new = &#39;0bsr&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocx&#39;, override = 1, run = 1)</span>

    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;dos&#39;, 1, savefile = &#39;ocx&#39;, input_geo_file = &#39;Bi2Se3_mp-541837_computed.POSCAR&#39;, it_folder = &#39;Bi2Se3&#39;, run = 0)</span>

    <span class="c1"># res_loop(&#39;Bi2Se3.rho.if&#39;, &#39;0bsr&#39;, 1   ,up = &#39;x&#39;)</span>
    <span class="c1"># res_loop(&#39;Bi2Se3.rho&#39;, &#39;dos&#39;, 1 ,up = &#39;x&#39;)</span>

    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, ise_new = &#39;0bsrsoc&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocx&#39;, override = 1, run = 1)</span>
    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, ise_new = &#39;0bsrsoc100&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocx&#39;, override = 1, run = 1)</span>
    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, ise_new = &#39;0bsrsoc010&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocx&#39;, override = 1, run = 1)</span>
    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, ise_new = &#39;0bsrsoc000&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocx&#39;, override = 1, run = 1)</span>
    <span class="c1"># add_loop(&#39;Bi2Se3.rho&#39;, &#39;1&#39;, 1, ise_new = &#39;0bsrsoc0&#39;, inherit_option = &#39;full&#39;, savefile = &#39;ocx&#39;, override = 1, run = 1)</span>

    <span class="c1"># res_loop(&#39;Bi2Se3.rho.if&#39;, &#39;0bsrsoc&#39;, 1, up = &#39;x&#39;)</span>
    <span class="c1"># res_loop(&#39;Bi2Se3.rho.if&#39;, &#39;0bsrsoc100&#39;, 1, up = &#39;x&#39;)</span>
    <span class="c1"># res_loop(&#39;Bi2Se3.rho.if&#39;, &#39;0bsrsoc010&#39;, 1, show = &#39;mag&#39;)</span>
    <span class="c1"># res_loop(&#39;Bi2Se3.rho.if&#39;, &#39;0bsrsoc000&#39;, 1, up = &#39;x&#39;)</span>
    <span class="c1"># res_loop(&#39;Bi2Se3.rho.if&#39;, &#39;0bsrsoc0&#39;, 1, up = &#39;x&#39;)</span>


    <span class="c1"># from bands import plot_bands</span>
    <span class="c1"># ban = &#39;/home/aksenov/scientific_projects/cathode/Bi2Se3/Bi2Se3.rho.if.0bsrsoc0/&#39;</span>
    <span class="c1"># plot_bands(&#39;/home/aksenov/scientific_projects/cathode/Bi2Se3/Bi2Se3.rho.dos/1.vasprun.xml&#39;, </span>
    <span class="c1">#     vasprun_bands = ban+&#39;1.vasprun.xml&#39;, kpoints = ban+&#39;KPOINTS&#39;, element = &#39;Bi&#39;, ylim = (-1.5, 2.5))</span>




    <span class="c1"># file = &#39;VO/CONTCAR_mopac&#39;</span>
    <span class="c1"># # file = &#39;VO/Kayunkid10.cif&#39;</span>
    <span class="c1"># st = smart_structure_read(input_geo_file = file)</span>

    <span class="c1"># st = st.return_atoms_to_cell()</span>
    <span class="c1"># st = st.shift_atoms(vector_red  = (0.5,0.5,0.5))</span>
    <span class="c1"># st = st.return_atoms_to_cell()</span>

    <span class="c1"># st.write_poscar(file+&#39;_conv&#39;, vasp5 = True)</span>



    <span class="c1"># add_loop(&#39;Ti2&#39;, &#39;0&#39;, 1, input_geo_file = &#39;Ti/hex111.geo&#39;, it_folder = &#39;Ti/hex/&#39;, run = 1, corenum = 1)</span>
    <span class="c1"># add_loop(&#39;Ti2&#39;, &#39;1hssb&#39;, 1, input_geo_file = &#39;Ti/hex111.geo&#39;, it_folder = &#39;Ti/hex/&#39;, run = 1, corenum = 4)</span>
    <span class="c1"># add_loop(&#39;TiFe&#39;, &#39;1hssb&#39;, 1, input_geo_file = &#39;TiFe/1.CONTCAR&#39;, it_folder = &#39;TiFe/B1/&#39;, run = 1, corenum = 4)</span>
    <span class="c1"># add_loop(&#39;Fe2&#39;, &#39;1hssbm&#39;, 1, input_geo_file = &#39;Fe/1.CONTCAR&#39;, it_folder = &#39;Fe/bcc/&#39;, run = 1, corenum = 8)</span>

    <span class="c1"># res_loop(&#39;Ti2&#39;, &#39;0&#39;, 1)</span>


    <span class="c1"># res_loop(&#39;Ti2&#39;, &#39;1hssb&#39;, 1)</span>
    <span class="c1"># res_loop(&#39;TiFe&#39;, &#39;1hssb&#39;, 1)</span>
    <span class="c1"># res_loop(&#39;Fe2&#39;, &#39;1hssbm&#39;, 1)</span>


    <span class="c1"># print(-20.8478--9.1541--9.2957 )</span>








    <span class="k">def</span> <span class="nf">k10</span><span class="p">():</span>
        <span class="n">V250</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2235.4046</span>
        <span class="n">V249v</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2224.0141</span>
        <span class="n">V248Tiv</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2223.2459</span>
        <span class="n">V249Ti</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">2233.7968</span>


        <span class="nb">print</span><span class="p">(</span><span class="n">V249Ti</span><span class="o">+</span><span class="n">V249v</span>  <span class="o">-</span> <span class="p">(</span><span class="n">V248Tiv</span> <span class="o">+</span> <span class="n">V250</span> <span class="p">)</span>  <span class="p">)</span>

    <span class="k">def</span> <span class="nf">k15</span><span class="p">():</span>
        <span class="n">V250</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2235.5223</span>
        <span class="n">V249v</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2224.1072</span>
        <span class="n">V248Tiv</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2223.2724</span>
        <span class="n">V249Ti</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">2234.0743</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">V249Ti</span><span class="o">+</span><span class="n">V249v</span>  <span class="o">-</span> <span class="p">(</span><span class="n">V248Tiv</span> <span class="o">+</span> <span class="n">V250</span> <span class="p">)</span>  <span class="p">)</span>

    <span class="c1"># k15()</span>














    <span class="k">return</span> <span class="c1">#end of workflow</span></div>





















<div class="viewcode-block" id="redox"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.redox">[docs]</a><span class="k">def</span> <span class="nf">redox</span><span class="p">(</span><span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ramp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span><span class="p">,</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">image_format</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Run, analyze, plot redox potentials</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>



    <span class="n">cl_list7</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;LiVPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-1&#39;</span><span class="p">,</span> <span class="s1">&#39;VPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-1&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVPO4F&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiVP2O7&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-1&#39;</span><span class="p">,</span> <span class="s1">&#39;VP2O7&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-1&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVP2O7&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiTiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr4-2&#39;</span><span class="p">,</span> <span class="s1">&#39;TiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr4-2&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiO2&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="c1"># [&#39;LiMn2O4&#39;, &#39;8Utmr4-9&#39;, &#39;Mn2O4&#39;, &#39;8Utmr4-9&#39;, &#39;LiMn2O4&#39;] ,</span>
        <span class="p">[</span><span class="s1">&#39;NaMnAsO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-9&#39;</span><span class="p">,</span> <span class="s1">&#39;MnAsO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-9&#39;</span><span class="p">,</span> <span class="s1">&#39;NaMnAsO4&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="c1"># [&#39;Na2FePO4F&#39;, &#39;8Utmr4&#39;, &#39;FePO4F&#39;, &#39;8Utmr4&#39;, &#39;Na2FePO4F&#39;] ,</span>
        <span class="c1"># [&#39;KFeSO4F&#39;, &#39;8Utmr4&#39;, &#39;FeSO4F&#39;, &#39;8Utmr4&#39;, &#39;KFeSO4F&#39;] ,</span>
        <span class="c1"># [&#39;KVPO4F&#39;, &#39;8Utmr3-1&#39;, &#39;VPO4F&#39;, &#39;8Utmr3-1&#39;, &#39;KVPO4F&#39;] ,</span>
    <span class="p">]</span>




    <span class="n">cl_list8</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ise</span> <span class="ow">in</span> <span class="s1">&#39;8u&#39;</span><span class="p">,</span> <span class="s1">&#39;8ue4&#39;</span><span class="p">,</span> <span class="s1">&#39;8ue5&#39;</span><span class="p">,</span> <span class="s1">&#39;8uL&#39;</span><span class="p">:</span>
    <span class="c1"># for ise in &#39;9u&#39;, &#39;9uk15&#39;, &#39;9uk1&#39;:</span>
        <span class="n">cl_list8</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="c1"># [&#39;KFeSO4F&#39;, ise, &#39;FeSO4F&#39;, ise, &#39;KFeSO4F&#39;] ,</span>
        <span class="c1"># [&#39;KVPO4F&#39;, ise, &#39;VPO4F&#39;, ise, &#39;KVPO4F&#39;] ,</span>
        <span class="p">[</span><span class="s1">&#39;LiCoO2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;CoO2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiCoO2&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="c1"># [&#39;LiCoPO4&#39;, ise, &#39;CoPO4&#39;, ise, &#39;LiCoPO4&#39;] ,</span>
        <span class="p">[</span><span class="s1">&#39;LiFePO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;FePO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="c1"># [&#39;LiMn2O4&#39;, ise, &#39;Mn2O4&#39;, ise, &#39;LiMn2O4&#39;] ,</span>
        <span class="p">[</span><span class="s1">&#39;LiMnPO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;MnPO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiMnPO4&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiNiO2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;NiO2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiNiO2&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiTiO2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;TiO2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiTiO2&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiTiS2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;TiS2&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiTiS2&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiVP2O7&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;VP2O7&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiVP2O7&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;LiVPO4F&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;VPO4F&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;LiVPO4F&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="c1"># [&#39;Na2FePO4F&#39;, ise, &#39;FePO4F&#39;, ise, &#39;Na2FePO4F&#39;] ,</span>
        <span class="p">[</span><span class="s1">&#39;NaFePO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;FePO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;NaFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;NaMnAsO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;MnAsO4&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="s1">&#39;NaMnAsO4&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># for li in cl_list8:  </span>
    <span class="c1">#     print li</span>
    <span class="c1"># sys.exit()</span>



    <span class="n">cl_list0</span> <span class="o">=</span> <span class="p">[</span> <span class="c1">#Shishkin2016</span>
    <span class="p">[</span><span class="s1">&#39;LiCoPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr2-8&#39;</span><span class="p">,</span> <span class="s1">&#39;LiCoPO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;LiFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr2-1&#39;</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;FePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-7&#39;</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;LiTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-3&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiS2&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;TiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-5&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiS2&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;NiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiNiO2&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;MnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiMnPO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;CoO2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-9&#39;</span><span class="p">,</span> <span class="s1">&#39;LiCoO2&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;LiNiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr4-6&#39;</span><span class="p">,</span> <span class="s1">&#39;LiNiO2&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;LiMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr2-2&#39;</span><span class="p">,</span> <span class="s1">&#39;LiMnPO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;NaFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr2-2&#39;</span><span class="p">,</span> <span class="s1">&#39;NaFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;CoPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr4-2&#39;</span><span class="p">,</span> <span class="s1">&#39;LiCoPO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;LiCoO2&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmr3-6&#39;</span><span class="p">,</span> <span class="s1">&#39;LiCoO2&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;LiTiO2.s10.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uisns&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiO2&#39;</span><span class="p">],</span> 
    <span class="p">[</span><span class="s1">&#39;TiO2.id.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uis&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiO2&#39;</span><span class="p">],</span> 

    <span class="p">[</span><span class="s1">&#39;LiMn2O4.s10.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uis&#39;</span><span class="p">,</span>    <span class="s1">&#39;LiMn2O4&#39;</span><span class="p">],</span> 
    <span class="p">[</span><span class="s1">&#39;Mn2O4.id.su.s10&#39;</span><span class="p">,</span><span class="s1">&#39;1urs&#39;</span><span class="p">,</span> <span class="s1">&#39;LiMn2O4&#39;</span><span class="p">],</span> 

    <span class="p">]</span>


    <span class="n">cl_list1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># [&#39;LiCoO2&#39;, &#39;8Ur3-6&#39;, &#39;LiCoO2&#39;] ,</span>
    <span class="c1"># [&#39;CoO2&#39;, &#39;8Ur3-9&#39;, &#39;LiCoO2&#39;] ,</span>
    <span class="c1"># [&#39;LiTiS2&#39;, &#39;8Ur3-3&#39;, &#39;LiTiS2&#39;] ,</span>
    <span class="c1"># [&#39;TiS2&#39;, &#39;8Ur3-5&#39;, &#39;LiTiS2&#39;] ,</span>
    <span class="p">[</span><span class="s1">&#39;LiFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Ur2-1&#39;</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;FePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;8Ur3-7&#39;</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">]</span> <span class="p">,</span>
    <span class="c1"># [&#39;NiO2&#39;, &#39;8Ur4&#39;, &#39;LiNiO2&#39;] ,</span>
    <span class="c1"># [&#39;MnPO4&#39;, &#39;8Ur4&#39;, &#39;LiMnPO4&#39;] ,</span>
    <span class="c1"># [&#39;LiCoPO4&#39;, &#39;8Ur2-8&#39;, &#39;LiCoPO4&#39;] ,</span>
    <span class="c1"># [&#39;LiNiO2&#39;, &#39;8Ur4-6&#39;, &#39;LiNiO2&#39;] ,</span>
    <span class="c1"># [&#39;LiMnPO4&#39;, &#39;8Ur2-2&#39;, &#39;LiMnPO4&#39;] ,</span>
    <span class="c1"># [&#39;NaFePO4&#39;, &#39;8Ur2-2&#39;, &#39;NaFePO4&#39;] ,</span>
    <span class="c1"># [&#39;CoPO4&#39;, &#39;8Ur4-2&#39;, &#39;LiCoPO4&#39;] ,</span>
    <span class="p">]</span>

    <span class="c1"># print cl_list8</span>
    <span class="c1"># sys.exit()</span>

    <span class="n">DSs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">final_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># for ls in  cl_list7+cl_list0, :</span>
    <span class="c1"># for ls in  cl_list8+cl_list0+cl_list7, :</span>
    

    <span class="c1"># for ls in  cl_list8,:</span>
    <span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span>  <span class="n">cl_list0</span><span class="p">,:</span>
    <span class="c1"># for ls in  cl_list7, :</span>
        <span class="c1"># print ls</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
            <span class="c1"># print (&#39;hello&#39;,cl)</span>
            <span class="n">energy_ref</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s1">&#39;Li&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;Li111&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmb4&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">if</span> <span class="s1">&#39;Na&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;Na111&#39;</span><span class="p">,</span> <span class="s1">&#39;8Utmb4&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="o">/</span><span class="mi">2</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ramp</span><span class="p">:</span> 
                    <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">run</span><span class="p">:</span> 
                    <span class="n">add_loop</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;Li&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;Na&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
                        <span class="k">continue</span>
                    <span class="c1"># print &#39;hello&#39;</span>


                    <span class="k">for</span> <span class="n">clb</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span> <span class="c1">#find deintercalated</span>
                        <span class="c1"># print clb == cl</span>
                        <span class="k">if</span> <span class="n">clb</span> <span class="o">==</span> <span class="n">cl</span><span class="p">:</span> 
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">clb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
                            <span class="n">bcl</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">clb</span><span class="p">)</span>
                            <span class="c1"># print (clb[0], cl[0])</span>
                    
                    <span class="c1"># print energy_ref</span>
                        
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ramp</span><span class="p">:</span> 
                        <span class="n">bcl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    
                    <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span> 
                    <span class="k">if</span> <span class="s1">&#39;TiO2&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Mn2O4&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="mi">100</span>
                        <span class="c1"># print (v, cl[0], bcl[0])</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     v = 1</span>


                    <span class="n">res_loop</span><span class="p">(</span><span class="n">bcl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bcl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>               <span class="n">v</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">)</span>
                    <span class="n">final_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">,</span> <span class="n">b_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">bcl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bcl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">),</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="n">energy_ref</span><span class="p">)</span>
                        <span class="c1"># print final_list</span>


            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ramp</span><span class="p">:</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">run</span><span class="p">:</span> 
                    <span class="n">add_loop</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">id2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DSs</span><span class="p">:</span> 
                        <span class="n">add_loop</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">input_geo_format</span> <span class="o">=</span> <span class="n">input_geo_format</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">DSs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">,</span> <span class="n">b_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="n">energy_ref</span><span class="p">)</span>

            <span class="c1"># print &#39;hello&#39;</span>
            <span class="c1"># print (final_list)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span> <span class="ow">and</span>  <span class="n">final_list</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1"># print (results)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">,</span> <span class="s1">&#39;kspacing&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;mdstep&#39;</span><span class="p">,</span> <span class="s1">&#39;ecut&#39;</span><span class="p">,</span> <span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="s1">&#39;set_is&#39;</span><span class="p">])</span>
        <span class="c1"># print df.set_index([&#39;is&#39;, &#39;mdstep&#39;, &#39;set_is&#39;]).sortlevel(0).round(3)</span>



        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># compare souces</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">,</span> <span class="s1">&#39;id_is&#39;</span><span class="p">,</span> <span class="s1">&#39;id_ds&#39;</span><span class="p">])[[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GGA+U_ramp&#39;</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GGA+U&#39;</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">]]</span>
            <span class="c1"># print df</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;database/literature.csv&#39;</span><span class="p">)[[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]]</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># print (dfs)</span>
            <span class="c1"># sys.exit()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dfs</span><span class="p">])</span>
            <span class="c1"># df = df.set_index([&#39;is&#39;, &#39;redox_pot&#39;]).sortlevel(0)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># print (df)</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([0-9])&quot;</span><span class="p">,</span> <span class="s2">&quot;$_</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>

            
            <span class="n">wc2</span><span class="o">=</span> <span class="s1">&#39;redox_pot&#39;</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
            <span class="n">df</span><span class="p">[[</span><span class="n">wc2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">wc2</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#compare with other dft</span>
                <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">)</span>
                <span class="c1"># print(df_piv)</span>
                <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df_piv</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;azh&#39;</span><span class="p">])</span>
                <span class="n">df_piv</span><span class="p">[[</span><span class="s1">&#39;GGA+U_ramp&#39;</span><span class="p">,</span> <span class="s1">&#39;azh&#39;</span><span class="p">,</span> <span class="s1">&#39;Shishkin2016&#39;</span> <span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="n">rot</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> 
                    <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#compare with experiment</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="c1"># print (df)</span>
                <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">)[[</span><span class="s1">&#39;GGA+U&#39;</span><span class="p">,</span> <span class="s1">&#39;exp&#39;</span><span class="p">]]</span>
                <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df_piv</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;exp&#39;</span><span class="p">])</span>
                <span class="n">df_piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="n">rot</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> 
                    <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span><span class="p">)</span>



            

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intercalation voltage (V)&#39;</span><span class="p">)</span>


            <span class="c1"># plt.legend(loc=&#39;best&#39;) </span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">handlelength</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> 
                <span class="n">handleheight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># mpl.rcParams.update({&#39;font.size&#39;: 14})</span>
            <span class="c1"># mpl.rcParams.update({&#39;font.size&#39;: 18})</span>
            <span class="c1"># mpl.rc(&#39;legend&#39;, fontsize= 10) </span>


            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>




            <span class="k">if</span> <span class="n">image_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">path_to_images</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">path_to_images</span><span class="p">)</span>
                <span class="n">path2im</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">path_to_images</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">image_format</span>
                <span class="n">printlog</span><span class="p">(</span> <span class="s2">&quot;Saving image ...&quot;</span><span class="p">,</span> <span class="n">path2im</span><span class="p">)</span>
                <span class="c1"># plt.savefig(path2im, dpi = dpi, format=image_format)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">image_name</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">image_name</span><span class="o">+</span><span class="s1">&#39;.eps&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>






<div class="viewcode-block" id="potential_barriers"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.potential_barriers">[docs]</a><span class="k">def</span> <span class="nf">potential_barriers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates figures and tables for report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;LiFePO4.nebLi1v1&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1ulong&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li &#39;</span><span class="p">)</span>    <span class="c1">#mep</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;LiFePO4.nebLi1v1&#39;</span><span class="p">,</span>   <span class="s1">&#39;1u&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li &#39;</span>
     <span class="p">)</span>   <span class="c1">#unexpectedly slightly lower energy for saddle point</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;LiFePO4.n7Li1v1&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1ulong&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li &#39;</span>
     <span class="p">)</span>


    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;FePO4.pnma2.n3i1e2Lims&#39;</span><span class="p">,</span> <span class="s1">&#39;1u&#39;</span><span class="p">,</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li without u-ramping &#39;</span>
     <span class="p">)</span>
    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;FePO4.pnma2v1.n3i1e2Lims&#39;</span><span class="p">,</span> <span class="s1">&#39;1ur&#39;</span><span class="p">,</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li, u-ramping du =  1.3 V&#39;</span>
     <span class="p">)</span>
    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;FePO4.pnma2v1.n7i1e2Lims&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1ur30&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li, u-ramping du =  0.13 V &#39;</span>
     <span class="p">)</span>



    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;NaFePO4.pnma.n3Na1v1mp&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1ulong&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Na &#39;</span>
     <span class="p">)</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;FePO4.pnma2.n3i1e2Na&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1u&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Na &#39;</span>
     <span class="p">)</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;KFePO4.pnma.suv100.n3K1v1ms&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1u&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for K &#39;</span><span class="p">)</span>    <span class="c1">#mep</span>


    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;LiVPO4F.nebLi1v1&#39;</span><span class="p">,</span><span class="s1">&#39;1ur&#39;</span><span class="p">,</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li &#39;</span><span class="p">)</span>    <span class="c1">#mep</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;LiMnPO4v1.n3Li1v1ms&#39;</span><span class="p">,[</span><span class="sa">u</span><span class="s1">&#39;1u&#39;</span><span class="p">],</span> <span class="n">verlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
    <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Diffusion path for Li &#39;</span><span class="p">)</span> 


    <span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span> <span class="mi">12</span><span class="p">)</span> 

    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>

    <span class="n">res_loop</span><span class="p">(</span><span class="s1">&#39;KFePO4.pnma.su&#39;</span><span class="p">,</span><span class="s1">&#39;4uiWF&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;fit_a&#39;</span><span class="p">,</span> 
        <span class="n">push2archive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span>
        <span class="n">description_for_archive</span> <span class="o">=</span> <span class="s1">&#39;Cell shape relaxation and search of minimum&#39;</span><span class="p">)</span>    <span class="c1">#mep</span></div>



<div class="viewcode-block" id="find_matched_calculations"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.find_matched_calculations">[docs]</a><span class="k">def</span> <span class="nf">find_matched_calculations</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look for it in struct_des and find similar calcs.</span>
<span class="sd">    Useful to find corresponding intercalated structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>




<div class="viewcode-block" id="calc_barriers"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.calc_barriers">[docs]</a><span class="k">def</span> <span class="nf">calc_barriers</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">del_ion</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">new_ion</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="s1">&#39;gga+u&#39;</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upA</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upB</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upC</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">param_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run_sc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">run_neb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">up_add_loop</span> <span class="o">=</span> <span class="s1">&#39;up2&#39;</span><span class="p">,</span> 
    <span class="n">up_res</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nise</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">choose_outcar_global</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cathodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplifies calculation of intercalation voltages</span>
<span class="sd">    and barriers by performing step by step calculations - </span>
<span class="sd">    remove cations or replace cations,</span>
<span class="sd">    create supercell, optimize supercell, calculate migration barriers</span>

<span class="sd">    mode (str) -</span>
<span class="sd">        - &#39;normal&#39;</span>
<span class="sd">            param_dic[&#39;start_pos&#39;] (int) - number of starting non-eqiv position</span>
<span class="sd">            param_dic[&#39;end_pos&#39;] (int)   - number of final non-eqiv position</span>

<span class="sd">        - &#39;replace&#39; - creates additional structures by replacing cations</span>

<span class="sd">            - *new_ion* (str) - choose new ion</span>

<span class="sd">        - &#39;make_ds&#39;  - creates deintercalated structures by removing all cations and then inserting in analogy to</span>

<span class="sd">            - *del_ion* - ions to be deleted either by replacement or removing, use &#39;Li Na&#39; if both should be removed</span>

<span class="sd">            param_dic[&#39;neb_search_voids&#39;] - if exists then in &#39;make_ds&#39; mode new voids are searched as final positions</span>

<span class="sd">        - func - functional either gga or gga+u, if gga is used the energies are taken for u=0, however</span>
<span class="sd">        take in mind that optimization was made for &#39;gga+u&#39;</span>

<span class="sd">    nise - if 1 than neb_ise is use, if 0 than main_ise is used. Variable is useful for two-step barrier determination with the second step with fixed occ</span>

<span class="sd">    param_dic - dictionary with parameters</span>
<span class="sd">        &#39;id&#39; - starting id</span>
<span class="sd">        &#39;ds&#39; - name of ds structure</span>
<span class="sd">        &#39;itfolder&#39; - folder for calculation</span>
<span class="sd">        &#39;main_set&#39; - set used for supercells and neb</span>
<span class="sd">        &#39;neb_set&#39; - set for neb used instead of main_set</span>
<span class="sd">        &#39;readfiles&#39; - to res_loop</span>
<span class="sd">        -del_pos - specific non-eqv position of del_ion to be removed starting from 0</span>
<span class="sd">        </span>
<span class="sd">        - meps - list of tuples (start_pos, end_pos)</span>
<span class="sd">        - meps2 - list of tuples (i_atom_to_move, end_pos)</span>
<span class="sd">        - ortho - global target sizes of supercell</span>
<span class="sd">        - ortho.mode_id - specific target sizes of supercell</span>
<span class="sd">        - old_behaviour (bool) - if True then first optimization of cell is not done for &#39;normal&#39;, second optimization for all modes;</span>
<span class="sd">            if False - only first optimization for all cells</span>
<span class="sd">        &#39;old.&#39;+mode_id</span>
<span class="sd">        ! war</span>

<span class="sd">    run_sc - run supercell construction part</span>
<span class="sd">    run_neb - run neb construction part </span>

<span class="sd">    style_dic - passed to plot_mep()</span>

<span class="sd">    choose_outcar_global - allows to override param_dic values, choose outcar to read from sequence set or u-ramp loop</span>

<span class="sd">    cathodes - list of lists - another way to configure the calculation - was initially used</span>

<span class="sd">    update</span>




<span class="sd">    TODO</span>
<span class="sd">    curver - is 1!!! check if it works correctly for other cases</span>


<span class="sd">    return</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">param_dic</span><span class="p">:</span>
        <span class="n">param_dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_loop_dic</span><span class="p">:</span>
        <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
    <span class="n">varset</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">varset</span>


    <span class="k">def</span> <span class="nf">calc_added</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether *cl* has attribute *attr* (tuple) and attr[3] is equal to *state*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hasat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="n">hasat</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="n">added</span> <span class="ow">and</span> <span class="n">hasat</span>

    <span class="k">def</span> <span class="nf">calc_added2</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether *cl* has attribute *attr* (tuple) and attr[3] is equal to *state*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(attr, state)</span>
        <span class="c1"># print(cl.neb_id)</span>
        <span class="c1"># sys.exit()</span>
        <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hasat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="n">hasat</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">added</span> <span class="ow">and</span> <span class="n">hasat</span>



    <span class="k">def</span> <span class="nf">make_dummy_calc_obj</span><span class="p">(</span><span class="n">calc_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if id not in calc saves dummy Calculation() to calc database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">calc_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">calc_id</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">calc_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">Calculation</span><span class="p">()</span> <span class="c1">#just empty calc to store state iformation</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">calc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span>
            <span class="k">return</span> <span class="n">cl</span>


    <span class="k">def</span> <span class="nf">cat_name_mod</span><span class="p">(</span><span class="n">init_name</span><span class="p">):</span>
        <span class="c1">#&#39;cathode_name&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;replace&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">init_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">del_ion</span><span class="p">,</span> <span class="n">new_ion</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;make_ds&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">init_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">del_ion</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;normal&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">init_name</span>
        <span class="k">return</span> <span class="n">name</span>


    <span class="k">def</span> <span class="nf">replace_cations</span><span class="p">(</span><span class="n">ion_to_replace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">replace_by</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datalist</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Step P: Create cells with Na and K from Li cells and optimize them first for small cells&quot;&quot;&quot;</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="n">datalist</span>
        <span class="n">LiX</span>    <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curise</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">curver</span> <span class="o">=</span> <span class="n">ver</span>

        <span class="n">curit</span>  <span class="o">=</span> <span class="n">LiX</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ion_to_replace</span><span class="p">,</span> <span class="n">replace_by</span><span class="p">)</span>
        <span class="n">curfol</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ion_to_replace</span><span class="p">,</span> <span class="n">replace_by</span><span class="p">)</span>

        <span class="n">itP</span> <span class="o">=</span> <span class="n">curit</span><span class="o">+</span><span class="s1">&#39;.ir&#39;</span> <span class="c1">#inherit by replacement</span>

        <span class="k">if</span> <span class="n">ion_to_replace</span> <span class="ow">in</span> <span class="n">LiX</span> <span class="ow">and</span> <span class="n">ion_to_replace</span> <span class="o">!=</span> <span class="n">replace_by</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">itP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
                <span class="n">inherit_icalc</span><span class="p">(</span><span class="s1">&#39;replace_atoms&#39;</span><span class="p">,</span> <span class="n">itP</span><span class="p">,</span> <span class="n">curver</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">LiX</span><span class="p">,</span> <span class="n">curise</span><span class="p">,</span> <span class="n">curver</span><span class="p">),</span> <span class="n">calc</span><span class="p">,</span> <span class="n">atom_new</span> <span class="o">=</span> <span class="n">replace_by</span><span class="p">,</span> <span class="n">atom_to_replace</span> <span class="o">=</span> <span class="n">ion_to_replace</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">curfol</span><span class="p">,</span> <span class="n">use_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error!&#39;</span><span class="p">,</span> <span class="n">ion_to_replace</span><span class="p">,</span> <span class="s1">&#39;was not found in name&#39;</span><span class="p">,</span> <span class="n">LiX</span><span class="p">,</span> <span class="s1">&#39;; Use correct names&#39;</span><span class="p">)</span>
            <span class="n">itP</span> <span class="o">=</span> <span class="kc">None</span>    
        <span class="k">return</span>  <span class="n">itP</span>


    <span class="k">def</span> <span class="nf">remove_cations</span><span class="p">(</span><span class="n">ions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Step S: remove cations and create DS structures from IS</span>
<span class="sd">            ions (list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idA0</span> <span class="o">=</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ver</span><span class="p">)</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>


        <span class="k">if</span> <span class="s1">&#39;del_pos&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
            <span class="n">itS</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;del_pos&#39;</span><span class="p">])</span> <span class="c1">#inherit delete</span>
            <span class="n">del_pos</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;del_pos&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itS</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span>
            <span class="n">del_pos</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ions_present</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ion</span> <span class="ow">in</span> <span class="n">ions</span><span class="p">:</span> <span class="c1"># all ions should be in name</span>
            <span class="k">if</span> <span class="n">ion</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ions_present</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ions_present</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># print(ions_present)</span>

        <span class="k">if</span> <span class="n">ions_present</span><span class="p">:</span>
            <span class="c1"># print(update)</span>

            <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="n">itS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct_des</span><span class="p">:</span>
                <span class="c1"># print(update)</span>
                <span class="n">inherit_icalc</span><span class="p">(</span><span class="s1">&#39;remove_atoms&#39;</span><span class="p">,</span> <span class="n">itS</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">idA0</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> 
                    <span class="n">atoms_to_remove</span> <span class="o">=</span> <span class="n">ions</span><span class="p">,</span> <span class="n">del_pos</span> <span class="o">=</span> <span class="n">del_pos</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">use_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> 
        
            <span class="k">return</span> <span class="n">itS</span>



    <span class="k">def</span> <span class="nf">optimize_cell</span><span class="p">(</span><span class="n">id_base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">datalist</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale_region</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">irun</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and read results</span>
<span class="sd">        irun (str) - number of run </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="c1"># print(id_base)</span>
        <span class="c1"># sys.exit()</span>

        <span class="k">if</span> <span class="n">id_base</span> <span class="ow">and</span> <span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            
            <span class="k">if</span> <span class="s1">&#39;scaling_set&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
                <span class="n">ise_new</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scaling_set&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ise_new</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scaling_set&#39;</span><span class="o">+</span><span class="n">irun</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span> <span class="c1">#</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ise_new</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scaling_set.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span> <span class="c1">#</span>

            <span class="k">if</span> <span class="s1">&#39;save&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
                <span class="n">savefile</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

            <span class="k">if</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scale_region.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;optimize_cell(): scale_region changed from&#39;</span><span class="p">,</span> <span class="n">scale_region</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span>  <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scale_region.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">],</span> <span class="n">imp</span> <span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

                <span class="n">scale_region</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scale_region.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span>


            <span class="n">curfol</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span>

            <span class="n">id_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">id_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="n">id_res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Scale region is &#39;</span><span class="p">,</span> <span class="n">scale_region</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">id_base</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_add_loop</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="n">savefile</span><span class="p">,</span> <span class="n">calc_method</span> <span class="o">=</span> <span class="s1">&#39;uniform_scale&#39;</span><span class="p">,</span> <span class="n">scale_region</span> <span class="o">=</span> <span class="n">scale_region</span><span class="p">,</span> 
                <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;inherit_xred&#39;</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">curfol</span><span class="o">+</span><span class="s1">&#39;/scaled/&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">add_loop_dic</span><span class="p">)</span>                    
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(dic[&#39;scale_outcar.&#39;+mode_id], up_res)</span>
                <span class="c1"># print(up_res)</span>
                <span class="c1"># sys.exit()</span>
                <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">id_res</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">readfiles</span><span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scale_outcar.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">],</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_fit</span><span class="p">:</span>
                    <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">id_res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">readfiles</span><span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scale_outcar.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">],</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;fit_a&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fitfo&#39;</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># sys.exit()</span>
                <span class="k">if</span> <span class="s1">&#39;2&#39;</span>  <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_res</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="s1">&#39;5&#39;</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_res</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="s1">&#39;&#39;</span>
                    <span class="c1"># del calc[id_res]</span>

                <span class="k">elif</span> <span class="s1">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_res</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="c1"># print(np.real(calc[id_res].B))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">curres</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;B&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id_res</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">)})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;No Bulk modulus&#39;</span><span class="p">)</span>
                    
                        
                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">id_res</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span>

                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_res</span>

                    <span class="k">if</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="n">irun</span><span class="p">:</span>
                        <span class="s1">&#39;&#39;</span>
                        <span class="k">if</span> <span class="n">add_to_database</span><span class="p">:</span>
                            <span class="n">add_to_database</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">id_res</span><span class="p">])</span>



                    <span class="k">return</span> <span class="n">id_res</span>




    <span class="k">def</span> <span class="nf">make_supercell</span><span class="p">(</span><span class="n">base_id</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Step A: Create supercells and calculate their total energy&quot;&quot;&quot;</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="n">dic</span>
        <span class="n">ise_new</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;ortho&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
            <span class="n">ortho</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ortho&#39;</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;ortho found in pd:&#39;</span><span class="p">,</span> <span class="n">ortho</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;ortho.&#39;</span><span class="o">+</span><span class="n">mode_id</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
            <span class="n">ortho</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ortho.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;ortho mode_id found in pd:&#39;</span><span class="p">,</span> <span class="n">ortho</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ortho</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Default ortho is used:&#39;</span><span class="p">,</span> <span class="n">ortho</span><span class="p">)</span>
        <span class="k">nonlocal</span> <span class="n">support_dict_key</span>
        
        <span class="n">support_dict_key</span> <span class="o">=</span> <span class="s1">&#39;support_&#39;</span><span class="o">+</span><span class="n">name_mod_supercell</span><span class="p">(</span><span class="n">ortho</span><span class="p">)</span>
        

        <span class="n">sc_unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_mod_supercell</span><span class="p">(</span><span class="n">ortho</span><span class="p">),</span> <span class="n">ise_new</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">support_dict_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
            <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#create supportive dictionary, which depends on ortho parameter</span>
        



        <span class="k">if</span> <span class="n">base_id</span><span class="p">:</span>
            <span class="c1"># print(base_id)</span>
            <span class="n">clA0</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">base_id</span><span class="p">]</span>

            <span class="n">mul_matrix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ngkpt</span>      <span class="o">=</span> <span class="kc">None</span>




            <span class="c1"># print(clA0.inh_id, sc_unique_id)</span>
            <span class="c1"># sys.exit()</span>
            <span class="c1"># if update or not calc_added(clA0, &#39;inh_id&#39;, 1):</span>
            <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">calc_added2</span><span class="p">(</span><span class="n">clA0</span><span class="p">,</span> <span class="s1">&#39;inh_id&#39;</span><span class="p">,</span> <span class="n">sc_unique_id</span><span class="p">):</span>
                

                <span class="k">if</span> <span class="s1">&#39;make_ds&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span> <span class="c1">#for DS structures use the same parameters as for IS structures</span>
                    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">printlog</span> <span class="p">(</span><span class="s1">&#39;Cell obtained by removing atoms&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                        <span class="n">printlog</span> <span class="p">(</span><span class="s1">&#39;I use mul_matrix and ngkpt from intercalated structure&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;mul_matrix&#39;</span><span class="p">]</span>
                            <span class="n">ngkpt_dict</span>      <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ngkpt_dict&#39;</span><span class="p">]</span>

                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! You are in IS-&gt;DS inheritance mode, please first make IS calculation to fill in supportive dictionary with mul_matrix and ngkpt&#39;</span><span class="p">)</span>
                        <span class="n">ks</span> <span class="o">=</span> <span class="n">varset</span><span class="p">[</span><span class="n">ise_new</span><span class="p">]</span><span class="o">.</span><span class="n">kspacing</span>
                        <span class="n">ngkpt</span> <span class="o">=</span> <span class="n">ngkpt_dict</span><span class="p">[</span><span class="n">ks</span><span class="p">]</span>
                        <span class="c1"># printlog (&#39;I use mul_matrix and ngkpt from intercalated structure&#39;, imp = &#39;y&#39;)</span>


                <span class="n">sfolder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">base_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span>
                <span class="c1"># print (sfolder)</span>
                <span class="c1"># sys.exit()</span>
                <span class="n">itA</span> <span class="o">=</span> <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">base_id</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_add_loop</span><span class="p">,</span> 
                <span class="n">it_folder</span> <span class="o">=</span> <span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/super/&#39;</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;supercell&#39;</span><span class="p">,</span> <span class="n">ortho</span> <span class="o">=</span> <span class="n">ortho</span><span class="p">,</span>
                <span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">mul_matrix</span><span class="p">,</span> <span class="n">ngkpt</span> <span class="o">=</span> <span class="n">ngkpt</span> <span class="p">,</span> <span class="o">**</span><span class="n">add_loop_dic</span><span class="p">)</span>
                
                <span class="c1"># print([itA, ise_new, base_id[2], support_dict_key, &#39;exist&#39;])</span>
                <span class="c1"># clA0.inh_id = [itA, ise_new, base_id[2], support_dict_key, &#39;exist&#39;]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">clA0</span><span class="p">,</span> <span class="s1">&#39;inh_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">clA0</span><span class="o">.</span><span class="n">inh_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span><span class="c1"># temporary for compat</span>
                    <span class="n">clA0</span><span class="o">.</span><span class="n">inh_id</span> <span class="o">=</span> <span class="p">{}</span> 

                <span class="n">clA0</span><span class="o">.</span><span class="n">inh_id</span><span class="p">[</span><span class="n">sc_unique_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">itA</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">base_id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># additional unique id and state, TODO: maybe move to add_neb </span>

                <span class="c1"># print(clA0.inh_id)</span>
                <span class="c1"># print(db[(&#39;Cu.su&#39;, &#39;1lo&#39;, 100)].inh_id)</span>
                <span class="c1"># header.db = db</span>
                <span class="k">if</span> <span class="s1">&#39;normal&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;mul_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">itA</span><span class="p">]</span><span class="o">.</span><span class="n">mul_matrix</span>               <span class="c1">#save for intercalated structure</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ngkpt_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">itA</span><span class="p">]</span><span class="o">.</span><span class="n">ngkpt_dict_for_kspacings</span> <span class="c1">#save for intercalated structure</span>



            <span class="k">else</span><span class="p">:</span>
                <span class="n">idA</span> <span class="o">=</span> <span class="n">clA0</span><span class="o">.</span><span class="n">inh_id</span><span class="p">[</span><span class="n">sc_unique_id</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;gga&#39;</span><span class="p">:</span>
                    <span class="n">choose_outcar</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#gga+u with additional control </span>
                    <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;neb_outcar.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span>
                <span class="c1"># print(dic[&#39;neb_outcar.&#39;+mode_id])</span>
                <span class="c1"># print(&#39;suprecell: chosen outcar:&#39;, choose_outcar)</span>
                <span class="c1"># print(up_res)</span>
                <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idA</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># res_loop(*idA, choose_outcar = 3, show = &#39;fo&#39;)</span>
                <span class="c1"># res_loop(*idA, choose_outcar = 4, show = &#39;fo&#39;)</span>
                <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;id_sc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idA</span>
                <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">idA</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    


                    <span class="k">return</span> <span class="n">idA</span>


    <span class="k">def</span> <span class="nf">make_neb</span><span class="p">(</span><span class="n">base_id</span><span class="p">,</span> <span class="n">atom_to_insert</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Step C: make neb</span>
<span class="sd">        base_id - calc id - where to study migration</span>
<span class="sd">        cat - special list of parameters, at cat[7] contains dict with paramerters</span>
<span class="sd">            dict</span>
<span class="sd">                &#39;start_pos&#39; - i_void_start</span>
<span class="sd">                &#39;end_pos&#39; - i_void_final</span>
<span class="sd">                &#39;meps&#39; - list of tuples (&#39;start_pos&#39;, &#39;end_pos&#39;)</span>

<span class="sd">        TODO:</span>
<span class="sd">        1. Transform cat to pure dicts?</span>
<span class="sd">        2. Make names consistent, like &#39;start_pos&#39; and i_void_start is the same!</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="c1">#param_dic</span>

        <span class="c1"># print(atom_to_insert)</span>
        <span class="c1"># sys.exit()</span>


        <span class="k">if</span> <span class="s1">&#39;neb_set&#39;</span> <span class="ow">in</span> <span class="n">pd</span> <span class="ow">and</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;neb_set&#39;</span><span class="p">]:</span>
            <span class="n">ise_new</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;neb_set&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ise_new</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">base_id</span><span class="p">:</span>
            <span class="n">idB</span> <span class="o">=</span> <span class="n">base_id</span>
            <span class="n">clB</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">idB</span><span class="p">]</span>
            <span class="c1"># print(pd)</span>
            <span class="n">default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;start_pos&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;end_pos&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                    <span class="n">pd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Start:&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="s1">&#39;; End:&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">])</span>

            <span class="n">sup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">])</span> <span class="c1"># support key - should be unique for current path, used to transfer xr from IS to DS </span>

            <span class="c1"># if &#39;replace&#39; in mode:</span>
            <span class="c1">#     sup_key = (cat[0], pd[&#39;start_pos&#39;], pd[&#39;end_pos&#39;], pd[&#39;i_atom_to_move&#39;])</span>


            <span class="n">neb_unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">],</span> <span class="n">atom_to_insert</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;rep_moving_atom&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                <span class="c1"># sys.exit()</span>
                <span class="n">neb_unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">],</span> <span class="n">atom_to_insert</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;rep_moving_atom&#39;</span><span class="p">])</span>



            <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;neb_unique_id = &#39;</span><span class="p">,</span> <span class="n">neb_unique_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;images&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Number of images set to&#39;</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>

            <span class="n">ok</span> <span class="o">=</span> <span class="s1">&#39;occmatrix_id&#39;</span> <span class="c1"># general</span>

            <span class="k">if</span> <span class="n">ok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="s1">&#39;occmatrix_id.&#39;</span><span class="o">+</span><span class="n">mode_id</span>





            <span class="k">if</span> <span class="n">ok</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="n">ok</span><span class="p">]]</span>
                <span class="n">occfile</span> <span class="o">=</span> <span class="n">write_occmatrix</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">occ_matrices</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>

                <span class="n">add_loop_dic</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;occmatrix&#39;</span><span class="p">:</span><span class="n">occfile</span><span class="p">}</span>


                <span class="c1"># up_res = &#39;up1&#39;</span>

            <span class="c1"># sys.exit()</span>
            <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">calc_added2</span><span class="p">(</span><span class="n">clB</span><span class="p">,</span> <span class="s1">&#39;neb_id&#39;</span><span class="p">,</span> <span class="n">neb_unique_id</span><span class="p">):</span>

                <span class="n">other_param</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;r_impurity&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                    <span class="n">other_param</span><span class="p">[</span><span class="s1">&#39;r_impurity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;r_impurity&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;i_atom_to_move&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                    <span class="n">other_param</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;atom_to_move&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                    <span class="n">other_param</span><span class="p">[</span><span class="s1">&#39;atom_to_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;atom_to_move&#39;</span><span class="p">]</span>
                    <span class="c1"># print(other_param[&#39;atom_to_move&#39;])</span>
                <span class="k">if</span> <span class="s1">&#39;end_pos_types_z&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                    <span class="n">other_param</span><span class="p">[</span><span class="s1">&#39;end_pos_types_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos_types_z&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;rep_moving_atom&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
                    <span class="n">other_param</span><span class="p">[</span><span class="s1">&#39;rep_moving_atom&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;rep_moving_atom&#39;</span><span class="p">]</span>
                       


                <span class="c1"># print(&#39;sdfsaf&#39;)</span>

                <span class="k">if</span> <span class="s1">&#39;normal&#39;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">or</span> <span class="s1">&#39;replace&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                
                    <span class="k">if</span> <span class="s1">&#39;neb_search_voids&#39;</span> <span class="ow">in</span> <span class="n">pd</span> <span class="ow">and</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;neb_search_voids&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">search_type</span> <span class="o">=</span> <span class="s1">&#39;existing_voids&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">search_type</span> <span class="o">=</span> <span class="s1">&#39;vacancy_creation&#39;</span>

                    <span class="c1"># print(&#39;make_neb:&#39;, add_loop_dic)</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">add_neb</span><span class="p">(</span><span class="n">clB</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_add_loop</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">,</span> 
                        <span class="n">i_void_start</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="n">i_void_final</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">],</span> 
                        <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="n">atom_to_insert</span><span class="p">,</span>
                        <span class="n">search_type</span> <span class="o">=</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">,</span> <span class="n">old_behaviour</span> <span class="o">=</span> <span class="n">old_behaviour</span><span class="p">,</span> <span class="o">**</span><span class="n">other_param</span><span class="p">)</span>                
                
                <span class="k">elif</span> <span class="s1">&#39;make_ds&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>

                    <span class="c1"># printlog(&#39;made_ds mode&#39;)</span>
                    <span class="k">if</span> <span class="s1">&#39;neb_search_voids&#39;</span> <span class="ow">in</span> <span class="n">pd</span> <span class="ow">and</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;neb_search_voids&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">it</span> <span class="o">=</span> <span class="n">add_neb</span><span class="p">(</span><span class="n">clB</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_add_loop</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">,</span> 
                            <span class="n">i_void_start</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="n">i_void_final</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">],</span>
                            <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="n">atom_to_insert</span><span class="p">,</span> <span class="n">search_type</span> <span class="o">=</span> <span class="s1">&#39;existing_voids&#39;</span><span class="p">,</span> 
                            <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">,</span> <span class="n">old_behaviour</span> <span class="o">=</span> <span class="n">old_behaviour</span><span class="p">,</span> <span class="o">**</span><span class="n">other_param</span><span class="p">)</span>                          
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># use the same positions as was used in normal</span>
                        <span class="n">xr_start</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">sup_key</span><span class="p">,</span> <span class="s1">&#39;xr_m_ion_start&#39;</span><span class="p">]</span>
                        <span class="n">xr_final</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">sup_key</span><span class="p">,</span> <span class="s1">&#39;xr_m_ion_final&#39;</span><span class="p">]</span>
                        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Using start and final positions from&#39;</span><span class="p">,</span> <span class="n">support_dict_key</span><span class="p">,</span> <span class="n">sup_key</span><span class="p">,</span> <span class="n">xr_start</span><span class="p">,</span> <span class="n">xr_final</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                        <span class="c1"># sys.exit()</span>
                        <span class="n">it</span> <span class="o">=</span> <span class="n">add_neb</span><span class="p">(</span><span class="n">clB</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_add_loop</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">,</span>  
                            <span class="n">xr_start</span> <span class="o">=</span> <span class="n">xr_start</span><span class="p">,</span>
                            <span class="n">xr_final</span> <span class="o">=</span> <span class="n">xr_final</span><span class="p">,</span>
                            <span class="n">i_void_start</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">],</span> <span class="n">i_void_final</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">],</span> <span class="c1">#just for name</span>
                            <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="n">atom_to_insert</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">,</span>
                            <span class="n">old_behaviour</span> <span class="o">=</span> <span class="n">old_behaviour</span><span class="p">)</span>                

                <span class="n">id_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;map&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span> <span class="c1"># attempt to create map of calculations of graph of calculations, not working yet</span>
                    <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">mp</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mp</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span>
                <span class="c1"># print(mp)</span>
                <span class="c1"># sys.exit()</span>
                <span class="k">if</span> <span class="n">idB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
                    <span class="n">mp</span><span class="p">[</span><span class="n">idB</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">id_nold</span> <span class="o">=</span> <span class="n">clB</span><span class="o">.</span><span class="n">neb_id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">id_nold</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">[</span><span class="n">idB</span><span class="p">]:</span>
                        <span class="n">mp</span><span class="p">[</span><span class="n">idB</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_nold</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>


                <span class="k">if</span> <span class="n">id_n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">[</span><span class="n">idB</span><span class="p">]:</span>
                    <span class="n">mp</span><span class="p">[</span><span class="n">idB</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_n</span><span class="p">)</span>


                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">clB</span><span class="p">,</span> <span class="s1">&#39;neb_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">clB</span><span class="o">.</span><span class="n">neb_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span><span class="c1"># temporary for compat</span>
                    <span class="n">clB</span><span class="o">.</span><span class="n">neb_id</span> <span class="o">=</span> <span class="p">{}</span> 
                <span class="c1"># print(neb_unique_id)</span>
                <span class="n">clB</span><span class="o">.</span><span class="n">neb_id</span><span class="p">[</span><span class="n">neb_unique_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># additional unique id and state, TODO: maybe move to add_neb </span>
                <span class="c1"># print(clB.id, clB.neb_id)</span>

                <span class="k">if</span> <span class="s1">&#39;normal&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">sup_key</span><span class="p">,</span> <span class="s1">&#39;xr_m_ion_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">xr_m_ion_start</span> <span class="c1"># xred coordinate of migrating ion in starting position</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">support_dict_key</span><span class="p">][</span><span class="n">sup_key</span><span class="p">,</span> <span class="s1">&#39;xr_m_ion_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">xr_m_ion_final</span> <span class="c1"># xred coordinate of migrating ion in final    position</span>
                    <span class="c1"># print (struct_des[it].x_m_ion_start, struct_des[it].x_m_ion_final)</span>
                    <span class="c1"># sys.exit()</span>




            <span class="k">else</span><span class="p">:</span>
                <span class="n">idC</span> <span class="o">=</span>  <span class="n">clB</span><span class="o">.</span><span class="n">neb_id</span><span class="p">[</span><span class="n">neb_unique_id</span><span class="p">]</span>



                <span class="c1"># res_loop(*idC[0:2],[1,2], show = &#39;me&#39;, readfiles = 1, choose_outcar = 3)</span>
                <span class="c1"># res_loop(*idC[0:2],[4], up = &#39;up1&#39;,show = &#39;mag&#39;, readfiles = 1, choose_outcar = 3, analys_type = &#39;ne&#39;)</span>
                <span class="c1"># res_loop(*idC[0:2],[4], up = &#39;up1&#39;,show = &#39;mag&#39;, readfiles = 1, choose_outcar = None, analys_type = &#39;ne&#39;)</span>
                <span class="c1"># print (dic)</span>
                <span class="c1"># print (dic[&#39;neb_outcar.&#39;+mode_id])</span>
                <span class="k">if</span> <span class="n">choose_outcar_global</span><span class="p">:</span>
                    <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar_global</span>

                <span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;gga&#39;</span><span class="p">:</span>
                    <span class="n">choose_outcar</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#gga+u with additional control </span>
                    <span class="n">okey</span> <span class="o">=</span> <span class="s1">&#39;neb_outcar.&#39;</span><span class="o">+</span><span class="n">mode_id</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;choosing outcar from dic &#39;</span><span class="p">,</span> <span class="n">okey</span><span class="p">)</span>
                    <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">okey</span><span class="p">]</span>
                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;chosen outcar = &#39;</span><span class="p">,</span> <span class="n">choose_outcar</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">neb_fit</span><span class="p">:</span>
                    <span class="s1">&#39;&#39;</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;up key of res_loop = &#39;</span><span class="p">,</span> <span class="n">up_res</span><span class="p">)</span>
                    <span class="c1"># printlog(&#39;choose_outcar = &#39;, choose_outcar)</span>

                    <span class="c1"># sys.exit()</span>

                    <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="n">idC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ise_new</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">images</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fomep&#39;</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> 
                        <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span> 
                        <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;neb&#39;</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span> 
                        <span class="n">check_job</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">[</span><span class="s1">&#39;check_job&#39;</span><span class="p">],</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ise_new</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">,</span> <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">[</span><span class="s1">&#39;check_job&#39;</span><span class="p">])</span>



                <span class="c1"># print (res)</span>

                <span class="c1"># if &#39;5&#39; in calc[idC].state: #some error</span>
                <span class="c1">#     clB.neb_id[3] = None</span>
                
                <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">idC</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="c1"># try:</span>
                        <span class="c1"># curres[&#39;dAO_change&#39;] = res[&#39;dAO_change&#39;]</span>
                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;sts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sts&#39;</span><span class="p">]</span>
                    <span class="c1"># except:</span>
                    <span class="c1">#     pass</span>
                    

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">curres</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;barrier&#39;</span><span class="p">:</span><span class="n">calc</span><span class="p">[</span><span class="n">idC</span><span class="p">]</span><span class="o">.</span><span class="n">barrier</span><span class="p">})</span>
                    
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">curres</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;barrier&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
                    
                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;dEm1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dEm1&#39;</span><span class="p">]</span> <span class="c1">#difference of energies between middle and first image of NEB</span>

                    <span class="c1"># print(curres[&#39;barrier&#39;], curres[&#39;dEm1&#39;])</span>



                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;id_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">idC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;id_end&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">idC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>


                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;atom_pos&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;atom_pos&#39;</span><span class="p">]</span>
                    <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;mep_energies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;mep_energies&#39;</span><span class="p">]</span>

                    <span class="c1"># dn = calc[idC].end.natom - calc[idB].end.natom</span>
                    <span class="c1"># v_int1 = calc[idC[0], idC[1],1].energy_sigma0 - calc[idB].energy_sigma0 - dn * curres[&#39;Eref&#39;]</span>
                    <span class="c1"># v_int2 = calc[idC[0], idC[1],2].energy_sigma0 - calc[idB].energy_sigma0 - dn * curres[&#39;Eref&#39;]</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Calculating atom-wise intercalation potentials&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">v_int1</span> <span class="o">=</span> <span class="n">calc_redox</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">idC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">idB</span><span class="p">])[</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">]</span>
                    <span class="n">v_int2</span> <span class="o">=</span> <span class="n">calc_redox</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">idC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span> <span class="n">calc</span><span class="p">[</span><span class="n">idB</span><span class="p">])[</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">]</span>

                    
                    <span class="c1"># print(&#39;Redox pot:&#39;, dn, v_int1, v_int2, curres[&#39;Eref&#39;])</span>


                    <span class="n">curres</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;V2&#39;</span><span class="p">:</span><span class="n">v_int1</span><span class="p">})</span> <span class="c1"># the batterry is fully discharged</span>
                    <span class="k">return</span>




    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># prepare parameters</span>
        <span class="n">main_set</span>    <span class="o">=</span> <span class="s1">&#39;1urs&#39;</span>   
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># result list, for each structure we have dict</span>
        <span class="n">scale_regions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">neb_fit</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># if to make neb fitting; the barries is saved to cl1.barrier</span>
        <span class="n">run_scale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">add_to_database</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">curver</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">local_state</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">support_dict_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="n">param_dic</span>





        <span class="k">if</span> <span class="s1">&#39;check_job&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">add_loop_dic</span><span class="p">:</span>
            <span class="n">add_loop_dic</span><span class="p">[</span><span class="s1">&#39;check_job&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


        <span class="c1"># print(pd)</span>
        <span class="k">if</span> <span class="s1">&#39;scaling_set&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
            <span class="n">scaling_set</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;scaling_set&#39;</span><span class="p">]</span>
            <span class="c1"># print(scaling_set)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaling_set</span> <span class="o">=</span> <span class="s1">&#39;4uis&#39;</span>
        <span class="c1"># print(scaling_set)</span>
        <span class="c1"># sys.exit()</span>

        <span class="n">mode_id</span> <span class="o">=</span> <span class="n">mode</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">del_ion</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_ion</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;neb_outcar.&#39;</span> <span class="o">+</span> <span class="n">mode_id</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="c1">#by default the last one is used</span>
        <span class="s1">&#39;scale_outcar.&#39;</span> <span class="o">+</span> <span class="n">mode_id</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="c1">#by default the last one is used</span>
        <span class="s1">&#39;scaling_set.&#39;</span><span class="o">+</span> <span class="n">mode_id</span><span class="p">:</span><span class="n">scaling_set</span><span class="p">,</span> <span class="c1">#</span>
        <span class="s1">&#39;skip.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;scale_region.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span><span class="c1"># additional specific control  </span>
        <span class="c1"># &#39;neb_outcar&#39; - (int) - choose_outcar in res_loop of make_neb</span>

        <span class="k">if</span> <span class="s1">&#39;scale_region&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scale_region.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;scale_region&#39;</span><span class="p">]</span>

        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;optimal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;Rb&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;Li_removal&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;Na_removal&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;K_removal&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;Rb_removal&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">scale_regions</span><span class="p">[</span><span class="n">new_ion</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="c1"># print(new_ion)</span>
        <span class="c1"># sys.exit()</span>

        
        <span class="k">if</span> <span class="n">up</span><span class="p">:</span>
            <span class="n">update</span>  <span class="o">=</span> <span class="n">up</span> <span class="c1"># initial update for removing and replacing atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update</span>  <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">upA</span><span class="p">:</span>
            <span class="n">updateA</span> <span class="o">=</span> <span class="n">upA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updateA</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># make supecell </span>
        
        <span class="k">if</span> <span class="n">upB</span><span class="p">:</span>
            <span class="n">updateB</span> <span class="o">=</span> <span class="n">upB</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">updateB</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># volume optimization, su</span>
        
        <span class="k">if</span> <span class="n">upC</span><span class="p">:</span>
            <span class="n">updateC</span> <span class="o">=</span> <span class="n">upC</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updateC</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># NEB</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">up_res</span><span class="p">:</span>
            <span class="n">up_res</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span> <span class="c1"># update files</span>

        <span class="k">if</span> <span class="s1">&#39;readfiles&#39;</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
            <span class="n">readfiles</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;readfiles&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_fit</span><span class="p">:</span>
            <span class="n">show_fit</span>  <span class="o">=</span> <span class="mi">0</span> <span class="c1">#control if to show fitting of supercell sizes</span>
        

    <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;8u&#39;</span> <span class="c1"># old</span>
    <span class="k">if</span> <span class="n">pd</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">:</span>
            <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">cathodes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;itfolder&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;main_set&#39;</span><span class="p">],</span> <span class="n">md</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">pd</span><span class="p">)</span> <span class="p">],</span> <span class="p">]</span>
        <span class="n">curver</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nise</span><span class="p">:</span>
            <span class="n">neb_set</span> <span class="o">=</span> <span class="n">nise</span> <span class="c1">#&#39;1uos&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">neb_set</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">cathodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cathodes</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
        <span class="c1"># cathodes == None:</span>

            <span class="n">cathodes</span> <span class="o">=</span> <span class="p">[</span>  <span class="c1">#cat[3] and cat[5] eventually was not used                                  </span>
               <span class="c1"># [&#39;LiCoO2&#39;, ise, &#39;CoO2&#39;, ise, &#39;LiCoO2&#39;       ,&#39;&#39;, main_set, merge_dics(dic,{&#39;scaling_set.make_ds.Li.Li&#39;:&#39;4uris&#39;,   }  ) ], old</span>
               <span class="c1"># [&#39;LiCoO2&#39;, ise, &#39;CoO2&#39;, ise, &#39;LiCoO2&#39;       ,&#39;&#39;, &#39;1u&#39;, merge_dics(dic,{&#39;scaling_set.normal.Li.Li&#39;:&#39;1u&#39;,   }  ) ],</span>
               <span class="c1"># [&#39;LiCoO2&#39;, ise, &#39;CoO2&#39;, ise, &#39;LiCoO2&#39;       ,&#39;&#39;, &#39;1uafm&#39;, merge_dics(dic,{ })  ], </span>
               <span class="c1"># [&#39;LiTiO2&#39;, ise, &#39;TiO2&#39;, ise, &#39;LiTiO2&#39;,         &#39;&#39;,  main_set, merge_dics(dic,{&#39;scaling_set.normal.Li.Li&#39;:&#39;4uisns&#39;, &#39;scaling_set.replace.Li.Na&#39;:&#39;4uisns&#39;, &#39;scaling_set2.make_ds.Li.Li&#39;:&#39;4uisns&#39;}) ], # only for IS Li Na</span>
               <span class="c1"># [&#39;LiNiO2&#39;, ise, &#39;NiO2&#39;, ise, &#39;LiNiO2&#39;       ,&#39;&#39;, main_set, merge_dics(dic,{&#39;scale_outcar.make_ds.Li.Li&#39;:None, &#39;neb_outcar.replace.Li.Na&#39;:3,&#39;neb_outcar.replace.Li.K&#39;:3, &#39;scaling_set.normal.Li.Li&#39;:&#39;4uisns&#39;, &#39;scaling_set2.make_ds.Li.Li&#39;:&#39;4uris&#39;, &#39;scaling_set1.make_ds.Li.Li&#39;:&#39;4uisC0W1&#39;, &#39;save&#39;:&#39;oc&#39;}) ] , # for Li use larger symprec, or isym = 0</span>
               <span class="c1"># [&#39;LiTiS2&#39;, ise, &#39;TiS2&#39;, ise, &#39;LiTiS2&#39;       ,&#39;&#39;, main_set, md(dic, {&#39;neb_outcar.make_ds.Li.Li&#39;:None}) ] ,</span>
               <span class="c1"># [&#39;LiMn2O4&#39;,   &#39;&#39;, &#39;Mn2O4&#39;,   &#39;&#39;, &#39;LiMn2O4&#39; , &#39;&#39;, main_set, md(dic, {&#39;neb_outcar.normal.Li.Li&#39;:3} )  ] ,</span>
               <span class="c1"># [&#39;LiVP2O7&#39;, ise, &#39;VP2O7&#39;, ise, &#39;LiVP2O7&#39;    ,&#39;&#39;, main_set, md(dic, {&#39;neb_outcar.normal.Li.Li&#39;:None, &#39;scale_region.replace.Li.K&#39;:(0,8) } )   ] ,</span>

               <span class="c1"># [&#39;Li2CoPO4F.pnma&#39;,   &#39;1u&#39;, &#39;CoPO4F&#39;,   &#39;&#39;, &#39;Li2CoPO4F/pnma&#39; , &#39;&#39;, main_set, md(dic, {} )  ],</span>
               <span class="c1"># [&#39;NaMnAsO4&#39;,  ise, &#39;MnAsO4&#39;, ise, &#39;NaMnAsO4&#39; ,&#39;&#39;, main_set, md(dic, {&#39;neb_outcar.normal.Li.Li&#39;:None} ) ] ,</span>
               <span class="c1"># [&#39;Na2FeVF7&#39;,   &#39;&#39;, &#39;FeVF7&#39;, &#39;&#39;, &#39;Na2FeVF7&#39; , &#39;&#39;, main_set, dic ] ,</span>
               <span class="c1"># [&#39;KFeSO4F&#39;,   &#39;&#39;, &#39;FeSO4F&#39;,  &#39;&#39;, &#39;KFeSO4F&#39; , &#39;&#39;, &#39;1urS&#39;, md(dic,{&#39;scaling_set.normal.Li.Li&#39;:&#39;4uSi&#39;, &#39;scale_outcar.normal.Li.Li&#39;:1, &#39;scaling_set.make_ds.K.K&#39;:&#39;4uSi&#39;  }) ] ,</span>
               <span class="c1"># [&#39;NaLiCoPO4F&#39; ,&#39;&#39;, &#39;CoPO4F&#39;,&#39;&#39;,&#39;NaLiCoPO4F&#39; , &#39;&#39;, main_set, md(dic,{&#39;scaling_set.make_ds.Li Na.Li&#39;:&#39;4uris&#39;,   })  ] ,</span>

               <span class="c1"># [&#39;LiNiO2.r3m&#39;,   &#39;1u&#39;, &#39;NiO2.r3m&#39;,  &#39;&#39;, &#39;LiNiO2/r3m&#39; , &#39;&#39;, &#39;1urAl&#39;, md(dic,{&#39;neb_outcar.normal.Li.Li&#39;:1, &#39;scaling_set.normal.Li.Li&#39;:&#39;4uisC0W1&#39;, &#39;scaling_set.make_ds.Li.Li&#39;:&#39;4uiAl&#39;,    }) ] , # for IS main_set is &#39;1urns&#39;</span>


               <span class="c1"># for paper exchange, from 06.09.2017 moved to file paper7</span>
               <span class="c1"># [&#39;LiMn2O4.Fd3m.111&#39;,   &#39;1u&#39;, &#39;Mn2O4.Fd3m.111&#39;, &#39;&#39;, &#39;LiMn2O4/Fd3m&#39; , &#39;&#39;, main_set, md(dic,{&#39;neb_set&#39;:neb_set, &#39;old.normal.Li.Li&#39;:1, &#39;neb_outcar.normal.Li.Li&#39;:None,&#39;neb_outcar.replace.Li.Na&#39;:3, &#39;occmatrix_id.replace.Li.Na&#39;:&#39;NaMn2O4.Fd3m.111.ir.su.s10v100.n3Na1v1ms.1urs.4&#39;}) ] ,</span>
               <span class="c1"># [&#39;LiFePO4&#39;, ise, &#39;FePO4&#39;, ise, &#39;LiFePO4&#39;    ,&#39;&#39;, main_set, md(dic,{&#39;neb_set&#39;:neb_set, &#39;neb_outcar.normal.Li.Li&#39;:3, &#39;neb_outcar.replace.Li.K&#39;:3, &#39;old.normal.Li.Li&#39;:1,&#39;old.make_ds.Li.Li&#39;:0,  &#39;occmatrix_id.normal.Li.Li&#39;:&#39;LiFePO4.s10.suv100.n3Li1v1ms.1urs.3&#39;, &#39;occmatrix_id.make_ds.Li.Li&#39;:&#39;FePO4.id.su.s10v100.n3Li1v1ms.1urs.4&#39; }) ] ,</span>
               <span class="c1"># [&#39;LiMnPO4&#39;, ise, &#39;MnPO4&#39;, ise, &#39;LiMnPO4&#39;    ,&#39;&#39;, main_set, md(dic, {&#39;neb_outcar.make_ds.Li.Li&#39;:None, &#39;old.normal.Li.Li&#39;:1, &#39;old.make_ds.Li.Li&#39;:1})  ] ,</span>
               <span class="c1"># [&#39;LiVPO4F&#39;, ise, &#39;VPO4F&#39;, ise, &#39;LiVPO4F&#39;    ,&#39;&#39;,  main_set, md(dic,{&#39;ortho.replace.Li.Na&#39;:[10,10,13],&#39;ortho.replace.Li.K&#39;:[10,10,13], &#39;old.normal.Li.Li&#39;:1, &#39;scale_outcar.replace.Li.Na&#39;:None,  &#39;neb_outcar.normal.Li.Li&#39;:None, &#39;neb_outcar.make_ds.Li.Li&#39;:None,&#39;scaling_set.normal.Li.Li&#39;:&#39;4uris&#39;, &#39;scaling_set.replace.Li.K&#39;:&#39;4uisC0W1&#39;, &#39;scaling_set.replace.Li.Na&#39;:&#39;4uris&#39;, &#39;scale_region.replace.Li.K&#39;:(-1,7),   &#39;skip.replace.Li.K&#39;:0, &#39;skip.replace.Li.Na&#39;:0}) ]  ,# only for IS</span>
               <span class="c1"># [&#39;KVPO4F.Pna21&#39;,   &#39;1u&#39;, &#39;VPO4F.Pna21&#39;, &#39;&#39;, &#39;KVPO4F/Pna21&#39;,  &#39;&#39;, &#39;1urs&#39;, md(dic,{&#39;neb_outcar.normal.Li.Li&#39;:None, &#39;old.normal.K.K&#39;:1, &#39;old.normal..&#39;:1, &#39;images&#39;:3}) ],</span>
               <span class="c1"># [&#39;Li2FePO4F.pnma&#39;,   &#39;1u&#39;, &#39;LiFePO4F.pnma&#39;,   &#39;&#39;, &#39;Li2FePO4F/pnma&#39; , &#39;&#39;, &#39;1u&#39;, md(dic, {&#39;ortho.replace.Li.Na&#39;:[13,13,13],&#39;ortho.replace.Li.K&#39;:[13,13,13],&#39;meps&#39;:[(1,1), (2,1), (1,3), (2,3), (3,2), (3,3)], &#39;del_pos&#39;:1} )  ], #(1,1), </span>
               <span class="c1"># [&#39;Li2FePO4F.pnma&#39;,   &#39;1u&#39;, &#39;LiFePO4F.pnma&#39;,   &#39;&#39;, &#39;Li2FePO4F/pnma&#39; , &#39;&#39;, &#39;1u&#39;, md(dic, {&#39;neb_set&#39;:&#39;1urs&#39;, &#39;ortho.replace.Li.Na&#39;:[13,13,13],&#39;ortho.replace.Li.K&#39;:[13,13,13],&#39;meps&#39;:[(3,2), (3,5)], &#39;del_pos&#39;:1} )  ], #(1,1), </span>
               <span class="c1"># [&#39;Na2FePO4F&#39;, &#39;&#39;, &#39;NaFePO4F&#39;, &#39;&#39;, &#39;Na2FePO4F&#39; , &#39;&#39;, &#39;1u&#39;, md(dic, {&#39;neb_set&#39;:nise, &#39;meps&#39;:[(1,1), (1,2), (1,3), (2,1), (2,2), (2,3)], &#39;scaling_set&#39;:&#39;4uis&#39;, &#39;del_pos&#39;:2})  ] , #neb_set: 1urs, 1u</span>
               <span class="c1"># [&#39;Na2FePO4F&#39;, &#39;&#39;, &#39;NaFePO4F&#39;, &#39;&#39;, &#39;Na2FePO4F&#39; , &#39;&#39;, &#39;1u&#39;, md(dic, {&#39;neb_set&#39;:nise, &#39;meps&#39;:[(2,2),  ], &#39;scaling_set&#39;:&#39;4uis&#39;, &#39;del_pos&#39;:2})  ] , #neb_set: 1urs, 1u, DS</span>

               <span class="c1"># for checks</span>
               <span class="c1"># [&#39;Li2FePO4F.pnma&#39;,   &#39;1u&#39;, &#39;LiFePO4F.pnma&#39;,   &#39;&#39;, &#39;Li2FePO4F/pnma&#39; , &#39;&#39;, &#39;1u&#39;, md(dic, {&#39;ortho.replace.Li.Na&#39;:[13,13,13],&#39;ortho.replace.Li.K&#39;:[13,13,13],&#39;meps&#39;:[(1,3)], &#39;del_pos&#39;:1} )  ], #(1,1), </span>




               <span class="c1"># other try</span>
               <span class="c1"># [&#39;LiFePO4&#39;, ise, &#39;FePO4&#39;, ise, &#39;LiFePO4&#39;    ,&#39;&#39;, &#39;1urs10&#39;, merge_dics(dic,{&#39;neb_outcar.normal.Li.Li&#39;:None, &#39;neb_outcar.replace.Li.K&#39;:4}) ] ,</span>
               <span class="c1"># [&#39;LiFePO4&#39;, ise, &#39;FePO4&#39;, ise, &#39;LiFePO4&#39;    ,&#39;&#39;, &#39;1m&#39;, merge_dics(dic,{&#39;scaling_set.normal.Li.Li&#39;:&#39;4mi&#39;}) ] ,</span>
               <span class="c1"># [&#39;NaFePO4&#39;, ise, &#39;FePO4&#39;, ise, &#39;NaFePO4&#39;    ,scaling_set, main_set ] , # maricite structure, barrier is high</span>

               <span class="c1"># [&#39;LiNiO2.r3m&#39;,   &#39;1u&#39;, &#39;NiO2.r3m&#39;,  &#39;&#39;, &#39;LiNiO2/r3m&#39; , &#39;&#39;, &#39;1urns&#39;, md(dic,{&#39;neb_outcar.normal.Li.Li&#39;:3, &#39;scaling_set.normal.Li.Li&#39;:&#39;4uisC0W1&#39;, &#39;scaling_set.make_ds.Li.Li&#39;:&#39;4uiAl&#39;,    }) ] , # for IS main_set is &#39;1urns&#39;</span>
               <span class="c1"># [&#39;LiMn2O4.Fd3m&#39;,   &#39;1u&#39;, &#39;Mn2O4.Fd3m&#39;, &#39;&#39;, &#39;LiMn2O4/Fd3m&#39; , &#39;&#39;, &#39;1ur10&#39;, md(dic,{&#39;neb_outcar.normal.Li.Li&#39;:None, &#39;scaling_set.&#39;+mode_id:&#39;1ur10&#39;,}) ] ,</span>
               <span class="c1"># [&#39;LiMn2O4.Fd3m&#39;,   &#39;1u&#39;, &#39;Mn2O4.Fd3m&#39;, &#39;&#39;, &#39;LiMn2O4/Fd3m&#39; , &#39;&#39;, &#39;1ur10&#39;, md(dic,{&#39;neb_outcar.normal.Li.Li&#39;:None, &#39;scaling_set.&#39;+mode_id:&#39;4uis&#39;,}) ] ,</span>
               <span class="c1"># [&#39;LiVPO4F&#39;, ise, &#39;VPO4F&#39;, ise, &#39;LiVPO4F&#39;    ,&#39;&#39;,  main_set, md(dic,{&#39;neb_outcar.normal.Li.Li&#39;:None, &#39;scaling_set.normal.Li.Li&#39;:&#39;4uris&#39;, &#39;scaling_set.replace.Li.K&#39;:&#39;4uris&#39;,  &#39;scale_region.replace.Li.K&#39;:(-5,3),   &#39;skip.replace.Li.K&#39;:0, &#39;skip.replace.Li.Na&#39;:1}) ]  ,# old</span>
         
         <span class="p">]</span>


    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cathodes</span><span class="p">:</span>
        <span class="n">curres</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#current result dict</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="c1"># dictionary with parameters</span>



        <span class="n">name</span> <span class="o">=</span> <span class="n">cat_name_mod</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;DS&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;proto&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;X&#39;</span><span class="o">+</span><span class="n">cat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]:</span>
            <span class="c1"># print(&#39;no&#39;)</span>
            <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ion</span>

        <span class="k">if</span> <span class="s1">&#39;make_ds&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0%&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;100%&#39;</span>


        <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">curres</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>


        <span class="k">if</span> <span class="s1">&#39;old.&#39;</span><span class="o">+</span><span class="n">mode_id</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span> 
            <span class="n">old_behaviour</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;old.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;old_behaviour&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
            <span class="n">old_behaviour</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;old_behaviour&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_behaviour</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># print (&#39;old_behaviour&#39;, old_behaviour)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;skip.&#39;</span><span class="o">+</span> <span class="n">mode_id</span><span class="p">]:</span>
            <span class="c1"># continue</span>

            <span class="k">if</span>   <span class="s1">&#39;replace&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                
                <span class="n">itP0</span> <span class="o">=</span> <span class="n">replace_cations</span><span class="p">(</span><span class="n">del_ion</span><span class="p">,</span> <span class="n">new_ion</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">curver</span><span class="p">)</span>  
                
                <span class="n">idA0</span> <span class="o">=</span> <span class="n">optimize_cell</span><span class="p">(</span> <span class="p">(</span><span class="n">itP0</span><span class="p">,</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scaling_set.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">],</span> <span class="n">curver</span><span class="p">),</span> <span class="n">cat</span><span class="p">,</span> <span class="n">scale_regions</span><span class="p">[</span><span class="n">new_ion</span><span class="p">],</span> <span class="n">update</span><span class="p">,</span> <span class="n">irun</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;make_ds&#39;</span>  <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                
                <span class="n">itP0</span> <span class="o">=</span> <span class="n">remove_cations</span><span class="p">(</span><span class="n">del_ion</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">cat</span><span class="p">,</span> <span class="n">curver</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>

                <span class="n">idA0</span> <span class="o">=</span> <span class="n">optimize_cell</span><span class="p">(</span> <span class="p">(</span><span class="n">itP0</span><span class="p">,</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;scaling_set.&#39;</span><span class="o">+</span><span class="n">mode_id</span><span class="p">],</span> <span class="n">curver</span><span class="p">),</span> <span class="n">cat</span><span class="p">,</span> <span class="n">scale_regions</span><span class="p">[</span><span class="n">del_ion</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_removal&#39;</span><span class="p">],</span> <span class="n">update</span><span class="p">,</span> <span class="n">irun</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;normal&#39;</span>  <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span> <span class="c1">#nothing done, use structures from provided list</span>
                
                <span class="k">if</span> <span class="n">old_behaviour</span><span class="p">:</span>
                    <span class="n">idA0</span> <span class="o">=</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">curver</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#9.04.2017# idA0 = optimize_cell( (cat[0], cat[7][&#39;scaling_set.&#39;+mode_id], curver), cat, scale_regions[&#39;optimal&#39;], update, irun = &#39;1&#39;)</span>
                    <span class="n">idA0</span> <span class="o">=</span> <span class="n">optimize_cell</span><span class="p">(</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">curver</span><span class="p">),</span> <span class="n">cat</span><span class="p">,</span> <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;optimal&#39;</span><span class="p">],</span> <span class="n">update</span><span class="p">,</span> <span class="n">irun</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>



            <span class="k">if</span> <span class="n">run_sc</span> <span class="ow">and</span> <span class="n">idA0</span><span class="p">:</span><span class="c1"># and name != &#39;NiO2&#39;:</span>
                
                <span class="n">make_dummy_calc_obj</span><span class="p">(</span><span class="n">idA0</span><span class="p">)</span>


                <span class="n">idA</span> <span class="o">=</span> <span class="n">make_supercell</span><span class="p">(</span><span class="n">idA0</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">updateA</span><span class="p">)</span>
                
                <span class="c1"># continue</span>
                <span class="k">if</span> <span class="n">run_scale</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">old_behaviour</span><span class="p">:</span>
                        <span class="n">idB</span> <span class="o">=</span> <span class="n">optimize_cell</span><span class="p">(</span><span class="n">idA</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">scale_regions</span><span class="p">[</span><span class="s1">&#39;optimal&#39;</span><span class="p">],</span> <span class="n">updateB</span><span class="p">,</span> <span class="n">irun</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">idB</span> <span class="o">=</span> <span class="n">idA</span>


                    <span class="k">if</span> <span class="n">run_neb</span> <span class="ow">and</span> <span class="n">idB</span><span class="p">:</span>


                        <span class="k">if</span> <span class="s1">&#39;meps&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span> <span class="c1"># start_pos, end_pos</span>
                            <span class="k">for</span> <span class="n">mep</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;meps&#39;</span><span class="p">]:</span>
                                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;MEP &#39;</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">mep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">make_neb</span><span class="p">(</span><span class="n">idB</span><span class="p">,</span> <span class="n">new_ion</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">updateC</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;meps2&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span> <span class="c1"># (i_atom_to_move, end_pos)</span>
                            <span class="k">for</span> <span class="n">mep</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;meps2&#39;</span><span class="p">]:</span>

                                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">mep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">make_neb</span><span class="p">(</span><span class="n">idB</span><span class="p">,</span> <span class="n">new_ion</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">updateC</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">make_neb</span><span class="p">(</span><span class="n">idB</span><span class="p">,</span> <span class="n">new_ion</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">updateC</span><span class="p">)</span>


        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curres</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">results</span></div>







<div class="viewcode-block" id="calc_antisite_defects"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.calc_antisite_defects">[docs]</a><span class="k">def</span> <span class="nf">calc_antisite_defects</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">image_format</span> <span class="o">=</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    <span class="n">readfiles</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># update = 0</span>
    <span class="n">main_set</span> <span class="o">=</span> <span class="s1">&#39;1urs&#39;</span>
    <span class="c1"># ise_new = &#39;1ur30&#39;</span>
    <span class="n">gga</span> <span class="o">=</span> <span class="s1">&#39;gga&#39;</span>

    <span class="k">if</span> <span class="n">gga</span> <span class="o">==</span> <span class="s1">&#39;gga+u&#39;</span><span class="p">:</span>
        <span class="n">choose_outcar</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">gga</span> <span class="o">==</span> <span class="s1">&#39;gga&#39;</span><span class="p">:</span>
        <span class="n">choose_outcar</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="n">cathodes</span> <span class="o">=</span> <span class="p">[</span>


    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1ur30&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaFePO4.ir.su.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;skol&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiMnPO4.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;skol&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiVPO4F.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;skol&#39;,&#39;main_set&#39;:&#39;1ur30&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiVP2O7.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;skol&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaMnAsO4.s10.su&#39;,&#39;4uis&#39;, 100)  , &#39;cluster&#39;:&#39;cee&#39;    },</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiTiS2.s10.su&#39;,&#39;4uis&#39;, 100)    , &#39;cluster&#39;:&#39;cee&#39;    },</span>



    <span class="c1"># {&#39;id&#39;:(&#39;Li2FePO4F.ir.su.s10.su&#39;,&#39;4uis&#39;,100), &#39;main_set&#39;:&#39;1u&#39;, &#39;cluster&#39;:&#39;cee&#39;},  #14 meV!!!</span>
    <span class="c1"># {&#39;id&#39;:(&#39;Li2FePO4F.ir.su.s10.su&#39;,&#39;4uis&#39;,100), &#39;main_set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;}, #50 meV!!</span>

    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1urZhang&#39;},</span>
    
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4mi&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1m&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4mi&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1msv&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4mi&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1mk15&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4mi&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1uAlf&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4.s10.su&#39;,&#39;4mi&#39;,100), &#39;cluster&#39;:&#39;cee&#39;, &#39;main_set&#39;:&#39;1mAlf&#39;},</span>


    <span class="c1"># {&#39;id&#39;:(&#39;KVPO4F.Pna21.s10.su&#39;, &#39;4uis&#39;, 100) , &#39;cluster&#39;:&#39;cee&#39;}, # energy is too high</span>

    <span class="c1"># {&#39;id&#39;:(&#39;Na2FePO4F.s10.su&#39;,&#39;4uis&#39;, 100) , &#39;cluster&#39;:&#39;cee&#39;    }, #also incorrect groundstate</span>
    <span class="c1"># {&#39;id&#39;:(&#39;Li2FePO4F.ir.su.s10.su&#39;,&#39;4uis&#39;,100), &#39;main_set&#39;:&#39;1ur30&#39;, &#39;cluster&#39;:&#39;skol&#39;},  #incorrect groundstate</span>
    <span class="c1"># {&#39;id&#39;:(&#39;KFeSO4F.s10.su&#39;,&#39;4uSi&#39;, 100), &#39;main_set&#39;:&#39;1urS&#39;, &#39;cluster&#39;:&#39;cee&#39;}, #too much forces</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiMn2O4.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;cee&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiCoO2.s10.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;cee&#39;},</span>
    <span class="c1"># {&#39;id&#39;:(&#39;Li2FePO4F.ir.su&#39;,&#39;4uis&#39;,100), &#39;cluster&#39;:&#39;cee&#39;},</span>

    <span class="c1">#pbcn</span>
    <span class="c1"># {&#39;id&#39;:(&#39;Na2FePO4F.s10.su&#39;,&#39;4uis&#39;, 100) , &#39;main_set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;Na2FePO4F.s10.su&#39;,&#39;4uis&#39;, 100) , &#39;main_set&#39;:&#39;1mAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaFePO4F.id2.su.s10.su&#39;,&#39;4uis&#39;,100) , &#39;main_set&#39;:&#39;1mAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaFePO4F.id2.su.s10.su&#39;,&#39;4uis&#39;,100) , &#39;main_set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>

    <span class="c1">#pbcn</span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaFePO4F.id2.su.s10.su&#39;,&#39;4uis&#39;,100),&#39;st_from&#39;:calc[&#39;NaFePO4F.id1.su.s10.su&#39;,&#39;4uis&#39;,100].init, &#39;cation&#39;:&#39;Na&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1mAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaFePO4F.id2.su.s10.su&#39;,&#39;4uis&#39;,100),&#39;st_from&#39;:calc[&#39;NaFePO4F.id1.su.s10.su&#39;,&#39;4uis&#39;,100].init, &#39;cation&#39;:&#39;Na&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;NaFePO4F.id2.su.s10.su&#39;,&#39;4uis&#39;,100),&#39;st_from&#39;:calc[&#39;NaFePO4F.id1.su.s10.su&#39;,&#39;4uis&#39;,100].init, &#39;cation&#39;:&#39;Na&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1urs&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>

    <span class="c1"># {&#39;id&#39;:(&#39;LiCoPO4F.pbcn.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiCoPO4F.pbcn.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Co&#39;, &#39;main_set&#39;:&#39;1urs&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1urs&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1m&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1mAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1urs&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>




    <span class="c1">#pnma Co!</span>

    <span class="c1"># {&#39;id&#39;:(&#39;LiCoPO4F.pnma.id2.su.s10&#39;,&#39;1urs&#39;,100),&#39;st_from&#39;:calc[&#39;LiCoPO4F.pnma.id1.su.s10&#39;,&#39;1urs&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Co&#39;, &#39;main_set&#39;:&#39;1urs&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.pnma.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.pnma.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1urs&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
    
    <span class="c1"># {&#39;id&#39;:(&#39;LiFePO4F.pnma.id2.su.s10&#39;,&#39;1u&#39;,100),&#39;st_from&#39;:calc[&#39;LiFePO4F.pnma.id1.su.s10&#39;,&#39;1u&#39;,100].init, &#39;cation&#39;:&#39;Li&#39;, &#39;trans&#39;:&#39;Fe&#39;, &#39;main_set&#39;:&#39;1m&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>





    <span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># result dictionary, for each structure we have dict</span>
    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cathodes</span><span class="p">:</span>
        <span class="c1"># name = cat_name_mod(l[0])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cathodes</span><span class="p">:</span>
        <span class="c1"># print(cat[&#39;id&#39;])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;main_set&#39;</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">:</span>
            <span class="n">ise_new</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;main_set&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ise_new</span> <span class="o">=</span> <span class="n">main_set</span>


        <span class="n">itA</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.as&#39;</span>
        <span class="n">itB</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.ifn&#39;</span>
        <span class="n">idA</span> <span class="o">=</span> <span class="p">(</span><span class="n">itA</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">idB</span> <span class="o">=</span> <span class="p">(</span><span class="n">itB</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;st_from&#39;</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">:</span>
            <span class="c1">#for creating in partly deintercalated structures</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># sufs = [&#39;.a1&#39;, &#39;.a2&#39;, &#39;.a3&#39;]</span>
            <span class="n">sufs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.a1&#39;</span><span class="p">,</span> <span class="s1">&#39;.a3&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">suf</span> <span class="ow">in</span> <span class="n">sufs</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">suf</span>
                <span class="n">idd</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">idd</span> <span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;a1&#39;</span> <span class="ow">in</span> <span class="n">suf</span><span class="p">:</span>
                    <span class="n">ida1</span> <span class="o">=</span> <span class="n">idd</span>
                <span class="k">elif</span> <span class="s1">&#39;a3&#39;</span> <span class="ow">in</span> <span class="n">suf</span><span class="p">:</span>
                    <span class="n">ida3</span> <span class="o">=</span> <span class="n">idd</span>


            <span class="n">idsuf</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sufs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.as&#39;</span><span class="p">]</span>
            <span class="n">idsuf</span> <span class="o">=</span> <span class="n">idA</span>

        <span class="c1"># print(idA not in calc, idsuf not in calc )</span>
        <span class="c1"># sys.exit()</span>

        <span class="c1"># if update or idA not in calc or idsuf not in calc:</span>
        <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="n">idsuf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;full_nomag&#39;</span><span class="p">,</span> 
                <span class="n">it_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="p">,</span> 
                <span class="n">cluster</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span> <span class="n">override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># cat[&#39;st_from&#39;] = calc[cat[&#39;id_frm&#39;]].init</span>
            <span class="k">for</span> <span class="n">suf</span> <span class="ow">in</span> <span class="n">sufs</span><span class="p">:</span>
                <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suf</span>
                <span class="c1"># print(suf)</span>
                <span class="c1"># sys.exit()</span>
                <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">ise_new</span><span class="p">,</span> 
                    <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;antisite&#39;</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">confdic</span> <span class="o">=</span> <span class="n">cat</span><span class="p">,</span>
                    <span class="n">it_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/anti/&#39;</span><span class="p">,</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span> <span class="n">override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      



        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span><span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span>  <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">)</span>
                
                <span class="n">_</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">ida3</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> <span class="n">b_id</span> <span class="o">=</span> <span class="n">ida1</span><span class="p">,</span>  <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">)</span> <span class="c1">#a1 - a3 - antisite energy</span>
                
                <span class="c1"># _, res = res_loop(*ids[1], up = &#39;up1&#39;, analys_type = &#39;diff&#39;, show = &#39;fo&#39;, b_id = idB,  choose_outcar = choose_outcar, readfiles = readfiles) #A - a2 move iron - energy of moving iron</span>

                <span class="n">calc_redox</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">ida1</span><span class="p">],</span>  <span class="n">calc</span><span class="p">[</span><span class="n">idB</span><span class="p">]</span> <span class="p">)</span> <span class="c1">#voltage for alk ion intercalation</span>
           
            <span class="k">except</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idA</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> <span class="n">b_id</span> <span class="o">=</span> <span class="n">idB</span><span class="p">,</span>  <span class="n">choose_outcar</span> <span class="o">=</span> <span class="n">choose_outcar</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="n">readfiles</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;e_as&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>










    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gga</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;database/literature.csv&#39;</span><span class="p">)[[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;e_as&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;functional&#39;</span><span class="p">]]</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
        
        <span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;functional&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;functional&#39;</span><span class="p">]</span>
        <span class="c1"># print(dfs)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
        <span class="c1"># print(df)</span>
        

        <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;e_as&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_piv</span><span class="p">)</span>
        
        <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Li2FePO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;NaFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;NaMnAsO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVP2O7&#39;</span> <span class="p">])</span>

        <span class="n">df_piv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([0-9])&quot;</span><span class="p">,</span> <span class="s2">&quot;$_</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df_piv</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>


        <span class="n">df_piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Antisite formation energy (eV)&#39;</span><span class="p">)</span>


        <span class="c1"># plt.legend(loc=&#39;best&#39;) </span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">handlelength</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> 
            <span class="n">handleheight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># plt.show()</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;figs/antisite_&#39;</span><span class="o">+</span><span class="n">gga</span><span class="c1">#+&#39;.&#39;+image_format</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">image_format</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">image_format</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>

        <span class="c1"># push_figure_to_archive(figname, </span>
        <span class="c1">#     caption = gga+r&quot;&quot;&quot; Formation energies of antisite defects Li$_M^`M_{ \rm Li}^\bullet$ ($M$ = Fe, Mn, V) for several cathode materials&quot;&quot;&quot;, </span>
        <span class="c1">#     figlabel = &#39;as_&#39;+gga, autocompl = False )</span>

    <span class="k">return</span></div>








<div class="viewcode-block" id="calc_antisite_defects3"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.calc_antisite_defects3">[docs]</a><span class="k">def</span> <span class="nf">calc_antisite_defects3</span><span class="p">(</span><span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cathodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">only</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &#39;add&#39; - element to be inserted in void!</span>
<span class="sd">    if provided</span>
<span class="sd">    only - only these configurations are considered</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">impurity</span> <span class="k">import</span> <span class="n">insert_atom</span>
    <span class="kn">from</span> <span class="nn">analysis</span> <span class="k">import</span> <span class="n">find_polaron</span>
    <span class="kn">from</span> <span class="nn">geo</span> <span class="k">import</span> <span class="n">image_distance</span>

    <span class="kn">from</span> <span class="nn">current_structures</span> <span class="k">import</span> <span class="n">Na2X</span>

    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cathodes</span><span class="p">:</span>
        <span class="n">cathodes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># {&#39;cl&#39;:calc[(&#39;Li2FePO4F.pnma&#39;,&#39;1u&#39;, 1)], &#39;el1&#39;:&#39;Li&#39;, &#39;el2&#39;:&#39;Fe&#39;, &#39;max_sep&#39;:4, &#39;set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
        <span class="c1"># {&#39;cl&#39;:calc[&#39;Li2FePO4F.pnma.su.s10&#39;,&#39;1u&#39;, 100], &#39;el1&#39;:&#39;Li&#39;, &#39;el2&#39;:&#39;Fe&#39;, &#39;max_sep&#39;:4, &#39;set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>

        <span class="p">{</span><span class="s1">&#39;cl&#39;</span><span class="p">:</span><span class="n">Na2X</span><span class="p">,</span> <span class="s1">&#39;el1&#39;</span><span class="p">:</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;el2&#39;</span><span class="p">:</span><span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;max_sep&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span><span class="s1">&#39;1uAlf&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">:</span><span class="s1">&#39;cee&#39;</span>    <span class="p">},</span> 
        <span class="c1"># {&#39;cl&#39;:calc[&#39;Na2FePO4F.s10.su&#39;,&#39;4uis&#39;, 100], &#39;el1&#39;:&#39;Na&#39;, &#39;el2&#39;:&#39;Fe&#39;, &#39;max_sep&#39;:4, &#39;set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
        <span class="c1"># {&#39;cl&#39;:Na_X, &#39;el1&#39;:&#39;Na&#39;, &#39;el2&#39;:&#39;Fe&#39;, &#39;max_sep&#39;:4, &#39;set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;    }, </span>
        <span class="c1"># {&#39;cl&#39;:Na_X, &#39;el1&#39;:&#39;Na&#39;, &#39;el2&#39;:&#39;Fe&#39;, &#39;max_sep&#39;:4, &#39;set&#39;:&#39;1uAlf&#39;, &#39;cluster&#39;:&#39;cee&#39;, &#39;add&#39;:&#39;Na&#39; ,&#39;i_void&#39;:3  }, #i_void: 0, 1</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up2&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_loop_dic</span><span class="p">:</span>
        <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">param_dic</span><span class="p">:</span>
        <span class="n">cathodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_dic</span><span class="p">]</span>

    <span class="c1"># print(cathodes)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cathodes</span><span class="p">:</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">it_base</span> <span class="o">=</span> <span class="n">it</span>

        <span class="k">if</span> <span class="s1">&#39;add&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">el_add</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">]</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">i_add</span> <span class="o">=</span> <span class="n">insert_atom</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">el_add</span><span class="p">,</span> <span class="n">i_void</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;i_void&#39;</span><span class="p">],</span>  <span class="n">r_imp</span> <span class="o">=</span> <span class="mf">1.7</span><span class="p">)</span>
            <span class="n">it</span><span class="o">+=</span><span class="n">el_add</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;i_void&#39;</span><span class="p">])</span>
            <span class="n">add_loop</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_base</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/as&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="p">,</span> <span class="o">**</span><span class="n">add_loop_dic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;iatom&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">i_add</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;iatom&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i_add</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sts</span> <span class="o">=</span> <span class="n">create_antisite_defect3</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;el1&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;el2&#39;</span><span class="p">],</span> <span class="n">max_sep</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">],</span> <span class="n">iatom</span> <span class="o">=</span> <span class="n">i_add</span>  <span class="p">)</span>
        


        <span class="n">cl_base</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">],</span> <span class="n">iopt</span> <span class="o">=</span> <span class="s1">&#39;full_nomag&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="n">update</span><span class="p">,</span> <span class="o">**</span><span class="n">add_loop_dic</span><span class="p">)</span>

        <span class="n">header</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st_as</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">only</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;as&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">st_as</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="n">suf</span>
            <span class="n">st_as</span><span class="o">.</span><span class="n">write_poscar</span><span class="p">()</span>
            <span class="n">add_loop</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st_as</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">it_base</span><span class="p">]</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/as&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="p">,</span> <span class="o">**</span><span class="n">add_loop_dic</span><span class="p">)</span>
            <span class="n">cl_as</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># print(cl_as.path[&#39;output&#39;])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dE(as) = </span><span class="si">{:.0f}</span><span class="s1"> meV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="p">(</span><span class="n">cl_as</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="o">-</span><span class="n">cl_base</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">cl_as</span><span class="o">.</span><span class="n">end</span>
                <span class="n">find_polaron</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">st_as</span><span class="o">.</span><span class="n">i_el1</span><span class="p">,</span> <span class="n">out_prec</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Separation after relax = </span><span class="si">{:.2f}</span><span class="s1"> A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>   <span class="n">image_distance</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">st_as</span><span class="o">.</span><span class="n">i_el1</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="n">st_as</span><span class="o">.</span><span class="n">i_el2</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>  <span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># if &#39;as0&#39; in suf:</span>
            <span class="c1">#     break</span>

    <span class="c1"># sys.exit()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="alkali_bar"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.alkali_bar">[docs]</a><span class="k">def</span> <span class="nf">alkali_bar</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="c1"># bulk mod, volume change, average voltage</span>

    <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">]:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;KNiO2&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># print (m)</span>

    <span class="k">if</span> <span class="n">option</span> <span class="o">!=</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;proto&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> 

        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
        <span class="c1"># m_piv = m.pivot(columns=&#39;ion&#39;, values=param[&#39;val&#39;])</span>
        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m</span><span class="p">[[</span><span class="s1">&#39;barrier&#39;</span><span class="p">]]</span>
        <span class="c1"># m_piv = m.pivot(columns=&#39;ion&#39;, values=param[&#39;val&#39;])[[&#39;Li&#39;, &#39;Na&#39;, &#39;Na2&#39;, &#39;NaLi&#39;]]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])[[</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,]]</span>

    <span class="c1"># if option == &#39;2&#39;: </span>
    <span class="c1">#     m.set_index(&#39;name&#39;, inplace = True)</span>
    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;XNiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;XVP2O7&#39;</span><span class="p">,</span> <span class="s1">&#39;XTiO2&#39;</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F&#39;</span><span class="p">,</span>  <span class="s1">&#39;XTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;XVP2O7&#39;</span><span class="p">,</span> <span class="s1">&#39;XTiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span> <span class="p">])</span>
    
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;barrier&#39;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">m_piv</span><span class="p">)</span>
        <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XFeSO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F.Pna21&#39;</span><span class="p">,</span><span class="s1">&#39;XVPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;XVP2O7&#39;</span><span class="p">,</span>  <span class="s1">&#39;XTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XNiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span>  <span class="s1">&#39;XTiO2&#39;</span> <span class="p">])</span>
    
    <span class="c1"># m_piv.index[&#39;XFeSO4F&#39;] = </span>
    <span class="n">m_piv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;XFeSO4F&#39;</span><span class="p">:</span><span class="s1">&#39;KFeSO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F.Pna21&#39;</span><span class="p">:</span><span class="s1">&#39;KVPO4F.Pna21&#39;</span><span class="p">,</span>  <span class="s1">&#39;XVPO4F&#39;</span><span class="p">:</span><span class="s1">&#39;LiVPO4F&#39;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([0-9])&quot;</span><span class="p">,</span> <span class="s2">&quot;$_</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>
    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
        <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>



    <span class="n">m_piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">handlelength</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> 
        <span class="n">handleheight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># mpl.rcParams.update({&#39;font.size&#39;: 22})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">5.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">s</span><span class="p">,</span>  <span class="n">h</span><span class="p">,</span><span class="s1">&#39;Anatase</span><span class="se">\n</span><span class="s1">         P1&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.5</span><span class="o">+</span><span class="n">s</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s1">&#39;Olivine&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">3.5</span><span class="o">+</span><span class="n">s</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;P$\bar</span><span class="si">{1}</span><span class="s1">$      Layered&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">5.5</span><span class="o">+</span><span class="n">s</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s1">&#39;Pyrophospate</span><span class="se">\n</span><span class="s1">          Pristine&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;yl&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># plt.show()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.eps&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
    <span class="c1"># plt.close(&#39;all&#39;)</span>
    <span class="c1"># plt.clf()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="cathode_screening"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.cathode_screening">[docs]</a><span class="k">def</span> <span class="nf">cathode_screening</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze results</span>

<span class="sd">    Notes:</span>
<span class="sd">    Eref is removed</span>
<span class="sd">    replace res_loop with calc_redox !!!</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>

    <span class="k">def</span> <span class="nf">sort_func</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span>  <span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># print (s)</span>
        <span class="k">return</span> <span class="n">s</span>


    <span class="k">if</span> <span class="s1">&#39;main&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
        <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="c1"># df[&#39;Li_IS&#39;] = calc_barriers(&#39;normal&#39;) #Basic intercalated structures</span>
            <span class="c1"># df[&#39;IS&#39;] = calc_barriers(&#39;normal&#39;) # all, except LiCoO2, KFeSO4F</span>

            <span class="c1"># df[&#39;Li_IS_gga&#39;] = calc_barriers(&#39;normal&#39;, func = &#39;gga&#39;) # U = 0, LiFePO4 LiMnPO4 LiNiO2 LiVPO4F NaMnAsO4 Na2FePO4F </span>
            <span class="c1"># df[&#39;Li_IS2&#39;] =calc_barriers(&#39;normal&#39;) #NaMnAsO4, Na2FePO4F, Na2FeVF7, NaLiCoPO4F, LiNiO2, LiMn2O4</span>
            
            <span class="c1"># df[&#39;K_IS2&#39;] =  calc_barriers(&#39;normal&#39;) #KVPO4, KFeSO4</span>

            <span class="n">calc_barriers</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span> 

            <span class="c1"># df[&#39;Na_IS&#39;] = calc_barriers(&#39;replace&#39;, &#39;Li&#39;, &#39;Na&#39;) #Na IS obtained from Li=base</span>
            <span class="c1"># df[&#39;K_IS&#39;] = calc_barriers(&#39;replace&#39;, &#39;Li&#39;, &#39;K&#39;)  #K  IS obtained from Li=base</span>
            <span class="c1"># calc_barriers(&#39;replace&#39;, &#39;Li&#39;, &#39;Na&#39;)  #K  IS obtained from Li=base</span>
        <span class="c1"># calc_barriers(&#39;replace&#39;, &#39;Na&#39;, &#39;K&#39;)  #K  IS obtained from Li=base</span>
        <span class="c1"># calc_barriers(&#39;replace&#39;, &#39;Na&#39;, &#39;Li&#39;)  #K  IS obtained from Li=base</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="c1"># df[&#39;Li_DS&#39;] =  calc_barriers(&#39;make_ds&#39;,  &#39;Li&#39;, &#39;Li&#39;) #Basic deintercalated structures</span>
            <span class="c1"># calc_barriers(&#39;make_ds&#39;,  &#39;Li&#39;, &#39;Li&#39;) #Basic deintercalated structures</span>
            <span class="c1"># df[&#39;DS_gga&#39;] =  calc_barriers(&#39;make_ds&#39;,  &#39;Li&#39;, &#39;Li&#39;, func = &#39;gga&#39;) #Basic deintercalated structures</span>
            <span class="c1"># sys.exit()</span>
            <span class="c1"># calc_barriers(&#39;make_ds&#39;,  &#39;Na&#39;, &#39;Na&#39;) #Basic deintercalated structures</span>
            <span class="c1"># df[&#39;K_DS&#39;] = calc_barriers(&#39;make_ds&#39;,  &#39;K&#39;, &#39;K&#39;) #Basic deintercalated structures</span>
            <span class="c1"># calc_barriers(&#39;make_ds&#39;,  &#39;Li Na&#39;, &#39;Li&#39;) #Basic deintercalated structures</span>
        <span class="c1"># save = 1</span>
        <span class="c1"># print(df[&#39;Li_DS&#39;][0][&#39;vol&#39;])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#calculate change of volume due to deintercalation</span>
        <span class="c1"># print(df)</span>
        <span class="n">al</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IS&#39;</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Li_IS&#39;</span><span class="p">]</span>
        <span class="n">a2</span><span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Li_IS2&#39;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Na_IS&#39;</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;K_IS&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;K_IS2&#39;</span><span class="p">]</span>
        
        <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Li_DS&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;K_DS&#39;</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Li_IS_gga&#39;</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DS_gga&#39;</span><span class="p">]</span>



        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">jd</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
                
                <span class="k">if</span> <span class="n">jd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                    <span class="c1"># ix[&#39;vol&#39;]</span>
                    <span class="c1"># ix[&#39;vol_red&#39;] = (ix[&#39;vol&#39;]/jd[&#39;vol&#39;]-1)*100 #reduction of volume in % due to deintercalation</span>
                    <span class="n">dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">b_id</span> <span class="o">=</span> <span class="n">jd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">energy_ref</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">],</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;redox_pot&#39;</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;vol_red&#39;</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
                        <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;vol_red&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;vol_red&#39;</span><span class="p">]</span>
                        <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;Vav&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Volumes are&#39;</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="n">jd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span><span class="s1">&#39;; ids are&#39;</span><span class="p">,</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">jd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;vol_red&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;vol_ds&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">jd</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span>

                    <span class="c1"># print (ix[&#39;name&#39;])</span>
                    <span class="k">if</span> <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;KVP2O7&#39;</span><span class="p">:</span>
                        <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;vol_red&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;Vav&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="kc">None</span>


                <span class="k">else</span><span class="p">:</span>
                    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;DS structure  &#39;</span><span class="p">,</span> <span class="n">jd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;is not in intercalated structure&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="n">ix</span><span class="p">[</span><span class="s1">&#39;vol_red&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="s1">&#39;&#39;</span>




        <span class="n">al</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">al</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        <span class="c1"># a.dropna(&#39;LiMn2O4&#39;)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


        <span class="c1"># print(b)</span>
        <span class="c1"># sys.exit()</span>


        <span class="c1"># print(a.round(1))</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>
        <span class="c1"># print(m)</span>
        <span class="c1"># m = pd.DataFrame(m, index =  sorted(m.index, key = sort_func  )  ) #sort</span>
        <span class="c1"># print(m)</span>
        
        <span class="c1"># print(m)</span>
        <span class="c1"># sys.exit()</span>



        <span class="c1"># alkali_bar(m, {&#39;val&#39;:&#39;B&#39;,       &#39;h&#39;:135, &#39;yl&#39;:&#39;Bulk modulus (GPa)&#39;, &#39;fig&#39;:&#39;bulk&#39; } ) #plot Bulk modulus</span>
        <span class="c1"># alkali_bar(m, {&#39;val&#39;:&#39;vol_red&#39;, &#39;h&#39;:440,  &#39;yl&#39;:&#39;Volume change (%)&#39; , &#39;fig&#39;:&#39;volume&#39; } )</span>
        <span class="c1"># alkali_bar(m, {&#39;val&#39;:&#39;Vav&#39;, &#39;h&#39;:40,  &#39;yl&#39;:&#39;Intercalation voltage (V)&#39; , &#39;fig&#39;:&#39;av_pot&#39; })</span>
        <span class="c1"># alkali_bar(m, {&#39;val&#39;:&#39;barrier&#39;,       &#39;h&#39;:135, &#39;yl&#39;:&#39;Migration barrier (eV)&#39;, &#39;fig&#39;:&#39;barrier_Li_Na_K&#39; }, option = &#39;1&#39; ) </span>
        <span class="c1"># alkali_bar(pd.concat([a, d]), {&#39;val&#39;:&#39;barrier&#39;,       &#39;h&#39;:135, &#39;yl&#39;:&#39;Migration barrier (eV)&#39;, &#39;fig&#39;:&#39;barrier_Li_IS_DS&#39; }, option = &#39;2&#39; ) </span>
        <span class="c1"># alkali_bar(a2, {&#39;val&#39;:&#39;barrier&#39;,       &#39;h&#39;:135, &#39;yl&#39;:&#39;Migration barrier (eV)&#39;, &#39;fig&#39;:&#39;barrier_Li_IS2&#39; }, option = &#39;3&#39; ) </span>

        <span class="c1">#comparison of gga and gga+</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#IS</span>
                <span class="n">al</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GGA+U&#39;</span>
                <span class="n">e</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;GGA&#39;</span>
                <span class="n">mc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">al</span><span class="p">,</span> <span class="n">e</span><span class="p">])</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;barriers_gga_ggau&#39;</span>
                <span class="c1"># print(mc)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#DS </span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GGA+U&#39;</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GGA&#39;</span>
                <span class="n">mc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;barriers_gga_ggau_DS&#39;</span>

            <span class="n">mc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;barrier&#39;</span><span class="p">)</span>
            <span class="n">m_piv</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># print(m_piv)</span>
            <span class="c1"># sys.exit()</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Na2FePO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;NaMnAsO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;LiFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiMnPO4&#39;</span><span class="p">,</span>  <span class="s1">&#39;LiNiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVP2O7&#39;</span> <span class="p">])</span>


            <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([0-9])&quot;</span><span class="p">,</span> <span class="s2">&quot;$_</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>

            <span class="n">m_piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">handlelength</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> 
                <span class="n">handleheight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Migration barrier (eV)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.eps&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>        


        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;database/literature.csv&#39;</span><span class="p">)[[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]]</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
            <span class="c1"># dfs[&#39;owner&#39;] = &#39;world&#39;    </span>
            <span class="c1"># print(dfs.sort_index())</span>
            <span class="c1"># print(dfs)</span>
            <span class="c1"># sys.exit()</span>

            <span class="c1"># m = </span>

            <span class="n">m</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;our&#39;</span>
            <span class="c1"># m[&#39;owner&#39;] = &#39;Skoltech&#39;    </span>
            <span class="n">m</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;our&#39;</span>   
            <span class="c1"># print(m)</span>

            <span class="c1"># m.dropna(inplace =1)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

            <span class="n">m</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="c1"># m.sort_index(inplace = 1)</span>

            <span class="c1"># print (m)</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;barrier&#39;</span><span class="p">)[[</span><span class="s1">&#39;our&#39;</span><span class="p">,</span> <span class="s1">&#39;theory&#39;</span><span class="p">]]</span>
            <span class="c1"># print( m_piv)</span>
            <span class="n">m_piv</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="c1"># df_piv = pd.DataFrame(df_piv, index =  sorted(df_piv.index, key = sort_func  )  )</span>

            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">m_piv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;LiMn2O4&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LiFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;NaFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;LiVPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;LiTiO2&#39;</span> <span class="p">])</span>

                <span class="n">m_piv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;theory&#39;</span><span class="p">:</span><span class="s1">&#39;Literature DFT&#39;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([0-9])&quot;</span><span class="p">,</span> <span class="s2">&quot;$_</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>

                <span class="n">m_piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">handlelength</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> 
                    <span class="n">handleheight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Migration barrier (eV)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/barriers_theory.png&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/barriers_theory.eps&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="alkali_bar2"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.alkali_bar2">[docs]</a><span class="k">def</span> <span class="nf">alkali_bar2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_type</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">reindex</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     bulk mod, volume change, average voltage</span>
<span class="sd">    plot bar figures for paper7</span>

<span class="sd">    m - dataframe object with data build from output of calc_barriers()</span>
<span class="sd">    param</span>
<span class="sd">        - val - y value to plot</span>
<span class="sd">            - barrier</span>
<span class="sd">        - yl - y legend</span>
<span class="sd">        - h - high of figure</span>
<span class="sd">        - fig - figure name</span>

<span class="sd">    option - </span>
<span class="sd">        1 - compare Li Na K</span>
<span class="sd">        2 - compare IS and DS on one plot</span>

<span class="sd">    reindex - change the order of index - for each project is added additionaly</span>


<span class="sd">    plot_type </span>
<span class="sd">        bar</span>
<span class="sd">        dAO_barrier - specific plot</span>
<span class="sd">    </span>
<span class="sd">    suf (str) - arbirtary suffix</span>

<span class="sd">    param[&#39;val&#39;] - [&#39;redox&#39;, &#39;vol_red&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

    <span class="c1"># if plot_type == &#39;dAO_barrier&#39;:</span>
    <span class="c1">#     param = None</span>

    <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">]:</span>
        <span class="c1"># print(m[&#39;name&#39;])</span>
        <span class="c1"># sys.exit()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;KNiO2&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>



    <span class="c1"># print(m)</span>

    <span class="k">if</span> <span class="s1">&#39;barrier&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Attention! Barriers were converted to absolute values&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="c1"># convert negative barriers to positive!</span>
        <span class="n">m</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="c1"># print(m[param[&#39;val&#39;]])</span>

        <span class="c1"># sys.exit()</span>


    <span class="n">m_x</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">mIS</span> <span class="o">=</span> <span class="n">m_x</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;100%&#39;</span><span class="p">]</span>
    <span class="n">mDS</span> <span class="o">=</span> <span class="n">m_x</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;0%&#39;</span><span class="p">]</span>


    <span class="c1"># print(mIS)</span>
    <span class="c1"># print(mDS)</span>



    <span class="n">ms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;proto&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">mIS</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;proto&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">mDS</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;proto&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        


    <span class="c1">#determine redox pot and volume change</span>
    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>

        <span class="n">redox</span><span class="p">,</span> <span class="n">volred</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;redox&#39;</span><span class="p">,</span> <span class="s1">&#39;vol_red&#39;</span><span class="p">]:</span>
            
            <span class="c1"># mIS.ix[0][&#39;new&#39;] = &#39;go&#39;</span>
            <span class="c1"># print(mIS)</span>
            <span class="k">for</span> <span class="n">rowIS</span><span class="p">,</span> <span class="n">rowDS</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mIS</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">mDS</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">idIS</span> <span class="o">=</span> <span class="n">rowIS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">idDS</span> <span class="o">=</span> <span class="n">rowDS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="c1"># print(idIS, idDS)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">calc_redox</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">idIS</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="n">idDS</span><span class="p">],</span> <span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">redox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">])</span>
                <span class="n">volred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;vol_red&#39;</span><span class="p">])</span>


            <span class="n">mIS</span> <span class="o">=</span> <span class="n">mIS</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">redox</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">redox</span><span class="p">,</span>    <span class="n">index</span><span class="o">=</span><span class="n">mIS</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="c1"># add column</span>
            <span class="n">mIS</span> <span class="o">=</span> <span class="n">mIS</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vol_red</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">mIS</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="c1"># add column</span>
        <span class="c1"># print(mIS)</span>
        <span class="c1"># sys.exit()</span>



        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">m_pivIS</span> <span class="o">=</span> <span class="n">mIS</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])[[</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,]]</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_pivIS</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;barrier&#39;</span><span class="p">,</span> <span class="p">]:</span> <span class="c1">#use negative axis for DS state</span>


                <span class="n">mDS</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mDS</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span><span class="o">*-</span><span class="mi">1</span>

                <span class="n">m_pivDS</span> <span class="o">=</span> <span class="n">mDS</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])[[</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,]]</span>

                <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_pivDS</span><span class="p">)</span>





        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> 
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_piv</span><span class="p">)</span>
        

        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
            <span class="c1"># m_piv = m.pivot(columns=&#39;ion&#39;, values=param[&#39;val&#39;])</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m</span><span class="p">[[</span><span class="s1">&#39;barrier&#39;</span><span class="p">]]</span>
            <span class="c1"># m_piv = m.pivot(columns=&#39;ion&#39;, values=param[&#39;val&#39;])[[&#39;Li&#39;, &#39;Na&#39;, &#39;Na2&#39;, &#39;NaLi&#39;]]</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_piv</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="c1"># m_piv = m.pivot(columns=&#39;ion&#39;, values=param[&#39;val&#39;])[[&#39;Li&#39;, &#39;Na&#39;, &#39;K&#39;,]]</span>

            <span class="c1"># ms.append(m_piv)</span>
        <span class="c1"># if option == &#39;2&#39;: </span>
        <span class="c1">#     m.set_index(&#39;name&#39;, inplace = True)</span>
        
        <span class="c1"># print(m_pivDS)</span>


        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="c1"># m_piv = m_piv.reindex(index = [&#39;XFePO4&#39;, &#39;XMnPO4&#39;, &#39;XTiS2&#39;, &#39;XNiO2&#39;, &#39;XVP2O7&#39;, &#39;XTiO2&#39; ])</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F&#39;</span><span class="p">,</span>  <span class="s1">&#39;XTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;XVP2O7&#39;</span><span class="p">,</span> <span class="s1">&#39;XTiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span> <span class="p">])</span>
        
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;barrier&#39;</span><span class="p">)</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(m_piv)</span>
            <span class="n">m_piv</span> <span class="o">=</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XFeSO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F.Pna21&#39;</span><span class="p">,</span><span class="s1">&#39;XVPO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;XVP2O7&#39;</span><span class="p">,</span>  <span class="s1">&#39;XTiS2&#39;</span><span class="p">,</span> <span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XNiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span>  <span class="s1">&#39;XTiO2&#39;</span> <span class="p">])</span>
        

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">)):</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;XMn2O4.Fd3m.111&#39;</span><span class="p">:</span><span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span><span class="s1">&#39;XFeSO4F&#39;</span><span class="p">:</span><span class="s1">&#39;KFeSO4F&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F.Pna21&#39;</span><span class="p">:</span><span class="s1">&#39;KVPO4F.Pna21&#39;</span><span class="p">,</span> <span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;XMO&#39;</span><span class="p">:</span><span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span><span class="s1">&#39;XFPO&#39;</span><span class="p">:</span><span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XMPO&#39;</span><span class="p">:</span><span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPOF&#39;</span><span class="p">:</span><span class="s1">&#39;XVPO4F&#39;</span><span class="p">,</span> <span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     
            <span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XMn2O4&#39;</span><span class="p">,</span> <span class="s1">&#39;XFePO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XMnPO4&#39;</span><span class="p">,</span> <span class="s1">&#39;XVPO4F&#39;</span><span class="p">])</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">mp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([0-9])&quot;</span><span class="p">,</span> <span class="s2">&quot;$_</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mp</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># #Make low indexes</span>

            <span class="c1"># print(mp.index)</span>

            <span class="n">mp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mp</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1">#</span>
            <span class="c1"># print(mp.index)</span>


        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
            <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m_piv</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="c1">#</span>


    <span class="c1"># print(m_piv)</span>
    <span class="c1"># mpl.style.use(&#39;ggplot&#39;)</span>

    <span class="c1"># fig, ax = plt.subplots()</span>
    

    <span class="k">if</span> <span class="s1">&#39;ylim&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="k">for</span> <span class="n">mp</span> <span class="ow">in</span> <span class="n">ms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># print(mp)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">)</span>
        
        <span class="c1"># plt.legend([&#39;Li&#39;, &#39;Na&#39;, &#39;K&#39;])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">],</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">handlelength</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> 
            <span class="n">handleheight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># mpl.rcParams.update({&#39;font.size&#39;: 22})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">5.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">s</span><span class="p">,</span>  <span class="n">h</span><span class="p">,</span><span class="s1">&#39;Anatase</span><span class="se">\n</span><span class="s1">         P1&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.5</span><span class="o">+</span><span class="n">s</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s1">&#39;Olivine&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">3.5</span><span class="o">+</span><span class="n">s</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;P$\bar</span><span class="si">{1}</span><span class="s1">$      Layered&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">5.5</span><span class="o">+</span><span class="n">s</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s1">&#39;Pyrophospate</span><span class="se">\n</span><span class="s1">          Pristine&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;yl&#39;</span><span class="p">])</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;dAO_barrier&#39;</span><span class="p">:</span>
        <span class="c1"># print(m_x)</span>
        <span class="n">m_dAO_IS</span> <span class="o">=</span> <span class="n">m_x</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;dAO_change&#39;</span><span class="p">)</span>
        <span class="c1"># dAO_bar = mIS[[&#39;dAO_change&#39;, &#39;barrier&#39;]]</span>
        <span class="c1"># print(dAO_bar)  </span>

        <span class="c1"># dAO_bar.plot(x= &#39;dAO_change&#39;,y = &#39;barrier&#39;, xlim = (0, 0.3), style = [&#39;o&#39;])</span>
        <span class="n">m_dAO_IS_piv</span> <span class="o">=</span> <span class="n">m_dAO_IS</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;barrier&#39;</span><span class="p">)[[</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,]]</span>


        <span class="c1"># m_dAO_IS_piv.columns.name = &#39;A-(O,F) distance, $\AA$&#39;</span>
        <span class="n">m_dAO_IS_piv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span>  <span class="s1">&#39;Change of A-(O,F) distance, $\AA$&#39;</span>
        <span class="c1"># print(m_dAO_IS_piv)  </span>



        <span class="n">header</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span> <span class="mi">16</span><span class="p">)</span> 

        <span class="n">m_dAO_IS_piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">style</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="s1">&#39;gs&#39;</span><span class="p">,</span> <span class="s1">&#39;bv&#39;</span><span class="p">],</span> <span class="n">ms</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Migration barrier, eV&#39;</span><span class="p">)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>

        <span class="c1"># filename = plot_type+suf</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


    <span class="c1"># plt.show()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;figs/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
    <span class="c1"># plt.close(&#39;all&#39;)</span>
    <span class="c1"># plt.clf()</span>
    <span class="c1"># plt.show()</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="e_bind"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.e_bind">[docs]</a><span class="k">def</span> <span class="nf">e_bind</span><span class="p">(</span><span class="n">cl_bulk</span><span class="p">,</span> <span class="n">cl_vac</span><span class="p">,</span> <span class="n">cl_sol</span><span class="p">,</span> <span class="n">cl_compl</span><span class="p">):</span>
    <span class="c1">#binding energy of vacancy - solute complex</span>
    <span class="c1">#cl_compl - complex</span>
    <span class="n">dE</span> <span class="o">=</span> <span class="n">cl_sol</span><span class="o">.</span><span class="n">e0</span> <span class="o">+</span> <span class="n">cl_vac</span><span class="o">.</span><span class="n">e0</span> <span class="o">-</span> <span class="p">(</span><span class="n">cl_bulk</span><span class="o">.</span><span class="n">e0</span> <span class="o">+</span> <span class="n">cl_compl</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">cl_compl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n_sol</span> <span class="o">=</span> <span class="n">cl_compl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of solute atoms = &#39;</span><span class="p">,</span> <span class="n">n_sol</span><span class="p">)</span>
        <span class="n">dE</span> <span class="o">=</span> <span class="n">n_sol</span><span class="o">*</span><span class="n">cl_sol</span><span class="o">.</span><span class="n">e0</span> <span class="o">+</span> <span class="n">cl_vac</span><span class="o">.</span><span class="n">e0</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_sol</span><span class="o">*</span><span class="n">cl_bulk</span><span class="o">.</span><span class="n">e0</span> <span class="o">+</span> <span class="n">cl_compl</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span>



    <span class="k">return</span> <span class="n">dE</span></div>




<div class="viewcode-block" id="plot_UvsD"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.plot_UvsD">[docs]</a><span class="k">def</span> <span class="nf">plot_UvsD</span><span class="p">(</span><span class="n">it1</span><span class="p">,</span> <span class="n">it2</span><span class="p">,</span> <span class="n">it_b</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">n_imag</span><span class="p">,</span> <span class="n">ise_b</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_b</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
    <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">invert_x</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">linetypes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  
    <span class="n">st_start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ver_lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intercalation potential vs deformation</span>
<span class="sd">    sc_reg - scale region</span>
<span class="sd">    n_imag - n_scale_images</span>
<span class="sd">    suf - suffix</span>
<span class="sd">    v_b (int) - if provided than version of base fixed to this number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plot_dist</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">plot_dist</span><span class="p">:</span>
        <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;sur&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span>


    <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">sc_reg</span><span class="p">,</span> <span class="n">n_imag</span><span class="p">)</span>
    <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ise_b</span><span class="p">:</span>
        <span class="n">ise_b</span> <span class="o">=</span> <span class="n">ise</span>

    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="p">[</span><span class="n">it1</span><span class="p">,</span> <span class="n">it2</span><span class="p">,</span> <span class="n">it_b</span><span class="p">]:</span>
        <span class="c1"># print(calc[it, ise, 2].state)</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="n">it_b</span><span class="p">:</span>
            <span class="n">iset</span> <span class="o">=</span> <span class="n">ise_b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iset</span> <span class="o">=</span> <span class="n">ise</span>
        <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">iset</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="n">up</span> <span class="p">:</span>
            <span class="n">res_loop</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">iset</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imag</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">show</span> <span class="o">=</span> <span class="n">show</span><span class="p">)</span>
            <span class="c1"># print(calc[it, ise, 2].state)</span>
    <span class="c1"># sums = {&#39;Li-O&#39;:[], &#39;Na-O&#39;:[], &#39;Li-O(b)&#39;:[], &#39;Na-O(b)&#39;:[]}</span>
    <span class="n">sums</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_imag</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cl1</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it1</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
        <span class="n">cl2</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it2</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v_b</span><span class="p">:</span>
            <span class="n">cl_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it_b</span><span class="p">,</span> <span class="n">ise_b</span><span class="p">,</span> <span class="n">v_b</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cl_b</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="n">it_b</span><span class="p">,</span> <span class="n">ise_b</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
        <span class="n">U1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_redox</span><span class="p">(</span><span class="n">cl1</span><span class="p">,</span> <span class="n">cl_b</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">scales</span><span class="p">[</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">U2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_redox</span><span class="p">(</span><span class="n">cl2</span><span class="p">,</span> <span class="n">cl_b</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">scales</span><span class="p">[</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="s1">&#39;redox_pot&#39;</span><span class="p">]</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_dist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">cl1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="n">cl2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">cl_b</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Li-O&#39;</span><span class="p">,</span> <span class="s1">&#39;Na-O&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe-O&#39;</span><span class="p">,</span> <span class="s1">&#39;O-O&#39;</span><span class="p">,</span> <span class="s1">&#39;Li-Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Na-Fe&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">sumAO</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">bond</span><span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sums</span><span class="p">:</span>
                            <span class="n">sums</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span> <span class="p">[]</span>
                        <span class="n">sums</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">sumAO</span><span class="p">[</span><span class="n">bond</span><span class="p">])</span>

        <span class="c1"># cl1.end.write_xyz()</span>
        <span class="c1"># cl2.end.write_xyz()</span>
        <span class="c1"># cl_b.end.write_xyz()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pos1&#39;</span><span class="p">,</span> <span class="s1">&#39;pos2&#39;</span><span class="p">,</span> <span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">invert_x</span><span class="p">:</span>
        <span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scales</span> <span class="p">]</span> 
        <span class="c1"># U1 = U1[::-1]</span>
        <span class="c1"># U2 = U2[::-1]</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">linetypes</span><span class="p">:</span>
        <span class="n">linetypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b-o&#39;</span><span class="p">,</span> <span class="s1">&#39;g-o&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fit_and_plot</span><span class="p">(</span><span class="n">U1</span> <span class="o">=</span> <span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">linetypes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">U2</span> <span class="o">=</span> <span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">linetypes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">legend</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
            <span class="n">image_name</span> <span class="o">=</span> <span class="s1">&#39;figs/strain_&#39;</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="n">legend</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Redox potential, V&#39;</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Compression, $\delta$, %&#39;</span><span class="p">,</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">,</span>
            <span class="n">ver_lines</span> <span class="o">=</span> <span class="n">ver_lines</span><span class="p">)</span>









    <span class="k">if</span> <span class="n">plot_dist</span><span class="p">:</span>
        <span class="n">header</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span> <span class="mi">10</span><span class="p">)</span> 

        <span class="n">fit_and_plot</span><span class="p">(</span>
                    <span class="c1"># l1 = (scales, sums[&#39;Li-O(1)&#39;], &#39;g--&#39;, &#39;Li-O&#39;), </span>
                    <span class="c1"># l2 = (scales, sums[&#39;Li-O(b)&#39;], &#39;g-&#39;, &#39;Li-O(b)&#39;), </span>
                    <span class="c1"># l3 = (scales, sums[&#39;Na-O(2)&#39;], &#39;r--&#39;, &#39;Na-O&#39;), </span>
                    <span class="c1"># l4 = (scales, sums[&#39;Na-O(b)&#39;], &#39;r-&#39;, &#39;Na-O(b)&#39;), </span>
                    <span class="n">l5</span> <span class="o">=</span> <span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">sums</span><span class="p">[</span><span class="s1">&#39;Fe-O(1)&#39;</span><span class="p">],</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe-O(1)&#39;</span><span class="p">),</span> 
                    <span class="n">l6</span> <span class="o">=</span> <span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">sums</span><span class="p">[</span><span class="s1">&#39;Fe-O(2)&#39;</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe-O(2)&#39;</span><span class="p">),</span> 
                    <span class="n">l7</span> <span class="o">=</span> <span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">sums</span><span class="p">[</span><span class="s1">&#39;Fe-O(b)&#39;</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe-O(b)&#39;</span><span class="p">),</span> 
                    <span class="c1"># l5 = (scales, sums[&#39;O-O(1)&#39;], &#39;g--&#39;, &#39;O-O(1)&#39;), </span>
                    <span class="c1"># l6 = (scales, sums[&#39;O-O(2)&#39;], &#39;r--&#39;, &#39;O-O(2)&#39;), </span>
                    <span class="c1"># l7 = (scales, sums[&#39;O-O(b)&#39;], &#39;k-&#39;,  &#39;O-O(b)&#39;), </span>
                    
                    <span class="c1"># l5 = (scales, sums[&#39;Li-Fe(1)&#39;], &#39;g--&#39;, &#39;Li-Fe(1)&#39;), </span>
                    <span class="c1"># l6 = (scales, sums[&#39;Na-Fe(2)&#39;], &#39;r--&#39;, &#39;Na-Fe(2)&#39;), </span>
                    <span class="c1"># l7 = (scales, sums[&#39;Li-Fe(b)&#39;], &#39;g-&#39;,  &#39;Li-Fe(b)&#39;), </span>
                    <span class="c1"># l8 = (scales, sums[&#39;Na-Fe(b)&#39;], &#39;r-&#39;,  &#39;Na-Fe(b)&#39;), </span>


                    <span class="c1"># ld = (scales, np.array(sums[&#39;Na-O&#39;])  - np.array(sums[&#39;Na-O(b)&#39;]), &#39;r--&#39;, &#39;d Na-O&#39;), </span>
                    <span class="c1"># ld2 = (scales, np.array(sums[&#39;Li-O&#39;]) - np.array(sums[&#39;Li-O(b)&#39;]), &#39;g-&#39;, &#39;d Li-O&#39;), </span>


            <span class="n">image_name</span> <span class="o">=</span> <span class="s1">&#39;figs/AO_dist_&#39;</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;average A-O, A&#39;</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Compression, $\delta$, %&#39;</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>



    <span class="k">return</span> <span class="n">scales</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">legend</span></div>


<div class="viewcode-block" id="calc_strain_influence"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.calc_strain_influence">[docs]</a><span class="k">def</span> <span class="nf">calc_strain_influence</span><span class="p">(</span><span class="n">cl_b</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rep_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">half</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">del_el_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">del_pos_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">invert_x</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vac</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="s1">&#39;Na2FePO4F/scaled&#39;</span><span class="p">,</span> 
    <span class="n">plot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mul_matrix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sreg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">suf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_scale_images</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ver_lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function</span>
<span class="sd">    Creates 3 calculations</span>
<span class="sd">    replace - if replacement of one Na by Li is needed</span>
<span class="sd">    rep_pos - replacement pos of Na with Li</span>
<span class="sd">    del_pos_list - del pos</span>
<span class="sd">    vac - if False all atoms are removed, if True only one atom is removed</span>
<span class="sd">    half - (bool) remove half of atoms (half charged)</span>
<span class="sd">    sreg - scale_region</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale_region</span> <span class="o">=</span> <span class="n">sreg</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mul_matrix</span><span class="p">:</span>
        <span class="n">mul_matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.99</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0025</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_region</span><span class="p">:</span>
        <span class="n">scale_region</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.6</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">n_scale_images</span><span class="p">:</span>
        <span class="n">n_scale_images</span> <span class="o">=</span> <span class="mi">12</span>
    
    <span class="n">cl_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ise</span><span class="p">:</span>
        <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;1uis&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">del_el_list</span><span class="p">:</span>
        <span class="n">del_el_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">del_pos_list</span><span class="p">:</span>
        <span class="n">del_pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,]</span>


    <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
        <span class="n">st_b</span> <span class="o">=</span> <span class="n">create_replaced_structure</span><span class="p">(</span><span class="n">cl_b</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">el1</span> <span class="o">=</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="n">el2</span> <span class="o">=</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="n">rep_pos</span> <span class="o">=</span> <span class="n">rep_pos</span><span class="p">)</span>
        <span class="n">it_b</span> <span class="o">=</span> <span class="n">cl_b</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.ir&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rep_pos</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Li&#39;</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">st_b</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cl_b</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="n">it_b</span> <span class="o">=</span> <span class="n">cl_b</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    

    <span class="n">st_b</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">cl_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">it_b</span><span class="p">,</span> <span class="n">st_b</span><span class="p">])</span>
    <span class="c1"># names = []</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">del_el_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">del_pos</span> <span class="ow">in</span> <span class="n">del_pos_list</span><span class="p">:</span>
            <span class="n">lsuf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">vac</span><span class="p">:</span>
                <span class="c1"># del_pos = 1</span>
                <span class="n">st_del</span> <span class="o">=</span> <span class="n">remove_one_atom</span><span class="p">(</span><span class="n">st_b</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">del_pos</span> <span class="o">=</span> <span class="n">del_pos</span><span class="p">)</span>
                <span class="n">it_del</span> <span class="o">=</span> <span class="n">it_b</span><span class="o">+</span><span class="s1">&#39;.vac&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">del_pos</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">half</span><span class="p">:</span>
                <span class="n">lsuf</span> <span class="o">=</span> <span class="s1">&#39;half&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_el_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="s1">&#39;Na&#39;</span><span class="p">:</span>
                        <span class="n">at_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="mi">61</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span><span class="mi">64</span><span class="p">]</span>
                        <span class="n">conf</span> <span class="o">=</span> <span class="s1">&#39;c6&#39;</span>
                        <span class="n">st_del</span> <span class="o">=</span> <span class="n">st_b</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">at_to_remove</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">el</span> <span class="o">==</span> <span class="s1">&#39;Li&#39;</span><span class="p">:</span>
                        <span class="n">at_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="mi">65</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">68</span><span class="p">]</span>
                        <span class="n">conf</span> <span class="o">=</span> <span class="s1">&#39;c5&#39;</span>
                        <span class="n">st_del</span> <span class="o">=</span> <span class="n">st_b</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">at_to_remove</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">it_del</span> <span class="o">=</span> <span class="n">it_b</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="n">lsuf</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">conf</span> <span class="c1"># </span>


                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_el_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">del_pos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">at_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="mi">61</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">59</span><span class="p">]</span>
                        <span class="n">conf</span> <span class="o">=</span> <span class="s1">&#39;c13&#39;</span>
                        <span class="n">st_del</span> <span class="o">=</span> <span class="n">st_b</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">at_to_remove</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">del_pos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">at_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="mi">65</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span><span class="mi">68</span><span class="p">]</span>
                        <span class="n">conf</span> <span class="o">=</span> <span class="s1">&#39;c5&#39;</span>
                        <span class="n">st_del</span> <span class="o">=</span> <span class="n">st_b</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">at_to_remove</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>                        

                    <span class="n">it_del</span> <span class="o">=</span> <span class="n">it_b</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">del_pos</span><span class="p">)</span><span class="o">+</span><span class="n">lsuf</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">conf</span> <span class="c1">#</span>



            <span class="k">else</span><span class="p">:</span>
                <span class="n">st_del</span> <span class="o">=</span> <span class="n">create_deintercalated_structure</span><span class="p">(</span><span class="n">st_b</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">del_pos</span> <span class="o">=</span> <span class="n">del_pos</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_pos_list</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">it_del</span> <span class="o">=</span> <span class="n">it_b</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span><span class="o">+</span><span class="n">el</span> <span class="c1"># for compatibility </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">it_del</span> <span class="o">=</span> <span class="n">it_b</span><span class="o">+</span><span class="s1">&#39;.id&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">del_pos</span><span class="p">)</span>
        



            <span class="n">cl_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">it_del</span><span class="p">,</span> <span class="n">st_del</span><span class="p">])</span>






    <span class="k">if</span> <span class="ow">not</span> <span class="n">suf</span><span class="p">:</span>
        <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;.sm&#39;</span>
    <span class="n">scales</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">clt</span> <span class="ow">in</span> <span class="n">cl_list</span><span class="p">:</span>
            <span class="n">idd</span> <span class="o">=</span> <span class="p">(</span><span class="n">clt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">iddsm</span> <span class="o">=</span> <span class="p">(</span><span class="n">clt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iddsm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span> <span class="ow">or</span> <span class="n">up</span><span class="p">:</span>
                <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idd</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">clt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">it_suffix</span> <span class="o">=</span> <span class="n">suf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">calc_method</span> <span class="o">=</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">mul_matrix</span> <span class="o">=</span> <span class="n">mul_matrix</span><span class="p">,</span>
                 <span class="n">scale_region</span> <span class="o">=</span> <span class="n">scale_region</span><span class="p">,</span> <span class="n">n_scale_images</span> <span class="o">=</span> <span class="n">n_scale_images</span><span class="p">,</span>  <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;inherit_xred&#39;</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>





        <span class="k">if</span> <span class="n">rep_pos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pos2</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="c1"># lin1 = &#39;-b&#39;</span>
            <span class="c1"># lin2 = &#39;-g&#39;</span>
        <span class="k">elif</span> <span class="n">rep_pos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pos2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># l1 = lin1</span>
            <span class="c1"># lin1 = lin2</span>
            <span class="c1"># lin2 = l1</span>




        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_el_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">leg2</span> <span class="o">=</span> <span class="s1">&#39;Li&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rep_pos</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; removal&#39;</span>
            <span class="n">leg1</span> <span class="o">=</span> <span class="s1">&#39;Na&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>    <span class="o">+</span><span class="s1">&#39; removal&#39;</span>
        
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_el_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">del_el_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">leg1</span> <span class="o">=</span> <span class="n">el</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">del_pos_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39; removal&#39;</span>
            <span class="n">leg2</span> <span class="o">=</span> <span class="n">el</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">del_pos_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39; removal&#39;</span>

        <span class="n">lin1</span> <span class="o">=</span> <span class="s1">&#39;-ob&#39;</span>
        <span class="n">lin2</span> <span class="o">=</span> <span class="s1">&#39;-og&#39;</span>
        
        <span class="c1"># if &#39;Li&#39; in leg2:</span>
        <span class="c1">#     lin2 = &#39;-og&#39;</span>
        <span class="c1"># elif &#39;Na&#39; in leg2:</span>
        <span class="c1">#     lin2 = &#39;-ok&#39;</span>


        <span class="n">scales</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="n">plot_UvsD</span><span class="p">(</span><span class="n">it1</span> <span class="o">=</span> <span class="n">cl_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">suf</span> <span class="p">,</span> <span class="n">it2</span> <span class="o">=</span> <span class="n">cl_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">it_b</span> <span class="o">=</span> <span class="n">cl_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">suf</span><span class="p">,</span> <span class="n">ise</span> <span class="o">=</span> <span class="n">ise</span><span class="p">,</span> <span class="n">sc_reg</span> <span class="o">=</span> <span class="n">scale_region</span><span class="p">,</span> 
            <span class="n">n_imag</span> <span class="o">=</span> <span class="n">n_scale_images</span><span class="p">,</span> 
            <span class="n">suf</span> <span class="o">=</span> <span class="n">cl_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">suf</span><span class="o">+</span><span class="n">ise</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="p">(</span><span class="n">leg1</span><span class="p">,</span> <span class="n">leg2</span><span class="p">,</span> <span class="s1">&#39;lower left&#39;</span><span class="p">),</span> <span class="n">linetypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">lin1</span><span class="p">,</span> <span class="n">lin2</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">,</span> 
            <span class="n">invert_x</span> <span class="o">=</span> <span class="n">invert_x</span><span class="p">,</span> <span class="n">st_start</span> <span class="o">=</span> <span class="n">cl_b</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">ver_lines</span> <span class="o">=</span> <span class="n">ver_lines</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">)</span>


<span class="c1"># ise, sc_reg, n_imag</span>
    <span class="k">return</span> <span class="n">scales</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">legend</span></div>



<div class="viewcode-block" id="replace"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.replace">[docs]</a><span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">el1</span><span class="p">,</span> <span class="n">el2</span><span class="p">,</span> <span class="n">reptype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    cl - calculation to work with</span>
<span class="sd">    el1 - element to be replaced</span>
<span class="sd">    el2 - replace by this</span>
<span class="sd">    reptype - type of replacement</span>
<span class="sd">        &#39;full&#39; - all atoms of specific symmetry type</span>
<span class="sd">        &#39;one&#39; - only one atom of specific symmetry type</span>

<span class="sd">    update - update </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span>
    <span class="c1"># print(determine_symmetry_positions(st, el1))</span>
    <span class="n">n_noneq_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">determine_symmetry_positions</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">el1</span><span class="p">))</span>
    <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Number of non-equiv pos&#39;</span><span class="p">,</span> <span class="n">n_noneq_pos</span><span class="p">)</span>


    <span class="c1"># sys.exit()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">reptype</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! replace(): Please provide reptype = &quot;full&quot; or &quot;one&quot;&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_noneq_pos</span><span class="p">):</span>
        <span class="s1">&#39;&#39;</span>
        <span class="n">pos</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;one&#39;</span> <span class="ow">in</span> <span class="n">reptype</span><span class="p">:</span>
            <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;one&#39;</span>
            <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;1uis&#39;</span>
            <span class="n">scale_region</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;4uis&#39;</span>
            <span class="n">scale_region</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">one</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">it_new</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.ir&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">suf</span><span class="o">+</span><span class="n">el2</span>
        <span class="n">id_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">it_folder</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sfolder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;replaced&#39;</span>

        <span class="c1"># print((it_new+&#39;.su&#39;, ise, 1))</span>
        <span class="c1"># print((it_new+&#39;.su&#39;, ise, 1) not in header.calc)</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">if</span> <span class="n">one</span><span class="p">:</span>
            <span class="n">id_new2</span> <span class="o">=</span> <span class="n">id_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_new2</span> <span class="o">=</span> <span class="p">(</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="n">id_new2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span><span class="p">:</span>
            <span class="n">st_rep</span> <span class="o">=</span> <span class="n">create_replaced_structure</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">el1</span> <span class="o">=</span> <span class="n">el1</span><span class="p">,</span> <span class="n">el2</span> <span class="o">=</span> <span class="n">el2</span><span class="p">,</span> <span class="n">rep_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">only_one</span> <span class="o">=</span> <span class="n">one</span><span class="p">)</span>
            <span class="n">st_rep</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">one</span><span class="p">:</span>
                <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">id_new</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st_rep</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1">#charge density without relaxation</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">id_new</span><span class="p">,</span> <span class="n">calc_method</span> <span class="o">=</span> <span class="s1">&#39;uniform_scale&#39;</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;inherit_xred&#39;</span><span class="p">,</span> <span class="n">scale_region</span> <span class="o">=</span> <span class="n">scale_region</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st_rep</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="p">)</span>
        



        <span class="k">else</span><span class="p">:</span>
            <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;full&#39;</span> <span class="ow">in</span> <span class="n">reptype</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">show_fit</span><span class="p">:</span>
                    <span class="n">res_loop</span><span class="p">(</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;fit_a&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fitfo&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_loop</span><span class="p">(</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_loop</span><span class="p">(</span> <span class="o">*</span><span class="n">id_new</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fo&#39;</span><span class="p">)</span>


    <span class="k">return</span></div>


<span class="n">calc_material</span> <span class="o">=</span> <span class="n">calc_barriers</span>



<div class="viewcode-block" id="neb_wrapper"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.neb_wrapper">[docs]</a><span class="k">def</span> <span class="nf">neb_wrapper</span><span class="p">(</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">paths</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run_neb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;IS&#39;</span><span class="p">,</span> <span class="n">DS</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">special_case</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">add_loop_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">substitute</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">up_res</span> <span class="o">=</span> <span class="s1">&#39;up2&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows to run, read, and plot composition diffusion path;</span>
<span class="sd">    was used for RbVPO4F and KVPO4F </span>


<span class="sd">    paths - list of tuples; each tuple contains (A, B, C, D, E),</span>
<span class="sd">        where A - #atom number from 0 - start position for migration</span>
<span class="sd">              B - end position number according add_neb</span>
<span class="sd">              C - name of created it</span>
<span class="sd">              D - (not nessesary) either path to occupation matrix or</span>
<span class="sd">                               id, from which the occupation matrix should be taken for IS</span>
<span class="sd">              E - (not nessesary) either path to occupation matrix or</span>
<span class="sd">                               id, from which the occupation matrix should be taken for DS</span>

<span class="sd">    special_case: # for KVP additional static run</span>
<span class="sd">    mode - </span>
<span class="sd">        &#39;IS&#39;, &#39;DS&#39;</span>

<span class="sd">    DS - calc used as initial ds</span>





<span class="sd">    substitute - manually substitute specific points of MEP</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">picture_functions</span> <span class="k">import</span> <span class="n">plot_mep</span>



    <span class="n">struct_des</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">struct_des</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">calc</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_loop_args</span><span class="p">:</span>
        <span class="n">add_loop_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s1">&#39;upC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_dic</span><span class="p">:</span>
        <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;upC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">n_set</span> <span class="o">=</span> <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;neb_set&#39;</span><span class="p">]</span>
    <span class="n">imag</span> <span class="o">=</span> <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>

    <span class="n">nameadd</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;main_set&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">n_set</span>
    <span class="n">tkeys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="s1">&#39;t_mep&#39;</span><span class="o">+</span><span class="n">nameadd</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span><span class="s1">&#39;t_it&#39;</span><span class="o">+</span><span class="n">nameadd</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">:</span><span class="s1">&#39;t_mepDS&#39;</span><span class="o">+</span><span class="n">nameadd</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tkeys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tkeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="p">:</span>
            <span class="c1"># print(key)</span>
            <span class="n">calc</span><span class="p">[</span><span class="n">tkeys</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mep</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">el</span> <span class="o">=</span> <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;el&#39;</span><span class="p">]</span>
    <span class="c1"># if &#39;old_behaviour&#39; in param_dic:</span>
    <span class="c1">#     old_behaviour = param_dic[&#39;old_behaviour&#39;]</span>
    <span class="c1"># else:</span>
    <span class="c1">#     old_behaviour = 0</span>

    <span class="k">if</span> <span class="n">run_neb</span> <span class="ow">or</span> <span class="n">read</span><span class="p">:</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
       
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;OCCMATRIX&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="c1"># the file is provided</span>
                <span class="n">add_loop_args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;occmatrix&#39;</span><span class="p">:</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># assuming that id of calculation is provided</span>
                <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;occmatrix_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;IS&#39;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;intercalated&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;OCCMATRIX&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="c1"># the file is provided</span>
                    <span class="n">add_loop_args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;occmatrix&#39;</span><span class="p">:</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># assuming that id of calculation is provided</span>
                    <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;occmatrix_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">t_key</span> <span class="o">=</span> <span class="n">tkeys</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span>
            <span class="c1"># print(t_key)</span>
            <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;i_atom_to_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  
            <span class="k">if</span> <span class="n">run_neb</span> <span class="ow">or</span> <span class="n">read</span><span class="p">:</span>
                <span class="n">calc_barriers</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span>  <span class="n">el</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">up_res</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">run_neb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upC</span> <span class="o">=</span> <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;upC&#39;</span><span class="p">],</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="n">param_dic</span><span class="p">,</span>  <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_args</span><span class="p">)</span> <span class="c1"># here 1 is 4.47 A; 3 is 6.64 A</span>
                <span class="c1"># print(t_key)</span>
                <span class="n">calc</span><span class="p">[</span><span class="n">t_key</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;_mep&#39;</span><span class="p">]</span>
                <span class="c1"># print(calc[t_key][p])</span>
            
            <span class="c1"># print (t_key) </span>
            <span class="c1"># print (calc[t_key]) </span>
            <span class="c1"># print(calc[t_key][p][1])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;t_key&#39;</span><span class="p">,</span> <span class="n">t_key</span><span class="p">)</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">((</span><span class="n">calc</span><span class="p">[</span><span class="n">t_key</span><span class="p">][</span><span class="n">pk</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>

            <span class="k">if</span> <span class="n">special_case</span><span class="p">:</span> <span class="c1"># for KVP additional static run</span>
                <span class="n">e_stat</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc</span><span class="p">[</span><span class="n">pk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.ifn&#39;</span><span class="p">,</span> <span class="s1">&#39;0m&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">e0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
                <span class="n">mep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">e_stat</span><span class="p">)))</span>
                <span class="n">suf2</span><span class="o">=</span> <span class="s1">&#39;_spec&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">mep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">t_key</span><span class="p">][</span><span class="n">pk</span><span class="p">][</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">suf2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>



        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;DS&#39;</span><span class="p">:</span>


            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;OCCMATRIX&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="c1"># the file is provided</span>
                    <span class="n">add_loop_args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;occmatrix&#39;</span><span class="p">:</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># assuming that id of calculation is provided</span>
                    <span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;occmatrix_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                <span class="n">cl</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                <span class="c1"># print(p[4])</span>

                <span class="n">occfile</span> <span class="o">=</span> <span class="n">write_occmatrix</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">occ_matrices</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
                <span class="c1"># continue</span>
                <span class="n">add_loop_args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;occmatrix&#39;</span><span class="p">:</span><span class="n">occfile</span><span class="p">}</span>


            <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>


            <span class="n">suf2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="sd">&quot;&quot;&quot;deintercalated&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">DS</span><span class="p">,</span> 
            <span class="c1"># Rb05V12, </span>
            <span class="c1"># Rb05V22</span>
            <span class="p">):</span>
                <span class="s1">&#39;&#39;</span>
                <span class="n">t_key_it</span> <span class="o">=</span> <span class="n">tkeys</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span>
                <span class="n">t_key</span>   <span class="o">=</span> <span class="n">tkeys</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">run_neb</span><span class="p">:</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">add_neb</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up2&#39;</span><span class="p">,</span> <span class="n">ise_new</span> <span class="o">=</span> <span class="n">n_set</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="n">imag</span><span class="p">,</span>  
                            <span class="n">xr_start</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">xr_m_ion_start</span><span class="p">,</span>
                            <span class="n">xr_final</span> <span class="o">=</span> <span class="n">struct_des</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">xr_m_ion_final</span><span class="p">,</span> 
                            <span class="n">i_atom_to_move</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i_void_final</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">#just needed for name</span>
                            <span class="n">atom_to_insert</span> <span class="o">=</span> <span class="n">el</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_args</span><span class="p">)</span> 
                    <span class="n">calc</span><span class="p">[</span><span class="n">t_key_it</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">it</span>




                <span class="k">if</span> <span class="n">read</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">res_loop</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">t_key_it</span><span class="p">][</span><span class="n">pk</span><span class="p">],</span><span class="n">n_set</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imag</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">check_job</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fomep&#39;</span><span class="p">,</span> <span class="n">readfiles</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;neb&#39;</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">calc</span><span class="p">[</span><span class="n">t_key</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span><span class="p">[</span><span class="s1">&#39;_mep&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">run_neb</span><span class="p">:</span>
                    <span class="n">pos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">((</span><span class="n">calc</span><span class="p">[</span><span class="n">t_key</span><span class="p">][</span><span class="n">pk</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="c1"># mep.extend(list(reversed(calc[t_key][p][1])))</span>
                    <span class="n">mep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="n">t_key</span><span class="p">][</span><span class="n">pk</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>




    <span class="k">if</span> <span class="n">substitute</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">substitute</span><span class="p">:</span>
            <span class="n">mep</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">substitute</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="c1"># print(pos)</span>
    <span class="c1"># print(mep)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">t_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="c1"># print(pos, mep)</span>
        <span class="n">plot_mep</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;figs/path_&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="n">suf2</span><span class="p">,</span> <span class="n">fitplot_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;figsize&#39;</span><span class="p">:(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="s1">&#39;hor&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ylim&#39;</span><span class="p">:</span><span class="n">ylim</span><span class="p">,</span> <span class="s1">&#39;legend&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">:</span><span class="n">first</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span><span class="n">last</span><span class="p">},</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">)</span>

    <span class="k">return</span></div>




<div class="viewcode-block" id="calc_charged"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.calc_charged">[docs]</a><span class="k">def</span> <span class="nf">calc_charged</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">del_dic</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;4uis&#39;</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create charged by removing specific sets of atoms provided in del_dic manually starting from 1</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if not del_dic:</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">it_folder</span><span class="p">:</span>
        <span class="n">it_folder</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">del_dic</span><span class="p">:</span>
        <span class="n">del_pos</span> <span class="o">=</span> <span class="n">del_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">it_new</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run</span><span class="p">:</span> 
            <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">del_pos</span><span class="p">,</span> <span class="n">from_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="c1"># st_halfLi.write_xyz()</span>
            <span class="n">add_loop</span><span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">calc_method</span> <span class="o">=</span> <span class="s1">&#39;uniform_scale&#39;</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;inherit_xred&#39;</span><span class="p">,</span> <span class="n">scale_region</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="p">)</span>
            <span class="c1"># print(st_halfLi.get_space_group_info())</span>
            <span class="c1"># add_loop(it_new,&#39;0u&#39;,1, input_st = st_halfLi, it_folder = &#39;Na2FePO4F/chg&#39;, override = True) #charge density without relaxation</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">idd</span> <span class="o">=</span> <span class="p">(</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idd</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;maga&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">)</span><span class="c1">#list(range(1,8))+[100], analys_type = &#39;fit_a&#39;, show = &#39;fitfo&#39;, up = &#39;1&#39;)</span>
            <span class="c1"># st = calc[idd].end</span>
            <span class="c1"># print(st.get_space_group_info())</span>
            <span class="c1"># alpha, beta, gamma = st.get_angles()</span>

            <span class="c1"># print(alpha, beta, gamma)  </span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="optimize"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.optimize">[docs]</a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ise</span> <span class="o">=</span> <span class="s1">&#39;4uis&#39;</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if not del_dic:</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">it_folder</span><span class="p">:</span>
        <span class="n">it_folder</span> <span class="o">=</span> <span class="s1">&#39;optimization/&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>

    <span class="n">it_new</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">if</span> <span class="n">run</span><span class="p">:</span> 
        <span class="n">add_loop</span><span class="p">(</span><span class="n">it_new</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">calc_method</span> <span class="o">=</span> <span class="s1">&#39;uniform_scale&#39;</span><span class="p">,</span> <span class="n">inherit_option</span> <span class="o">=</span> <span class="s1">&#39;inherit_xred&#39;</span><span class="p">,</span> <span class="n">scale_region</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">it_folder</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">idd</span> <span class="o">=</span> <span class="p">(</span><span class="n">it_new</span><span class="o">+</span><span class="s1">&#39;.su&#39;</span><span class="p">,</span> <span class="n">ise</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
            <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">analys_type</span> <span class="o">=</span> <span class="s1">&#39;fit_a&#39;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;fitfo&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_loop</span><span class="p">(</span><span class="o">*</span><span class="n">idd</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="s1">&#39;maga&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">)</span><span class="c1">#list(range(1,8))+[100], analys_type = &#39;fit_a&#39;, show = &#39;fitfo&#39;, up = &#39;1&#39;)</span>
        <span class="c1"># st = calc[idd].end</span>
        <span class="c1"># print(st.get_space_group_info())</span>
        <span class="c1"># alpha, beta, gamma = st.get_angles()</span>

        <span class="c1"># print(alpha, beta, gamma)  </span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="create_project_from_geofile"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.create_project_from_geofile">[docs]</a><span class="k">def</span> <span class="nf">create_project_from_geofile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    empty project is added to database</span>
<span class="sd">    get name from geofile and create required folder and put file into it  </span>
<span class="sd">    Various rules to create project name</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">db</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#simple - just name of file</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">projectname</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">makedir</span><span class="p">(</span><span class="n">projectname</span><span class="o">+</span><span class="s1">&#39;/temp&#39;</span><span class="p">)</span>
        <span class="n">startgeofile</span> <span class="o">=</span> <span class="n">projectname</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">basename</span>


    <span class="k">if</span> <span class="n">projectname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">startgeofile</span><span class="p">)</span>
        <span class="n">db</span><span class="p">[</span><span class="n">projectname</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="n">db</span><span class="p">[</span><span class="n">projectname</span><span class="p">][</span><span class="s1">&#39;startgeofile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startgeofile</span>
        <span class="n">db</span><span class="p">[</span><span class="n">projectname</span><span class="p">][</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Project &#39;</span><span class="p">,</span> <span class="n">projectname</span><span class="p">,</span> <span class="s1">&#39;was created&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Error! project already exist&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">projectname</span></div>

<div class="viewcode-block" id="get_alkali_ion"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.get_alkali_ion">[docs]</a><span class="k">def</span> <span class="nf">get_alkali_ion</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>

    <span class="n">for_diffusion</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">get_elements</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Rb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mg&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">for_diffusion</span><span class="p">:</span>
                <span class="n">for_diffusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>

    <span class="n">el</span> <span class="o">=</span> <span class="n">for_diffusion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">for_diffusion</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Warning! More than one candidate for NEB was found, I use first&#39;</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">el</span></div>




<div class="viewcode-block" id="process_cathode_material"><a class="viewcode-back" href="../../siman.html#siman.project_funcs.process_cathode_material">[docs]</a><span class="k">def</span> <span class="nf">process_cathode_material</span><span class="p">(</span><span class="n">projectname</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AI module to process cif file and automatic calculation of standard properties of cathode material </span>
<span class="sd">    </span>
<span class="sd">    step 1 - read geo and run simple relaxation</span>

<span class="sd">    step 2 - calc barriers, IS</span>

<span class="sd">    step 3 - calc barriers, DS</span>

<span class="sd">    step 4 - make table with lattice constants for IS and DS</span>

<span class="sd">    step 5 - make table with intercalation potential </span>

<span class="sd">    INPUT:</span>
<span class="sd">    target_x (float) - required concentration of Na in DS state</span>
<span class="sd">    update - allows to rewrite service table</span>
<span class="sd">    params (dic)</span>
<span class="sd">        show_fit</span>
<span class="sd">        run_neb</span>
<span class="sd">        up_SC</span>
<span class="sd">        up_res</span>
<span class="sd">        atom_to_move</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">geo</span> <span class="k">import</span> <span class="n">determine_symmetry_positions</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">remove_x</span>
    <span class="n">pn</span> <span class="o">=</span> <span class="n">projectname</span>
    
    <span class="n">m_set</span> <span class="o">=</span> <span class="s1">&#39;1u&#39;</span><span class="p">;</span> <span class="n">n_set</span>  <span class="o">=</span> <span class="s1">&#39;1u&#39;</span><span class="p">;</span> <span class="n">clust</span> <span class="o">=</span> <span class="s1">&#39;cee&#39;</span> <span class="c1"># </span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">show_fit</span>  <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_fit&#39;</span><span class="p">)</span>
    <span class="n">up_scale</span>  <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;up_scale&#39;</span><span class="p">)</span>
    <span class="n">up_SC</span>  <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;up_SC&#39;</span><span class="p">)</span>
    <span class="n">up_res</span>    <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;up_res&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;up1&#39;</span>
    <span class="n">sc_set</span>    <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sc_set&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;4uis&#39;</span>
    <span class="n">run_neb</span>   <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run_neb&#39;</span><span class="p">)</span>
    <span class="c1"># atom_to_move </span>





    <span class="k">if</span> <span class="n">update</span> <span class="ow">or</span> <span class="s1">&#39;res&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">]:</span>
        <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">]:</span>
        <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;latex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="n">service_list</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;steps&#39;</span><span class="p">]:</span>
            <span class="n">startgeofile</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;startgeofile&#39;</span><span class="p">]</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;geo file is &#39;</span><span class="p">,</span> <span class="n">startgeofile</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">smart_structure_read</span><span class="p">(</span><span class="n">startgeofile</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">primitive</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="n">add_loop</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="n">m_set</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">pn</span><span class="p">)</span>
            <span class="n">startgeofile</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_loop</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="n">m_set</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>

        <span class="c1"># if 2 not in db[pn][&#39;steps&#39;]:</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">pn</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">m_set</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">el</span>  <span class="o">=</span> <span class="n">get_alkali_ion</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

        <span class="n">it_ds</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;Name for DS is&#39;</span><span class="p">,</span> <span class="n">it_ds</span><span class="p">)</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="n">cl</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;el&#39;</span><span class="p">:</span><span class="n">el</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">:</span><span class="n">it_ds</span><span class="p">,</span> <span class="s1">&#39;itfolder&#39;</span><span class="p">:</span><span class="n">cl</span><span class="o">.</span><span class="n">sfolder</span><span class="p">,</span> 
        <span class="s1">&#39;images&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;neb_set&#39;</span><span class="p">:</span><span class="n">n_set</span><span class="p">,</span> <span class="s1">&#39;main_set&#39;</span><span class="p">:</span><span class="n">m_set</span><span class="p">,</span> <span class="s1">&#39;scaling_set&#39;</span><span class="p">:</span><span class="n">sc_set</span><span class="p">,</span> <span class="s1">&#39;scale_region&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="s1">&#39;readfiles&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ortho&#39;</span><span class="p">:[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]}</span>


        <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;atom_to_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_to_move&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>


        <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 

        <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;check_job&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">:</span><span class="n">clust</span><span class="p">}</span>
        <span class="n">fitplot_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ylim&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">)}</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">style_dic</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;IS&#39;</span><span class="p">}</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">calc_barriers</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">up_res</span> <span class="o">=</span> <span class="n">up_res</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="n">show_fit</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">up_scale</span><span class="p">,</span> <span class="n">upA</span> <span class="o">=</span> <span class="n">up_SC</span><span class="p">,</span> <span class="n">upC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="n">pd</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">,</span>
            <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">,</span> <span class="n">run_neb</span> <span class="o">=</span> <span class="n">run_neb</span><span class="p">)</span> 
            
            <span class="c1"># print(a)</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">service_list</span><span class="p">:</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># db[pn][&#39;B&#39;] = [ a[0][&#39;B&#39;] ]</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># cl.res()</span>
            <span class="n">style_dic</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;DS&#39;</span><span class="p">}</span>

            <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span>

            <span class="n">pos</span> <span class="o">=</span> <span class="n">determine_symmetry_positions</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
            <span class="c1"># cl.me()</span>

            <span class="k">if</span> <span class="n">target_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_barriers</span><span class="p">(</span><span class="s1">&#39;make_ds&#39;</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">up_res</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="n">show_fit</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="n">pd</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">,</span>
                <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">,</span> <span class="n">run_neb</span> <span class="o">=</span> <span class="n">run_neb</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">service_list</span><span class="p">:</span>
                
                    <span class="n">service_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">x_vac</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">target_x</span> <span class="c1"># concentration of vacancies</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">el</span><span class="o">+</span><span class="n">x_str</span><span class="o">+</span><span class="n">it_ds</span>

                <span class="n">syms</span> <span class="o">=</span>  <span class="n">remove_x</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">info_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x_vac</span><span class="p">)</span>

                <span class="n">printlog</span><span class="p">(</span><span class="s1">&#39;The following syms are found&#39;</span><span class="p">,</span> <span class="n">syms</span><span class="p">,</span> <span class="s1">&#39;I check all of them&#39;</span><span class="p">,</span> <span class="n">imp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>


                <span class="c1"># sys.exit()</span>
                <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">:</span>
                    <span class="n">st_rem</span>  <span class="o">=</span>  <span class="n">remove_x</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x_vac</span><span class="p">)</span>

                    <span class="n">id_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;sg&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">m_set</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">add_loop</span><span class="p">(</span><span class="o">*</span><span class="n">id_new</span><span class="p">,</span> <span class="n">input_st</span> <span class="o">=</span> <span class="n">st_rem</span><span class="p">,</span> <span class="n">it_folder</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">sfolder</span><span class="o">+</span><span class="s1">&#39;/ds&#39;</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">)</span>
                    
                    <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_new</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">calc_barriers</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">up_res</span> <span class="o">=</span> <span class="s1">&#39;up1&#39;</span><span class="p">,</span> <span class="n">show_fit</span> <span class="o">=</span> <span class="n">show_fit</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">param_dic</span> <span class="o">=</span> <span class="n">pd</span><span class="p">,</span> <span class="n">add_loop_dic</span> <span class="o">=</span> <span class="n">add_loop_dic</span><span class="p">,</span>
                    <span class="n">fitplot_args</span> <span class="o">=</span> <span class="n">fitplot_args</span><span class="p">,</span> <span class="n">style_dic</span> <span class="o">=</span> <span class="n">style_dic</span><span class="p">,</span> <span class="n">run_neb</span> <span class="o">=</span> <span class="n">run_neb</span><span class="p">)</span> 
                    <span class="n">info</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_x</span>
                    <span class="k">if</span> <span class="n">info</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">service_list</span><span class="p">:</span>
                        <span class="n">service_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

                    <span class="c1"># print (service_list)</span>


    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="s1">&#39;&#39;</span>
        <span class="c1">#Lattice constants, and intercalation potentials </span>
        <span class="c1">#the first calculation now is considered as intercalated </span>
        <span class="c1"># IS = </span>
        <span class="kn">from</span> <span class="nn">table_functions</span> <span class="k">import</span> <span class="n">table_geometry</span><span class="p">,</span> <span class="n">table_potentials</span>

        <span class="c1"># print(&#39;service list is &#39;, service_list)</span>
        <span class="sd">&quot;&quot;&quot;Lattice constants&quot;&quot;&quot;</span>

        <span class="n">sts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cll</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">service_list</span><span class="p">:</span>
            <span class="c1"># print(a)</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">end</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">end</span>
            <span class="n">st</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">sts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="n">cll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;Plot figures&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="s1">&#39;id_sc&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                    <span class="n">db</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id_sc&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">jmol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">table_geometry</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span>
        <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;latex&#39;</span><span class="p">][</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>


        <span class="sd">&quot;&quot;&quot;Intercalation potentials&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">table_potentials</span><span class="p">(</span><span class="n">cll</span><span class="p">)</span>
        <span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;latex&#39;</span><span class="p">][</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>





    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1">#create report</span>
        <span class="kn">from</span> <span class="nn">table_functions</span> <span class="k">import</span> <span class="n">generate_latex_report</span>

        <span class="n">latex_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">]:</span>
            <span class="n">latex_text</span><span class="o">+=</span><span class="n">db</span><span class="p">[</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;latex&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">generate_latex_report</span><span class="p">(</span><span class="n">latex_text</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;tex/&#39;</span><span class="o">+</span><span class="n">pn</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">pn</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Siman 0.9.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Dmitry Aksenov.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>